<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>教員用コントロールパネル</title>
<link rel="stylesheet" href="style.css">

<!-- QRコード -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- ぽよん音 -->
<audio id="poyonSound" src="poyon.mp3" preload="auto"></audio>

<!-- Firebase -->
<script type="module">
import { db, ref, set, onValue } from "./common.js";

document.addEventListener("DOMContentLoaded", () => {

  /* ========== 要素 ========== */
  const classSelect = document.getElementById("classSelect");
  const unlockBtn   = document.getElementById("unlock");
  const lockBtn     = document.getElementById("lock");
  const resetBtn    = document.getElementById("reset");
  const showQRBtn   = document.getElementById("showQR");
  const backBtn     = document.getElementById("backBtn");

  const qrSection   = document.getElementById("qr-section");
  const chartSection= document.getElementById("chart-section");
  const qrBox       = document.getElementById("qrcode");

  const barOK   = document.getElementById("barOK");
  const barX    = document.getElementById("barX");
  const countOK = document.getElementById("countOK");
  const countX  = document.getElementById("countX");

  const poyon   = document.getElementById("poyonSound");

  let currentRoom = null;
  let previousTotal = 0;  // 票数の前回値（ぽよん制御用）

  /* ========== ルーム選択 ========== */
  classSelect.addEventListener("change", () => {
    currentRoom = classSelect.value;
    previousTotal = 0;  // ルーム切り替え時にリセット
    loadResultListener();
  });

  /* ========== Firebaseから集計＆グラフ更新 ========== */
  function loadResultListener() {
    if (!currentRoom) return;

    const answersRef = ref(db, `rooms/${currentRoom}/answers`);
    const resultRef  = ref(db, `rooms/${currentRoom}/result`);

    onValue(answersRef, (snapshot) => {
      const answers = snapshot.val() || {};

      // O / X を集計
      let o = 0;
      let x = 0;
      Object.values(answers).forEach(v => {
        if (v === "O") o++;
        if (v === "X") x++;
      });

      const total = o + x;
      const maxWidth = 450; // プロジェクター向け表示

      // 横棒グラフを更新
      barOK.style.width = total === 0 ? "0px" : `${(o / total) * maxWidth}px`;
      barX.style.width  = total === 0 ? "0px" : `${(x / total) * maxWidth}px`;

      // 人数表示
      countOK.textContent = `${o}人`;
      countX.textContent  = `${x}人`;

      // result ノードにも反映（他画面からも見られるように）
      set(resultRef, { O: o, X: x });

      // 票数が増えたときだけ ぽよん
      if (total > previousTotal) {
        poyon.currentTime = 0;
        poyon.play().catch(() => {});
      }
      previousTotal = total;
    });
  }

  /* ========== 回答開始（リセット付き） ========== */
  unlockBtn.addEventListener("click", async () => {
    if (!currentRoom) return alert("ルームを選択してください");

    await set(ref(db, `rooms/${currentRoom}/answers`), {});
    await set(ref(db, `rooms/${currentRoom}/result`), { O: 0, X: 0 });
    await set(ref(db, `rooms/${currentRoom}/activity`), { status: "open" });

    previousTotal = 0; // 新しい設問としてカウントをリセット
    glow(unlockBtn);
  });

  /* ========== 回答終了 ========== */
  lockBtn.addEventListener("click", () => {
    if (!currentRoom) return;
    set(ref(db, `rooms/${currentRoom}/activity`), { status: "closed" });
    glow(lockBtn);
  });

  /* ========== リセットのみ ========== */
  resetBtn.addEventListener("click", () => {
    if (!currentRoom) return;
    set(ref(db, `rooms/${currentRoom}/answers`), {});
    set(ref(db, `rooms/${currentRoom}/result`), { O: 0, X: 0 });
    previousTotal = 0;
    glow(resetBtn);
  });

  /* ========== QRコード表示 ========== */
  showQRBtn.addEventListener("click", () => {
    if (!currentRoom) return alert("ルームを選択してください");

    chartSection.style.display = "none";
    qrSection.style.display = "flex";
    glow(showQRBtn);

    qrBox.innerHTML = "";
    new QRCode(qrBox, {
      text: `https://qzp04374-code.github.io/quiz-app/student.html?room=${currentRoom}`,
      width: 260,
      height: 260
    });
  });

  /* ========== グラフに戻る ========== */
  backBtn.addEventListener("click", () => {
    qrSection.style.display = "none";
    chartSection.style.display = "block";
    glow(backBtn);
  });

  /* ========== ボタン発光 ========== */
  function glow(btn) {
    document.querySelectorAll("button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  }

});
</script>

</head>
<body>

<h1>教員用コントロールパネル</h1>

<!-- ───── ボタン（横並び） ───── -->
<div class="controls">
  <label>ルーム：</label>
  <select id="classSelect">
    <option value="">選択してください</option>
    <option value="kyoto-01">kyoto-01</option>
    <option value="kyoto-02">kyoto-02</option>
    <option value="sendai-01">sendai-01</option>
    <option value="sendai-02">sendai-02</option>
    <option value="nagoya-01">nagoya-01</option>
    <option value="nagoya-02">nagoya-02</option>
  </select>

  <button id="unlock">回答開始</button>
  <button id="lock">回答終了</button>
  <button id="reset">集計リセット</button>
  <button id="showQR">QR表示</button>
  <button id="backBtn">グラフ</button>
</div>

<!-- ───── 横棒グラフ（プロジェクター用巨大版） ───── -->
<div id="chart-section">

  <div class="bar-row">
    <label class="large-label">○</label>
    <div class="bar ok-bar"><div id="barOK"></div></div>
    <span class="count-text" id="countOK">0人</span>
  </div>

  <div class="bar-row">
    <label class="large-label">✕</label>
    <div class="bar x-bar"><div id="barX"></div></div>
    <span class="count-text" id="countX">0人</span>
  </div>

</div>

<!-- ───── QRコード表示 ───── -->
<div id="qr-section" style="display:none;">
  <h2>学生アクセス用 QRコード</h2>
  <div id="qrcode"></div>
</div>

</body>
</html>

