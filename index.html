<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æ•™å“¡ç”¨ã‚¯ã‚¤ã‚ºã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { db, ref, set, onValue, update } from "./common.js";

const activityRef = ref(db, "activity");
const resultRef = ref(db, "result");

// åˆæœŸåŒ–
set(activityRef, { status: "locked" });
set(resultRef, { O: 0, X: 0 });

document.addEventListener("DOMContentLoaded", () => {
  const lockBtn = document.getElementById("lock");
  const unlockBtn = document.getElementById("unlock");
  const resetBtn = document.getElementById("reset");
  const ctx = document.getElementById("resultChart").getContext("2d");

  // ä¸­å¤®ã«ï¼…ã‚’æããƒ—ãƒ©ã‚°ã‚¤ãƒ³
  const centerText = {
    id: "centerText",
    afterDraw(chart) {
      const {ctx, chartArea: {width, height}} = chart;
      ctx.save();
      ctx.font = "bold 28px sans-serif";
      ctx.fillStyle = "#333";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      const data = chart.data.datasets[0].data;
      const total = data[0] + data[1];
      const percent = total > 0 ? Math.round((data[0] / total) * 100) : 0;
      ctx.fillText(`${percent}%`, width / 2, height / 2);
    }
  };

  // ã‚°ãƒ©ãƒ•è¨­å®š
  const chart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["â—‹", "Ã—"],
      datasets: [{
        data: [0, 0],
        backgroundColor: ["#4dd0e1", "#ef9a9a"],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: "bottom" },
        title: { display: true, text: "ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é›†è¨ˆçµæœ" }
      }
    },
    plugins: [centerText]
  });

  // æ“ä½œãƒœã‚¿ãƒ³
  lockBtn.onclick = () => update(activityRef, { status: "locked" });
  unlockBtn.onclick = () => update(activityRef, { status: "open" });
  resetBtn.onclick = () => set(resultRef, { O: 0, X: 0 });

  // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
  onValue(resultRef, (snapshot) => {
    const data = snapshot.val() || { O: 0, X: 0 };
    chart.data.datasets[0].data = [data.O, data.X];
    chart.update();
  });
});
</script>
</head>

<body>
<h1>æ•™å“¡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«</h1>

<div class="controls">
  <button id="unlock">ğŸŸ¢ å›ç­”é–‹å§‹</button>
  <button id="lock">ğŸ”´ å›ç­”çµ‚äº†</button>
  <button id="reset">ğŸ§¹ ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<div style="width:260px; height:260px; margin: 1em auto;">
  <canvas id="resultChart"></canvas>
</div>

</body>
</html>

