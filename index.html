<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>教員用コントロールパネル</title>
<link rel="stylesheet" href="style.css">

<!-- Chart.js & QRCode.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- ぽよん音 -->
<audio id="poyonSound" src="poyon.mp3" preload="auto"></audio>

<!-- Firebase -->
<script type="module">
import { db, ref, set, onValue } from "./common.js";

document.addEventListener("DOMContentLoaded", () => {

  /* ----------------------
      要素参照
  -----------------------*/
  const classSelect = document.getElementById("classSelect");
  const unlockBtn = document.getElementById("unlock");
  const lockBtn = document.getElementById("lock");
  const resetBtn = document.getElementById("reset");
  const showQRBtn = document.getElementById("showQR");
  const backBtn = document.getElementById("backBtn");

  const qrSection = document.getElementById("qr-section");
  const chartSection = document.getElementById("chart-section");
  const ctx = document.getElementById("resultChart").getContext("2d");
  const poyon = document.getElementById("poyonSound");

  let currentRoom = null;

  /* ----------------------
      ルーム選択
  -----------------------*/
  classSelect.addEventListener("change", () => {
    currentRoom = classSelect.value;
    loadChartListener();
  });

  /* ----------------------
      グラフ初期化
  -----------------------*/
  let chart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["○", "×"],
      datasets: [{
        data: [0, 0],
        backgroundColor: ["#4caf50", "#f44336"],
        borderWidth: 0
      }]
    },
    options: {
      plugins: {
        legend: { display: true, position: "bottom" }
      },
      cutout: "55%"
    }
  });

  /* ----------------------
      Firebase リスナー
  -----------------------*/
  function loadChartListener() {
    if (!currentRoom) return;

    const resultRef = ref(db, `rooms/${currentRoom}/result`);

    onValue(resultRef, (snapshot) => {
      const data = snapshot.val() || { O: 0, X: 0 };

      chart.data.datasets[0].data = [data.O || 0, data.X || 0];
      chart.update();
    });

    // 回答が送信されたら「ぽよん♪」
    const answersRef = ref(db, `rooms/${currentRoom}/answers`);
    onValue(answersRef, (snapshot) => {
      if (snapshot.exists()) {
        poyon.currentTime = 0;
        poyon.play().catch(() => {});
      }
    });
  }

  /* ----------------------
      回答開始（集計リセット＋開始）
  -----------------------*/
  unlockBtn.addEventListener("click", async () => {
    if (!currentRoom) {
      alert("ルームを選択してください");
      return;
    }

    const roomActivityRef = ref(db, `rooms/${currentRoom}/activity`);
    const roomResultRef = ref(db, `rooms/${currentRoom}/result`);
    const roomAnswersRef = ref(db, `rooms/${currentRoom}/answers`);

    await set(roomAnswersRef, {});
    await set(roomResultRef, { O: 0, X: 0 });
    await set(roomActivityRef, { status: "open" });

    glowButton(unlockBtn);
  });

  /* ----------------------
      回答終了
  -----------------------*/
  lockBtn.addEventListener("click", async () => {
    if (!currentRoom) return;
    const refAct = ref(db, `rooms/${currentRoom}/activity`);
    await set(refAct, { status: "closed" });

    glowButton(lockBtn);
  });

  /* ----------------------
      集計リセットのみ
  -----------------------*/
  resetBtn.addEventListener("click", async () => {
    if (!currentRoom) return;

    await set(ref(db, `rooms/${currentRoom}/answers`), {});
    await set(ref(db, `rooms/${currentRoom}/result`), { O: 0, X: 0 });

    glowButton(resetBtn);
  });

  /* ----------------------
      QR表示
  -----------------------*/
  showQRBtn.addEventListener("click", () => {
    if (!currentRoom) {
      alert("ルームを選択してください");
      return;
    }

    chartSection.style.display = "none";
    qrSection.style.display = "flex";

    glowButton(showQRBtn);

    const qrDiv = document.getElementById("qrcode");
    qrDiv.innerHTML = "";

    new QRCode(qrDiv, {
      text: `https://qzp04374-code.github.io/quiz-app/student.html?room=${currentRoom}`,
      width: 220,
      height: 220
    });
  });

  backBtn.addEventListener("click", () => {
    qrSection.style.display = "none";
    chartSection.style.display = "block";
    glowButton(backBtn);
  });

  /* ----------------------
      ボタン発光
  -----------------------*/
  function glowButton(btn) {
    document.querySelectorAll("button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  }

});
</script>

</head>
<body>
  <h1>教員用コントロールパネル</h1>

  <div class="controls">
    <label>ルーム選択：</label>
    <select id="classSelect">
      <option value="">選択してください</option>
      <option value="kyoto-01">kyoto-01</option>
      <option value="kyoto-02">kyoto-02</option>
      <option value="sendai-01">sendai-01</option>
      <option value="sendai-02">sendai-02</option>
      <option value="nagoya-01">nagoya-01</option>
      <option value="nagoya-02">nagoya-02</option>
    </select>

    <button id="unlock">回答開始</button>
    <button id="lock">回答終了</button>
    <button id="reset">集計リセット</button>
    <button id="showQR">QRコード表示</button>
    <button id="backBtn">グラフに戻る</button>
  </div>

  <!-- グラフ -->
  <div id="chart-section">
    <canvas id="resultChart" width="260" height="260"></canvas>
  </div>

  <!-- QRコード -->
  <div id="qr-section" style="display:none;">
    <h2>学生アクセス用 QRコード</h2>
    <div id="qrcode"></div>
  </div>
</body>
</html>

