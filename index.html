<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>教員用コントロールページ</title>

<link rel="stylesheet" href="style.css" />

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

</head>

<body>

<h1>クイズ コントロールパネル</h1>

<div class="class-selector">
  <label>クラス選択：</label>
  <select id="classSelect">
    <option value="kyoto-01">kyoto-01</option>
    <option value="kyoto-02">kyoto-02</option>
    <option value="sendai-01">sendai-01</option>
    <option value="sendai-02">sendai-02</option>
    <option value="nagoya-01">nagoya-01</option>
    <option value="nagoya-02">nagoya-02</option>
  </select>
</div>

<div class="controls">
  <button id="unlock">回答開始</button>
  <button id="lock">回答終了</button>
  <button id="reset">集計リセット</button>
  <button id="showQR">QRコード表示</button>
  <button id="backBtn">グラフに戻る</button>
</div>

<audio id="popSound" src="https://soundeffect-lab.info/sound/anime/mp3/decision1.mp3"></audio>

<!-- グラフ -->
<div id="chart-section">
  <canvas id="resultChart" width="260" height="260"></canvas>
</div>

<!-- QRコード -->
<div id="qr-section" style="display:none;">
  <h2>学生アクセス用 QRコード</h2>
  <div id="qrcode"></div>
  <p style="margin-top: 1em;">
    <a href="https://qzp04374-code.github.io/quiz-app/student.html" target="_blank">
      https://qzp04374-code.github.io/quiz-app/student.html
    </a>
  </p>
</div>

<script type="module">

import { db, ref, set, update, onValue, child, get } from "./common.js";

const classSelect = document.getElementById("classSelect");
const unlockBtn = document.getElementById("unlock");
const lockBtn = document.getElementById("lock");
const resetBtn = document.getElementById("reset");
const showQRBtn = document.getElementById("showQR");
const backBtn = document.getElementById("backBtn");
const popSound = document.getElementById("popSound");

let selectedClass = classSelect.value;

// firebase 参照
const classRoomRef = ref(db, "class_room");
const answersRef = (cls) => ref(db, `answers/${cls}`);
const statusRef = (cls) => ref(db, `status/${cls}`);
const resultRef = (cls) => ref(db, `result/${cls}`);

// クラス選択時に Firebase に反映
classSelect.addEventListener("change", () => {
  selectedClass = classSelect.value;
  set(classRoomRef, selectedClass);

  // グラフデータ更新
  setupResultListener();
});

// -------------------------------
// グラフの初期化
// -------------------------------
const ctx = document.getElementById("resultChart").getContext("2d");
let chart = new Chart(ctx, {
  type: "doughnut",
  data: {
    labels: ["○", "×"],
    datasets: [
      {
        data: [0, 0],
        backgroundColor: ["#4caf50", "#f44336"],
        borderWidth: 0
      }
    ]
  },
  options: {
    plugins: {
      legend: { display: true, position: "bottom" }
    },
    cutout: "60%"
  }
});

// Firebase → グラフ更新
function setupResultListener() {
  onValue(resultRef(selectedClass), (snap) => {
    const data = snap.val() || { O: 0, X: 0 };
    chart.data.datasets[0].data = [data.O || 0, data.X || 0];
    chart.update();
  });
}
setupResultListener();

// -------------------------------
// 回答開始
// -------------------------------
unlockBtn.addEventListener("click", async () => {
  await set(answersRef(selectedClass), {});               // 回答リセット
  await set(resultRef(selectedClass), { O: 0, X: 0 });    // 集計リセット
  await set(statusRef(selectedClass), "open");            // 回答開始

  glow(unlockBtn);
  alert("回答を開始しました");
});

// -------------------------------
// 回答終了
// -------------------------------
lockBtn.addEventListener("click", async () => {
  await set(statusRef(selectedClass), "closed");

  glow(lockBtn);
  alert("回答を締め切りました");
});

// -------------------------------
// 集計だけリセット
// -------------------------------
resetBtn.addEventListener("click", async () => {
  await set(answersRef(selectedClass), {});
  await set(resultRef(selectedClass), { O: 0, X: 0 });

  glow(resetBtn);
  alert("集計をリセットしました");
});

// -------------------------------
// QRコード表示
// -------------------------------
showQRBtn.addEventListener("click", () => {
  document.getElementById("chart-section").style.display = "none";
  document.getElementById("qr-section").style.display = "block";

  if (!document.getElementById("qrcode").hasChildNodes()) {
    new QRCode(document.getElementById("qrcode"), {
      text: "https://qzp04374-code.github.io/quiz-app/student.html",
      width: 220,
      height: 220
    });
  }
  glow(showQRBtn);
});

// -------------------------------
// グラフに戻る
// -------------------------------
backBtn.addEventListener("click", () => {
  document.getElementById("qr-section").style.display = "none";
  document.getElementById("chart-section").style.display = "block";
  glow(backBtn);
});

// -------------------------------
// ボタン発光エフェクト
// -------------------------------
function glow(btn) {
  document.querySelectorAll("button").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
}

</script>

</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>教員用コントロールページ</title>

<link rel="stylesheet" href="style.css" />

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

</head>

<body>

<h1>クイズ コントロールパネル</h1>

<div class="class-selector">
  <label>クラス選択：</label>
  <select id="classSelect">
    <option value="kyoto-01">kyoto-01</option>
    <option value="kyoto-02">kyoto-02</option>
    <option value="sendai-01">sendai-01</option>
    <option value="sendai-02">sendai-02</option>
    <option value="nagoya-01">nagoya-01</option>
    <option value="nagoya-02">nagoya-02</option>
  </select>
</div>

<div class="controls">
  <button id="unlock">回答開始</button>
  <button id="lock">回答終了</button>
  <button id="reset">集計リセット</button>
  <button id="showQR">QRコード表示</button>
  <button id="backBtn">グラフに戻る</button>
</div>

<audio id="popSound" src="https://soundeffect-lab.info/sound/anime/mp3/decision1.mp3"></audio>

<!-- グラフ -->
<div id="chart-section">
  <canvas id="resultChart" width="260" height="260"></canvas>
</div>

<!-- QRコード -->
<div id="qr-section" style="display:none;">
  <h2>学生アクセス用 QRコード</h2>
  <div id="qrcode"></div>
  <p style="margin-top: 1em;">
    <a href="https://qzp04374-code.github.io/quiz-app/student.html" target="_blank">
      https://qzp04374-code.github.io/quiz-app/student.html
    </a>
  </p>
</div>

<script type="module">

import { db, ref, set, update, onValue, child, get } from "./common.js";

const classSelect = document.getElementById("classSelect");
const unlockBtn = document.getElementById("unlock");
const lockBtn = document.getElementById("lock");
const resetBtn = document.getElementById("reset");
const showQRBtn = document.getElementById("showQR");
const backBtn = document.getElementById("backBtn");
const popSound = document.getElementById("popSound");

let selectedClass = classSelect.value;

// firebase 参照
const classRoomRef = ref(db, "class_room");
const answersRef = (cls) => ref(db, `answers/${cls}`);
const statusRef = (cls) => ref(db, `status/${cls}`);
const resultRef = (cls) => ref(db, `result/${cls}`);

// クラス選択時に Firebase に反映
classSelect.addEventListener("change", () => {
  selectedClass = classSelect.value;
  set(classRoomRef, selectedClass);

  // グラフデータ更新
  setupResultListener();
});

// -------------------------------
// グラフの初期化
// -------------------------------
const ctx = document.getElementById("resultChart").getContext("2d");
let chart = new Chart(ctx, {
  type: "doughnut",
  data: {
    labels: ["○", "×"],
    datasets: [
      {
        data: [0, 0],
        backgroundColor: ["#4caf50", "#f44336"],
        borderWidth: 0
      }
    ]
  },
  options: {
    plugins: {
      legend: { display: true, position: "bottom" }
    },
    cutout: "60%"
  }
});

// Firebase → グラフ更新
function setupResultListener() {
  onValue(resultRef(selectedClass), (snap) => {
    const data = snap.val() || { O: 0, X: 0 };
    chart.data.datasets[0].data = [data.O || 0, data.X || 0];
    chart.update();
  });
}
setupResultListener();

// -------------------------------
// 回答開始
// -------------------------------
unlockBtn.addEventListener("click", async () => {
  await set(answersRef(selectedClass), {});               // 回答リセット
  await set(resultRef(selectedClass), { O: 0, X: 0 });    // 集計リセット
  await set(statusRef(selectedClass), "open");            // 回答開始

  glow(unlockBtn);
  alert("回答を開始しました");
});

// -------------------------------
// 回答終了
// -------------------------------
lockBtn.addEventListener("click", async () => {
  await set(statusRef(selectedClass), "closed");

  glow(lockBtn);
  alert("回答を締め切りました");
});

// -------------------------------
// 集計だけリセット
// -------------------------------
resetBtn.addEventListener("click", async () => {
  await set(answersRef(selectedClass), {});
  await set(resultRef(selectedClass), { O: 0, X: 0 });

  glow(resetBtn);
  alert("集計をリセットしました");
});

// -------------------------------
// QRコード表示
// -------------------------------
showQRBtn.addEventListener("click", () => {
  document.getElementById("chart-section").style.display = "none";
  document.getElementById("qr-section").style.display = "block";

  if (!document.getElementById("qrcode").hasChildNodes()) {
    new QRCode(document.getElementById("qrcode"), {
      text: "https://qzp04374-code.github.io/quiz-app/student.html",
      width: 220,
      height: 220
    });
  }
  glow(showQRBtn);
});

// -------------------------------
// グラフに戻る
// -------------------------------
backBtn.addEventListener("click", () => {
  document.getElementById("qr-section").style.display = "none";
  document.getElementById("chart-section").style.display = "block";
  glow(backBtn);
});

// -------------------------------
// ボタン発光エフェクト
// -------------------------------
function glow(btn) {
  document.querySelectorAll("button").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
}

</script>

</body>
</html>