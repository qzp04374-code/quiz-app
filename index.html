<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>教員用コントロールパネル</title>
<link rel="stylesheet" href="style.css">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase -->
<script type="module">
import { db, ref, set, onValue } from "./common.js";

document.addEventListener("DOMContentLoaded", () => {

  const roomSelect = document.getElementById("room-select");
  const unlockBtn = document.getElementById("unlock");
  const lockBtn = document.getElementById("lock");
  const resetBtn = document.getElementById("reset");

  const chartCanvas = document.getElementById("resultChart");
  const ctx = chartCanvas.getContext("2d");
  const countO = document.getElementById("countO");
  const countX = document.getElementById("countX");

  // 「ぽよん♪」効果音
  const sound = new Audio("poyon.mp3");

  let currentRoom = "kyoto-01";

  let chart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["○", "×"],
      datasets: [{
        data: [0, 0],
        backgroundColor: ["#4caf50", "#f44336"],
        borderWidth: 0
      }]
    },
    options: {
      cutout: "60%",
      plugins: {
        legend: { display: true, position: "bottom" }
      }
    }
  });

  // ルーム変更時
  roomSelect.addEventListener("change", () => {
    currentRoom = roomSelect.value;
    startListening();   // リスナー再設定
  });

  function startListening() {
    const resultRef = ref(db, `rooms/${currentRoom}/result`);

    onValue(resultRef, (snapshot) => {
      const data = snapshot.val() || { O: 0, X: 0 };

      const prevO = chart.data.datasets[0].data[0];
      const prevX = chart.data.datasets[0].data[1];

      chart.data.datasets[0].data = [data.O || 0, data.X || 0];
      chart.update();

      countO.textContent = data.O || 0;
      countX.textContent = data.X || 0;

      // 送信イベントが発生したら「ぽよん♪」
      if (data.O !== prevO || data.X !== prevX) {
        sound.currentTime = 0;
        sound.play().catch(() => {});
      }
    });
  }

  // 初期設定
  startListening();

  // 回答開始
  unlockBtn.addEventListener("click", () => {
    set(ref(db, `rooms/${currentRoom}/activity`), { status: "open" });
  });

  // 回答終了
  lockBtn.addEventListener("click", () => {
    set(ref(db, `rooms/${currentRoom}/activity`), { status: "closed" });
  });

  // 集計リセット
  resetBtn.addEventListener("click", () => {
    set(ref(db, `rooms/${currentRoom}/result`), { O: 0, X: 0 });
    set(ref(db, `rooms/${currentRoom}/answers`), {});
  });

});
</script>

</head>
<body>

<h1>教員用コントロールパネル</h1>

<div class="controls">
  <label>ルーム選択：</label>
  <select id="room-select">
    <option value="kyoto-01">kyoto-01</option>
    <option value="kyoto-02">kyoto-02</option>
    <option value="sendai-01">sendai-01</option>
    <option value="sendai-02">sendai-02</option>
    <option value="nagoya-01">nagoya-01</option>
    <option value="nagoya-02">nagoya-02</option>
  </select>

  <button id="unlock">回答開始</button>
  <button id="lock">回答終了</button>
  <button id="reset">集計リセット</button>
</div>

<!-- 円グラフ -->
<div id="chart-section">
  <canvas id="resultChart" width="300" height="300"></canvas>

  <div class="count-box">
    <div class="count-item">◯：<span id="countO">0</span> 人</div>
    <div class="count-item">✕：<span id="countX">0</span> 人</div>
  </div>
</div>

</body>
</html>

