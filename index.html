<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>教員用コントロールページ</title>
<link rel="stylesheet" href="style.css">

<!-- Chart.js & QRCode.js 読み込み -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- Firebaseモジュール -->
<script type="module">
import { db, ref, set, onValue, update, child } from "./common.js";

document.addEventListener("DOMContentLoaded", () => {
  const unlockBtn = document.getElementById("unlock");
  const lockBtn = document.getElementById("lock");
  const resetBtn = document.getElementById("reset");
  const showQRBtn = document.getElementById("showQR");
  const backBtn = document.getElementById("backBtn");

  const qrSection = document.getElementById("qr-section");
  const chartSection = document.getElementById("chart-section");
  const ctx = document.getElementById("resultChart").getContext("2d");

  // Firebase参照
  const activityRef = ref(db, "activity");
  const resultRef = ref(db, "result");
  const answersRef = ref(db, "answers"); // 学生回答データをリセット対象に追加

  // グラフ初期化
  let chart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["○", "×"],
      datasets: [{
        data: [0, 0],
        backgroundColor: ["#4caf50", "#f44336"],
        borderWidth: 0
      }]
    },
    options: {
      plugins: {
        legend: { display: true, position: "bottom" }
      },
      cutout: "65%"
    }
  });

  // リアルタイム更新
  onValue(resultRef, (snapshot) => {
    const data = snapshot.val() || { O: 0, X: 0 };
    chart.data.datasets[0].data = [data.O || 0, data.X || 0];
    chart.update();
  });

  // ✅ 回答開始（集計リセット＋開始）
  unlockBtn.addEventListener("click", async () => {
    // ① 既存集計をクリア
    await set(answersRef, {});
    await set(resultRef, { O: 0, X: 0 });

    // ② 回答開始
    await set(activityRef, { status: "open" });
    glowButton(unlockBtn);
    alert("集計をリセットして、回答を開始しました。");
  });

  // 回答終了
  lockBtn.addEventListener("click", () => {
    set(activityRef, { status: "closed" });
    glowButton(lockBtn);
  });

  // 集計リセットのみ（独立操作用）
  resetBtn.addEventListener("click", () => {
    set(resultRef, { O: 0, X: 0 });
    set(answersRef, {});
    glowButton(resetBtn);
    alert("集計をリセットしました。");
  });

  // QR表示切り替え
  showQRBtn.addEventListener("click", () => {
    chartSection.style.display = "none";
    qrSection.style.display = "flex";
    glowButton(showQRBtn);

    if (!document.getElementById("qrcode").hasChildNodes()) {
      new QRCode(document.getElementById("qrcode"), {
        text: "https://qzp04374-code.github.io/quiz-app/student.html",
        width: 220,
        height: 220
      });
    }
  });

  // QR→戻る
  backBtn.addEventListener("click", () => {
    qrSection.style.display = "none";
    chartSection.style.display = "block";
    glowButton(backBtn);
  });

  // 発光エフェクト関数
  function glowButton(btn) {
    document.querySelectorAll("button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  }
});
</script>

</head>
<body>
  <h1>クイズ コントロールパネル</h1>

  <div class="controls">
    <button id="unlock">回答開始</button>
    <button id="lock">回答終了</button>
    <button id="reset">集計リセット</button>
    <button id="showQR">QRコード表示</button>
    <button id="backBtn">グラフに戻る</button>
  </div>

  <!-- 円グラフ表示 -->
  <div id="chart-section">
    <canvas id="resultChart" width="240" height="240"></canvas>
  </div>

  <!-- QRコード表示 -->
  <div id="qr-section" style="display:none;">
    <h2>学生アクセス用 QRコード</h2>
    <div id="qrcode"></div>
    <p><a href="https://qzp04374-code.github.io/quiz-app/student.html" target="_blank">
      https://qzp04374-code.github.io/quiz-app/student.html</a></p>
  </div>

</body>
</html>

