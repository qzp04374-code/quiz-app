<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>教員用コントロールページ</title>

<link rel="stylesheet" href="style.css">

<!-- Chart.js & QRCode.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- ぽよん音 -->
<audio id="poyon" src="poyon.mp3" preload="auto"></audio>

<script type="module">
import { db, ref, set, onValue, update, getRoom } from "./common.js";

document.addEventListener("DOMContentLoaded", () => {

  /* -------------------------
       現在のクラスを取得
  ------------------------- */
  const room = getRoom();
  document.getElementById("roomName").textContent = room;

  /* -------------------------
       Firebase 参照
  ------------------------- */
  const activityRef = ref(db, `rooms/${room}/activity`);
  const resultRef   = ref(db, `rooms/${room}/result`);
  const answersRef  = ref(db, `rooms/${room}/answers`);

  /* -------------------------
       要素取得
  ------------------------- */
  const unlockBtn = document.getElementById("unlock");
  const lockBtn   = document.getElementById("lock");
  const resetBtn  = document.getElementById("reset");
  const showQRBtn = document.getElementById("showQR");
  const backBtn   = document.getElementById("backBtn");

  const qrSection = document.getElementById("qr-section");
  const chartSection = document.getElementById("chart-section");

  const poyon = document.getElementById("poyon");
  poyon.volume = 0.6;

  /* -------------------------
       グラフ初期化
  ------------------------- */
  const ctx = document.getElementById("resultChart").getContext("2d");

  let prevO = 0;
  let prevX = 0;

  let chart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["○", "×"],
      datasets: [{
        data: [0, 0],
        backgroundColor: ["#4caf50", "#f44336"],
        borderWidth: 0
      }]
    },
    options: {
      plugins: {
        legend: { display: true, position: "bottom" }
      },
      cutout: "60%"
    }
  });

  /* -------------------------
       集計のリアルタイム反映
  ------------------------- */
  onValue(resultRef, snapshot => {
    const v = snapshot.val() || { O: 0, X: 0 };
    chart.data.datasets[0].data = [v.O || 0, v.X || 0];
    chart.update();

    // ぽよん♪音
    if (v.O > prevO || v.X > prevX) {
      try {
        poyon.currentTime = 0;
        poyon.play();
      } catch (e) {}
    }

    prevO = v.O || 0;
    prevX = v.X || 0;
  });

  /* -------------------------
       回答開始（リセット込み）
  ------------------------- */
  unlockBtn.addEventListener("click", async () => {
    await set(answersRef, {});
    await set(resultRef, { O: 0, X: 0 });
    await set(activityRef, { status: "open" });

    glow(unlockBtn);
    alert("回答を開始しました（集計リセット済み）");
  });

  /* -------------------------
       回答終了
  ------------------------- */
  lockBtn.addEventListener("click", () => {
    set(activityRef, { status: "closed" });
    glow(lockBtn);
  });

  /* -------------------------
       集計リセットのみ
  ------------------------- */
  resetBtn.addEventListener("click", () => {
    set(resultRef, { O: 0, X: 0 });
    set(answersRef, {});
    glow(resetBtn);
    alert("集計をリセットしました");
  });

  /* -------------------------
       QRコード生成
  ------------------------- */
  showQRBtn.addEventListener("click", () => {
    chartSection.style.display = "none";
    qrSection.style.display = "flex";
    glow(showQRBtn);

    const link = `https://qzp04374-code.github.io/quiz-app/student.html?room=${room}`;
    document.getElementById("qrLink").href = link;
    document.getElementById("qrLink").textContent = link;

    const qrDiv = document.getElementById("qrcode");
    qrDiv.innerHTML = ""; // 毎回クリア

    new QRCode(qrDiv, {
      text: link,
      width: 220,
      height: 220
    });
  });

  /* -------------------------
       グラフへ戻る
  ------------------------- */
  backBtn.addEventListener("click", () => {
    qrSection.style.display = "none";
    chartSection.style.display = "block";
    glow(backBtn);
  });

  /* -------------------------
       発光アニメーション
  ------------------------- */
  function glow(btn) {
    document.querySelectorAll(".ctrl-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  }

  /* -------------------------
       全クラス使用状況を表示
  ------------------------- */
  const statusRef = ref(db, "rooms");

  onValue(statusRef, snapshot => {
    const data = snapshot.val() || {};
    const list = document.getElementById("roomStatus");
    list.innerHTML = "";

    const classList = [
      "kyoto-01","kyoto-02",
      "sendai-01","sendai-02",
      "nagoya-01","nagoya-02"
    ];

    classList.forEach(c=>{
      const active = data[c]?.activity?.status === "open";
      const div = document.createElement("div");
      div.style.color = active ? "#7fff7f" : "#ccc";
      div.textContent = `${active ? "●" : "○"} ${c}`;
      list.appendChild(div);
    });
  });

});
</script>

<style>
body {
  background: #1a1a1a;
  color: white;
  text-align: center;
  font-family: "Segoe UI", sans-serif;
}

h1 {
  color: #fff;
  margin-top: 12px;
  font-weight: 600;
}

#roomName {
  color: #99ffcc;
  font-size: 1.3rem;
  margin-bottom: 10px;
}

.controls {
  margin-top: 15px;
}

.ctrl-btn {
  padding: 10px 22px;
  margin: 6px;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  cursor: pointer;
  background: #333;
  color: #fff;
  transition: 0.2s;
}

.ctrl-btn:hover {
  background: #555;
}

.ctrl-btn.active {
  background: #007777;
  box-shadow: 0 0 10px #33ffee;
}

#qr-section {
  display: none;
  flex-direction: column;
  align-items: center;
  margin-top: 20px;
}

#qrcode {
  margin: 20px;
}

#chart-section {
  margin-top: 25px;
}

#roomStatus {
  margin-top: 12px;
  font-size: 15px;
  line-height: 1.7;
}
</style>

</head>

<body>

<h1>教員コントロールパネル</h1>
<div id="roomName"></div>

<!-- クラス使用状況 -->
<div id="roomStatus"></div>

<!-- 操作ボタン -->
<div class="controls">
  <button id="unlock" class="ctrl-btn">回答開始</button>
  <button id="lock" class="ctrl-btn">回答終了</button>
  <button id="reset" class="ctrl-btn">集計リセット</button>
  <button id="showQR" class="ctrl-btn">QRコード</button>
  <button id="backBtn" class="ctrl-btn">グラフへ戻る</button>
</div>

<!-- グラフ表示 -->
<div id="chart-section">
  <canvas id="resultChart" width="240" height="240"></canvas>
</div>

<!-- QRコード -->
<div id="qr-section">
  <h2>学生アクセス用 QRコード</h2>
  <div id="qrcode"></div>
  <p><a id="qrLink" target="_blank" style="color:#9ff;"></a></p>
</div>

</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>教員用コントロールページ</title>

<link rel="stylesheet" href="style.css">

<!-- Chart.js & QRCode.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- ぽよん音 -->
<audio id="poyon" src="poyon.mp3" preload="auto"></audio>

<script type="module">
import { db, ref, set, onValue, update, getRoom } from "./common.js";

document.addEventListener("DOMContentLoaded", () => {

  /* -------------------------
       現在のクラスを取得
  ------------------------- */
  const room = getRoom();
  document.getElementById("roomName").textContent = room;

  /* -------------------------
       Firebase 参照
  ------------------------- */
  const activityRef = ref(db, `rooms/${room}/activity`);
  const resultRef   = ref(db, `rooms/${room}/result`);
  const answersRef  = ref(db, `rooms/${room}/answers`);

  /* -------------------------
       要素取得
  ------------------------- */
  const unlockBtn = document.getElementById("unlock");
  const lockBtn   = document.getElementById("lock");
  const resetBtn  = document.getElementById("reset");
  const showQRBtn = document.getElementById("showQR");
  const backBtn   = document.getElementById("backBtn");

  const qrSection = document.getElementById("qr-section");
  const chartSection = document.getElementById("chart-section");

  const poyon = document.getElementById("poyon");
  poyon.volume = 0.6;

  /* -------------------------
       グラフ初期化
  ------------------------- */
  const ctx = document.getElementById("resultChart").getContext("2d");

  let prevO = 0;
  let prevX = 0;

  let chart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["○", "×"],
      datasets: [{
        data: [0, 0],
        backgroundColor: ["#4caf50", "#f44336"],
        borderWidth: 0
      }]
    },
    options: {
      plugins: {
        legend: { display: true, position: "bottom" }
      },
      cutout: "60%"
    }
  });

  /* -------------------------
       集計のリアルタイム反映
  ------------------------- */
  onValue(resultRef, snapshot => {
    const v = snapshot.val() || { O: 0, X: 0 };
    chart.data.datasets[0].data = [v.O || 0, v.X || 0];
    chart.update();

    // ぽよん♪音
    if (v.O > prevO || v.X > prevX) {
      try {
        poyon.currentTime = 0;
        poyon.play();
      } catch (e) {}
    }

    prevO = v.O || 0;
    prevX = v.X || 0;
  });

  /* -------------------------
       回答開始（リセット込み）
  ------------------------- */
  unlockBtn.addEventListener("click", async () => {
    await set(answersRef, {});
    await set(resultRef, { O: 0, X: 0 });
    await set(activityRef, { status: "open" });

    glow(unlockBtn);
    alert("回答を開始しました（集計リセット済み）");
  });

  /* -------------------------
       回答終了
  ------------------------- */
  lockBtn.addEventListener("click", () => {
    set(activityRef, { status: "closed" });
    glow(lockBtn);
  });

  /* -------------------------
       集計リセットのみ
  ------------------------- */
  resetBtn.addEventListener("click", () => {
    set(resultRef, { O: 0, X: 0 });
    set(answersRef, {});
    glow(resetBtn);
    alert("集計をリセットしました");
  });

  /* -------------------------
       QRコード生成
  ------------------------- */
  showQRBtn.addEventListener("click", () => {
    chartSection.style.display = "none";
    qrSection.style.display = "flex";
    glow(showQRBtn);

    const link = `https://qzp04374-code.github.io/quiz-app/student.html?room=${room}`;
    document.getElementById("qrLink").href = link;
    document.getElementById("qrLink").textContent = link;

    const qrDiv = document.getElementById("qrcode");
    qrDiv.innerHTML = ""; // 毎回クリア

    new QRCode(qrDiv, {
      text: link,
      width: 220,
      height: 220
    });
  });

  /* -------------------------
       グラフへ戻る
  ------------------------- */
  backBtn.addEventListener("click", () => {
    qrSection.style.display = "none";
    chartSection.style.display = "block";
    glow(backBtn);
  });

  /* -------------------------
       発光アニメーション
  ------------------------- */
  function glow(btn) {
    document.querySelectorAll(".ctrl-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  }

  /* -------------------------
       全クラス使用状況を表示
  ------------------------- */
  const statusRef = ref(db, "rooms");

  onValue(statusRef, snapshot => {
    const data = snapshot.val() || {};
    const list = document.getElementById("roomStatus");
    list.innerHTML = "";

    const classList = [
      "kyoto-01","kyoto-02",
      "sendai-01","sendai-02",
      "nagoya-01","nagoya-02"
    ];

    classList.forEach(c=>{
      const active = data[c]?.activity?.status === "open";
      const div = document.createElement("div");
      div.style.color = active ? "#7fff7f" : "#ccc";
      div.textContent = `${active ? "●" : "○"} ${c}`;
      list.appendChild(div);
    });
  });

});
</script>

<style>
body {
  background: #1a1a1a;
  color: white;
  text-align: center;
  font-family: "Segoe UI", sans-serif;
}

h1 {
  color: #fff;
  margin-top: 12px;
  font-weight: 600;
}

#roomName {
  color: #99ffcc;
  font-size: 1.3rem;
  margin-bottom: 10px;
}

.controls {
  margin-top: 15px;
}

.ctrl-btn {
  padding: 10px 22px;
  margin: 6px;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  cursor: pointer;
  background: #333;
  color: #fff;
  transition: 0.2s;
}

.ctrl-btn:hover {
  background: #555;
}

.ctrl-btn.active {
  background: #007777;
  box-shadow: 0 0 10px #33ffee;
}

#qr-section {
  display: none;
  flex-direction: column;
  align-items: center;
  margin-top: 20px;
}

#qrcode {
  margin: 20px;
}

#chart-section {
  margin-top: 25px;
}

#roomStatus {
  margin-top: 12px;
  font-size: 15px;
  line-height: 1.7;
}
</style>

</head>

<body>

<h1>教員コントロールパネル</h1>
<div id="roomName"></div>

<!-- クラス使用状況 -->
<div id="roomStatus"></div>

<!-- 操作ボタン -->
<div class="controls">
  <button id="unlock" class="ctrl-btn">回答開始</button>
  <button id="lock" class="ctrl-btn">回答終了</button>
  <button id="reset" class="ctrl-btn">集計リセット</button>
  <button id="showQR" class="ctrl-btn">QRコード</button>
  <button id="backBtn" class="ctrl-btn">グラフへ戻る</button>
</div>

<!-- グラフ表示 -->
<div id="chart-section">
  <canvas id="resultChart" width="240" height="240"></canvas>
</div>

<!-- QRコード -->
<div id="qr-section">
  <h2>学生アクセス用 QRコード</h2>
  <div id="qrcode"></div>
  <p><a id="qrLink" target="_blank" style="color:#9ff;"></a></p>
</div>

</body>
</html>