<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>教員用コントロールページ</title>
<link rel="stylesheet" href="style.css">

<!-- Chart.js & QRCode.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- Firebase Modules -->
<script type="module">
import { db, ref, set, onValue } from "./common.js";

document.addEventListener("DOMContentLoaded", () => {

  /* ------------------------------
     1) DOM参照
  ------------------------------ */
  const classSelect = document.getElementById("class-select");
  const unlockBtn = document.getElementById("unlock");
  const lockBtn = document.getElementById("lock");
  const resetBtn = document.getElementById("reset");
  const showQRBtn = document.getElementById("showQR");
  const backBtn = document.getElementById("backBtn");

  const chartSection = document.getElementById("chart-section");
  const qrSection = document.getElementById("qr-section");
  const qrBox = document.getElementById("qrcode");

  const ctx = document.getElementById("resultChart").getContext("2d");

  let currentRoom = null;


  /* ------------------------------
     2) グラフ初期化
  ------------------------------ */
  let chart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["○", "×"],
      datasets: [{
        data: [0, 0],
        backgroundColor: ["#4caf50", "#f44336"],
        borderWidth: 0
      }]
    },
    options: {
      plugins: {
        legend: { display: true, position: "bottom" }
      },
      cutout: "65%"
    }
  });


  /* ------------------------------
     3) クラス選択
  ------------------------------ */
  classSelect.addEventListener("change", () => {
    currentRoom = classSelect.value;
    console.log("【選択中のルーム】", currentRoom);

    if (!currentRoom) return;

    // リアルタイムで result 更新
    const roomResultRef = ref(db, `rooms/${currentRoom}/result`);
    onValue(roomResultRef, (snapshot) => {
      const data = snapshot.val() || { O: 0, X: 0 };
      chart.data.datasets[0].data = [data.O || 0, data.X || 0];
      chart.update();
    });
  });


  /* ------------------------------
     4) 回答開始（リセット + 開始）
  ------------------------------ */
  unlockBtn.addEventListener("click", async () => {
    if (!currentRoom) {
      alert("クラスを選択してください");
      return;
    }

    const roomActivityRef = ref(db, `rooms/${currentRoom}/activity`);
    const roomResultRef = ref(db, `rooms/${currentRoom}/result`);
    const roomAnswersRef = ref(db, `rooms/${currentRoom}/answers`);

    await set(roomAnswersRef, {});          // 回答者リセット
    await set(roomResultRef, { O: 0, X: 0 }); // 集計リセット
    await set(roomActivityRef, { status: "open" });

    glow(unlockBtn);
    alert(`「${currentRoom}」の回答を開始しました`);
  });


  /* ------------------------------
     5) 回答終了
  ------------------------------ */
  lockBtn.addEventListener("click", async () => {
    if (!currentRoom) return;

    const roomActivityRef = ref(db, `rooms/${currentRoom}/activity`);
    await set(roomActivityRef, { status: "closed" });

    glow(lockBtn);
  });


  /* ------------------------------
     6) 集計リセット
  ------------------------------ */
  resetBtn.addEventListener("click", async () => {
    if (!currentRoom) return;

    const roomResultRef = ref(db, `rooms/${currentRoom}/result`);
    const roomAnswersRef = ref(db, `rooms/${currentRoom}/answers`);

    await set(roomResultRef, { O: 0, X: 0 });
    await set(roomAnswersRef, {});

    glow(resetBtn);
    alert(`「${currentRoom}」の集計をリセットしました`);
  });


  /* ------------------------------
     7) QRコード表示
  ------------------------------ */
  showQRBtn.addEventListener("click", () => {
    if (!currentRoom) {
      alert("クラスを選択してください");
      return;
    }

    chartSection.style.display = "none";
    qrSection.style.display = "flex";
    glow(showQRBtn);

    qrBox.innerHTML = ""; // QR 再生成

    new QRCode(qrBox, {
      text: `https://qzp04374-code.github.io/quiz-app/student.html?room=${currentRoom}`,
      width: 220,
      height: 220
    });
  });


  /* ------------------------------
     8) グラフに戻る
  ------------------------------ */
  backBtn.addEventListener("click", () => {
    qrSection.style.display = "none";
    chartSection.style.display = "block";
    glow(backBtn);
  });


  /* ------------------------------
     9) ボタン発光エフェクト
  ------------------------------ */
  function glow(btn) {
    document.querySelectorAll("button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  }

});
</script>

</head>

<body>

  <h1>クイズ コントロールパネル</h1>

  <!-- クラス選択 -->
  <div class="controls">
    <select id="class-select">
      <option value="">▼ クラスを選択</option>
      <option value="kyoto-01">kyoto-01</option>
      <option value="kyoto-02">kyoto-02</option>
      <option value="sendai-01">sendai-01</option>
      <option value="sendai-02">sendai-02</option>
      <option value="nagoya-01">nagoya-01</option>
      <option value="nagoya-02">nagoya-02</option>
    </select>

    <button id="unlock">回答開始</button>
    <button id="lock">回答終了</button>
    <button id="reset">集計リセット</button>
    <button id="showQR">QRコード表示</button>
    <button id="backBtn">グラフに戻る</button>
  </div>

  <!-- グラフ -->
  <div id="chart-section">
    <canvas id="resultChart" width="250" height="250"></canvas>
  </div>

  <!-- QR -->
  <div id="qr-section" style="display:none;">
    <h2>学生アクセス用 QRコード</h2>
    <div id="qrcode"></div>
  </div>

</body>
</html>

