<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClassSync Display</title>

  <style>
    :root{
      --bg:#050608;
      --panel:rgba(17,24,39,.55);
      --line:rgba(255,255,255,.10);
      --ink:#f9fafb;
      --muted:#cbd5e1;

      /* è‰²å¯¾å¿œï¼šæ­£æœ¬ï¼ˆindex/studentã¨ä¸€è‡´ï¼‰ */
      --color-o:#34c759;
      --color-x:#ff3b30;
      --color-a:#0a84ff;
      --color-b:#30d158;
      --color-c:#ff9f0a;
      --color-d:#bf5af2;
      --color-e:#ff375f;

      /* è¿½åŠ ï¼šé¸æŠè‚¢ã®è©°ã¾ã‚Šå…·åˆï¼ˆJSãŒ em / æ•°å€¤ã§æ›´æ–°ï¼‰ */
      --choicesGap: 0.34em; /* è¡Œã¨è¡Œã®éš™é–“ */
      --cLH: 1.12;          /* è¡Œé–“ï¼ˆå°ã•ã„å­—ã»ã© JS ã§ 1.06 ä»˜è¿‘ã¾ã§ä¸‹ãŒã‚‹ï¼‰ */
      --cGap: 0.50em;       /* ãƒãƒƒã‚¸ã¨æœ¬æ–‡ã®é–“ */
      --cPadY: 0.44em;      /* è¡Œã®ä¸Šä¸‹ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
      --cPadX: 0.70em;      /* è¡Œã®å·¦å³ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */

      --ok:#22c55e;
       /* displayå´ã§èª¿æ•´ã™ã‚‹è¡¨ç¤ºå¤‰æ•°ï¼ˆpxç›¸å½“ï¼‰ */
      --qMax: 68;     /* å•é¡Œæ–‡ã®æœ€å¤§ */
      --cMin: 26;     /* é¸æŠè‚¢æ–‡å­— æœ€å° */
      --cMax: 46;     /* é¸æŠè‚¢æ–‡å­— æœ€å¤§ */
}

    body{
      margin:0;
      min-height:100vh;
      background:var(--bg);
      color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
      overflow:hidden;
    }

    #buildTag{
      position:fixed; right:12px; bottom:10px;
      opacity:.55; font-size:12px; z-index:9999;
      background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.08);
      padding:6px 10px; border-radius:999px;
      backdrop-filter: blur(8px);
    }

    /* pollãƒ¢ãƒ¼ãƒ‰ï¼šå·¦ã‚’æ¶ˆã—ã¦é›†è¨ˆå…¨å¹… */
    body.poll #leftPanel{ display:none !important; }
    body.poll .grid{ grid-template-columns: 1fr !important; }
    body.poll.closed .grid{ grid-template-columns: 1fr !important; }

    /* textãƒ¢ãƒ¼ãƒ‰ï¼šå³å´ã‚’ï¼ˆäººæ•°ãƒãƒ¼ï¼‹ä¸€è¦§ï¼‰ã«æœ€é©åŒ– */
    /* ===========================
       TEXTãƒ¢ãƒ¼ãƒ‰ï¼šä¸Šæ®µï¼å•é¡Œ+ä»¶æ•° / ä¸‹æ®µï¼TEXTä¸€è¦§(å…¨å¹…)
       â€» #textAnswersBox ã‚’ .grid ç›´ä¸‹ã«ç§»å‹•ã—ãŸå‰æ
    =========================== */
    
    /* textå›ç­”ä¸€è¦§ã¯â€œ2æ®µç›®ã§å…¨å¹…â€ã«ã™ã‚‹ */
    #textAnswersBox{
      grid-column: 1 / -1;     /* å…¨åˆ—ã«ã¾ãŸãŒã‚‹ */
    }
    
    /* TEXTãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ grid ã‚’2æ®µã«ï¼šä¸Š(å•é¡Œ+ä»¶æ•°) / ä¸‹(TEXTä¸€è¦§) */
    body.textmode .grid{
      grid-template-rows: minmax(170px, 28vh) 1fr;
    }
    
    /* ä¸Šæ®µï¼ˆå·¦/å³ï¼‰ã‚’å°‘ã—ç· ã‚ã‚‹ï¼šå³ã¯ä»¶æ•°ãƒãƒ¼ä¸­å¿ƒ */
    body.textmode #vchartWrap{
      flex: 0 0 auto;
      height: 92px;
    }
    body.textmode #vchart{
      align-items:center;
      justify-content:flex-start;
      padding: 10px 12px;
    }
    
    /* ä¸‹æ®µï¼ˆTEXTä¸€è¦§ï¼‰ã¯æ®‹ã‚Šå…¨éƒ¨ã‚’ä½¿ã£ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    body.textmode #textAnswersBox{
      max-height: none !important;  /* 38vhåˆ¶é™ã‚’è§£é™¤ */
      overflow: auto;
      min-height: 0;
    }
    
    /* ç”»é¢ãŒåºƒã„ã¨ãã¯2ã‚«ãƒ©ãƒ ã§â€œèª­ã¿ã‚„ã™ãâ€ */
    @media (min-width: 1100px){
      
      /* âœ… TEXTå›ç­”ï¼šæ®µçµ„ã¿ã‚’ã‚„ã‚ã¦ã€Œ1æ®µï¼ˆ1ã‚«ãƒ©ãƒ ï¼‰ã€ã«å›ºå®š */
      body.textmode #textAnswersList{
        column-count: 1;
        column-gap: 0;
      }
      body.textmode .textItem{
        break-inside: auto; /* 2ã‚«ãƒ©ãƒ ç”¨ã®æŒ‡å®šã‚’ç„¡åŠ¹åŒ– */
      }

    }

    .wrap{
      height:100vh;
      display:flex;
      flex-direction:column;
      padding:16px 16px 14px;
      box-sizing:border-box;
      gap:10px;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:18px;
      background:var(--panel);
      border:1px solid var(--line);
      box-shadow:0 18px 50px rgba(0,0,0,.55);
    }
    .room{
      font-weight:900;
      letter-spacing:.08em;
      font-size:18px;
      white-space:nowrap;
    }
    .meta{
      color:var(--muted);
      font-size:14px;
      display:flex;
      gap:12px;
      align-items:center;
      white-space:nowrap;
    }
    .soundBtn{
      background:rgba(2,6,23,.6);
      border:1px solid rgba(255,255,255,.12);
      color:#f9fafb;
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      letter-spacing:.06em;
      cursor:pointer;
      user-select:none;
    }
    .soundBtn.on{
      border-color: rgba(34,197,94,.45);
      box-shadow:0 0 0 3px rgba(34,197,94,.15);
    }

    .grid{
      flex:1;
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:10px;
      min-height:0;
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:0 18px 50px rgba(0,0,0,.55);
      padding:14px 14px;
      box-sizing:border-box;
      min-height:0;
      overflow:hidden;
    }

    .secTitle{
      margin:0 0 6px 0;
      font-size:15px;
      letter-spacing:.10em;
      color:var(--muted);
      font-weight:800;
    }

    /* å·¦ï¼ˆæˆæ¥­ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰ */
    #leftPanel{ display:flex; flex-direction:column; gap:10px; min-height:0; }
    #leftScroll{ min-height:0; overflow:hidden; }

    /* âœ… æ›¸ãå•é¡Œ(textmode)ã¯ã€å…¥ã‚Šåˆ‡ã‚‰ãªã„åˆ†ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§èª­ã‚€ */
    body.textmode #leftScroll{
      overflow:auto;
      padding-right:8px;
    }
    /* è§£ç­”çµ‚äº†ï¼ˆclosedï¼‰æ™‚ã¯ã€å·¦å´ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã—ã¦é¸æŠè‚¢ãŒåˆ‡ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ */
    body.closed #leftScroll{
      overflow:auto;
      padding-right:8px; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ä½™ç™½ï¼ˆä»»æ„ï¼‰ */
    }

    #question{
      margin:0;
      font-size: clamp(30px, 4.2vw, calc(var(--qMax) * 1px));
      line-height:1.12;
      font-weight:900;
      letter-spacing:.02em;
      text-align:left;
      padding:0 2px;
    }
    
    /* å•é¡Œæ–‡ã®ç¸®å°ä¸‹é™ï¼ˆJSãŒã“ã“ã¾ã§ã—ã‹ä¸‹ã’ãªã„ï¼‰ */
    :root{
      --q-min-px: 20; /* å¥½ã¿ã§ 18ã€œ24 ãã‚‰ã„ */
    }

    #choices{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr;
      gap: var(--choicesGap);
    }
    /* ===== choices scroll safety ===== */
    #choices{
      overflow-y: auto;          /* âœ… ä¸‹ãŒåˆ‡ã‚ŒãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
      overscroll-behavior: contain;
      padding-right: 10px;       /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼åˆ† */
      max-height: 100%;
    }

    /* âœ… choices viewport: keep a stable window; overflow scroll handles overrun */
    #choices{
      height: min(52vh, 520px);   /* <- ã“ã“ã§â€œæ â€ã‚’å›ºå®šï¼ˆå¥½ã¿ã§èª¿æ•´ï¼‰ */
      min-height: 260px;
      max-height: min(52vh, 520px);
    }

    /* âœ… choices typography driven by cMin/cMax (no per-row height slider) */
    #choices{
      font-size: clamp(calc(var(--cMin) * 1px), 2.2vw, calc(var(--cMax) * 1px));
    }
    .choice{
      display:flex;
      align-items:flex-start;
    
      /* pxå›ºå®šã‚’ã‚„ã‚ã¦ â€œæ–‡å­—ã‚µã‚¤ã‚ºé€£å‹•â€ ã«ã™ã‚‹ */
      gap: var(--cGap);
      padding: var(--cPadY) var(--cPadX);
    
      border-radius: 14px;
      border: none;
      background: rgba(2,6,23,.22);
    
      /* è¡Œé–“ã‚‚é€£å‹•ï¼ˆå¥½ã¿ã§ 1.12ã€œ1.30ï¼‰ */
      line-height: var(--cLH);
    
      word-break: break-word;
    }
    .choice.correct{
      box-shadow: 0 0 0 3px rgba(34,197,94,22);
    }
    .choice > div:last-child{
      flex:1;
      white-space: pre-wrap;             /* æ”¹è¡Œã¯ä¿æŒã€ãŸã ã—ãƒãƒƒã‚¸å¾Œã®å¼·åˆ¶æ”¹è¡Œã¯èµ·ã“ã•ãªã„ */
      min-width: 0;
    }
/* scrollbarï¼ˆæ§ãˆã‚ï¼‰ */
    #choices::-webkit-scrollbar{
      width: 10px;
    }
    #choices::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.25);
      border-radius: 6px;
    }

    .badge{
      /* æ–‡å­—ã‚µã‚¤ã‚ºã«å¯¾ã—ã¦æ¯”ç‡ã§æ±ºã‚ã‚‹ï¼ˆ= cMax ã‚’å‹•ã‹ã™ã¨å…¨éƒ¨å‹•ãï¼‰ */
      height: 1.65em;         /* è¡Œé–“ï¼ˆç¸¦ï¼‰ãŒåºƒãŒã‚‹/ç‹­ã¾ã‚‹ */
      min-width: 2.35em;      /* æ¨ªå¹…ã‚‚è¿½éš */
      padding: 0 0.55em;      /* ä½™ç™½ã‚‚è¿½éš */
    
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    
      font-weight: 1000;
      letter-spacing: .06em;
    
      /* ãƒãƒƒã‚¸æ–‡å­—ã‚‚æœ¬æ–‡ã«é€£å‹•ï¼ˆå°‘ã—å°ã•ã‚ã«ã—ãŸã‘ã‚Œã° 0.90ã€œ0.98ï¼‰ */
      font-size: 0.98em;
    
      color:#0b1220;
      margin-top: 0.05em;     /* ã¡ã‚‡ã„ã ã‘ä¸‹ã’ã‚‹ï¼ˆä»»æ„ï¼‰ */
      flex: 0 0 auto;
    }
    .badge.A{background:var(--color-a);}
    .badge.B{background:var(--color-b);}
    .badge.C{background:var(--color-c);}
    .badge.D{background:var(--color-d); color:#fff;}
    .badge.E{background:var(--color-e); color:#fff;}
    .badge.O{background:var(--color-o);}
    .badge.X{background:var(--color-x); color:#fff;}

    .choice.correct{
      border:2px solid rgba(34,197,94,.85);
      box-shadow:0 0 0 3px rgba(34,197,94,.15);
    }
    @keyframes pulseGreen {
      0%   { box-shadow:0 0 0 0 rgba(34,197,94,.55); }
      70%  { box-shadow:0 0 0 14px rgba(34,197,94,0); }
      100% { box-shadow:0 0 0 0 rgba(34,197,94,0); }
    }
    body.closed .choice.correct{ animation:pulseGreen 1.3s infinite; }

    /* è§£èª¬ */
    #answerBox{
      display:none;
      margin-top:10px;
      padding:14px 14px;
      border-radius:18px;
      background:rgba(2,6,23,.78);
      border:1px solid rgba(34,197,94,.45);
    }
    #answerBox.show{ display:block; }
    #answerLine{
      font-size:clamp(26px, 3.2vw, 34px);
      font-weight:1000;
      color:var(--ok);
      margin:0 0 8px 0;
      letter-spacing:.04em;
    }
    #explanationLine{
      margin:0;
      font-size:clamp(18px, 2.5vw, 26px);
      line-height:1.40;
      color:#e5e7eb;
      white-space:pre-wrap;
    }

    /* å³ï¼šé›†è¨ˆï¼ˆç¸¦æ£’ï¼‰ */
    #rightPanel{ display:flex; flex-direction:column; gap:10px; min-height:0; }
    #vchartWrap{
      flex:1;
      min-height:0;
      border-radius:18px;
      background:rgba(2,6,23,.55);
      border:1px solid rgba(255,255,255,.08);
      padding:12px 10px 8px;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    #vchart{
      flex:1;
      display:flex;
      align-items:flex-end;
      justify-content:space-around;
      gap:12px;
      padding:6px 6px 2px;
      box-sizing:border-box;
      min-height:0;
    }
    .col{
      width:100%;
      max-width:84px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-end;
      gap:6px;
    }
    .count{
      font-size:14px;
      font-weight:1000;
      color:#e5e7eb;
      line-height:1.1;
      min-height:20px;
      text-align:center;
      white-space:nowrap;
    }
    .bar{
      width:100%;
      border-radius:12px 12px 6px 6px;
      background:rgba(255,255,255,.12);
      position:relative;
      overflow:hidden;
      height:12px;
      transition:height .2s ease;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
    }
    .barFill{ position:absolute; inset:0; opacity:.95; }
    .lab{
      font-size:16px;
      font-weight:1000;
      color:var(--muted);
      letter-spacing:.08em;
    }

    /* textå›ç­”ä¸€è¦§ */
    #textAnswersBox{
      display:none;
      border-radius:18px;
      background:rgba(2,6,23,.55);
      border:1px solid rgba(255,255,255,.08);
      padding:12px 12px;
      box-sizing:border-box;
      max-height:38vh;
      overflow:auto;
      min-height:0;
    }
    #textAnswersBox.show{ display:block; }
    #textAnswersTitle{
      font-weight:1000;
      letter-spacing:.08em;
      color:rgba(203,213,225,.92);
      margin:0 0 8px 0;
      font-size:13px;
    }
    /* âœ… TEXTå›ç­”ã‚’â€œã‚‚ã£ã¨å¤§ãã„å­—â€ã«ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚¿å‘ã‘ï¼‰ */
    .textItem{
      font-size:clamp(22px, 2.6vw, 32px);
      line-height:1.45;
      margin-bottom:10px; /* å°‘ã—è¦‹ã‚„ã™ã */
    }
    .textItem .no{
      min-width:52px; /* ç•ªå·ã®æ¡ã‚ºãƒ¬é˜²æ­¢ï¼ˆãŠå¥½ã¿ï¼‰ */
      font-size:0.95em;
    }

    .textItem .no{
      display:inline-block;
      min-width:44px;
      margin-right:8px;
      color:rgba(203,213,225,.85);
      font-weight:1000;
      letter-spacing:.06em;
    }

    /* QR */
    #qrLayer{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.92);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:999;
      opacity:1;
      transition:opacity .45s ease;
    }
    #qrLayer.hidden{ opacity:0; pointer-events:none; }
    .qrBox{
      width:min(920px, 94vw);
      border-radius:28px;
      padding:20px 20px 14px;
      background:var(--panel);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 24px 80px rgba(0,0,0,.75);
      text-align:center;
    }
    .qrTitle{
      margin:0 0 6px 0;
      font-size:22px;
      letter-spacing:.10em;
      font-weight:1000;
    }
    .qrHint{
      margin:0 0 10px 0;
      color:var(--muted);
      font-size:16px;
    }
    #qrcode{
      display:flex;
      justify-content:center;
      align-items:center;
      margin:8px 0 8px;
    }
    #qrcode canvas{
  width:520px !important;
  height:520px !important;
  border-radius:18px;
  background:#fff;
  padding:10px;
  box-sizing:border-box;
  image-rendering: pixelated; /* ä¸€éƒ¨ç’°å¢ƒã§åŠ¹ã */
}
@media (max-width: 820px){
  #qrcode canvas{
    width: min(520px, 86vw) !important;
    height: min(520px, 86vw) !important;
  }
}

    #qrCount{ margin-top:6px; color:rgba(203,213,225,.9); font-size:14px; }

    #toast{
      position:fixed;
      left:50%;
      top:16px;
      transform:translateX(-50%);
      background:rgba(17,24,39,.92);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 14px;
      border-radius:999px;
      color:#f9fafb;
      font-weight:1000;
      letter-spacing:.06em;
      z-index:1200;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease;
      box-shadow:0 18px 50px rgba(0,0,0,.55);
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      #leftScroll{ overflow:auto; }
      body.poll #leftPanel{ display:none !important; }
    }

    /* =========================
       Timer Progress Bar
       ========================= */
    #timerBarWrap{
      width: 180px;              /* ãƒãƒ¼ã®æ¨ªå¹…ï¼ˆå¥½ã¿ã§èª¿æ•´ï¼‰ */
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
      overflow: hidden;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    }

    #timerBar{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      transform-origin: left;
      transition: width .15s linear;
      background: linear-gradient(90deg,
        rgba(34,197,94,.95),   /* green */
        rgba(245,158,11,.95),  /* amber */
        rgba(239,68,68,.95)    /* red */
      );
      box-shadow: 0 10px 28px rgba(0,0,0,.28);
    }

    /* ã‚¿ã‚¤ãƒãƒ¼å‹•ä½œä¸­ã¯æ•°å­—ã‚’å°‘ã—å¼·èª¿ */
    body.timer-running #timerLabel{
      color:#fff;
      text-shadow: 0 0 16px rgba(255,255,255,.18);
    }

    /* æ®‹ã‚Šã‚ãšã‹ã®æ³¨æ„å–šèµ·ï¼ˆä»»æ„ï¼šã‚ã¨ã§ONã«ã§ãã‚‹ï¼‰ */
    body.timer-urgent #timerBar{
      animation: timerPulse .7s infinite;
    }
    @keyframes timerPulse{
      0%   { filter: brightness(1.0); }
      50%  { filter: brightness(1.35); }
      100% { filter: brightness(1.0); }
    }

  /* =========================
   éå…¬é–‹ãƒã‚¹ã‚¯ï¼šMEDIUMæ¼”å‡º
   ========================= */
#vchartWrap{ position:relative; }

.resultsMask{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  border-radius:18px;
  overflow:hidden;

  background: rgba(2,6,23,.92);
  backdrop-filter: blur(18px) brightness(.65) saturate(1.00);

  opacity:0;
  pointer-events:none;
  transition: opacity .18s ease;
}
.resultsMask.show{ opacity:1; pointer-events:auto; }

/* èƒŒæ™¯æ¼”å‡ºï¼ˆã‚ªãƒ¼ãƒ­ãƒ©ï¼‰ */
.maskFx{
  position:absolute; inset:-20%;
  z-index:0;
  pointer-events:none;
  opacity:.42;
  filter: blur(16px);
  animation: hueShift 10s linear infinite;
}
@keyframes hueShift{
  0%   { filter: blur(18px) hue-rotate(0deg); }
  100% { filter: blur(18px) hue-rotate(18deg); }
}

.maskFx .blob{
  position:absolute;
  width: 44vmax; height: 44vmax;
  border-radius: 999px;
  mix-blend-mode: screen;
  opacity:.22;
  will-change: transform;
}
.maskFx .b1{
  left: -12%; top: 10%;
  background: radial-gradient(circle at 30% 30%,
    rgba(10,132,255,.85), rgba(10,132,255,0) 60%);
  animation: blobFloat1 7.2s ease-in-out infinite;
}
.maskFx .b2{
  right: -14%; top: 18%;
  background: radial-gradient(circle at 30% 30%,
    rgba(48,209,88,.82), rgba(48,209,88,0) 60%);
  animation: blobFloat2 8.2s ease-in-out infinite;
}
.maskFx .b3{
  left: 10%; bottom: -18%;
  background: radial-gradient(circle at 30% 30%,
    rgba(191,90,242,.78), rgba(191,90,242,0) 62%);
  animation: blobFloat3 9.0s ease-in-out infinite;
}
@keyframes blobFloat1{
  0%,100%{ transform: translate(-2%, 0%) scale(1.00); }
  50%    { transform: translate(8%, 6%)  scale(1.08); }
}
@keyframes blobFloat2{
  0%,100%{ transform: translate(0%, 0%)  scale(1.00); }
  50%    { transform: translate(-10%, 8%) scale(1.07); }
}
@keyframes blobFloat3{
  0%,100%{ transform: translate(0%, 0%)  scale(1.00); }
  50%    { transform: translate(6%, -10%) scale(1.10); }
}

/* æ–œã‚ã«èµ°ã‚‹ã‚·ãƒãƒ¼ï¼ˆå…‰ã®ç­‹ï¼‰ */
.maskFx .sheen{
  position:absolute;
  left:-60%;
  top:-20%;
  width:50%;
  height:160%;
  transform: rotate(20deg);
  background: linear-gradient(90deg,
    rgba(255,255,255,0),
    rgba(255,255,255,.22),
    rgba(255,255,255,0)
  );
  opacity:.10;
  animation: sheenMove 2.4s ease-in-out infinite;
}
@keyframes sheenMove{
  0%   { transform: translateX(0) rotate(20deg); }
  100% { transform: translateX(260%) rotate(20deg); }
}

/* ã‚¹ã‚­ãƒ£ãƒ³ãƒ©ã‚¤ãƒ³ï¼ˆå°‘ã—ã ã‘å¼·ã‚ï¼‰ */
.resultsMask::before{
  content:"";
  position:absolute; inset:-35% 0;
  background: linear-gradient(180deg,
    rgba(255,255,255,0) 0%,
    rgba(255,255,255,.10) 45%,
    rgba(255,255,255,0) 75%);
  animation: scan 2.4s linear infinite;
  opacity:.34;
  z-index:1;
}
@keyframes scan{
  0%   { transform: translateY(-30%); }
  100% { transform: translateY(35%); }
}

/* å¾®ãƒã‚¤ã‚ºï¼ˆã»ã‚“ã®ã‚Šå‹•ãï¼‰ */
.resultsMask::after{
  content:"";
  position:absolute; inset:0;
  background-image:
    repeating-linear-gradient(
      0deg,
      rgba(255,255,255,.04) 0px,
      rgba(255,255,255,.04) 1px,
      rgba(255,255,255,0) 2px,
      rgba(255,255,255,0) 5px
    );
  opacity:.12;
  mix-blend-mode: overlay;
  animation: noiseDrift .9s steps(2) infinite;
  z-index:2;
}
@keyframes noiseDrift{
  0%   { transform: translate(0,0); }
  100% { transform: translate(-10px, 8px); }
}

/* å‰é¢ã‚«ãƒ¼ãƒ‰ */
.maskInner{
  position:relative;
  z-index:3;
  text-align:center;
  padding:18px 16px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(17,24,39,.56);
  box-shadow:
    0 26px 86px rgba(0,0,0,.58),
    0 0 0 1px rgba(10,132,255,.10),
    0 0 44px rgba(10,132,255,.14);
  animation: innerPulse 2.6s ease-in-out infinite;
}
@keyframes innerPulse{
  0%,100%{ transform: translateY(0); filter: brightness(1.00); }
  50%    { transform: translateY(-2px); filter: brightness(1.06); }
}

.maskTitle{
  font-weight:1100;
  letter-spacing:.12em;
  font-size:22px;
  color:#fff;
  text-shadow: 0 0 18px rgba(255,255,255,.14);
}
.maskSub{
  margin-top:8px;
  font-weight:900;
  letter-spacing:.08em;
  color:rgba(203,213,225,.88);
  font-size:14px;
}

/* â€œã‚¦ãƒ‹â€¦â€ */
.uni{ display:flex; gap:8px; justify-content:center; margin-top:14px; }
.uni span{
  width:11px; height:11px; border-radius:999px;
  background:rgba(255,255,255,.75);
  box-shadow: 0 0 20px rgba(255,255,255,.22);
  animation: uni 0.85s infinite ease-in-out;
}
.uni span:nth-child(2){ animation-delay:.10s; opacity:.88; }
.uni span:nth-child(3){ animation-delay:.20s; opacity:.78; }
.uni span:nth-child(4){ animation-delay:.30s; opacity:.68; }
.uni span:nth-child(5){ animation-delay:.40s; opacity:.58; }
@keyframes uni{
  0%,100%{ transform: translateY(0) scale(.98); }
  50%    { transform: translateY(-7px) scale(1.12); }
}

/* å‹•ãã‚’æ­¢ã‚ãŸã„ç’°å¢ƒé…æ…® */
@media (prefers-reduced-motion: reduce){
  .maskFx, .maskFx .blob, .maskFx .sheen,
  .resultsMask::before, .resultsMask::after,
  .maskInner, .uni span{
    animation: none !important;
  }
}

/* ===== Display tuning panel (localStorage) ===== */
#tunePanel{
  position: fixed;
  right: 14px;
  top: 76px;
  width: 360px;
  max-width: calc(100vw - 28px);
  background: rgba(17,24,39,92);
  border: 1px solid rgba(255,255,255,14);
  border-radius: 18px;
  box-shadow: 0 22px 70px rgba(0,0,0,65);
  padding: 12px 12px;
  z-index: 1300;
  display: none;
  backdrop-filter: blur(10px);
}
#tunePanel.show{ display:block; }

.tpHead{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
.tpTitle{ font-weight:1000; letter-spacing:.06em; font-size:13px; color:rgba(226,232,240,95); }
.tpClose{
  border:1px solid rgba(255,255,255,18);
  background: rgba(2,6,23,45);
  color:#fff;
  border-radius: 999px;
  padding: 6px 10px;
  cursor:pointer;
  font-weight:900;
}
.tpRow{ margin-top:10px; display:grid; grid-template-columns: 1fr; gap:6px; }
.tpLab{ font-size:12px; color: rgba(203,213,225,90); font-weight:900; letter-spacing:.06em; }
.tpVal{ font-size:12px; color: rgba(203,213,225,90); font-weight:900; text-align:right; }
.tpRow input[type="range"]{ width:100%; }
.tpFoot{ margin-top:12px; display:flex; flex-wrap:wrap; gap:8px; }
.tpBtn{
  border:1px solid rgba(255,255,255,18);
  background: rgba(34,197,94,16);
  color:#fff;
  border-radius: 12px;
  padding: 8px 10px;
  cursor:pointer;
  font-weight:1000;
  letter-spacing:.04em;
}
.tpBtn.ghost{ background: rgba(2,6,23,35); }
.tpHint{ margin-top:10px; font-size:12px; color: rgba(203,213,225,85); line-height:1.35; }
    
  </style>
  <link rel="icon" href="data:,">
</head>

<body>
  <div id="buildTag">build: 2026-01-06 / tts-runid-stable</div>
  <div id="toast">è§£ç­”çµ‚äº† â†’ å…¬é–‹</div>

  <div id="qrLayer">
    <div class="qrBox">
      <div class="qrTitle">å‚åŠ ç”¨QRã‚³ãƒ¼ãƒ‰</div>
      <div class="qrHint">ã‚¹ãƒãƒ›ã§èª­ã¿å–ã£ã¦å‚åŠ </div>
      <div id="qrcode"></div>
      <div id="qrCount">å‚åŠ ä¸­ 0äºº</div>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div class="room" id="roomLabel">ROOM</div>
      <div class="meta">
        <span id="statusLabel">status: -</span>
        <span id="countLabel">å‚åŠ ä¸­ 0äºº</span>
        <span id="timerLabel" style="font-weight:1000;">â± --:--</span>

        <div id="timerBarWrap" aria-hidden="true">
          <div id="timerBar"></div>
        </div>
        
        <button id="soundBtn" class="soundBtn">ğŸ”ˆ éŸ³OFFï¼ˆã‚¿ãƒƒãƒ—ã§ONï¼‰</button>
        <button id="ttsBtn" class="soundBtn">ğŸ—£ èª­ã¿ä¸Šã’OFF</button>
        <button id="ttsSpeakBtn" class="soundBtn">ğŸ”˜ èª­ã‚€</button>
        <button id="tuneBtn" class="soundBtn">âš™ è¡¨ç¤ºèª¿æ•´</button>

      </div>
    </div>

    <div class="grid" id="mainGrid">
      <div class="panel" id="leftPanel">
        <div class="secTitle">å•é¡Œ</div>
        <div id="leftScroll">
          <p id="question">ï¼ˆå•é¡Œã‚’å¾…ã£ã¦ã„ã¾ã™â€¦ï¼‰</p>

          <div id="answerBox">
            <p id="answerLine"></p>
            <p id="explanationLine"></p>
          </div>

          <div id="choices"></div>
        </div>
      </div>

      <div class="panel" id="rightPanel">
        <div class="secTitle" id="rightTitle">é›†è¨ˆï¼ˆç¸¦æ£’ï¼‰</div>
        <div id="vchartWrap">
          <div id="vchart"></div>

          <!-- â˜…è¿½åŠ ï¼šæŠ•ç¥¨ä¸­ éå…¬é–‹ãƒã‚¹ã‚¯ï¼ˆMEDIUMæ¼”å‡ºï¼‰ -->
          <div id="resultsMask" class="resultsMask" aria-hidden="true">
            <div class="maskFx" aria-hidden="true">
              <span class="blob b1"></span>
              <span class="blob b2"></span>
              <span class="blob b3"></span>
              <span class="sheen"></span>
            </div>

            <div class="maskInner">
              <div class="maskTitle">æŠ•ç¥¨ä¸­â€¦</div>
              <div class="maskSub">çµæœã¯ã€Œè§£ç­”çµ‚äº†ã€ã§å…¬é–‹</div>

              <div class="uni" aria-hidden="true">
                <span></span><span></span><span></span><span></span><span></span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- â˜…ã“ã“ã«ç§»å‹•ï¼šTEXTå›ç­”ã‚’â€œå…¨å¹…ã®åºƒã„æ®µâ€ã§è¡¨ç¤º -->
      <div id="textAnswersBox">
        <div id="textAnswersTitle">æ–‡å­—å›ç­”ï¼ˆè§£ç­”çµ‚äº†ã§è¡¨ç¤ºï¼‰</div>
        <div id="textAnswersList"></div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update } from
      "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBke-wTU16skpbK8z80ddK04tE154dHERQ",
      authDomain: "satosan-41eac.firebaseapp.com",
      databaseURL: "https://satosan-41eac-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "satosan-41eac"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const url = new URL(location.href);
    const room = url.searchParams.get("room") || "kyoto-01";

    const roomLabel   = document.getElementById("roomLabel");
    const statusLabel = document.getElementById("statusLabel");
    const countLabel  = document.getElementById("countLabel");
    const timerLabel  = document.getElementById("timerLabel");
    const timerBar = document.getElementById("timerBar");
    
    const leftScroll = document.getElementById("leftScroll");
    const qEl = document.getElementById("question");
    const cEl = document.getElementById("choices");

    const answerBox = document.getElementById("answerBox");
    const answerLine = document.getElementById("answerLine");
    const explanationLine = document.getElementById("explanationLine");

    const vchart = document.getElementById("vchart");
    const rightTitle = document.getElementById("rightTitle");
    
    const resultsMask = document.getElementById("resultsMask");

    const textBox = document.getElementById("textAnswersBox");
    const textList = document.getElementById("textAnswersList");
    const textTitle = document.getElementById("textAnswersTitle");

    const qrLayer = document.getElementById("qrLayer");
    const qrDiv   = document.getElementById("qrcode");
    const qrCount = document.getElementById("qrCount");

    const toast  = document.getElementById("toast");

    /* =========================================================
   å›ºå®šãƒ¡ãƒ¢ï¼ˆå£Šã•ãªã„æœ€å„ªå…ˆäº‹é …ï¼‰
   - displayã¯ã€Œæ§‹é€ ï¼ˆactivity / questionï¼‰ã€ã§æç”»ã‚’æ±ºã‚ã‚‹
   - answersã¯UIæ§‹é€ ã‚’æ±ºã‚ãªã„ï¼ˆæ•°ãˆã‚‹ã ã‘ï¼æ­£è¦ã‚½ãƒ¼ã‚¹ã¯ rooms/{room}/answersï¼‰
   - quizï¼šé›†è¨ˆã®choiceé †ã¯ currentQuestion.choices ã‚’å„ªå…ˆï¼ˆå•é¡Œã¨é›†è¨ˆã®ä¸€è‡´ã‚’ä¿è¨¼ï¼‰
   - pollï¼šé›†è¨ˆã®choiceé †ã¯ activity.config.choicesï¼ˆãªã‘ã‚Œã° mode ã‹ã‚‰è£œå®Œï¼‰
   - view/mode/status ãŒå¤‰ã‚ã£ãŸã‚‰å¿…ãšå†æç”»ï¼ˆpoll TEXTã®closedè¡¨ç¤ºã‚‚å«ã‚€ï¼‰
   - pollã«å…¥ã£ãŸã‚‰ quizã®å•é¡Œè³¼èª­ã¯å¿…ãšè§£é™¤ï¼ˆunsubQï¼‰
   ========================================================= */

    // ===== Sound: poyon.mp3ï¼ˆåŒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰ =====
    const soundBtn = document.getElementById("soundBtn");
    const se = new Audio("./poyon.mp3");
    se.preload = "auto";
    se.volume = 0.6;

    // ===== SE: closed gongï¼ˆåŒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰=====
    const gong = new Audio("./gong.mp3"); // â€»ãƒ•ã‚¡ã‚¤ãƒ«åã¯ gong.mp3 æ¨å¥¨
    gong.preload = "auto";
    gong.volume = 0.8;

    // ===== SE: countdownï¼ˆåŒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰=====
    const cd = new Audio("./countdown.mp3");
    cd.preload = "auto";
    cd.volume = 0.7;

    let soundEnabled = false;
    let soundUnlocked = false;
    let lastAnswerTotal = 0;

    async function unlockSound(){
      if (soundUnlocked) return true;
      try{
        await se.play();
        se.pause();
        se.currentTime = 0;
        soundUnlocked = true;
        soundEnabled = true;
        soundBtn.classList.add("on");
        soundBtn.textContent = "ğŸ”Š éŸ³ON";
        return true;
      }catch(e){
        soundUnlocked = false;
        soundEnabled = false;
        soundBtn.classList.remove("on");
        soundBtn.textContent = "ğŸ”ˆ éŸ³OFFï¼ˆã‚¿ãƒƒãƒ—ã§ONï¼‰";
        return false;
      }
    }
    
    // â˜…è¿½åŠ ï¼šå‡ºé¡Œé–‹å§‹SEï¼ˆstart.mp3ï¼‰
    const startSe = new Audio("./start.mp3");
    startSe.preload = "auto";
    startSe.volume = 0.85;
    
    function playStart(){
      if (!soundEnabled || !soundUnlocked) return;
      try{
        startSe.currentTime = 0;
        startSe.play().catch(()=>{});
      }catch(_){}
    }

    soundBtn.onclick = async () => { await unlockSound(); };
    (function addOneShotUnlock(){
      const handler = async () => {
        await unlockSound();
        window.removeEventListener("pointerdown", handler, true);
        window.removeEventListener("keydown", handler, true);
      };
      window.addEventListener("pointerdown", handler, true);
      window.addEventListener("keydown", handler, true);
    })();

    function playPoyon(){
      if (!soundEnabled || !soundUnlocked) return;
      try{
        se.currentTime = 0;
        se.play().catch(()=>{});
      }catch(_){}
    }

    function playGong(){
      if (!soundEnabled || !soundUnlocked) return;
      try{
        gong.currentTime = 0;
        gong.play().catch(()=>{});
      }catch(_){}
    }

    function playCountdown(){
    if (!soundEnabled || !soundUnlocked) return;
    try{
      cd.currentTime = 0;
      cd.play().catch(()=>{});
    }catch(_){}
  }

    // ===== TTSï¼ˆWeb Speech APIï¼‰======
    const ttsBtn = document.getElementById("ttsBtn");
    const ttsSpeakBtn = document.getElementById("ttsSpeakBtn");

    let ttsEnabled = false;      // èª­ã¿ä¸Šã’æ©Ÿèƒ½ON/OFF
    let ttsUnlocked = false;     // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ¸ˆã¿æ‰±ã„ï¼ˆè‡ªå‹•èª­ã¿ä¸Šã’è¨±å¯ï¼‰
    let ttsSpeaking = false;     // é€£æ‰“é˜²æ­¢
    let ttsAutoSpokenKey = null; // åŒä¸€å‡ºé¡Œã§1å›ã ã‘
    let ttsRunId = 0; // â˜…è¿½åŠ ï¼šèª­ã¿ä¸Šã’ã®ä¸–ä»£IDï¼ˆå¤ã„å‡¦ç†ã‚’æ®ºã™ï¼‰
    // â˜…è¿½åŠ ï¼šopenå¾Œã«èª­ã¿ä¸Šã’é–‹å§‹ã™ã‚‹ã¾ã§ã®å¾…ã¡æ™‚é–“
    const OPEN_READ_DELAY_MS = 1000;
    let ttsOpenReadyAt = 0;          // Date.now()ã§æ¯”è¼ƒ
    let ttsOpenDelayTimer = null;    // setTimeoutä¿æŒ

    let ttsClosedKey = "";      // closedèª­ã¿ä¸Šã’ã®å¤šé‡é˜²æ­¢ï¼ˆqidã”ã¨ï¼‰
    let ttsReadClosed = true;   // å¿…è¦ãªã‚‰ON/OFF

    // ===== TTS DICT (dict/tts-dict.json) =====
    let TTS_DICT = [];        // ç”Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆJSONï¼‰
    let TTS_REPLACERS = [];   // ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¸ˆã¿ï¼ˆé–¢æ•°é…åˆ—ï¼‰

    async function loadTtsDict(){
      try{
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥äº‹æ•…å›é¿ï¼šæ¯å›ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«ï¼ˆé‹ç”¨ã«åˆã‚ã›ã¦å›ºå®švã§ã‚‚OKï¼‰
        const res = await fetch("./dict/tts-dict.json?v=" + Date.now());
        if (!res.ok) throw new Error("dict fetch failed: " + res.status);
        const data = await res.json();
        TTS_DICT = Array.isArray(data) ? data : [];
        TTS_REPLACERS = compileTtsDict(TTS_DICT);
        console.log("[TTS] dict loaded:", TTS_REPLACERS.length);
      }catch(e){
        console.warn("[TTS] dict load failed:", e);
        TTS_DICT = [];
        TTS_REPLACERS = [];
      }
    }

    function compileTtsDict(list){
      const out = [];

      const esc = (s) => String(s).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");

      for (const e of (list || [])){
        if (!e || !e.from) continue;
        const to = (e.to ?? "");
        const type = e.type || "text"; // â˜…è¿½åŠ ï¼štypeçœç•¥ã¯textæ‰±ã„

        if (type === "text"){
          const from = String(e.from);
          out.push((s) => s.split(from).join(to));
          continue;
        }

        if (type === "word"){
          const from = esc(e.from);
          const re = new RegExp("\\b" + from + "\\b", "g");
          out.push((s) => s.replace(re, to));
          continue;
        }

        if (type === "regex"){
        try{
            const re = new RegExp(String(e.from), e.flags || "g");
            out.push((s) => s.replace(re, to));
          }catch(err){
            console.warn("[TTS] bad regex entry:", e, err);
          }
          continue;
        }
      }
      return out;
    }

    function ttsNormalize(text){
      let s = String(text || "");

      // ã“ã“ã§æœ€ä½é™ã®èª­ã¿ä¸Šã’æ•´å½¢ï¼ˆå¿…è¦ãªã‚‰å¢—ã‚„ã™ï¼‰
      s = s.replace(/\s+/g, " ").trim();

      // è¾æ›¸é©ç”¨
      for (const fn of (TTS_REPLACERS || [])){
        try{ s = fn(s); }catch(_){}
      }
      return s;
    }

    // èµ·å‹•æ™‚ã«1å›ãƒ­ãƒ¼ãƒ‰ï¼ˆawaitã—ãªã„ï¼displayãŒæ­¢ã¾ã‚‰ãªã„ï¼‰
    loadTtsDict();

    // å‡ºé¡Œæ™‚ã®ã€Œç„¡éŸ³æ™‚é–“ã€è¨­å®šï¼ˆmsï¼‰
    // â€»ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›(mode=text)ã¯é¸æŠè‚¢ãŒãªã„ã®ã§ã€ã“ã“ã¯ä½¿ã‚ã‚Œã¾ã›ã‚“
    const TTS_GAP = {
      qToChoicesMs: 800,  // å•é¡Œâ†’é¸æŠè‚¢ã®é–“
      choiceGapMs: 450,   // é¸æŠè‚¢â†’é¸æŠè‚¢ã®é–“
      jingleDelayMs: 220, // ã‚¸ãƒ³ã‚°ãƒ«å¾Œã®é–“ï¼ˆçŸ­ã‚ï¼‰
    };

    // sleep
    const waitMs = (ms) => new Promise(r => setTimeout(r, ms));

    // ã€Œèª­ã¿ä¸Šã’å‰ã‚¸ãƒ³ã‚°ãƒ«ã€ï¼šæ—¢å­˜ã® poyon.mp3 ã‚’æµç”¨ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ ãªã—ï¼‰
    async function playTtsJingle(){
      // ã‚¸ãƒ³ã‚°ãƒ«è‡ªä½“ã¯ä»»æ„ï¼šéŸ³ONæ™‚ã ã‘é³´ã‚‹
      if (!soundEnabled || !soundUnlocked) return;
      try{
        const j = new Audio("./poyon.mp3");
        j.preload = "auto";
        j.volume = 0.45;
        j.currentTime = 0;
        j.play().catch(()=>{});
        await waitMs(TTS_GAP.jingleDelayMs);
      }catch(_){}
    }

    function stopTTS(){
  // â˜…é‡è¦ï¼šé€²è¡Œä¸­ã®èª­ã¿ä¸Šã’ã‚’ã™ã¹ã¦ç„¡åŠ¹åŒ–
  ttsRunId++;

  // â˜…é…å»¶èª­ã¿ä¸Šã’äºˆç´„ãŒæ®‹ã£ã¦ã„ãŸã‚‰æ­¢ã‚ã‚‹
  try{
    if (ttsOpenDelayTimer){ clearTimeout(ttsOpenDelayTimer); ttsOpenDelayTimer = null; }
    ttsOpenReadyAt = 0;
  }catch(_){}

  try{ window.speechSynthesis.cancel(); }catch(_){}

  // â˜…ã“ã“ãŒæ ¸å¿ƒï¼šOFFã‚„ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾Œã«ãƒ­ãƒƒã‚¯çŠ¶æ…‹ãŒæ®‹ã‚‰ãªã„ã‚ˆã†è§£é™¤
  ttsSpeaking = false;
}

    // Web Speechï¼š1ç™ºè©±ã‚’PromiseåŒ–
    function speakOnce(text, runId){

      text = ttsNormalize(text); // â˜…è¿½åŠ ï¼šèª­ã¿ä¸Šã’è¾æ›¸ã‚’å¿…ãšé€šã™
      
      return new Promise((resolve) => {
        if (!text) return resolve();
        if (runId !== ttsRunId) return resolve(); // â˜…å¤ã„ä¸–ä»£ãªã‚‰å³çµ‚äº†

        const u = new SpeechSynthesisUtterance(text);
        u.lang = "ja-JP";
        u.rate = 1.0;
        u.pitch = 1.0;

        u.onend = () => resolve();
        u.onerror = () => resolve();

        // speakç›´å‰ã«ã‚‚ç¢ºèªï¼ˆæ··å…¥é˜²æ­¢ï¼‰
        if (runId !== ttsRunId) return resolve();

        try{
          window.speechSynthesis.speak(u);
        }catch(_){
          resolve();
        }
      });
    }
    
    function speakLabelJa(key){
      const k = String(key || "").trim().toUpperCase();
      if (k === "O" || k === "ã€‡") return "ã¾ã‚‹";
      if (k === "X" || k === "Ã—") return "ã°ã¤";
      if (k === "A") return "ã‚¨ãƒ¼";
      if (k === "B") return "ãƒ“ãƒ¼";
      if (k === "C") return "ã‚·ãƒ¼";
      if (k === "D") return "ãƒ‡ã‚£ãƒ¼";
      if (k === "E") return "ã‚¤ãƒ¼";
      return k;
    }

    function getCorrectKeyForSpeak(){
      if (!currentQuestion) return null;

      let ck = currentQuestion.answer ? String(currentQuestion.answer).trim().toUpperCase() : null;

      // ABâ†’OX å¤‰æ›ï¼ˆã‚ãªãŸã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã¨åˆã‚ã›ã‚‹ï¼‰
      try{
        const norm = normalizeChoicesObj(currentQuestion.choices || {});
        if (norm && norm.mapAB && ck) ck = mapABtoOXKey(ck);
      }catch(_){}

      if (ck === "ã€‡") ck = "O";
      if (ck === "Ã—") ck = "X";
      return ck;
    }

    async function speakClosedAnswerOnly(){
      if (!ttsReadClosed) return;
      if (!ttsEnabled || !ttsUnlocked) return;
      if (isQR) return;
      if (currentView !== "quiz") return;
      if (!(currentMode === "ox" || currentMode === "five")) return;
    
      if (!latestQid) return;
      const key = `${latestQid}::closed`;
      if (ttsClosedKey === key) return;
      ttsClosedKey = key;
    
      const ck = getCorrectKeyForSpeak();
      if (!ck) return;
    
      // è§£èª¬ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚ãªãŸã®è¡¨ç¤ºè¡Œã‚’èª­ã‚€ï¼šç„¡ã‘ã‚Œã°ç©ºã§OKï¼‰
      let ex = "";
      try{
        ex = (explanationLine?.textContent || "").trim();
        ex = ex.replace(/^è§£èª¬[:ï¼š]\s*/, "");
      }catch(_){}
    
      // â˜…è¿½åŠ ï¼šäº”æŠã®ã¨ãã€æ­£è§£ã®é¸æŠè‚¢æœ¬æ–‡ã‚’æ‹¾ã†ï¼ˆè¡¨ç¤ºDOMã‹ã‚‰ï¼ã‚ºãƒ¬é˜²æ­¢ï¼‰
      let choiceText = "";
      try{
        if (currentMode === "five" && /^[A-E]$/.test(String(ck))){
          const rows = Array.from(cEl?.querySelectorAll?.(".choice") || []);
          for (const row of rows){
            const badge = (row.querySelector(".badge")?.textContent || "").trim().toUpperCase();
            const text  = (row.children?.[1]?.textContent || "").trim(); // 2ã¤ç›®ãŒæœ¬æ–‡ï¼ˆæ—¢å­˜è¨­è¨ˆï¼‰
            if (badge === String(ck) && text){
              choiceText = text;
              break;
            }
          }
        }
      }catch(_){}
    
      // æ··ã–ã‚Šé˜²æ­¢ï¼šå¿…ãšåœæ­¢â†’runIdã§å®ˆã‚‹
      stopTTS();
      const myRun = ttsRunId;
      await waitMs(2000);
      if (myRun !== ttsRunId) return;
    
      // â˜…å¤‰æ›´ï¼šæ­£è§£è¨˜å·ã®ã‚ã¨ã«ã€è©²å½“ã™ã‚‹é¸æŠè‚¢æ–‡ã‚‚èª­ã‚€
      if (choiceText){
        await speakOnce(`æ­£è§£ã¯ã€${speakLabelJa(ck)}ã€‚${choiceText}ã€‚`, myRun);
      }else{
        await speakOnce(`æ­£è§£ã¯ã€${speakLabelJa(ck)}ã€‚`, myRun);
      }
      if (myRun !== ttsRunId) return;
    
      if (ex){
        await speakOnce(`è§£èª¬ã€‚${ex}`, myRun);
      }
    }
  
    // ä»Šã®å•é¡Œã‹ã‚‰ã€Œèª­ã¿ä¸Šã’ç”¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã€ã‚’ä½œã‚‹
    function buildTtsSegments(isOpen){
      // ç”»é¢è¡¨ç¤ºï¼ˆDOMï¼‰ã‹ã‚‰å–ã‚‹ï¼šè¡¨ç¤ºï¼èª­ã¿ä¸Šã’ã‚’ä¸€è‡´ã•ã›ã‚‹
      const qText = (qEl?.textContent || "").trim();
      if (!qText) return [];

      const segments = [];
      segments.push({ type:"say", text: `å•é¡Œã€‚${qText}` });

      // textå…¥åŠ›ï¼ˆé¸æŠè‚¢ãªã—ï¼‰ãªã‚‰ã“ã“ã§çµ‚äº†ï¼ˆclassã§ã‚‚åˆ¤å®šã—ã¦ã‚ºãƒ¬è€æ€§ã‚’ä¸Šã’ã‚‹ï¼‰
      if (currentMode === "text" || document.body.classList.contains("textmode")) return segments;

      // choices DOMï¼ˆ#choicesï¼‰ã‹ã‚‰æ‹¾ã†ï¼šå‰å•ã®å–ã‚Šã“ã¼ã—é˜²æ­¢
      const rows = Array.from(cEl?.querySelectorAll?.(".choice") || []);
      if (!rows.length) return segments; // é¸æŠè‚¢ãŒè¡¨ç¤ºã•ã‚Œã¦ãªã„ãªã‚‰èª­ã¾ãªã„

      // å‡ºé¡Œæ™‚(open)ã®ã¿ï¼šå•é¡Œâ†’é¸æŠè‚¢ã®ç„¡éŸ³
      if (isOpen) segments.push({ type:"pause", ms:TTS_GAP.qToChoicesMs });

      rows.forEach((row, idx) => {
        // .badge ã¨æœ¬æ–‡ã‚’èª­ã‚€ï¼ˆrenderChoicesãŒä½œã‚‹æ§‹é€ ã«åˆã‚ã›ã‚‹ï¼‰
        const badge = (row.querySelector(".badge")?.textContent || "").trim();
        const text  = (row.children?.[1]?.textContent || "").trim(); // 2ã¤ç›®ãŒæœ¬æ–‡
        const line = text ? `${badge}ã€‚${text}` : `${badge}`;
        if (line) segments.push({ type:"say", text: line });

        // å‡ºé¡Œæ™‚(open)ã®ã¿ï¼šé¸æŠè‚¢é–“ã®ç„¡éŸ³ï¼ˆæœ€å¾Œã¯ä¸è¦ï¼‰
        if (isOpen && idx < rows.length - 1){
          segments.push({ type:"pause", ms:TTS_GAP.choiceGapMs });
        }
      });

      return segments;
    }

// å®Ÿè¡Œï¼šã‚¸ãƒ³ã‚°ãƒ«â†’èª­ã¿ä¸Šã’ï¼ˆç„¡éŸ³æŒ¿å…¥å«ã‚€ï¼‰
async function speakCurrent({ withJingle=true, auto=false } = {}){
  if (!ttsEnabled) return;
  if (!ttsUnlocked) return;
  if (ttsSpeaking) return;

  if (currentView !== "quiz") return;
  if (isQR === true) return;

  const isOpen = (currentStatus === "open");

  // â˜…è¿½åŠ ï¼šé¸æŠè‚¢ãŒæç”»ã•ã‚Œã‚‹å‰ã«èª­ã‚“ã§ã—ã¾ã†äº‹æ•…ã‚’é˜²ã
  if (isOpen && (currentMode === "ox" || currentMode === "five")){
    await waitForChoicesRendered(700);
  }
  const segs = buildTtsSegments(isOpen);
  if (!segs.length) return;

  // â˜…é–‹å§‹æ™‚ã«å‰ã®èª­ã¿ä¸Šã’ã‚’å®Œå…¨åœæ­¢ï¼ˆä¸–ä»£ã‚‚æ›´æ–°ï¼‰
  stopTTS();
  const myRun = ttsRunId;

  ttsSpeaking = true;
  try{
    // cancel ç›´å¾Œã«å°‘ã—å¾…ã¤ã¨æ··ã–ã‚ŠãŒæ¸›ã‚‹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å·®å¯¾ç­–ï¼‰
    await waitMs(60);
    if (myRun !== ttsRunId) return;

    if (withJingle) await playTtsJingle();
    if (myRun !== ttsRunId) return;

    for (const s of segs){
      if (myRun !== ttsRunId) return;

      if (s.type === "pause"){
        await waitMs(s.ms);
        continue;
      }

      // say
      await speakOnce(s.text, myRun);
    }
  }finally{
    // è‡ªåˆ†ãŒæœ€æ–°ä¸–ä»£ã®ã¨ãã ã‘è§£é™¤
    if (myRun === ttsRunId) ttsSpeaking = false;
  }
}

// è‡ªå‹•èª­ã¿ä¸Šã’ï¼ˆã€Œopenã«ãªã£ãŸå‡ºé¡Œã€ã‚’1å›ã ã‘ï¼‰
// è‡ªå‹•èª­ã¿ä¸Šã’ï¼ˆã€Œopenã«ãªã£ãŸå‡ºé¡Œã€ã‚’1å›ã ã‘ï¼‰
// â˜…å¤‰æ›´ï¼šopenç›´å¾Œã¯3ç§’å¾…ã£ã¦ã‹ã‚‰èª­ã‚€
function maybeAutoSpeak(){
  if (!ttsEnabled || !ttsUnlocked) return;
  if (currentView !== "quiz") return;
  if (isQR === true) return;
  if (currentStatus !== "open") return;
  if (!currentQuestion) return;
  if (currentQid !== latestQid) return;

  // ã€ŒåŒã˜å‡ºé¡Œ(open)ã€ã§äºŒé‡ã«èª­ã¾ãªã„ï¼ˆqidãŒåˆ†ã‹ã‚Œã°qidå„ªå…ˆï¼‰
  const qidKey = (latestQid || "") + ":open";
  if (ttsAutoSpokenKey === qidKey) return;

  // â˜…openå¾Œ3ç§’å¾…ã¡ï¼ˆã¾ã æ™‚é–“ãªã‚‰äºˆç´„ã—ã¦çµ‚ã‚ã‚Šï¼‰
  const now = Date.now();
  if (ttsOpenReadyAt && now < ttsOpenReadyAt){
    const wait = ttsOpenReadyAt - now;
    if (ttsOpenDelayTimer) clearTimeout(ttsOpenDelayTimer);
    ttsOpenDelayTimer = setTimeout(() => {
      ttsOpenDelayTimer = null;
      maybeAutoSpeak();
    }, Math.max(0, wait));
    return;
  }

  // â˜…ã“ã“ã¾ã§æ¥ãŸã‚‰èª­ã¿ä¸Šã’OK
  ttsAutoSpokenKey = qidKey;

  // start.mp3 ã‚’é³´ã‚‰ã™ã®ã§ã€TTSå´ã®ã‚¸ãƒ³ã‚°ãƒ«ã¯ç„¡ã—ãŒè‡ªç„¶ï¼ˆå¥½ã¿ã§trueã§ã‚‚OKï¼‰
  speakCurrent({ withJingle:false, auto:true });
}

// ãƒœã‚¿ãƒ³ï¼šèª­ã¿ä¸Šã’ON/OFF
ttsBtn.onclick = async () => {
  if (ttsEnabled){
    ttsEnabled = false;
    ttsBtn.classList.remove("on");
    ttsBtn.textContent = "ğŸ—£ èª­ã¿ä¸Šã’OFF";
    stopTTS();
    return;
  }
  // ON
  ttsEnabled = true;
  ttsUnlocked = true; // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ¸ˆã¿æ‰±ã„ï¼ˆè‡ªå‹•èª­ã¿ä¸Šã’è¨±å¯ï¼‰
  ttsAutoSpokenKey = null;   // â˜…è¿½åŠ ï¼šONã«ã—ãŸã‚‰è‡ªå‹•ã®ã€Œ1å›ã ã‘ã€åˆ¤å®šã‚’ãƒªã‚»ãƒƒãƒˆ
  ttsClosedKey = "";         // â˜…è¿½åŠ ï¼ˆä»»æ„ï¼‰ï¼šclosedèª­ã¿ä¸Šã’ã®å¤šé‡é˜²æ­¢ã‚‚ãƒªã‚»ãƒƒãƒˆã—ãŸã„å ´åˆ
  ttsBtn.classList.add("on");
  ttsBtn.textContent = "ğŸ—£ èª­ã¿ä¸Šã’ON";

  // ã¤ã„ã§ã«éŸ³ã‚‚è§£æ”¾ï¼ˆã‚¸ãƒ³ã‚°ãƒ«ã‚’é³´ã‚‰ã—ãŸã„å ´åˆï¼‰
  await unlockSound();

  // ä»Šopenä¸­ãªã‚‰ã€ãã®å•é¡Œã‚’å³èª­ã‚“ã§ã‚‚OKï¼ˆå¥½ã¿ï¼‰
  maybeAutoSpeak();
};

// ãƒœã‚¿ãƒ³ï¼šæ‰‹å‹•ã§èª­ã‚€ï¼ˆå‡ºé¡Œä¸­ã˜ã‚ƒãªãã¦ã‚‚èª­ã‚ã‚‹ãŒã€ç„¡éŸ³æŒ¿å…¥ã¯openæ™‚ã ã‘ï¼‰
  // å¤‰æ›´å‰ï¼šttsSpeakBtn.onclick = async () => {
   if (ttsSpeakBtn && ttsBtn){
    ttsSpeakBtn.onclick = async () => {
      ttsEnabled = true;
      ttsUnlocked = true;
      ttsBtn.classList.add("on");
      ttsBtn.textContent = "ğŸ—£ èª­ã¿ä¸Šã’ON";

      await unlockSound();
      ttsAutoSpokenKey = null;   // â˜…è¿½åŠ ï¼šæ‰‹å‹•ã¯å¿…ãšèª­ã¾ã›ãŸã„ã®ã§ãƒªã‚»ãƒƒãƒˆ
      stopTTS();                 // â˜…è¿½åŠ ï¼šæ®‹ç•™ã‚¿ã‚¤ãƒãƒ¼/ç™ºè©±ã‚’ç¢ºå®Ÿã«æƒé™¤ã—ã¦ã‹ã‚‰èª­ã‚€
      await speakCurrent({ withJingle:true, auto:false });
    };
  }

    function uiLabel(key){
      const k = String(key).trim().toUpperCase();
      if (k === "O") return "â—‹";
      if (k === "X") return "âœ•";
      return k;
    }

    // ===== ABã®ã¿å•é¡Œã‚’ OX ã«çµ±ä¸€ã™ã‚‹ï¼ˆdisplayå´ã®æ­£è¦åŒ–ï¼‰=====
    function isABOnlyChoices(obj){
      if (!obj || typeof obj !== "object") return false;
      const ks = Object.keys(obj).map(k => String(k).trim().toUpperCase()).sort();
      return ks.length === 2 && ks[0] === "A" && ks[1] === "B";
    }

    function mapABtoOXKey(k){
      const key = String(k).trim().toUpperCase();
      if (key === "A") return "O";
      if (key === "B") return "X";
      return key;
    }

    function normalizeChoicesObj(choicesObj){
      // A/Bã®ã¿ãªã‚‰ O/X ã«å¤‰æ›ã—ã¦è¿”ã™ï¼ˆè¡¨ç¤ºã‚‚é›†è¨ˆã‚‚çµ±ä¸€ï¼‰
      if (!isABOnlyChoices(choicesObj)) return { obj: choicesObj, mapAB: false };

      const A = choicesObj.A ?? choicesObj.a ?? "";
      const B = choicesObj.B ?? choicesObj.b ?? "";
      return {
        mapAB: true,
        obj: { O: A, X: B }
      };
    }

    async function waitForChoicesRendered(timeoutMs = 700){
      // textã¯é¸æŠè‚¢ãªã—
      if (currentMode === "text" || document.body.classList.contains("textmode")) return;

      // æœŸå¾…æ•°ï¼šchoiceOrder ãŒã‚ã‚‹ãªã‚‰ãã‚Œã‚’å„ªå…ˆã€ç„¡ã‘ã‚Œã° mode ã§æ¨å®š
      const expected =
        (Array.isArray(choiceOrder) && choiceOrder.length) ? choiceOrder.length :
        (currentMode === "ox" ? 2 : currentMode === "five" ? 5 : 0);

      if (!expected) return;

      const start = performance.now();
      while (performance.now() - start < timeoutMs){
        const rows = cEl?.querySelectorAll?.(".choice") || [];
        if (rows.length >= expected) return;   // æƒã£ãŸ
        await waitMs(40);
      }
    }

    roomLabel.textContent = `ROOM: ${room}`;

    const activityRef = ref(db, `rooms/${room}/activity`);
    const qidRef      = ref(db, `rooms/${room}/quiz/current_question_id`);
    const answersRef  = ref(db, `rooms/${room}/answers`);
    const qRef = (qid) => ref(db, `rooms/${room}/questions/${qid}`);

    // displayèµ·å‹•ã§å¼·åˆ¶QR
    update(activityRef, { qr: true }).catch(()=>{});

    const studentUrl =
      `https://qzp04374-code.github.io/quiz-app/exp-display/student.html?room=${encodeURIComponent(room)}`;
    
    function safeDrawQR(){
      try{
        if (!qrDiv) return;
        qrDiv.innerHTML = "";

        // QRCode.js ãŒè½ã¡ã¦ã‚‹ï¼èª­ã¿è¾¼ã¿å¤±æ•—ã§ã‚‚å…¨åœæ­¢ã•ã›ãªã„
        if (!window.QRCode){
          qrDiv.innerHTML = `<div style="color:#fca5a5;font-weight:800;">
            QRãƒ©ã‚¤ãƒ–ãƒ©ãƒªæœªèª­è¾¼ï¼ˆqrcode.min.jsï¼‰<br>Consoleã‚’ç¢ºèª
          </div>`;
          return;
        }

        // eslint-disable-next-line no-undef
        new QRCode(qrDiv, { text: studentUrl, width: 520, height: 520 });
      }catch(e){
        console.error("QR draw failed:", e);
        try{
          qrDiv.innerHTML = `<div style="color:#fca5a5;font-weight:800;">
            QRç”Ÿæˆã«å¤±æ•—ï¼ˆConsoleå‚ç…§ï¼‰
          </div>`;
        }catch(_){}
      }
    }    

    // æ—©ã‚ã«1å›ã€loadå¾Œã«ã‚‚ã†1å›ï¼ˆCDNé…å»¶ã«ã‚‚å¼·ãã™ã‚‹ï¼‰
    safeDrawQR();
    window.addEventListener("load", safeDrawQR);

    let isQR = true;
    let currentStatus = "-";
    let lastStatus = null;
    let currentMode = null;
    let currentView = "quiz";
    let choiceOrder = ["A","B","C","D","E"];
    let currentQuestion = null;
    let currentRevealMode = "live"; // â˜…è¿½åŠ ï¼šlive / closed
    
    let expectedN = 0;              // â˜…è¿½åŠ ï¼š100%äººæ•°ï¼ˆæ¯æ•°ï¼‰ã€‚0ãªã‚‰å¾“æ¥ã©ãŠã‚Šã€ŒæŠ•ç¥¨æ•°=æ¯æ•°ã€
    let lastAnswers = {};

    // ===== Auto-fit question text (ONLY question) =====
    function fitQuestionToLeftScroll({
      minPx = 28,     // ã“ã‚Œä»¥ä¸‹ã«ã¯ç¸®ã‚ãªã„ï¼ˆå¥½ã¿ã§18ã€œ24ï¼‰
      step = 2,       // 2pxãšã¤ç¸®ã‚ã‚‹
      maxLoops = 30,  // ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢
    } = {}) {
    if (!leftScroll || !qEl) return;

      // å‰å•ã®ç¸®å°ãŒæ®‹ã‚‰ãªã„ã‚ˆã†ã«æ¯å›ãƒªã‚»ãƒƒãƒˆ
      qEl.style.fontSize = "";

      // DOMåæ˜ å¾Œã«æ¸¬ã‚‹
      requestAnimationFrame(() => {
        let loops = 0;
        let fontSize = parseFloat(getComputedStyle(qEl).fontSize);

        // #leftScroll ã®ä¸­èº«ãŒã¯ã¿å‡ºã—ã¦ã„ã‚‹é–“ã ã‘ç¸®ã‚ã‚‹
        // overflow:hiddenã§ã‚‚scrollHeightã¯å¢—ãˆã‚‹ã®ã§åˆ¤å®šå¯èƒ½
        while (leftScroll.scrollHeight > leftScroll.clientHeight &&
               fontSize > minPx &&
               loops < maxLoops) {
          fontSize -= step;
          qEl.style.fontSize = `${fontSize}px`;
          loops++;
        }
      });
    }

    // ===== Fit choices height (scroll-safe) =====
    function fitChoicesHeight(){
      // choices window is fixed-height; keep overflow scroll.
      return;
    }

    function clamp01(x){ return Math.max(0, Math.min(1, x)); }

    function updateChoiceSpacing(){
      // textmodeã¯é¸æŠè‚¢ãªã—ï¼ˆè§¦ã‚‰ãªã„ï¼‰
      if (currentMode === "text" || document.body.classList.contains("textmode")) return;
      if (!cEl) return;
    
      const fs = parseFloat(getComputedStyle(cEl).fontSize) || 32; // #choicesã®å®Ÿãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º(px)
      const min = 22, max = 70; // tpCMaxã®ç¯„å›²ã«åˆã‚ã›ã‚‹
      const t = clamp01((fs - min) / (max - min)); // 0=å°ã•ã„å­— / 1=å¤§ãã„å­—
    
      // å°ã•ã„å­—ã»ã© â€œè©°ã‚ã‚‹â€
      // line-height: 1.06 ï½ 1.16ï¼ˆæ¨™æº–ã‚‚å°‘ã—ç‹­ã‚ï¼‰
      const lh = 1.06 + t * 0.10;
    
      // è¡Œé–“ã ã‘ã˜ã‚ƒãªãã€è¡Œé–“éš”ãƒ»ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚‚å°‘ã—é€£å‹•
      const choicesGap = 0.26 + t * 0.16; // em
      const cGap  = 0.46 + t * 0.10;      // em
      const padY  = 0.38 + t * 0.12;      // em
      const padX  = 0.62 + t * 0.14;      // em
    
      const root = document.documentElement.style;
      root.setProperty("--cLH", String(lh.toFixed(3)));
      root.setProperty("--choicesGap", `${choicesGap.toFixed(3)}em`);
      root.setProperty("--cGap", `${cGap.toFixed(3)}em`);
      root.setProperty("--cPadY", `${padY.toFixed(3)}em`);
      root.setProperty("--cPadX", `${padX.toFixed(3)}em`);
    }

    // é€£ç¶šå‘¼ã³å‡ºã—ã‚’ã¾ã¨ã‚ã‚‹ï¼ˆæç”»ã®ãŸã³ã«æš´ã‚Œãªã„ã‚ˆã†ã«ï¼‰
    let _fitReq = 0;
    function requestFitQuestion() {
      cancelAnimationFrame(_fitReq);
      _fitReq = requestAnimationFrame(() => {
    
        const isTextMode =
          (typeof currentMode !== "undefined" && currentMode === "text") ||
          document.body.classList.contains("textmode");
    
        // âœ… æ›¸ãå•é¡Œ(textmode)ã¯ã€Œè‡ªå‹•ç¸®å°ã€ã‚’ã—ãªã„ï¼ˆqMaxãŒç´ ç›´ã«åŠ¹ãã‚ˆã†ã«ï¼‰
        if (isTextMode) {
          if (typeof qEl !== "undefined" && qEl) qEl.style.fontSize = ""; // å‰å›ã®ç¸®å°æ®‹ã‚Šã‚’æ¶ˆã™
          return;
        }
    
        // quizï¼ˆé¸æŠè‚¢ã‚ã‚Šï¼‰ã®ã¨ãã ã‘å¾“æ¥é€šã‚Š
        fitQuestionToLeftScroll({ minPx: 30 });
    
        // âœ… 1ãƒ•ãƒ¬ãƒ¼ãƒ å¾Œã« choices é«˜ã•ã‚’è¨ˆç®—ï¼ˆDOMåæ˜ å¾Œã§ã‚ºãƒ¬ãªã„ï¼‰
        requestAnimationFrame(() => {
          fitChoicesHeight();
          updateChoiceSpacing(); // â˜…è¿½åŠ ï¼šé¸æŠè‚¢ã®è¡Œé–“/éš™é–“ã‚’æ–‡å­—ã‚µã‚¤ã‚ºé€£å‹•ã§æ›´æ–°
        });
      });
      // ===== æœ€å¼·ã‚»ãƒƒãƒˆï¼šãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ç§»å‹•/å€ç‡å¤‰æ›´/å¾©å¸°ã§ç¢ºå®Ÿã«å†ãƒ•ã‚£ãƒƒãƒˆ =====
      function refitNow(){
        requestFitQuestion();
        if (typeof updateChoiceSpacing === "function") updateChoiceSpacing();
      
        // ãƒ¢ãƒ‹ã‚¿ç§»å‹•ç›´å¾Œã®ã€Œé…ã‚Œã¦ã‚µã‚¤ã‚ºç¢ºå®šã€å¯¾ç­–ï¼ˆä¿é™ºï¼‰
        setTimeout(() => {
          requestFitQuestion();
          if (typeof updateChoiceSpacing === "function") updateChoiceSpacing();
        }, 120);
      }
      
      // 1) ãµã¤ã†ã®ã‚µã‚¤ã‚ºå¤‰æ›´
      window.addEventListener("resize", refitNow);
      
      // 2) ã‚ºãƒ¼ãƒ  / DPI / è¡¨ç¤ºé ˜åŸŸå¤‰åŒ–ï¼ˆãƒ¢ãƒ‹ã‚¿ç§»å‹•ã§åŠ¹ãã“ã¨ãŒã‚ã‚‹ï¼‰
      if (window.visualViewport){
        window.visualViewport.addEventListener("resize", refitNow);
      }
      
      // 3) åˆ¥ç”»é¢ã¸ç§»å‹•â†’æˆ»ã£ãŸã€ãªã©
      window.addEventListener("focus", refitNow);
      
      // 4) ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åˆ‡æ›¿
      document.addEventListener("fullscreenchange", refitNow);
      
      // 5) å¾©å¸°ãƒ»å†è¡¨ç¤ºï¼ˆç’°å¢ƒã«ã‚ˆã‚‹ãŒä¿é™ºï¼‰
      window.addEventListener("pageshow", refitNow);

    }

    // ===== Display tuning (per QID, localStorage) =====
    const tuneBtn   = document.getElementById("tuneBtn");
    const tunePanel = document.getElementById("tunePanel");
    const tuneClose = document.getElementById("tuneClose");
    
    const tpQMax = document.getElementById("tpQMax");
    const tpCMax = document.getElementById("tpCMax");
const tpQMaxVal = document.getElementById("tpQMaxVal");
    const tpCMaxVal = document.getElementById("tpCMaxVal");
const tpSave     = document.getElementById("tpSave");
    const tpResetQ   = document.getElementById("tpResetQ");
    const tpResetAll = document.getElementById("tpResetAll");
    const tpHint     = document.getElementById("tpHint");
    
    let _tuneDefaults = null;
    
    function readDefaultsOnce(){
      if (_tuneDefaults) return _tuneDefaults;
      const cs = getComputedStyle(document.documentElement);
      _tuneDefaults = {
        qMax: Number(cs.getPropertyValue("--qMax").trim()) || 64,
        cMax: Number(cs.getPropertyValue("--cMax").trim()) || 46
      };
      return _tuneDefaults;
    }
    
    function setCssVars(t){
      if (!t) return;
      const root = document.documentElement.style;
      if (Number.isFinite(t.qMax)) root.setProperty("--qMax", String(Math.round(t.qMax)));
      if (Number.isFinite(t.cMax)) root.setProperty("--cMax", String(Math.round(t.cMax)));
}
    
    function getTuneKey(room, qid){
      const r = String(room || "room");
      const q = String(qid || "__noqid__");
      return `cls:disp:tune:${r}:${q}`;
    }
    
    function loadTune(room, qid){
      try{
        const raw = localStorage.getItem(getTuneKey(room, qid));
        if (!raw) return null;
        const obj = JSON.parse(raw);
        return { qMax: Number(obj.qMax), cMax: Number(obj.cMax) };
      }catch(e){
        console.warn("tune load failed:", e);
        return null;
      }
    }
    
    function saveTune(room, qid, t){
      try{
        localStorage.setItem(getTuneKey(room, qid), JSON.stringify({
          qMax: Math.round(Number(t.qMax)),
          cMax: Math.round(Number(t.cMax)),
          at: Date.now(),
        }));
        return true;
      }catch(e){
        console.warn("tune save failed:", e);
        return false;
      }
    }
    
    function deleteTune(room, qid){
      try{ localStorage.removeItem(getTuneKey(room, qid)); }catch(e){}
    }
    
    function deleteAllTunes(room){
      const prefix = `cls:disp:tune:${String(room || "room")}:`;
      try{
        const keys = [];
        for (let i=0; i<localStorage.length; i++){
          const k = localStorage.key(i);
          if (k && k.startsWith(prefix)) keys.push(k);
        }
        keys.forEach(k => localStorage.removeItem(k));
      }catch(e){}
    }
    
    function reflectUiFromCss(){
      const cs = getComputedStyle(document.documentElement);
      const qMax = Number(cs.getPropertyValue("--qMax").trim()) || 64;
      const cMax = Number(cs.getPropertyValue("--cMax").trim()) || 46;
tpQMax.value = String(qMax);
      tpCMax.value = String(cMax);
tpQMaxVal.textContent = String(qMax);
      tpCMaxVal.textContent = String(cMax);
}
    
    function reflectVals(){
      tpQMaxVal.textContent = tpQMax.value;
      tpCMaxVal.textContent = tpCMax.value;
}
    
    function applyTuneForCurrentQid(){
      // room å¤‰æ•°ã¯ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ `room` ãŒå­˜åœ¨ã—ã¾ã™:contentReference[oaicite:8]{index=8}
      const roomName = (typeof room !== "undefined") ? room : "room";
      const qid = (typeof currentQid !== "undefined") ? currentQid : null;
    
      const d = readDefaultsOnce();
      const t = loadTune(roomName, qid);
    
      if (t && Number.isFinite(t.qMax) && Number.isFinite(t.cMax)){
        setCssVars(t);
        if (tpHint) tpHint.textContent = `é©ç”¨ä¸­ï¼šQID=${qid || "-"}ï¼ˆä¿å­˜æ¸ˆã¿ï¼‰`;
      }else{
        setCssVars(d);
        if (tpHint) tpHint.textContent = `åˆæœŸå€¤ï¼šQID=${qid || "-"}ï¼ˆæœªä¿å­˜ï¼‰`;
      }
    
      reflectUiFromCss();
      requestFitQuestion();
      
    }
    
    // UI events
    if (tuneBtn && tunePanel && tuneClose){
      tuneBtn.addEventListener("click", () => {
        tunePanel.classList.toggle("show");
        reflectUiFromCss();
      });
      tuneClose.addEventListener("click", () => tunePanel.classList.remove("show"));
    }
    
    [tpQMax, tpCMax].forEach(inp => {
      if (!inp) return;
      inp.addEventListener("input", () => {
        reflectVals();
        setCssVars({
          qMax: Number(tpQMax.value),
          cMax: Number(tpCMax.value),});
        requestFitQuestion();
      });
    });
    
    if (tpSave){
      tpSave.addEventListener("click", () => {
        const roomName = (typeof room !== "undefined") ? room : "room";
        const qid = (typeof currentQid !== "undefined") ? currentQid : null;
    
        const ok = saveTune(roomName, qid, {
          qMax: Number(tpQMax.value),
          cMax: Number(tpCMax.value),});
        if (tpHint) tpHint.textContent = ok ? `ä¿å­˜ã—ã¾ã—ãŸï¼šQID=${qid || "-"}ï¼ˆã“ã®ç«¯æœ«ã®ã¿ï¼‰` : "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ";
        applyTuneForCurrentQid();
      });
    }
    
    if (tpResetQ){
      tpResetQ.addEventListener("click", () => {
        const roomName = (typeof room !== "undefined") ? room : "room";
        const qid = (typeof currentQid !== "undefined") ? currentQid : null;
        deleteTune(roomName, qid);
        if (tpHint) tpHint.textContent = `åˆæœŸåŒ–ã—ã¾ã—ãŸï¼šQID=${qid || "-"}`;
        applyTuneForCurrentQid();
      });
    }
    
    if (tpResetAll){
      tpResetAll.addEventListener("click", () => {
        const roomName = (typeof room !== "undefined") ? room : "room";
        deleteAllTunes(roomName);
        if (tpHint) tpHint.textContent = "ã“ã®ROOMã®ä¿å­˜ã‚’å…¨ã¦åˆæœŸåŒ–ã—ã¾ã—ãŸ";
        applyTuneForCurrentQid();
      });
    }

    // ===== Timer =====
    let timerState = null;
    let timerInterval = null;
    let lastAutoClosedAt = 0;
    let lastCountdownSec = null; // ç›´å‰ã«é³´ã‚‰ã—ãŸç§’ï¼ˆ3/2/1ã®é€£æ‰“é˜²æ­¢ï¼‰
    let countdownPlayed = false; // æ®‹ã‚Š3ç§’ã§1å›ã ã‘é³´ã‚‰ã™ç”¨

    function fmt2(n){ return String(n).padStart(2,"0"); }
    function fmtRemain(ms){
      const s = Math.max(0, Math.ceil(ms/1000));
      const m = Math.floor(s/60);
      const r = s % 60;
      return `${fmt2(m)}:${fmt2(r)}`;
    }

    function stopTimerTick() {
      if (timerInterval){ clearInterval(timerInterval); timerInterval = null; }
      if (timerLabel) timerLabel.textContent = "â± --:--";

      // â˜…è¿½åŠ 
      if (timerBar) timerBar.style.width = "0%";
      document.body.classList.remove("timer-running", "timer-urgent");

      lastCountdownSec = null;
      countdownPlayed = false;
    }

    function ensureTimerTick(){
      if (timerInterval) return;
  
      timerInterval = setInterval(async () => {
        if (!timerState || !timerState.running || !timerState.endsAt){
          ;
          return;
        }

        const remain = timerState.endsAt - Date.now();

        // ===== æ®‹ã‚Š3ç§’ã«å…¥ã£ãŸç¬é–“ã«1å›ã ã‘ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³éŸ³ï¼ˆmp3å†…ã§ 3,2,1,0ï¼‰=====
        if (timerState.autoClose && currentStatus === "open" && isQR === false){
          if (remain <= 3000 && remain > 0 && !countdownPlayed){
            playCountdown();
            countdownPlayed = true;
          }
          // 3ç§’ã‚ˆã‚Šå‰ã«æˆ»ã£ãŸã‚‰ï¼ˆæ¬¡ã®ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ãªã©ï¼‰ãƒªã‚»ãƒƒãƒˆ
            if (remain > 3000) countdownPlayed = false;
        }

          // è¡¨ç¤ºæ›´æ–°
          if (timerLabel) timerLabel.textContent = `â± ${fmtRemain(remain)}`;

        // â˜…æ®‹ã‚Š%ã§ãƒãƒ¼ã‚’ç¸®ã‚ã‚‹
        if (timerBar && timerState && timerState.durationSec){
          const totalMs = timerState.durationSec * 1000;
          const ratio = Math.max(0, Math.min(1, remain / totalMs)); // 1â†’0
          timerBar.style.width = `${Math.round(ratio * 100)}%`;

          // æ®‹ã‚Š10ç§’ã§ç‚¹æ»…ï¼ˆè¦ã‚‰ãªã‘ã‚Œã°æ¶ˆã—ã¦OKï¼‰
          document.body.classList.toggle("timer-urgent", remain <= 10_000 && remain > 0);
        }

        // 0ç§’ã§è‡ªå‹• closeï¼ˆopen ã‹ã¤ QRã§ãªã„æ™‚ã ã‘ï¼‰
        if (remain <= 0 && timerState.autoClose && currentStatus === "open" && isQR === false){
          const now = Date.now();
          // é€£æ‰“é˜²æ­¢
          if (now - lastAutoClosedAt > 1500){
            lastAutoClosedAt = now;
            await update(activityRef, { status:"closed" }).catch(()=>{});
          }
        }
      }, 250);
    } 
     
    /* â˜…Q1æ¬ è½å¯¾ç­–ï¼šæœ€å¾Œã®QIDã‚’ä¿æŒã—ã€pollâ†’quizã§å¿…ãšè¡¨ç¤ºå‡¦ç†ã‚’å›ã™ */
    let latestQid = null;
    let subscribedQid = null;
    let currentQid = null; // â˜…è¿½åŠ ï¼šcurrentQuestionãŒå¯¾å¿œã—ã¦ã„ã‚‹QID
    let unsubQ = null;

    function defaultChoicesFromMode(mode){
      if (mode === "ox") return ["O","X"];
      if (mode === "five") return ["A","B","C","D","E"];
      return ["A","B","C","D","E"];
    }

    function showToast(){
      toast.style.opacity = "1";
      setTimeout(()=> toast.style.opacity = "0", 1200);
    }

    function showQR(){
      isQR = true;
      qrLayer.classList.remove("hidden");
      document.getElementById("mainGrid").style.visibility = "hidden";
    }
    function hideQRWithFade(){
      isQR = false;
      qrLayer.classList.add("hidden");
      setTimeout(()=>{
        if (!isQR) document.getElementById("mainGrid").style.visibility = "visible";
      }, 460);
    }

    function placeAnswerBoxTop(isTop){
      if (!leftScroll) return;
      if (isTop) leftScroll.insertBefore(answerBox, cEl);
      else leftScroll.appendChild(answerBox);
    }

    function updateAnswerUI(){
      const q = currentQuestion;
      const shouldShow = (currentStatus === "closed") && q && (q.answer || q.explanation);
      placeAnswerBoxTop(currentStatus === "closed");

      if (!shouldShow){
        answerBox.classList.remove("show");
        answerLine.textContent = "";
        explanationLine.textContent = "";
        return;
      }
      answerBox.classList.add("show");
      let ans = q.answer ? String(q.answer).trim().toUpperCase() : "";
      const normAns = normalizeChoicesObj(q.choices || {});
      if (normAns.mapAB && ans) ans = mapABtoOXKey(ans);

      answerLine.textContent = ans ? `æ­£è§£ï¼š${uiLabel(ans)}` : "æ­£è§£ï¼šâ€”";
      explanationLine.textContent = q.explanation ? `è§£èª¬ï¼š${q.explanation}` : "";
    }

    function colorOf(label){
      const css = getComputedStyle(document.documentElement);
      switch(String(label).trim().toUpperCase()){
        case "O": return css.getPropertyValue("--color-o");
        case "X": return css.getPropertyValue("--color-x");
        case "A": return css.getPropertyValue("--color-a");
        case "B": return css.getPropertyValue("--color-b");
        case "C": return css.getPropertyValue("--color-c");
        case "D": return css.getPropertyValue("--color-d");
        case "E": return css.getPropertyValue("--color-e");
        default:  return "#94a3b8";
      }
    }

    function renderChoices(choicesObj, correctKey, showCorrect){
      cEl.innerHTML = "";
      const entries = Object.entries(choicesObj || {});
      entries.forEach(([k, v]) => {
        const key = String(k).trim().toUpperCase();
        const row = document.createElement("div");
        row.className = "choice";
        if (showCorrect && correctKey && key === correctKey) row.classList.add("correct");

        const b = document.createElement("div");
        b.className = `badge ${key}`;
        b.textContent = uiLabel(key);

        const t = document.createElement("div");
        t.className = "choiceText";
        t.textContent = v;

        row.appendChild(b);
        row.appendChild(t);
        cEl.appendChild(row);
      });
    }
    
    function renderVChart(counts, order){
      vchart.innerHTML = "";
    
      const ord = Array.isArray(order) && order.length ? order : Object.keys(counts || {});
      if (!ord.length){
        vchart.innerHTML = `<div style="color:rgba(203,213,225,.9);">ï¼ˆé›†è¨ˆå¾…ã¡ï¼‰</div>`;
        return;
      }
    
      const entries = ord.map(k => [String(k).toUpperCase(), Number((counts||{})[k]||0)]);
      const max = Math.max(...entries.map(([,v])=>v), 1);
    
      // â˜…æ¯æ•°ï¼šexpectedN ãŒå…¥ã£ã¦ã„ã‚Œã°ãã‚Œã‚’å„ªå…ˆï¼ˆãŸã ã—æŠ•ç¥¨æ•°ã‚ˆã‚Šå°ã•ã„ã¨100%è¶…ãˆã‚‹ã®ã§ max ã‚’å–ã‚‹ï¼‰
      const actualTotal = entries.reduce((s,[,v]) => s + (Number(v)||0), 0);
      const denom = (expectedN > 0 ? Math.max(expectedN, actualTotal) : actualTotal) || 1;
    
      entries.forEach(([lab, val]) => {
        const col = document.createElement("div");
        col.className = "col";
    
        const cnt = document.createElement("div");
        cnt.className = "count";
        const pct = Math.round((val / denom) * 100);
        cnt.textContent = `${val}ï¼ˆ${pct}%ï¼‰`;
    
        const bar = document.createElement("div");
        bar.className = "bar";
        const h = Math.max(12, Math.round((val / max) * 280));
        bar.style.height = `${h}px`;
    
        const fill = document.createElement("div");
        fill.className = "barFill";
        fill.style.background = colorOf(lab);
        bar.appendChild(fill);
    
        const label = document.createElement("div");
        label.className = "lab";
        label.textContent = uiLabel(lab);
    
        col.appendChild(cnt);
        col.appendChild(bar);
        col.appendChild(label);
    
        vchart.appendChild(col);
      });
    }

    function escapeHtml(str){
      return str
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function renderTextAnswers(answers){
      textList.innerHTML = "";
      const keys = Object.keys(answers || {});
      const items = [];

      keys.forEach(uid => {
        const v = answers[uid];
        if (typeof v === "string") items.push(v);
        else if (v && typeof v === "object" && typeof v.value === "string") items.push(v.value);
      });

      if (currentStatus !== "closed"){
        textTitle.textContent = `æ–‡å­—å›ç­”ï¼ˆè§£ç­”çµ‚äº†ã§è¡¨ç¤ºï¼‰ / ç¾åœ¨ ${items.length} ä»¶`;
        return;
      }

      textTitle.textContent = `æ–‡å­—å›ç­”ï¼ˆå…¬é–‹ä¸­ï¼‰ / ${items.length} ä»¶`;

      items.forEach((t, idx) => {
        const div = document.createElement("div");
        div.className = "textItem";
        div.innerHTML = `<span class="no">${idx+1}.</span>${escapeHtml(String(t||""))}`;
        textList.appendChild(div);
      });

      if (items.length === 0){
        const div = document.createElement("div");
        div.className = "textItem";
        div.innerHTML = `<span class="no">â€”</span>ï¼ˆå›ç­”ãªã—ï¼‰`;
        textList.appendChild(div);
      }
    }

        function getEffectiveChoiceOrder(){
      // quizä¸­ã¯ã€Œä»Šè¡¨ç¤ºã—ã¦ã„ã‚‹å•é¡Œã€ã®choicesã‚’æœ€å„ªå…ˆï¼ˆ=å³ã®é›†è¨ˆã‚‚å¿…ãšä¸€è‡´ã•ã›ã‚‹ï¼‰
      if (currentView === "quiz" && currentQuestion && currentQuestion.choices && typeof currentQuestion.choices === "object"){
        const norm = normalizeChoicesObj(currentQuestion.choices || {});
        const ord = Object.keys(norm.obj || {}).map(k => String(k).trim().toUpperCase());
        if (ord.length) return ord;
      }
      // poll/standbyç­‰ã¯å¾“æ¥é€šã‚Š activityç”±æ¥
      return Array.isArray(choiceOrder) ? choiceOrder : [];
    }

    function shouldHideResults(){
      // textã¯å…ƒã€…ã€Œclosedã§ä¸€è¦§å…¬é–‹ã€ãªã®ã§ã€ã“ã“ã§ã¯å¾“æ¥ä»•æ§˜ã‚’å„ªå…ˆã—ã¦éš ã•ãªã„
      if (currentMode === "text") return false;
      return (currentRevealMode === "closed") && (currentStatus === "open") && (isQR === false);
    }
    
    function syncRevealUI(){
      const hide = shouldHideResults();
      if (resultsMask) resultsMask.classList.toggle("show", hide);
    
      // ã‚¿ã‚¤ãƒˆãƒ«ã‚‚åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼ˆè¦‹ãŸç›®ã§åˆ†ã‹ã‚‹ã‚ˆã†ã«ï¼‰
      rightTitle.textContent =
        (currentMode === "text") ? "æ–‡å­—å…¥åŠ›ï¼ˆä»¶æ•°ï¼‹ä¸€è¦§ï¼‰" :
        hide ? "é›†è¨ˆï¼ˆéå…¬é–‹ï¼‰" : "é›†è¨ˆï¼ˆç¸¦æ£’ï¼‰";
    }

    function recomputeAndRenderFromAnswers(ans){
      const keys = Object.keys(ans || {});
      const n = keys.length;

      const denomN = (expectedN > 0 ? Math.max(expectedN, n) : 0);
      countLabel.textContent = (expectedN > 0) ? `å‚åŠ ä¸­ ${n} / ${denomN}äºº` : `å‚åŠ ä¸­ ${n}äºº`;
      qrCount.textContent    = countLabel.textContent;

      const isText = (currentMode === "text");
      if (isText){
        vchart.innerHTML = `
          <div style="width:100%; display:flex; align-items:center; justify-content:space-between; gap:12px;">
            <div style="font-weight:1000; letter-spacing:.10em; color:rgba(203,213,225,.92);">
              æ–‡å­—å…¥åŠ›
              <div style="margin-top:6px; font-size:14px; color:rgba(203,213,225,.85);">
                ${currentStatus === "closed" ? "å…¬é–‹ä¸­" : "å—ä»˜ä¸­ï¼ˆè§£ç­”çµ‚äº†ã§å…¬é–‹ï¼‰"}
              </div>
            </div>
            <div style="text-align:right;">
              <div style="font-size:14px; color:rgba(203,213,225,.85); font-weight:900; letter-spacing:.08em;">ä»¶æ•°</div>
              <div style="font-size:44px; font-weight:1100; line-height:1; color:#fff;">${n}</div>
            </div>
          </div>
        `;
        textBox.classList.add("show");
        renderTextAnswers(ans);
        return;
      }

      textBox.classList.remove("show");
      textList.innerHTML = "";

    const effectiveOrder = getEffectiveChoiceOrder();

    const counts = {};
    (effectiveOrder || []).forEach(c => counts[c] = 0);


      keys.forEach(uid => {
        const v = ans[uid];
        let val = null;
        if (typeof v === "string") val = v;
        else if (v && typeof v === "object" && typeof v.value === "string") val = v.value;
        if (!val) return;

    let key = String(val).trim().toUpperCase();

    // â˜…é›†è¨ˆã®åŸºæº–ãŒOXã®ã¨ãã¯ A/B ã‚’ O/X ã«çµ±ä¸€
    if (Array.isArray(effectiveOrder) && effectiveOrder.length === 2 &&
        effectiveOrder.includes("O") && effectiveOrder.includes("X")){
      key = mapABtoOXKey(key);
    }

    if (counts[key] === undefined){
      return; // æƒ³å®šå¤–ã¯ç„¡è¦–
    }
    counts[key] += 1;

      });

      renderVChart(counts, effectiveOrder);

    }

    /* â˜…QIDã‚’è¡¨ç¤ºå‡¦ç†ã«å›ã™é–¢æ•°ï¼ˆpollä¸­ã«QIDãŒæ¥ã¦ã‚‚ä¿æŒã—ã¦ã€quizã«æˆ»ã£ãŸã‚‰å¿…ãšé©ç”¨ï¼‰ */
function applyCurrentQid(){
  // quizä»¥å¤–ï¼ˆpoll/standby/qrï¼‰ã«å…¥ã£ãŸã‚‰ã€å‰ã®å•é¡Œè³¼èª­ã‚’å¿…ãšæ­¢ã‚ã‚‹
  if (currentView !== "quiz"){
    if (unsubQ) { unsubQ(); unsubQ = null; }
    subscribedQid = null;
    currentQid = null;
    return;
  }

  const qid = latestQid;

  // qidãŒç„¡ã„
  if (!qid){
    subscribedQid = null;
    currentQid = null;
    currentQuestion = null;
    qEl.textContent = "ï¼ˆå•é¡Œã‚’å¾…ã£ã¦ã„ã¾ã™â€¦ï¼‰";
    cEl.innerHTML = "";
    updateAnswerUI();
    applyTuneForCurrentQid();
    requestFitQuestion();
    return;
  }

  // åŒã˜qidã§è³¼èª­ãŒç”Ÿãã¦ã„ã‚‹ï¼šè³¼èª­ã¯å¼µã‚Šç›´ã•ãªã„ãŒã€å†æç”»ã¯ã™ã‚‹
  if (qid === subscribedQid && unsubQ) {
    if (currentQuestion) {
      cEl.innerHTML = ""; // å‰ã®é¸æŠè‚¢DOMæ®‹ã‚Šäº‹æ•…é˜²æ­¢

      const isTextMode = (currentMode === "text") || document.body.classList.contains("textmode");
      if (isTextMode){
        choiceOrder = [];
        renderChoices({}, null, false);
      } else {
        const norm = normalizeChoicesObj(currentQuestion.choices || {});
        const choicesForUI = norm.obj;

        // choiceOrderæ›´æ–°ï¼ˆè¡¨ç¤ºã¨é›†è¨ˆä¸€è‡´ï¼‰
        if (choicesForUI && typeof choicesForUI === "object"){
          const ord = Object.keys(choicesForUI).map(k => String(k).trim().toUpperCase());
          if (ord.length) choiceOrder = ord;
        }

        let ck = currentQuestion.answer ? String(currentQuestion.answer).trim().toUpperCase() : null;
        if (norm.mapAB && ck) ck = mapABtoOXKey(ck);

        renderChoices(choicesForUI || {}, ck, currentStatus === "closed");
      }

      updateAnswerUI();
      maybeAutoSpeak();
      recomputeAndRenderFromAnswers(lastAnswers);
      applyTuneForCurrentQid();
      requestFitQuestion();
    }
    return;
  }

  // ã“ã“ã‹ã‚‰ã€Œæ–°ã—ã„qidã€ï¼šè³¼èª­ã‚’å¼µã‚Šç›´ã™
  if (unsubQ) { unsubQ(); unsubQ = null; }
  subscribedQid = qid;

  unsubQ = onValue(qRef(qid), snap => {
    const q = snap.val();
    if (!q){
      currentQid = null;
      currentQuestion = null;
      qEl.textContent = "ï¼ˆå•é¡Œãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰";
      cEl.innerHTML = "";
      updateAnswerUI();
      requestFitQuestion();
      return;
    }

    currentQid = qid;
    currentQuestion = q;

    qEl.textContent = q.question || "";
    cEl.innerHTML = ""; // å‰å•DOMã‚’å¿…ãšæ¶ˆã™

    const isTextMode = (currentMode === "text") || document.body.classList.contains("textmode");
    if (isTextMode){
      choiceOrder = [];
      renderChoices({}, null, false);
      updateAnswerUI();
      maybeAutoSpeak();
      recomputeAndRenderFromAnswers(lastAnswers);
      applyTuneForCurrentQid();
      requestFitQuestion();
      return;
    }

    const norm = normalizeChoicesObj(q.choices || {});
    const choicesForUI = norm.obj;
    
    if (choicesForUI && typeof choicesForUI === "object"){
      const ord = Object.keys(choicesForUI).map(k => String(k).trim().toUpperCase());
      if (ord.length) choiceOrder = ord;
    }
    
    let ck = q.answer ? String(q.answer).trim().toUpperCase() : null;
    if (norm.mapAB && ck) ck = mapABtoOXKey(ck);
    
    renderChoices(choicesForUI || {}, ck, currentStatus === "closed");
    updateAnswerUI();
    maybeAutoSpeak();
    recomputeAndRenderFromAnswers(lastAnswers);
    
    // â˜…è¿½åŠ ï¼šæ–°QIDã®æœ€åˆã®æç”»ã§ã‚‚ tuning ã‚’ç¢ºå®Ÿã«é©ç”¨
    applyTuneForCurrentQid();
    
    requestFitQuestion();

  });
}
    
// activity
onValue(activityRef, snap => {
  const a = snap.val() || {};
  currentStatus = a.status || "-";
  currentMode = a.mode || null;
  currentRevealMode = (a.revealMode === "closed") ? "closed" : "live";
  // â˜…ã“ã“ã«è¿½åŠ 
  expectedN = Math.max(0, Math.floor(Number(a.expectedN || 0)));

  // â˜…å®‰å…¨å¼ï¼šcElãŒå­˜åœ¨ã™ã‚‹ã¨ãã ã‘æ¶ˆã™ï¼ˆå­˜åœ¨ã—ãªã„ã¨å…¨åœæ­¢â†’QRãŒå‡ºãªã„ï¼‰
  if (currentMode === "text" && typeof cEl !== "undefined" && cEl) {
    cEl.innerHTML = "";
    choiceOrder = [];
  }

  currentView = a.view || "qr";
  timerState = a.timer || null;
  if (timerState && timerState.running && timerState.endsAt) ensureTimerTick();
  else stopTimerTick();
  document.body.classList.toggle("timer-running", !!(timerState && timerState.running && timerState.endsAt));

  statusLabel.textContent = `status: ${currentStatus}`;
  document.body.classList.toggle("poll", currentView === "poll");
  document.body.classList.toggle("closed", currentStatus === "closed");
  document.body.classList.toggle("textmode", currentMode === "text");

  rightTitle.textContent =
   (currentMode === "text") ? "æ–‡å­—å…¥åŠ›ï¼ˆä»¶æ•°ï¼‹ä¸€è¦§ï¼‰" : "é›†è¨ˆï¼ˆç¸¦æ£’ï¼‰";

  // âœ…QRåˆ¤å®šï¼šONãªã‚‰è¡¨ç¤ºã€ONã§ãªã‘ã‚Œã°å¿…ãšéè¡¨ç¤ºï¼ˆå›ºã¾ã‚Šé˜²æ­¢ï¼‰
  const qrOn =
    (a.qr === true) ||
    (a.qr === "true") ||
    (a.view === "qr");
  
  if (qrOn) showQR();
  else hideQRWithFade();

  const cfgChoices = (a.config && Array.isArray(a.config.choices)) ? a.config.choices : null;
  if (cfgChoices && cfgChoices.length){
    choiceOrder = cfgChoices.map(x => String(x).trim().toUpperCase());
  } else if (currentMode){
    choiceOrder = defaultChoicesFromMode(currentMode);
  }
  
  // â˜…configãŒABã®ã¿ã§ã‚‚ displayä¸Šã¯OXã¸çµ±ä¸€ï¼ˆA/B â†’ O/Xï¼‰
  if (choiceOrder.length === 2 && choiceOrder.includes("A") && choiceOrder.includes("B")){
    choiceOrder = ["O","X"];
  }
  // â˜…è¿½åŠ ï¼šopenã«åˆ‡ã‚Šæ›¿ã‚ã£ãŸç¬é–“ï¼ˆå‡ºé¡Œé–‹å§‹ï¼‰
  if (lastStatus !== "open" && currentStatus === "open") {
    playStart();
  
    // â˜…äºˆç´„ã¯ maybeAutoSpeak ãŒæ‹…å½“ï¼ˆä¸€æœ¬åŒ–ï¼‰
    ttsOpenReadyAt = Date.now() + OPEN_READ_DELAY_MS;
    if (ttsOpenDelayTimer) { clearTimeout(ttsOpenDelayTimer); ttsOpenDelayTimer = null; }
    maybeAutoSpeak(); // â†ã“ã“ã§å‘¼ã¶ã ã‘
  }

  if (lastStatus !== "closed" && currentStatus === "closed") {
    showToast();
ã€€ã€€playGong();
    speakClosedAnswerOnly(); // â˜…ã“ã“
  }
  lastStatus = currentStatus;
  // â˜…è¿½åŠ ï¼šopenã§ãªããªã£ãŸã‚‰äºˆç´„ã‚’è§£é™¤
  if (currentStatus !== "open") {
    ttsOpenReadyAt = 0;
    if (ttsOpenDelayTimer) { clearTimeout(ttsOpenDelayTimer); ttsOpenDelayTimer = null; }
  }

  if (currentView === "poll"){
    if (unsubQ) { unsubQ(); unsubQ = null; }
    currentQuestion = null;
    qEl.textContent = "ï¼ˆå£é ­Q&Aï¼šé›†è¨ˆã®ã¿ï¼‰";
    cEl.innerHTML = "";
        
    // â˜…è¿½åŠ ï¼špollã¸å…¥ã£ãŸç¬é–“ã«ã€ç¾answersã§å³æç”»ï¼ˆTEXTã‚‚å«ã‚€ï¼‰
    recomputeAndRenderFromAnswers(lastAnswers);
    updateAnswerUI();
  } else if (currentView === "standby"){
    currentQuestion = null;
    qEl.textContent = "ï¼ˆã‚¹ã‚¿ãƒ³ãƒã‚¤ä¸­â€¦ å…ˆç”Ÿã®æ“ä½œã‚’å¾…ã£ã¦ã„ã¾ã™ï¼‰";
    cEl.innerHTML = "";
    updateAnswerUI();
  } else {
    updateAnswerUI();
  }

  // â˜…é‡è¦ï¼špollâ†’quizã«ãªã£ãŸç¬é–“ã«ã€ä¿æŒã—ã¦ã„ãŸQIDã‚’å¿…ãšåæ˜ ï¼ˆQ1æ¬ è½ã‚’é˜²ãï¼‰
  applyCurrentQid();

  // å³å†æç”»
  if (a.qr !== true){
    // view/mode/statusãŒå¤‰ã‚ã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å³æç”»ï¼ˆTEXTã®closedè¡¨ç¤ºã‚’ç¢ºå®Ÿã«åæ˜ ï¼‰
    recomputeAndRenderFromAnswers(lastAnswers);
  }
  syncRevealUI();
});

 // qidï¼šå¸¸ã«ä¿æŒã—ã€quizçŠ¶æ…‹ãªã‚‰å³é©ç”¨
 onValue(qidRef, snap => {
   latestQid = snap.val() || null;
   applyCurrentQid();      
 });

    // answersï¼šä¿å­˜ï¼‹éŸ³ï¼‹å†æç”»
    onValue(answersRef, snap => {
      const ans = snap.val() || {};
      lastAnswers = ans;

      const n = Object.keys(ans).length;
      if (n > lastAnswerTotal) playPoyon();
      lastAnswerTotal = n;

      recomputeAndRenderFromAnswers(ans);
    });

    </script>

    <!-- ===== Display tuning panel (per QID, localStorage) ===== -->
    <div id="tunePanel" aria-hidden="true">
      <div class="tpHead">
        <div class="tpTitle">è¡¨ç¤ºå¾®èª¿æ•´ï¼ˆã“ã®PCã®ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰</div>
        <button id="tuneClose" class="tpClose">âœ•</button>
      </div>
  
      <div class="tpRow">
        <div class="tpLab">å•é¡Œæ–‡ æœ€å¤§ï¼ˆqMaxï¼‰</div>
        <input id="tpQMax" type="range" min="38" max="90" step="1">
        <div class="tpVal"><span id="tpQMaxVal"></span>px</div>
      </div>
  
      <div class="tpRow">
        <div class="tpLab">é¸æŠè‚¢ æœ€å¤§ï¼ˆcMaxï¼‰</div>
        <input id="tpCMax" type="range" min="22" max="70" step="1">
        <div class="tpVal"><span id="tpCMaxVal"></span>px</div>
      </div>
<div class="tpFoot">
        <button id="tpSave" class="tpBtn">ä¿å­˜ï¼ˆã“ã®å•é¡Œã ã‘ï¼‰</button>
        <button id="tpResetQ" class="tpBtn ghost">ã“ã®å•é¡Œã‚’åˆæœŸåŒ–</button>
        <button id="tpResetAll" class="tpBtn ghost">å…¨éƒ¨åˆæœŸåŒ–</button>
      </div>
  
      <div class="tpHint" id="tpHint"></div>
    </div>

</body>
</html>
