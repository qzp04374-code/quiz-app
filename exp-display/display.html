<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClassSync Display</title>

  <style>
    :root{
      --bg:#050608;
      --panel:rgba(17,24,39,.55);
      --line:rgba(255,255,255,.10);
      --ink:#f9fafb;
      --muted:#cbd5e1;

      --color-o:#34c759;
      --color-x:#ff3b30;
      --color-a:#0a84ff;
      --color-b:#30d158;
      --color-c:#ff9f0a;
      --color-d:#bf5af2;
      --color-e:#ff375f;

      --ok:#22c55e;
    }

    body{
      margin:0;
      min-height:100vh;
      background:var(--bg);
      color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
      overflow:hidden;
    }

    /* buildË°®Á§∫Ôºà„Å©„ÅÆÁâà„ÇíË¶ã„Å¶„Çã„Åã‰∫ãÊïÖÈò≤Ê≠¢Ôºâ */
    #buildTag{
      position:fixed; right:12px; bottom:10px;
      opacity:.55; font-size:12px; z-index:9999;
      background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.08);
      padding:6px 10px; border-radius:999px;
      backdrop-filter: blur(8px);
    }

    body.closed .grid{ grid-template-columns: 1.6fr 1fr; }

    .wrap{
      height:100vh;
      display:flex;
      flex-direction:column;
      align-items:stretch;
      justify-content:flex-start;
      padding:16px 16px 14px;
      box-sizing:border-box;
      gap:10px;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:18px;
      background:var(--panel);
      border:1px solid var(--line);
      box-shadow:0 18px 50px rgba(0,0,0,.55);
    }
    .room{
      font-weight:900;
      letter-spacing:.08em;
      font-size:18px;
      white-space:nowrap;
    }
    .meta{
      color:var(--muted);
      font-size:14px;
      display:flex;
      gap:12px;
      align-items:center;
      white-space:nowrap;
    }
    .soundBtn{
      background:rgba(2,6,23,.6);
      border:1px solid rgba(255,255,255,.12);
      color:#f9fafb;
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      letter-spacing:.06em;
      cursor:pointer;
      user-select:none;
    }
    .soundBtn.on{
      border-color: rgba(34,197,94,.45);
      box-shadow:0 0 0 3px rgba(34,197,94,.15);
    }

    .grid{
      flex:1;
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:10px;
      min-height:0;
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:0 18px 50px rgba(0,0,0,.55);
      padding:14px 14px;
      box-sizing:border-box;
      min-height:0;
      overflow:hidden;
    }

    #leftPanel{ display:flex; flex-direction:column; gap:10px; min-height:0; }
    #leftScroll{ min-height:0; overflow:hidden; }

    .secTitle{
      margin:0 0 6px 0;
      font-size:15px;
      letter-spacing:.10em;
      color:var(--muted);
      font-weight:800;
    }

    #question{
      margin:0;
      font-size:clamp(30px, 4.1vw, 44px);
      line-height:1.12;
      font-weight:900;
      letter-spacing:.02em;
      text-align:left;
      padding:0 2px;
    }

    #choices{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
    }

    .choice{
      background:rgba(2,6,23,.6);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:10px 12px;
      font-size:clamp(18px, 2.05vw, 22px);
      line-height:1.20;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }

    .badge{
      min-width:42px;
      height:34px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      color:#0b1220;
      margin-top:2px;
      flex:0 0 auto;
    }
    .badge.A{background:var(--color-a);}
    .badge.B{background:var(--color-b);}
    .badge.C{background:var(--color-c);}
    .badge.D{background:var(--color-d); color:#fff;}
    .badge.E{background:var(--color-e); color:#fff;}
    .badge.O{background:var(--color-o);}
    .badge.X{background:var(--color-x); color:#fff;}

    .choice.correct{
      border:2px solid rgba(34,197,94,.85);
      box-shadow:0 0 0 3px rgba(34,197,94,.15);
    }

    @keyframes pulseGreen {
      0%   { box-shadow:0 0 0 0 rgba(34,197,94,.55); }
      70%  { box-shadow:0 0 0 14px rgba(34,197,94,0); }
      100% { box-shadow:0 0 0 0 rgba(34,197,94,0); }
    }
    body.closed .choice.correct{ animation:pulseGreen 1.3s infinite; }

    #answerBox{
      display:none;
      margin-top:10px;
      padding:14px 14px;
      border-radius:18px;
      background:rgba(2,6,23,.78);
      border:1px solid rgba(34,197,94,.45);
    }
    #answerBox.show{ display:block; }
    #answerLine{
      font-size:clamp(26px, 3.2vw, 34px);
      font-weight:1000;
      color:var(--ok);
      margin:0 0 8px 0;
      letter-spacing:.04em;
    }
    #explanationLine{
      margin:0;
      font-size:clamp(18px, 2.5vw, 26px);
      line-height:1.40;
      color:#e5e7eb;
      white-space:pre-wrap;
    }

    #rightPanel{ display:flex; flex-direction:column; gap:10px; min-height:0; }

    /* ===== Á∏¶Ê£í„ÉÅ„É£„Éº„ÉàÂõ∫ÂÆö ===== */
    #vchartWrap{
      flex:1;
      min-height:0;
      border-radius:18px;
      background:rgba(2,6,23,.55);
      border:1px solid rgba(255,255,255,.08);
      padding:12px 10px 8px;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      overflow:hidden;
    }
    #vchart{
      flex:1;
      display:flex;
      align-items:flex-end;
      justify-content:space-around;
      gap:10px;
      padding:6px 4px 4px;
      box-sizing:border-box;
      min-height:0;
    }
    .col{
      width:100%;
      max-width:60px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-end;
      gap:6px;
    }
    body.closed .col{ max-width:74px; }

    .count{
      font-size:14px;
      font-weight:900;
      color:#e5e7eb;
      line-height:1.1;
      min-height:20px;
      text-align:center;
      white-space:nowrap;
    }
    body.closed .count{ font-size:16px; }

    .bar{
      width:100%;
      border-radius:12px 12px 6px 6px;
      background:rgba(255,255,255,.12);
      position:relative;
      overflow:hidden;
      height:12px;
      transition:height .2s ease;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
    }
    .barFill{ position:absolute; inset:0; opacity:.95; }
    .lab{
      font-size:15px;
      font-weight:900;
      color:var(--muted);
      letter-spacing:.06em;
    }
    body.closed .correctBar{
      animation:pulseGreen 1.3s infinite;
      border-radius:16px 16px 10px 10px;
    }

    /* QR */
    #qrLayer{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.92);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:999;
      opacity:1;
      transition:opacity .45s ease;
    }
    #qrLayer.hidden{ opacity:0; pointer-events:none; }
    .qrBox{
      width:min(920px, 94vw);
      border-radius:28px;
      padding:20px 20px 14px;
      background:var(--panel);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 24px 80px rgba(0,0,0,.75);
      text-align:center;
    }
    .qrTitle{
      margin:0 0 6px 0;
      font-size:22px;
      letter-spacing:.10em;
      font-weight:900;
    }
    .qrHint{
      margin:0 0 10px 0;
      color:var(--muted);
      font-size:16px;
    }
    #qrcode{
      display:flex;
      justify-content:center;
      align-items:center;
      margin:8px 0 8px;
    }
    #qrcode canvas{
      width:min(560px, 70vw) !important;
      height:min(560px, 70vw) !important;
      border-radius:18px;
      background:#fff;
      padding:8px;
      box-sizing:border-box;
    }
    #qrCount{ margin-top:6px; color:rgba(203,213,225,.9); font-size:14px; }

    #ending{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
      background:rgba(0,0,0,.88);
    }
    #ending.show{ display:flex; }

    #toast{
      position:fixed;
      left:50%;
      top:16px;
      transform:translateX(-50%);
      background:rgba(17,24,39,.92);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 14px;
      border-radius:999px;
      color:#f9fafb;
      font-weight:900;
      letter-spacing:.06em;
      z-index:1200;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease;
      box-shadow:0 18px 50px rgba(0,0,0,.55);
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      #leftScroll{ overflow:auto; }
    }
  </style>
</head>

<body>
  <div id="buildTag">build: 2025-12-27 / answersÈõÜË®à / vchart</div>

  <div id="toast">Ëß£Á≠îÁµÇ‰∫Ü ‚Üí Ê≠£Ëß£ÂÖ¨Èñã</div>

  <div id="qrLayer">
    <div class="qrBox">
      <div class="qrTitle">ÂèÇÂä†Áî®QR„Ç≥„Éº„Éâ</div>
      <div class="qrHint">„Çπ„Éû„Éõ„ÅßË™≠„ÅøÂèñ„Å£„Å¶ÂèÇÂä†</div>
      <div id="qrcode"></div>
      <div id="qrCount">ÂèÇÂä†‰∏≠ 0‰∫∫</div>
    </div>
  </div>

  <div id="ending">
    <div style="
      background:rgba(17,24,39,.65);
      border:1px solid rgba(255,255,255,.12);
      border-radius:26px;
      padding:28px 26px;
      width:min(860px, 92vw);
      text-align:center;
      box-shadow:0 24px 80px rgba(0,0,0,.8);
    ">
      <div style="font-size:44px;font-weight:900;letter-spacing:.06em;">ÊéàÊ•≠ÁµÇ‰∫Ü„Åó„Åæ„Åô</div>
      <div style="margin-top:8px;color:var(--muted);font-size:18px;">„ÅîÂçîÂäõ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åó„Åü„ÄÇ</div>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div class="room" id="roomLabel">ROOM</div>
      <div class="meta">
        <span id="statusLabel">status: -</span>
        <span id="countLabel">ÂèÇÂä†‰∏≠ 0‰∫∫</span>
        <button id="soundBtn" class="soundBtn">üîà Èü≥ON</button>
      </div>
    </div>

    <div class="grid" id="mainGrid">
      <div class="panel" id="leftPanel">
        <div class="secTitle">ÂïèÈ°å</div>
        <div id="leftScroll">
          <p id="question">ÔºàÂïèÈ°å„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô‚Ä¶Ôºâ</p>

          <div id="answerBox">
            <p id="answerLine"></p>
            <p id="explanationLine"></p>
          </div>

          <div id="choices"></div>
        </div>
      </div>

      <div class="panel" id="rightPanel">
        <div class="secTitle">ÈõÜË®àÔºàÁ∏¶Ê£íÔºâ</div>
        <div id="vchartWrap">
          <div id="vchart"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update } from
      "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBke-wTU16skpbK8z80ddK04tE154dHERQ",
      authDomain: "satosan-41eac.firebaseapp.com",
      databaseURL: "https://satosan-41eac-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "satosan-41eac",
      storageBucket: "satosan-41eac.firebasestorage.app",
      messagingSenderId: "992482993229",
      appId: "1:992482993229:web:e2c59b078233b0ed16e804",
      measurementId: "G-VT9FKHN3LT"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const url = new URL(location.href);
    const room = url.searchParams.get("room") || "kyoto-01";

    const roomLabel   = document.getElementById("roomLabel");
    const statusLabel = document.getElementById("statusLabel");
    const countLabel  = document.getElementById("countLabel");

    const leftScroll = document.getElementById("leftScroll");

    const qEl = document.getElementById("question");
    const cEl = document.getElementById("choices");

    const answerBox = document.getElementById("answerBox");
    const answerLine = document.getElementById("answerLine");
    const explanationLine = document.getElementById("explanationLine");

    const vchart = document.getElementById("vchart");

    const qrLayer = document.getElementById("qrLayer");
    const qrDiv   = document.getElementById("qrcode");
    const qrCount = document.getElementById("qrCount");

    const ending = document.getElementById("ending");
    const toast  = document.getElementById("toast");

    // ---- Sound ----
    const soundBtn = document.getElementById("soundBtn");
    const se = new Audio("poyon.mp3");
    se.preload = "auto";
    se.volume = 0.55;
    let soundEnabled = false;
    let lastAnswerTotal = 0;

    soundBtn.onclick = async () => {
      try{
        await se.play();
        se.pause();
        se.currentTime = 0;
        soundEnabled = true;
        soundBtn.classList.add("on");
        soundBtn.textContent = "üîä Èü≥ON";
      }catch(e){
        soundEnabled = false;
        soundBtn.classList.remove("on");
        soundBtn.textContent = "üîà Èü≥ONÔºàÊäº„Åó„Å¶Ôºâ";
      }
    };

    roomLabel.textContent = `ROOM: ${room}`;

    const activityRef = ref(db, `rooms/${room}/activity`);
    const qidRef      = ref(db, `rooms/${room}/quiz/current_question_id`);
    const answersRef  = ref(db, `rooms/${room}/answers`);
    const qRef = (qid) => ref(db, `rooms/${room}/questions/${qid}`);

    // displayËµ∑Âãï„ÅßÂº∑Âà∂QR
    update(activityRef, { qr: true }).catch(()=>{});

    // QRÔºàÂõ∫ÂÆöURLÔºâ
    const studentUrl = `https://qzp04374-code.github.io/quiz-app/exp-display/student.html?room=${encodeURIComponent(room)}`;
    function drawQR(){
      qrDiv.innerHTML = "";
      // eslint-disable-next-line no-undef
      new QRCode(qrDiv, { text: studentUrl, width: 540, height: 540 });
    }
    drawQR();

    let isQR = true;
    let currentStatus = "-";
    let lastStatus = null;
    let currentQuestion = null;

    // ‚òÖ„Åì„Åì„ÅåËÇùÔºöchoices„ÅÆÈ†ÜÂ∫è„Çí activity „Åã„Çâ‰øùÊåÅÔºà„Å™„Åë„Çå„Å∞ÂïèÈ°å„Åã„ÇâÊé®ÂÆöÔºâ
    let currentMode = null;
    let currentChoices = ["A","B","C","D","E"];

    function showToast(){
      toast.style.opacity = "1";
      setTimeout(()=> toast.style.opacity = "0", 1200);
    }

    function showQR(){
      isQR = true;
      qrLayer.classList.remove("hidden");
      document.getElementById("mainGrid").style.visibility = "hidden";
    }

    function hideQRWithFade(){
      isQR = false;
      qrLayer.classList.add("hidden");
      setTimeout(()=>{
        if (!isQR) document.getElementById("mainGrid").style.visibility = "visible";
      }, 460);
    }

    function placeAnswerBoxTop(isTop){
      if (!leftScroll) return;
      if (isTop) leftScroll.insertBefore(answerBox, cEl);
      else leftScroll.appendChild(answerBox);
    }

    function colorOf(label){
      const css = getComputedStyle(document.documentElement);
      switch(label){
        case "O": return css.getPropertyValue("--color-o");
        case "X": return css.getPropertyValue("--color-x");
        case "A": return css.getPropertyValue("--color-a");
        case "B": return css.getPropertyValue("--color-b");
        case "C": return css.getPropertyValue("--color-c");
        case "D": return css.getPropertyValue("--color-d");
        case "E": return css.getPropertyValue("--color-e");
        default:  return "#94a3b8";
      }
    }

    function renderChoices(choicesObj, correctKey, showCorrect){
      cEl.innerHTML = "";
      const entries = Object.entries(choicesObj || {});
      entries.forEach(([k, v]) => {
        const key = String(k).trim().toUpperCase();
        const row = document.createElement("div");
        row.className = "choice";
        if (showCorrect && correctKey && key === correctKey) row.classList.add("correct");

        const b = document.createElement("div");
        b.className = `badge ${key}`;
        b.textContent = key;

        const t = document.createElement("div");
        t.textContent = v;

        row.appendChild(b);
        row.appendChild(t);
        cEl.appendChild(row);
      });
    }

    function renderAnswerBox(q){
      const show = (currentStatus === "closed") && q && (q.answer || q.explanation);
      if (!show){
        answerBox.classList.remove("show");
        answerLine.textContent = "";
        explanationLine.textContent = "";
        return;
      }
      answerBox.classList.add("show");
      answerLine.textContent = q.answer ? `Ê≠£Ëß£Ôºö${String(q.answer).toUpperCase()}` : "Ê≠£Ëß£Ôºö‚Äî";
      explanationLine.textContent = q.explanation ? `Ëß£Ë™¨Ôºö${q.explanation}` : "";
    }

    // ‚òÖÁ∏¶Ê£íÔºöchoicesÈ†Ü„ÅßÂõ∫ÂÆöË°®Á§∫
    function renderVChart(counts, order){
      vchart.innerHTML = "";

      const ord = Array.isArray(order) && order.length ? order : Object.keys(counts || {});
      if (!ord.length){
        vchart.innerHTML = `<div style="color:rgba(203,213,225,.9);">ÔºàÈõÜË®àÂæÖ„Å°Ôºâ</div>`;
        return;
      }

      const entries = ord.map(k => [String(k).toUpperCase(), Number((counts||{})[k]||0)]);
      const max = Math.max(...entries.map(([,v])=>v), 1);
      const total = entries.reduce((s,[,v]) => s + (Number(v)||0), 0) || 1;

      const correctKey = (currentQuestion && currentQuestion.answer)
        ? String(currentQuestion.answer).trim().toUpperCase()
        : null;

      entries.forEach(([lab, val]) => {
        const col = document.createElement("div");
        col.className = "col";

        const cnt = document.createElement("div");
        cnt.className = "count";
        const pct = Math.round((val / total) * 100);
        cnt.textContent = `${val}Ôºà${pct}%Ôºâ`;

        const bar = document.createElement("div");
        bar.className = "bar";
        const h = Math.max(12, Math.round((val / max) * 250));
        bar.style.height = `${h}px`;

        if (currentStatus === "closed" && correctKey && lab === correctKey){
          bar.classList.add("correctBar");
        }

        const fill = document.createElement("div");
        fill.className = "barFill";
        fill.style.background = colorOf(lab);

        bar.appendChild(fill);

        const label = document.createElement("div");
        label.className = "lab";
        label.textContent = lab;

        col.appendChild(cnt);
        col.appendChild(bar);
        col.appendChild(label);

        vchart.appendChild(col);
      });
    }

    // ===== ÂèÇÂä†‰∫∫Êï∞ + ÈõÜË®àÔºàanswersÁõ¥ÈõÜË®àÔºâ =====
    onValue(answersRef, snap => {
      const ans = snap.val() || {};
      const keys = Object.keys(ans);
      const n = keys.length;

      countLabel.textContent = `ÂèÇÂä†‰∏≠ ${n}‰∫∫`;
      qrCount.textContent = `ÂèÇÂä†‰∏≠ ${n}‰∫∫`;

      // Èü≥ÔºöÂõûÁ≠îÊï∞Â¢óÂä†„ÅßÈ≥¥„Çâ„ÅôÔºàË¶ÅÔºöÈü≥ON„ÇØ„É™„ÉÉ„ÇØÔºâ
      if (soundEnabled && n > lastAnswerTotal){
        se.currentTime = 0;
        se.play().catch(()=>{});
      }
      lastAnswerTotal = n;

      // ‚òÖ„Åì„Åì„ÅßÈõÜË®à„Çí‰Ωú„ÇãÔºàindex/result„Å´‰æùÂ≠ò„Åó„Å™„ÅÑÔºâ
      const counts = {};
      (currentChoices || []).forEach(c => counts[c] = 0);

      // Â≠¶Áîü„ÅØ {value, timestamp} ÂΩ¢Âºè„ÅßÊäï„Åí„Çã:contentReference[oaicite:1]{index=1}
      keys.forEach(uid => {
        const v = ans[uid];
        let val = null;
        if (typeof v === "string") val = v;
        else if (v && typeof v === "object" && typeof v.value === "string") val = v.value;
        if (!val) return;

        const key = String(val).trim().toUpperCase();
        if (counts[key] !== undefined) counts[key] += 1;
      });

      // text„É¢„Éº„Éâ„ÅØ‰∫∫Êï∞„Å†„ÅëÔºàÂøÖË¶Å„Å™„ÇâÂæå„Åß‰∏ÄË¶ß„ÇÇÔºâ
      if (currentMode === "text"){
        renderVChart({ "ÂõûÁ≠îÊï∞": n }, ["ÂõûÁ≠îÊï∞"]);
      } else {
        renderVChart(counts, currentChoices);
      }
    });

    // activityÔºöqr/status/ending/mode/choices
    onValue(activityRef, snap => {
      const a = snap.val() || {};

      currentStatus = a.status || "-";
      statusLabel.textContent = `status: ${currentStatus}`;
      document.body.classList.toggle("closed", currentStatus === "closed");
      placeAnswerBoxTop(currentStatus === "closed");

      // mode / choices „ÇíÊõ¥Êñ∞Ôºà„Åì„Åì„ÅåÈõÜË®à„ÅÆÂü∫Ê∫ñÔºâ
      currentMode = a.mode || null;
      const cfgChoices = (a.config && Array.isArray(a.config.choices)) ? a.config.choices : null;
      if (cfgChoices && cfgChoices.length) currentChoices = cfgChoices.map(x => String(x).toUpperCase());

      if (a.ending === true) ending.classList.add("show");
      else ending.classList.remove("show");

      const q = (a.qr === true);
      if (q) showQR();
      else hideQRWithFade();

      if (lastStatus !== "closed" && currentStatus === "closed") showToast();
      lastStatus = currentStatus;

      renderAnswerBox(currentQuestion);
      if (currentQuestion && currentQuestion.choices){
        const ck = currentQuestion.answer ? String(currentQuestion.answer).trim().toUpperCase() : null;
        renderChoices(currentQuestion.choices, ck, currentStatus === "closed");
      }
    });

    // ÂïèÈ°åË°®Á§∫
    let unsubQ = null;
    onValue(qidRef, snap => {
      const qid = snap.val();
      if (!qid){
        currentQuestion = null;
        qEl.textContent = "ÔºàÂïèÈ°å„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô‚Ä¶Ôºâ";
        cEl.innerHTML = "";
        renderAnswerBox(null);
        placeAnswerBoxTop(false);
        return;
      }

      if (unsubQ) unsubQ();
      unsubQ = onValue(qRef(qid), qsnap => {
        const q = qsnap.val();
        if (!q){
          currentQuestion = null;
          qEl.textContent = "ÔºàÂïèÈ°å„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„ÇìÔºâ";
          cEl.innerHTML = "";
          renderAnswerBox(null);
          placeAnswerBoxTop(false);
          return;
        }

        currentQuestion = q;
        qEl.textContent = q.question || "";

        // ‚òÖÂïèÈ°å„Å´ choices „Åå„ÅÇ„Çã„Å™„Çâ„ÄÅ„Åù„Çå„ÇíÂÑ™ÂÖà„Åó„Å¶‰∏¶„Å≥È†Ü„Å´‰Ωø„ÅÜ
        if (q.choices && typeof q.choices === "object"){
          const ord = Object.keys(q.choices).map(k => String(k).toUpperCase());
          if (ord.length) currentChoices = ord;
        }

        const correctKey = q.answer ? String(q.answer).trim().toUpperCase() : null;

        placeAnswerBoxTop(currentStatus === "closed");
        renderChoices(q.choices || {}, correctKey, currentStatus === "closed");
        renderAnswerBox(q);
      });
    });
  </script>
</body>
</html>
