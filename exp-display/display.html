<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClassSync Display</title>

  <style>
    :root{
      --bg:#050608;
      --panel:rgba(17,24,39,.55);
      --line:rgba(255,255,255,.10);
      --ink:#f9fafb;
      --muted:#cbd5e1;

      /* è‰²å¯¾å¿œï¼šæ­£æœ¬ï¼ˆindex/studentã¨ä¸€è‡´ï¼‰ */
      --color-o:#34c759;
      --color-x:#ff3b30;
      --color-a:#0a84ff;
      --color-b:#30d158;
      --color-c:#ff9f0a;
      --color-d:#bf5af2;
      --color-e:#ff375f;

      --ok:#22c55e;
    }

    body{
      margin:0;
      min-height:100vh;
      background:var(--bg);
      color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
      overflow:hidden;
    }

    #buildTag{
      position:fixed; right:12px; bottom:10px;
      opacity:.55; font-size:12px; z-index:9999;
      background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.08);
      padding:6px 10px; border-radius:999px;
      backdrop-filter: blur(8px);
    }

    /* pollãƒ¢ãƒ¼ãƒ‰ï¼šå·¦ã‚’æ¶ˆã—ã¦é›†è¨ˆå…¨å¹… */
    body.poll #leftPanel{ display:none !important; }
    body.poll .grid{ grid-template-columns: 1fr !important; }
    body.poll.closed .grid{ grid-template-columns: 1fr !important; }

    /* textãƒ¢ãƒ¼ãƒ‰ï¼šå³å´ã‚’ï¼ˆäººæ•°ãƒãƒ¼ï¼‹ä¸€è¦§ï¼‰ã«æœ€é©åŒ– */
    body.textmode #vchartWrap{
      flex: 0 0 auto;
      height: 120px;
    }
    body.textmode #vchart{
      align-items:center;
      justify-content:flex-start;
      padding: 10px 12px;
    }
    body.textmode #textAnswersBox{
      display:block !important;
      flex: 1 1 auto;
      max-height:none !important;
      overflow:auto;
    }

    .wrap{
      height:100vh;
      display:flex;
      flex-direction:column;
      padding:16px 16px 14px;
      box-sizing:border-box;
      gap:10px;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:18px;
      background:var(--panel);
      border:1px solid var(--line);
      box-shadow:0 18px 50px rgba(0,0,0,.55);
    }
    .room{
      font-weight:900;
      letter-spacing:.08em;
      font-size:18px;
      white-space:nowrap;
    }
    .meta{
      color:var(--muted);
      font-size:14px;
      display:flex;
      gap:12px;
      align-items:center;
      white-space:nowrap;
    }
    .soundBtn{
      background:rgba(2,6,23,.6);
      border:1px solid rgba(255,255,255,.12);
      color:#f9fafb;
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      letter-spacing:.06em;
      cursor:pointer;
      user-select:none;
    }
    .soundBtn.on{
      border-color: rgba(34,197,94,.45);
      box-shadow:0 0 0 3px rgba(34,197,94,.15);
    }

    .grid{
      flex:1;
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:10px;
      min-height:0;
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:0 18px 50px rgba(0,0,0,.55);
      padding:14px 14px;
      box-sizing:border-box;
      min-height:0;
      overflow:hidden;
    }

    .secTitle{
      margin:0 0 6px 0;
      font-size:15px;
      letter-spacing:.10em;
      color:var(--muted);
      font-weight:800;
    }

    /* å·¦ï¼ˆæˆæ¥­ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰ */
    #leftPanel{ display:flex; flex-direction:column; gap:10px; min-height:0; }
    #leftScroll{ min-height:0; overflow:hidden; }
    /* è§£ç­”çµ‚äº†ï¼ˆclosedï¼‰æ™‚ã¯ã€å·¦å´ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã—ã¦é¸æŠè‚¢ãŒåˆ‡ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ */
    body.closed #leftScroll{
      overflow:auto;
      padding-right:8px; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ä½™ç™½ï¼ˆä»»æ„ï¼‰ */
    }

    #question{
      margin:0;
      font-size:clamp(30px, 4.1vw, 44px);
      line-height:1.12;
      font-weight:900;
      letter-spacing:.02em;
      text-align:left;
      padding:0 2px;
    }
    #choices{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
    }
    .choice{
      background:rgba(2,6,23,.6);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:10px 12px;
      font-size:clamp(18px, 2.05vw, 22px);
      line-height:1.20;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .badge{
      min-width:46px;
      height:34px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      color:#0b1220;
      margin-top:2px;
      flex:0 0 auto;
      letter-spacing:.06em;
    }
    .badge.A{background:var(--color-a);}
    .badge.B{background:var(--color-b);}
    .badge.C{background:var(--color-c);}
    .badge.D{background:var(--color-d); color:#fff;}
    .badge.E{background:var(--color-e); color:#fff;}
    .badge.O{background:var(--color-o);}
    .badge.X{background:var(--color-x); color:#fff;}

    .choice.correct{
      border:2px solid rgba(34,197,94,.85);
      box-shadow:0 0 0 3px rgba(34,197,94,.15);
    }
    @keyframes pulseGreen {
      0%   { box-shadow:0 0 0 0 rgba(34,197,94,.55); }
      70%  { box-shadow:0 0 0 14px rgba(34,197,94,0); }
      100% { box-shadow:0 0 0 0 rgba(34,197,94,0); }
    }
    body.closed .choice.correct{ animation:pulseGreen 1.3s infinite; }

    /* è§£èª¬ */
    #answerBox{
      display:none;
      margin-top:10px;
      padding:14px 14px;
      border-radius:18px;
      background:rgba(2,6,23,.78);
      border:1px solid rgba(34,197,94,.45);
    }
    #answerBox.show{ display:block; }
    #answerLine{
      font-size:clamp(26px, 3.2vw, 34px);
      font-weight:1000;
      color:var(--ok);
      margin:0 0 8px 0;
      letter-spacing:.04em;
    }
    #explanationLine{
      margin:0;
      font-size:clamp(18px, 2.5vw, 26px);
      line-height:1.40;
      color:#e5e7eb;
      white-space:pre-wrap;
    }

    /* å³ï¼šé›†è¨ˆï¼ˆç¸¦æ£’ï¼‰ */
    #rightPanel{ display:flex; flex-direction:column; gap:10px; min-height:0; }
    #vchartWrap{
      flex:1;
      min-height:0;
      border-radius:18px;
      background:rgba(2,6,23,.55);
      border:1px solid rgba(255,255,255,.08);
      padding:12px 10px 8px;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    #vchart{
      flex:1;
      display:flex;
      align-items:flex-end;
      justify-content:space-around;
      gap:12px;
      padding:6px 6px 2px;
      box-sizing:border-box;
      min-height:0;
    }
    .col{
      width:100%;
      max-width:84px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-end;
      gap:6px;
    }
    .count{
      font-size:14px;
      font-weight:1000;
      color:#e5e7eb;
      line-height:1.1;
      min-height:20px;
      text-align:center;
      white-space:nowrap;
    }
    .bar{
      width:100%;
      border-radius:12px 12px 6px 6px;
      background:rgba(255,255,255,.12);
      position:relative;
      overflow:hidden;
      height:12px;
      transition:height .2s ease;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
    }
    .barFill{ position:absolute; inset:0; opacity:.95; }
    .lab{
      font-size:16px;
      font-weight:1000;
      color:var(--muted);
      letter-spacing:.08em;
    }

    /* textå›ç­”ä¸€è¦§ */
    #textAnswersBox{
      display:none;
      border-radius:18px;
      background:rgba(2,6,23,.55);
      border:1px solid rgba(255,255,255,.08);
      padding:12px 12px;
      box-sizing:border-box;
      max-height:38vh;
      overflow:auto;
      min-height:0;
    }
    #textAnswersBox.show{ display:block; }
    #textAnswersTitle{
      font-weight:1000;
      letter-spacing:.08em;
      color:rgba(203,213,225,.92);
      margin:0 0 8px 0;
      font-size:13px;
    }
    .textItem{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.25);
      margin-bottom:8px;
      font-size:clamp(18px, 2.1vw, 24px);
      line-height:1.35;
      color:#f9fafb;
      white-space:pre-wrap;
    }
    .textItem .no{
      display:inline-block;
      min-width:44px;
      margin-right:8px;
      color:rgba(203,213,225,.85);
      font-weight:1000;
      letter-spacing:.06em;
    }

    /* QR */
    #qrLayer{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.92);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:999;
      opacity:1;
      transition:opacity .45s ease;
    }
    #qrLayer.hidden{ opacity:0; pointer-events:none; }
    .qrBox{
      width:min(920px, 94vw);
      border-radius:28px;
      padding:20px 20px 14px;
      background:var(--panel);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 24px 80px rgba(0,0,0,.75);
      text-align:center;
    }
    .qrTitle{
      margin:0 0 6px 0;
      font-size:22px;
      letter-spacing:.10em;
      font-weight:1000;
    }
    .qrHint{
      margin:0 0 10px 0;
      color:var(--muted);
      font-size:16px;
    }
    #qrcode{
      display:flex;
      justify-content:center;
      align-items:center;
      margin:8px 0 8px;
    }
    #qrcode canvas{
      width:min(520px, 68vw) !important;
      height:min(520px, 68vw) !important;
      border-radius:18px;
      background:#fff;
      padding:8px;
      box-sizing:border-box;
    }
    #qrCount{ margin-top:6px; color:rgba(203,213,225,.9); font-size:14px; }

    #toast{
      position:fixed;
      left:50%;
      top:16px;
      transform:translateX(-50%);
      background:rgba(17,24,39,.92);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 14px;
      border-radius:999px;
      color:#f9fafb;
      font-weight:1000;
      letter-spacing:.06em;
      z-index:1200;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease;
      box-shadow:0 18px 50px rgba(0,0,0,.55);
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      #leftScroll{ overflow:auto; }
      body.poll #leftPanel{ display:none !important; }
    }

    /* =========================
       Timer Progress Bar
       ========================= */
    #timerBarWrap{
      width: 180px;              /* ãƒãƒ¼ã®æ¨ªå¹…ï¼ˆå¥½ã¿ã§èª¿æ•´ï¼‰ */
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
      overflow: hidden;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    }

    #timerBar{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      transform-origin: left;
      transition: width .15s linear;
      background: linear-gradient(90deg,
        rgba(34,197,94,.95),   /* green */
        rgba(245,158,11,.95),  /* amber */
        rgba(239,68,68,.95)    /* red */
      );
      box-shadow: 0 10px 28px rgba(0,0,0,.28);
    }

    /* ã‚¿ã‚¤ãƒãƒ¼å‹•ä½œä¸­ã¯æ•°å­—ã‚’å°‘ã—å¼·èª¿ */
    body.timer-running #timerLabel{
      color:#fff;
      text-shadow: 0 0 16px rgba(255,255,255,.18);
    }

    /* æ®‹ã‚Šã‚ãšã‹ã®æ³¨æ„å–šèµ·ï¼ˆä»»æ„ï¼šã‚ã¨ã§ONã«ã§ãã‚‹ï¼‰ */
    body.timer-urgent #timerBar{
      animation: timerPulse .7s infinite;
    }
    @keyframes timerPulse{
      0%   { filter: brightness(1.0); }
      50%  { filter: brightness(1.35); }
      100% { filter: brightness(1.0); }
    }

    
  </style>
</head>

<body>
  <div id="buildTag">build: 2026-01-03 / q1fix-textlist-fullheight</div>
  <div id="toast">è§£ç­”çµ‚äº† â†’ å…¬é–‹</div>

  <div id="qrLayer">
    <div class="qrBox">
      <div class="qrTitle">å‚åŠ ç”¨QRã‚³ãƒ¼ãƒ‰</div>
      <div class="qrHint">ã‚¹ãƒãƒ›ã§èª­ã¿å–ã£ã¦å‚åŠ </div>
      <div id="qrcode"></div>
      <div id="qrCount">å‚åŠ ä¸­ 0äºº</div>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div class="room" id="roomLabel">ROOM</div>
      <div class="meta">
        <span id="statusLabel">status: -</span>
        <span id="countLabel">å‚åŠ ä¸­ 0äºº</span>
        <span id="timerLabel" style="font-weight:1000;">â± --:--</span>

        <div id="timerBarWrap" aria-hidden="true">
          <div id="timerBar"></div>
        </div>
        
        <button id="soundBtn" class="soundBtn">ğŸ”ˆ éŸ³OFFï¼ˆã‚¿ãƒƒãƒ—ã§ONï¼‰</button>

      </div>
    </div>

    <div class="grid" id="mainGrid">
      <div class="panel" id="leftPanel">
        <div class="secTitle">å•é¡Œ</div>
        <div id="leftScroll">
          <p id="question">ï¼ˆå•é¡Œã‚’å¾…ã£ã¦ã„ã¾ã™â€¦ï¼‰</p>

          <div id="answerBox">
            <p id="answerLine"></p>
            <p id="explanationLine"></p>
          </div>

          <div id="choices"></div>
        </div>
      </div>

      <div class="panel" id="rightPanel">
        <div class="secTitle" id="rightTitle">é›†è¨ˆï¼ˆç¸¦æ£’ï¼‰</div>
        <div id="vchartWrap">
          <div id="vchart"></div>
        </div>

        <div id="textAnswersBox">
          <div id="textAnswersTitle">æ–‡å­—å›ç­”ï¼ˆè§£ç­”çµ‚äº†ã§è¡¨ç¤ºï¼‰</div>
          <div id="textAnswersList"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update } from
      "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBke-wTU16skpbK8z80ddK04tE154dHERQ",
      authDomain: "satosan-41eac.firebaseapp.com",
      databaseURL: "https://satosan-41eac-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "satosan-41eac"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const url = new URL(location.href);
    const room = url.searchParams.get("room") || "kyoto-01";

    const roomLabel   = document.getElementById("roomLabel");
    const statusLabel = document.getElementById("statusLabel");
    const countLabel  = document.getElementById("countLabel");
    const timerLabel  = document.getElementById("timerLabel");
    
    const leftScroll = document.getElementById("leftScroll");
    const qEl = document.getElementById("question");
    const cEl = document.getElementById("choices");

    const answerBox = document.getElementById("answerBox");
    const answerLine = document.getElementById("answerLine");
    const explanationLine = document.getElementById("explanationLine");

    const vchart = document.getElementById("vchart");
    const rightTitle = document.getElementById("rightTitle");

    const textBox = document.getElementById("textAnswersBox");
    const textList = document.getElementById("textAnswersList");
    const textTitle = document.getElementById("textAnswersTitle");

    const qrLayer = document.getElementById("qrLayer");
    const qrDiv   = document.getElementById("qrcode");
    const qrCount = document.getElementById("qrCount");

    const toast  = document.getElementById("toast");

    /* =========================================================
   å›ºå®šãƒ¡ãƒ¢ï¼ˆå£Šã•ãªã„æœ€å„ªå…ˆäº‹é …ï¼‰
   - displayã¯ã€Œæ§‹é€ ï¼ˆactivity / questionï¼‰ã€ã§æç”»ã‚’æ±ºã‚ã‚‹
   - answersã¯UIæ§‹é€ ã‚’æ±ºã‚ãªã„ï¼ˆæ•°ãˆã‚‹ã ã‘ï¼æ­£è¦ã‚½ãƒ¼ã‚¹ã¯ rooms/{room}/answersï¼‰
   - quizï¼šé›†è¨ˆã®choiceé †ã¯ currentQuestion.choices ã‚’å„ªå…ˆï¼ˆå•é¡Œã¨é›†è¨ˆã®ä¸€è‡´ã‚’ä¿è¨¼ï¼‰
   - pollï¼šé›†è¨ˆã®choiceé †ã¯ activity.config.choicesï¼ˆãªã‘ã‚Œã° mode ã‹ã‚‰è£œå®Œï¼‰
   - view/mode/status ãŒå¤‰ã‚ã£ãŸã‚‰å¿…ãšå†æç”»ï¼ˆpoll TEXTã®closedè¡¨ç¤ºã‚‚å«ã‚€ï¼‰
   - pollã«å…¥ã£ãŸã‚‰ quizã®å•é¡Œè³¼èª­ã¯å¿…ãšè§£é™¤ï¼ˆunsubQï¼‰
   ========================================================= */

    // ===== Sound: poyon.mp3ï¼ˆåŒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰ =====
    const soundBtn = document.getElementById("soundBtn");
    const se = new Audio("./poyon.mp3");
    se.preload = "auto";
    se.volume = 0.6;

    // ===== SE: closed gongï¼ˆåŒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰=====
    const gong = new Audio("./gong.mp3"); // â€»ãƒ•ã‚¡ã‚¤ãƒ«åã¯ gong.mp3 æ¨å¥¨
    gong.preload = "auto";
    gong.volume = 0.8;

    let soundEnabled = false;
    let soundUnlocked = false;
    let lastAnswerTotal = 0;

    async function unlockSound(){
      if (soundUnlocked) return true;
      try{
        await se.play();
        se.pause();
        se.currentTime = 0;
        soundUnlocked = true;
        soundEnabled = true;
        soundBtn.classList.add("on");
        soundBtn.textContent = "ğŸ”Š éŸ³ON";
        return true;
      }catch(e){
        soundUnlocked = false;
        soundEnabled = false;
        soundBtn.classList.remove("on");
        soundBtn.textContent = "ğŸ”ˆ éŸ³OFFï¼ˆã‚¿ãƒƒãƒ—ã§ONï¼‰";
        return false;
      }
    }
    soundBtn.onclick = async () => { await unlockSound(); };
    (function addOneShotUnlock(){
      const handler = async () => {
        await unlockSound();
        window.removeEventListener("pointerdown", handler, true);
        window.removeEventListener("keydown", handler, true);
      };
      window.addEventListener("pointerdown", handler, true);
      window.addEventListener("keydown", handler, true);
    })();

    function playPoyon(){
      if (!soundEnabled || !soundUnlocked) return;
      try{
        se.currentTime = 0;
        se.play().catch(()=>{});
      }catch(_){}
    }

    function playGong(){
      if (!soundEnabled || !soundUnlocked) return;
      try{
        gong.currentTime = 0;
        gong.play().catch(()=>{});
      }catch(_){}
    }

    function uiLabel(key){
      const k = String(key).trim().toUpperCase();
      if (k === "O") return "â—‹";
      if (k === "X") return "âœ•";
      return k;
    }

    // ===== ABã®ã¿å•é¡Œã‚’ OX ã«çµ±ä¸€ã™ã‚‹ï¼ˆdisplayå´ã®æ­£è¦åŒ–ï¼‰=====
    function isABOnlyChoices(obj){
      if (!obj || typeof obj !== "object") return false;
      const ks = Object.keys(obj).map(k => String(k).trim().toUpperCase()).sort();
      return ks.length === 2 && ks[0] === "A" && ks[1] === "B";
    }

    function mapABtoOXKey(k){
      const key = String(k).trim().toUpperCase();
      if (key === "A") return "O";
      if (key === "B") return "X";
      return key;
    }

    function normalizeChoicesObj(choicesObj){
      // A/Bã®ã¿ãªã‚‰ O/X ã«å¤‰æ›ã—ã¦è¿”ã™ï¼ˆè¡¨ç¤ºã‚‚é›†è¨ˆã‚‚çµ±ä¸€ï¼‰
      if (!isABOnlyChoices(choicesObj)) return { obj: choicesObj, mapAB: false };

      const A = choicesObj.A ?? choicesObj.a ?? "";
      const B = choicesObj.B ?? choicesObj.b ?? "";
      return {
        mapAB: true,
        obj: { O: A, X: B }
      };
    }


    roomLabel.textContent = `ROOM: ${room}`;

    const activityRef = ref(db, `rooms/${room}/activity`);
    const qidRef      = ref(db, `rooms/${room}/quiz/current_question_id`);
    const answersRef  = ref(db, `rooms/${room}/answers`);
    const qRef = (qid) => ref(db, `rooms/${room}/questions/${qid}`);

    // displayèµ·å‹•ã§å¼·åˆ¶QR
    update(activityRef, { qr: true }).catch(()=>{});

    const studentUrl =
      `https://qzp04374-code.github.io/quiz-app/exp-display/student.html?room=${encodeURIComponent(room)}`;
    function drawQR(){
      qrDiv.innerHTML = "";
      // eslint-disable-next-line no-undef
      new QRCode(qrDiv, { text: studentUrl, width: 520, height: 520 });
    }
    drawQR();

    let isQR = true;
    let currentStatus = "-";
    let lastStatus = null;
    let currentMode = null;
    let currentView = "quiz";
    let choiceOrder = ["A","B","C","D","E"];
    let currentQuestion = null;

    let lastAnswers = {};
    
    // ===== Timer =====
    let timerState = null;
    let timerInterval = null;
    let lastAutoClosedAt = 0;

    function fmt2(n){ return String(n).padStart(2,"0"); }
    function fmtRemain(ms){
      const s = Math.max(0, Math.ceil(ms/1000));
      const m = Math.floor(s/60);
      const r = s % 60;
      return `${fmt2(m)}:${fmt2(r)}`;
    }

    function stopTimerTick(){
      if (timerInterval){ clearInterval(timerInterval); timerInterval = null; }
      if (timerLabel) timerLabel.textContent = "â± --:--";

      // â˜…è¿½åŠ 
      if (timerBar) timerBar.style.width = "0%";
      document.body.classList.remove("timer-running", "timer-urgent");
    }

    function ensureTimerTick(){
      if (timerInterval) return;
      timerInterval = setInterval(async () => {
        if (!timerState || !timerState.running || !timerState.endsAt){
          stopTimerTick();
          return;
        }    

        const remain = timerState.endsAt - Date.now();
        if (timerLabel) timerLabel.textContent = `â± ${fmtRemain(remain)}`;
        // â˜…æ®‹ã‚Š%ã§ãƒãƒ¼ã‚’ç¸®ã‚ã‚‹
        if (timerBar && timerState && timerState.durationSec){
          const totalMs = timerState.durationSec * 1000;
          const ratio = Math.max(0, Math.min(1, remain / totalMs)); // 1â†’0
          timerBar.style.width = `${Math.round(ratio * 100)}%`;

        // æ®‹ã‚Š10ç§’ã§ç‚¹æ»…ï¼ˆè¦ã‚‰ãªã‘ã‚Œã°æ¶ˆã—ã¦OKï¼‰
        document.body.classList.toggle("timer-urgent", remain <= 10_000 && remain > 0);
      }

        // 0ç§’ã§è‡ªå‹• closeï¼ˆopen ã‹ã¤ QRã§ãªã„æ™‚ã ã‘ï¼‰
        if (remain <= 0 && timerState.autoClose && currentStatus === "open" && isQR === false){
          const now = Date.now();
          // é€£æ‰“é˜²æ­¢
          if (now - lastAutoClosedAt > 1500){
            lastAutoClosedAt = now;
            await update(activityRef, { status:"closed" }).catch(()=>{});
          }
        }
      }, 250);
    }


    /* â˜…Q1æ¬ è½å¯¾ç­–ï¼šæœ€å¾Œã®QIDã‚’ä¿æŒã—ã€pollâ†’quizã§å¿…ãšè¡¨ç¤ºå‡¦ç†ã‚’å›ã™ */
    let latestQid = null;
    let unsubQ = null;

    function defaultChoicesFromMode(mode){
      if (mode === "ox") return ["O","X"];
      if (mode === "five") return ["A","B","C","D","E"];
      return ["A","B","C","D","E"];
    }

    function showToast(){
      toast.style.opacity = "1";
      setTimeout(()=> toast.style.opacity = "0", 1200);
    }

    function showQR(){
      isQR = true;
      qrLayer.classList.remove("hidden");
      document.getElementById("mainGrid").style.visibility = "hidden";
    }
    function hideQRWithFade(){
      isQR = false;
      qrLayer.classList.add("hidden");
      setTimeout(()=>{
        if (!isQR) document.getElementById("mainGrid").style.visibility = "visible";
      }, 460);
    }

    function placeAnswerBoxTop(isTop){
      if (!leftScroll) return;
      if (isTop) leftScroll.insertBefore(answerBox, cEl);
      else leftScroll.appendChild(answerBox);
    }

    function updateAnswerUI(){
      const q = currentQuestion;
      const shouldShow = (currentStatus === "closed") && q && (q.answer || q.explanation);
      placeAnswerBoxTop(currentStatus === "closed");

      if (!shouldShow){
        answerBox.classList.remove("show");
        answerLine.textContent = "";
        explanationLine.textContent = "";
        return;
      }
      answerBox.classList.add("show");
      let ans = q.answer ? String(q.answer).trim().toUpperCase() : "";
      const normAns = normalizeChoicesObj(q.choices || {});
      if (normAns.mapAB && ans) ans = mapABtoOXKey(ans);

      answerLine.textContent = ans ? `æ­£è§£ï¼š${uiLabel(ans)}` : "æ­£è§£ï¼šâ€”";
      explanationLine.textContent = q.explanation ? `è§£èª¬ï¼š${q.explanation}` : "";
    }

    function colorOf(label){
      const css = getComputedStyle(document.documentElement);
      switch(String(label).trim().toUpperCase()){
        case "O": return css.getPropertyValue("--color-o");
        case "X": return css.getPropertyValue("--color-x");
        case "A": return css.getPropertyValue("--color-a");
        case "B": return css.getPropertyValue("--color-b");
        case "C": return css.getPropertyValue("--color-c");
        case "D": return css.getPropertyValue("--color-d");
        case "E": return css.getPropertyValue("--color-e");
        default:  return "#94a3b8";
      }
    }

    function renderChoices(choicesObj, correctKey, showCorrect){
      cEl.innerHTML = "";
      const entries = Object.entries(choicesObj || {});
      entries.forEach(([k, v]) => {
        const key = String(k).trim().toUpperCase();
        const row = document.createElement("div");
        row.className = "choice";
        if (showCorrect && correctKey && key === correctKey) row.classList.add("correct");

        const b = document.createElement("div");
        b.className = `badge ${key}`;
        b.textContent = uiLabel(key);

        const t = document.createElement("div");
        t.textContent = v;

        row.appendChild(b);
        row.appendChild(t);
        cEl.appendChild(row);
      });
    }

    function renderVChart(counts, order){
      vchart.innerHTML = "";

      const ord = Array.isArray(order) && order.length ? order : Object.keys(counts || {});
      if (!ord.length){
        vchart.innerHTML = `<div style="color:rgba(203,213,225,.9);">ï¼ˆé›†è¨ˆå¾…ã¡ï¼‰</div>`;
        return;
      }

      const entries = ord.map(k => [String(k).toUpperCase(), Number((counts||{})[k]||0)]);
      const max = Math.max(...entries.map(([,v])=>v), 1);
      const total = entries.reduce((s,[,v]) => s + (Number(v)||0), 0) || 1;

      entries.forEach(([lab, val]) => {
        const col = document.createElement("div");
        col.className = "col";

        const cnt = document.createElement("div");
        cnt.className = "count";
        const pct = Math.round((val / total) * 100);
        cnt.textContent = `${val}ï¼ˆ${pct}%ï¼‰`;

        const bar = document.createElement("div");
        bar.className = "bar";
        const h = Math.max(12, Math.round((val / max) * 280));
        bar.style.height = `${h}px`;

        const fill = document.createElement("div");
        fill.className = "barFill";
        fill.style.background = colorOf(lab);
        bar.appendChild(fill);

        const label = document.createElement("div");
        label.className = "lab";
        label.textContent = uiLabel(lab);

        col.appendChild(cnt);
        col.appendChild(bar);
        col.appendChild(label);

        vchart.appendChild(col);
      });
    }

    function escapeHtml(str){
      return str
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function renderTextAnswers(answers){
      textList.innerHTML = "";
      const keys = Object.keys(answers || {});
      const items = [];

      keys.forEach(uid => {
        const v = answers[uid];
        if (typeof v === "string") items.push(v);
        else if (v && typeof v === "object" && typeof v.value === "string") items.push(v.value);
      });

      if (currentStatus !== "closed"){
        textTitle.textContent = `æ–‡å­—å›ç­”ï¼ˆè§£ç­”çµ‚äº†ã§è¡¨ç¤ºï¼‰ / ç¾åœ¨ ${items.length} ä»¶`;
        return;
      }

      textTitle.textContent = `æ–‡å­—å›ç­”ï¼ˆå…¬é–‹ä¸­ï¼‰ / ${items.length} ä»¶`;

      items.forEach((t, idx) => {
        const div = document.createElement("div");
        div.className = "textItem";
        div.innerHTML = `<span class="no">${idx+1}.</span>${escapeHtml(String(t||""))}`;
        textList.appendChild(div);
      });

      if (items.length === 0){
        const div = document.createElement("div");
        div.className = "textItem";
        div.innerHTML = `<span class="no">â€”</span>ï¼ˆå›ç­”ãªã—ï¼‰`;
        textList.appendChild(div);
      }
    }

        function getEffectiveChoiceOrder(){
      // quizä¸­ã¯ã€Œä»Šè¡¨ç¤ºã—ã¦ã„ã‚‹å•é¡Œã€ã®choicesã‚’æœ€å„ªå…ˆï¼ˆ=å³ã®é›†è¨ˆã‚‚å¿…ãšä¸€è‡´ã•ã›ã‚‹ï¼‰
      if (currentView === "quiz" && currentQuestion && currentQuestion.choices && typeof currentQuestion.choices === "object"){
        const norm = normalizeChoicesObj(currentQuestion.choices || {});
        const ord = Object.keys(norm.obj || {}).map(k => String(k).trim().toUpperCase());
        if (ord.length) return ord;
      }
      // poll/standbyç­‰ã¯å¾“æ¥é€šã‚Š activityç”±æ¥
      return Array.isArray(choiceOrder) ? choiceOrder : [];
    }

    function recomputeAndRenderFromAnswers(ans){
      const keys = Object.keys(ans || {});
      const n = keys.length;

      countLabel.textContent = `å‚åŠ ä¸­ ${n}äºº`;
      qrCount.textContent = `å‚åŠ ä¸­ ${n}äºº`;

      const isText = (currentMode === "text");
      if (isText){
        vchart.innerHTML = `
          <div style="width:100%; display:flex; align-items:center; justify-content:space-between; gap:12px;">
            <div style="font-weight:1000; letter-spacing:.10em; color:rgba(203,213,225,.92);">
              æ–‡å­—å…¥åŠ›
              <div style="margin-top:6px; font-size:14px; color:rgba(203,213,225,.85);">
                ${currentStatus === "closed" ? "å…¬é–‹ä¸­" : "å—ä»˜ä¸­ï¼ˆè§£ç­”çµ‚äº†ã§å…¬é–‹ï¼‰"}
              </div>
            </div>
            <div style="text-align:right;">
              <div style="font-size:14px; color:rgba(203,213,225,.85); font-weight:900; letter-spacing:.08em;">ä»¶æ•°</div>
              <div style="font-size:44px; font-weight:1100; line-height:1; color:#fff;">${n}</div>
            </div>
          </div>
        `;
        textBox.classList.add("show");
        renderTextAnswers(ans);
        return;
      }

      textBox.classList.remove("show");
      textList.innerHTML = "";

    const effectiveOrder = getEffectiveChoiceOrder();

    const counts = {};
    (effectiveOrder || []).forEach(c => counts[c] = 0);


      keys.forEach(uid => {
        const v = ans[uid];
        let val = null;
        if (typeof v === "string") val = v;
        else if (v && typeof v === "object" && typeof v.value === "string") val = v.value;
        if (!val) return;

    let key = String(val).trim().toUpperCase();

    // â˜…é›†è¨ˆã®åŸºæº–ãŒOXã®ã¨ãã¯ A/B ã‚’ O/X ã«çµ±ä¸€
    if (Array.isArray(effectiveOrder) && effectiveOrder.length === 2 &&
        effectiveOrder.includes("O") && effectiveOrder.includes("X")){
      key = mapABtoOXKey(key);
    }

    if (counts[key] === undefined){
      return; // æƒ³å®šå¤–ã¯ç„¡è¦–
    }
    counts[key] += 1;

      });

      renderVChart(counts, effectiveOrder);

    }

    /* â˜…QIDã‚’è¡¨ç¤ºå‡¦ç†ã«å›ã™é–¢æ•°ï¼ˆpollä¸­ã«QIDãŒæ¥ã¦ã‚‚ä¿æŒã—ã¦ã€quizã«æˆ»ã£ãŸã‚‰å¿…ãšé©ç”¨ï¼‰ */
function applyCurrentQid(){
  // quizä»¥å¤–ï¼ˆpoll/standby/qrï¼‰ã«å…¥ã£ãŸã‚‰ã€å‰ã®å•é¡Œè³¼èª­ã‚’å¿…ãšæ­¢ã‚ã‚‹
  if (currentView !== "quiz"){
    if (unsubQ) { unsubQ(); unsubQ = null; }
    return;
  }

  const qid = latestQid;

  if (unsubQ) { unsubQ(); unsubQ = null; }

  if (!qid){
    currentQuestion = null;
    qEl.textContent = "ï¼ˆå•é¡Œã‚’å¾…ã£ã¦ã„ã¾ã™â€¦ï¼‰";
    cEl.innerHTML = "";
    updateAnswerUI();
    return;
  }

  unsubQ = onValue(qRef(qid), qsnap => {
    const q = qsnap.val();
    if (!q){
      currentQuestion = null;
      qEl.textContent = "ï¼ˆå•é¡Œãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰";
      cEl.innerHTML = "";
      updateAnswerUI();
      return;
    }

    currentQuestion = q;
    qEl.textContent = q.question || "";

    // choicesæ­£è¦åŒ–ï¼ˆABã®ã¿ â†’ OXã¸ï¼‰
    const norm = normalizeChoicesObj(q.choices || {});
    const choicesForUI = norm.obj;

    // choiceOrder ã‚‚æ­£è¦åŒ–å¾Œã®ã‚­ãƒ¼ã«ã™ã‚‹
    if (choicesForUI && typeof choicesForUI === "object"){
      const ord = Object.keys(choicesForUI).map(k => String(k).trim().toUpperCase());
      if (ord.length) choiceOrder = ord;
    }

    // æ­£è§£ã‚­ãƒ¼ã‚‚å¤‰æ›ï¼ˆABã®ã¿ãªã‚‰ Aâ†’O / Bâ†’Xï¼‰
    let ck = q.answer ? String(q.answer).trim().toUpperCase() : null;
    if (norm.mapAB && ck) ck = mapABtoOXKey(ck);

    renderChoices(choicesForUI || {}, ck, currentStatus === "closed");
    updateAnswerUI();

    // â˜…å•é¡ŒãŒåˆ‡ã‚Šæ›¿ã‚ã£ãŸã‚‰ã€ä»Šã‚ã‚‹å›ç­”ã§é›†è¨ˆã‚’å³å†æç”»
    recomputeAndRenderFromAnswers(lastAnswers);
  });
}


    // activity
    onValue(activityRef, snap => {
      const a = snap.val() || {};
      currentStatus = a.status || "-";
      currentMode = a.mode || null;
      currentView = a.view || "quiz";
      timerState = a.timer || null;
      if (timerState && timerState.running && timerState.endsAt) ensureTimerTick();
      else stopTimerTick();
      document.body.classList.toggle("timer-running", !!(timerState && timerState.running && timerState.endsAt));

      statusLabel.textContent = `status: ${currentStatus}`;
      document.body.classList.toggle("poll", currentView === "poll");
      document.body.classList.toggle("closed", currentStatus === "closed");
      document.body.classList.toggle("textmode", currentMode === "text");

      rightTitle.textContent =
        (currentMode === "text") ? "æ–‡å­—å…¥åŠ›ï¼ˆä»¶æ•°ï¼‹ä¸€è¦§ï¼‰" : "é›†è¨ˆï¼ˆç¸¦æ£’ï¼‰";

      if (a.qr === true) showQR();
      else hideQRWithFade();

      const cfgChoices = (a.config && Array.isArray(a.config.choices)) ? a.config.choices : null;
      if (cfgChoices && cfgChoices.length){
        choiceOrder = cfgChoices.map(x => String(x).trim().toUpperCase());
      } else if (currentMode){
        choiceOrder = defaultChoicesFromMode(currentMode);
      }

      // â˜…configãŒABã®ã¿ã§ã‚‚ displayä¸Šã¯OXã¸çµ±ä¸€ï¼ˆA/B â†’ O/Xï¼‰
      if (choiceOrder.length === 2 && choiceOrder.includes("A") && choiceOrder.includes("B")){
        choiceOrder = ["O","X"];
      }

      if (lastStatus !== "closed" && currentStatus === "closed") {
        showToast();
ã€€ã€€ã€€ã€€ã€€playGong();
      }
      lastStatus = currentStatus;

      if (currentView === "poll"){
        if (unsubQ) { unsubQ(); unsubQ = null; }
        currentQuestion = null;
        qEl.textContent = "ï¼ˆå£é ­Q&Aï¼šé›†è¨ˆã®ã¿ï¼‰";
        cEl.innerHTML = "";
        
        // â˜…è¿½åŠ ï¼špollã¸å…¥ã£ãŸç¬é–“ã«ã€ç¾answersã§å³æç”»ï¼ˆTEXTã‚‚å«ã‚€ï¼‰
        recomputeAndRenderFromAnswers(lastAnswers);
        updateAnswerUI();
        } else if (currentView === "standby"){
          currentQuestion = null;
          qEl.textContent = "ï¼ˆã‚¹ã‚¿ãƒ³ãƒã‚¤ä¸­â€¦ å…ˆç”Ÿã®æ“ä½œã‚’å¾…ã£ã¦ã„ã¾ã™ï¼‰";
          cEl.innerHTML = "";
          updateAnswerUI();
        } else {
          updateAnswerUI();
        }

      // â˜…é‡è¦ï¼špollâ†’quizã«ãªã£ãŸç¬é–“ã«ã€ä¿æŒã—ã¦ã„ãŸQIDã‚’å¿…ãšåæ˜ ï¼ˆQ1æ¬ è½ã‚’é˜²ãï¼‰
      applyCurrentQid();

      // å³å†æç”»
      if (a.qr !== true){
        // view/mode/statusãŒå¤‰ã‚ã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å³æç”»ï¼ˆTEXTã®closedè¡¨ç¤ºã‚’ç¢ºå®Ÿã«åæ˜ ï¼‰
        recomputeAndRenderFromAnswers(lastAnswers);
      }
    });

    // qidï¼šå¸¸ã«ä¿æŒã—ã€quizçŠ¶æ…‹ãªã‚‰å³é©ç”¨
    onValue(qidRef, snap => {
      latestQid = snap.val() || null;
      applyCurrentQid();
    });

    // answersï¼šä¿å­˜ï¼‹éŸ³ï¼‹å†æç”»
    onValue(answersRef, snap => {
      const ans = snap.val() || {};
      lastAnswers = ans;

      const n = Object.keys(ans).length;
      if (n > lastAnswerTotal) playPoyon();
      lastAnswerTotal = n;

      recomputeAndRenderFromAnswers(ans);
    });
  </script>
</body>
</html>
