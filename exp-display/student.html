<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClassSync Student</title>

  <style>
    :root{
      /* display/index と同じ色（踏襲） */
      --color-o:#34c759;
      --color-x:#ff3b30;
      --color-a:#0a84ff;
      --color-b:#30d158;
      --color-c:#ff9f0a;
      --color-d:#bf5af2;
      --color-e:#ff375f;

      --bg:#050608;
      --line:rgba(255,255,255,.10);
      --ink:#f9fafb;
      --muted:rgba(203,213,225,.85);

      --shadow: 0 18px 60px rgba(0,0,0,.65);
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 20% 20%, rgba(96,165,250,.10), transparent 55%),
        radial-gradient(1000px 800px at 80% 30%, rgba(34,197,94,.08), transparent 55%),
        radial-gradient(900px 900px at 50% 90%, rgba(191,90,242,.10), transparent 60%),
        var(--bg);
      color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
      overflow:hidden;
    }

    /* 上部ステータス */
    .topbar{
      position:fixed;
      top:12px; left:12px; right:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:18px;
      background:rgba(17,24,39,.55);
      border:1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
      box-shadow:0 18px 60px rgba(0,0,0,.45);
      z-index:10;
    }
    .room{
      font-weight:1000;
      letter-spacing:.10em;
      font-size:14px;
      white-space:nowrap;
    }
    .status{
      font-weight:900;
      font-size:13px;
      color:var(--muted);
      letter-spacing:.06em;
      display:flex;
      gap:10px;
      align-items:center;
      white-space:nowrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(2,6,23,.45);
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background:#9ca3af;
      box-shadow:0 0 0 3px rgba(156,163,175,.15);
    }
    .dot.open{
      background:#22c55e;
      box-shadow:0 0 0 3px rgba(34,197,94,.18), 0 0 16px rgba(34,197,94,.35);
    }
    .dot.closed{
      background:#ef4444;
      box-shadow:0 0 0 3px rgba(239,68,68,.18), 0 0 16px rgba(239,68,68,.25);
    }

    /* 画面中央：コントローラー本体 */
    .stage{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:88px 14px 18px;
    }

    .controller{
      width:min(720px, 94vw);
      height:min(520px, 72vh);
      position:relative;
      border-radius:48px;
      background:
        radial-gradient(100% 120% at 50% 20%, rgba(255,255,255,.06), transparent 55%),
        linear-gradient(180deg, rgba(17,24,39,.92), rgba(2,6,23,.88));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      overflow:hidden;
      padding:18px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:12px;
    }

    /* グリップ */
    .controller::before,
    .controller::after{
      content:"";
      position:absolute;
      top:64%;
      width:44%;
      height:60%;
      border-radius:60px;
      background:
        radial-gradient(90% 80% at 50% 10%, rgba(255,255,255,.05), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.22));
      border:1px solid rgba(255,255,255,.08);
      z-index:0;
    }
    .controller::before{ left:-14%; transform:rotate(10deg); }
    .controller::after { right:-14%; transform:rotate(-10deg); }

    .controller > *{ position:relative; z-index:1; }

    /* 中央表示 */
    .hud{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:18px;
      background:rgba(2,6,23,.55);
      border:1px solid rgba(255,255,255,.08);
      letter-spacing:.10em;
      font-weight:1000;
      color:rgba(203,213,225,.92);
      text-align:center;
    }
    .hud strong{
      color:#fff;
      letter-spacing:.12em;
    }

    /* メイン操作領域 */
    .controls{
      flex:1;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      min-height:0;
      align-items:center;
    }

    /* 左：D-Pad風（装飾） */
    .dpad{
      height:100%;
      min-height:240px;
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:.9;
    }
    .dpadCore{
      width:min(220px, 44vw);
      aspect-ratio:1/1;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
      gap:10px;
      padding:10px;
    }
    .dpadPiece{
      border-radius:18px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .dpadPiece.center{
      border-radius:22px;
      background:rgba(255,255,255,.06);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08), 0 18px 40px rgba(0,0,0,.25);
    }

    /* 右：ボタン群 */
    .pad{
      height:100%;
      min-height:240px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:12px;
      position:relative; /* FX用 */
    }

    /* ===== B1：強め吸い込み演出（ox/five送信時） ===== */
    .fxRing, .fxRing2{
      position:absolute;
      left:50%;
      top:50%;
      width:18px;
      height:18px;
      transform:translate(-50%,-50%);
      border-radius:999px;
      pointer-events:none;
      opacity:0;
      z-index:6;
      background: radial-gradient(circle, rgba(255,255,255,.95), rgba(255,255,255,0) 62%);
      filter: blur(.1px);
    }
    .fxRing2{
      width:16px; height:16px;
      background: radial-gradient(circle, rgba(168,85,247,.85), rgba(168,85,247,0) 62%);
      mix-blend-mode: screen;
      z-index:5;
      filter: blur(.4px);
    }
    .fxRing::after,
    .fxRing2::after{
      content:"";
      position:absolute;
      inset:-10px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,.22);
      opacity:0;
    }
    .fxRing2::after{
      border-color: rgba(168,85,247,.18);
      inset:-14px;
      border-width: 3px;
    }
    .controller.fx .fxRing{
      opacity:1;
      animation: ringPopB1 520ms cubic-bezier(.12,.9,.1,1) forwards;
    }
    .controller.fx .fxRing::after{
      animation: ringOutlineB1 520ms cubic-bezier(.12,.9,.1,1) forwards;
    }
    .controller.fx .fxRing2{
      opacity:1;
      animation: ringPopB1b 600ms cubic-bezier(.12,.9,.1,1) forwards;
    }
    .controller.fx .fxRing2::after{
      animation: ringOutlineB1b 600ms cubic-bezier(.12,.9,.1,1) forwards;
    }
    @keyframes ringPopB1{
      0%   { transform:translate(-50%,-50%) scale(.55); opacity:0; }
      12%  { opacity:1; }
      65%  { transform:translate(-50%,-50%) scale(12.5); opacity:.55; }
      100% { transform:translate(-50%,-50%) scale(16.0); opacity:0; }
    }
    @keyframes ringOutlineB1{
      0%   { opacity:0; transform:scale(.55); }
      18%  { opacity:.65; }
      70%  { opacity:.35; transform:scale(13.0); }
      100% { opacity:0; transform:scale(16.5); }
    }
    @keyframes ringPopB1b{
      0%   { transform:translate(-50%,-50%) scale(.5); opacity:0; }
      15%  { opacity:1; }
      70%  { transform:translate(-50%,-50%) scale(10.8); opacity:.45; }
      100% { transform:translate(-50%,-50%) scale(14.8); opacity:0; }
    }
    @keyframes ringOutlineB1b{
      0%   { opacity:0; transform:scale(.5); }
      20%  { opacity:.55; }
      72%  { opacity:.28; transform:scale(11.6); }
      100% { opacity:0; transform:scale(15.4); }
    }

    .trail{
      position:absolute;
      border-radius:999px;
      pointer-events:none;
      z-index:7;
      will-change: transform, opacity, filter;
      transform-origin:center;
      filter: blur(.2px);
      mix-blend-mode: screen;
    }
    .trail.t1{ opacity:.55; animation: trail1 520ms cubic-bezier(.12,.9,.1,1) forwards; }
    .trail.t2{ opacity:.35; animation: trail2 560ms cubic-bezier(.12,.9,.1,1) forwards; }
    @keyframes trail1{
      0%   { transform:translate(0,0) scale(1.00) rotate(0deg);   opacity:.55; filter: blur(.2px); }
      35%  { transform:translate(6px,10px) scale(.78) rotate(180deg); opacity:.48; filter: blur(.6px); }
      70%  { transform:translate(12px,22px) scale(.28) rotate(520deg); opacity:.22; filter: blur(1.2px); }
      100% { transform:translate(18px,34px) scale(.06) rotate(900deg); opacity:0;    filter: blur(1.8px); }
    }
    @keyframes trail2{
      0%   { transform:translate(-2px,2px) scale(1.00) rotate(0deg);   opacity:.35; filter: blur(.3px); }
      40%  { transform:translate(4px,14px) scale(.72) rotate(210deg); opacity:.28; filter: blur(.8px); }
      75%  { transform:translate(10px,26px) scale(.22) rotate(620deg); opacity:.14; filter: blur(1.4px); }
      100% { transform:translate(16px,38px) scale(.05) rotate(980deg); opacity:0;    filter: blur(2.0px); }
    }

    /* ボタン共通 */
    .btn{
      -webkit-tap-highlight-color: transparent;
      appearance:none;
      border:none;
      cursor:pointer;
      user-select:none;
      outline:none;

      width:84px; height:84px;
      border-radius:999px;
      color:#0b1020;
      font-weight:1100;
      font-size:30px;
      letter-spacing:.06em;

      background: rgba(255,255,255,.88);
      box-shadow:
        inset 0 10px 18px rgba(255,255,255,.35),
        inset 0 -14px 18px rgba(0,0,0,.18),
        0 18px 40px rgba(0,0,0,.55);
      transform: translateY(0);
      transition: transform .10s ease, filter .12s ease, box-shadow .12s ease, opacity .15s ease;
      position:relative;
      will-change: transform, opacity, filter;
    }
    .btn::after{
      content:"";
      position:absolute;
      inset:10px;
      border-radius:999px;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.55), rgba(255,255,255,0) 55%);
      opacity:.85;
      pointer-events:none;
    }
    .btn:active{
      transform: translateY(3px) scale(.985);
      filter: brightness(.98);
      box-shadow:
        inset 0 10px 18px rgba(255,255,255,.25),
        inset 0 -14px 18px rgba(0,0,0,.25),
        0 10px 24px rgba(0,0,0,.55);
    }
    .btn.sel{
      box-shadow:
        0 0 0 3px rgba(255,255,255,.24),
        0 0 0 10px rgba(255,255,255,.10),
        0 0 36px rgba(255,255,255,.16),
        0 18px 40px rgba(0,0,0,.55);
      transform: translateY(-2px) scale(1.05);
    }
    .btn.sucked{
      pointer-events:none;
      animation: suckInB1 520ms cubic-bezier(.12,.9,.1,1) forwards;
    }
    @keyframes suckInB1{
      0%{ transform: translateY(-2px) scale(1.05) rotate(0deg); opacity:1; filter: blur(0); }
      18%{ transform: translateY(1px) scale(.90) rotate(180deg); opacity:1; filter: blur(.2px); }
      50%{ transform: translateY(12px) scale(.42) rotate(540deg); opacity:.70; filter: blur(1.0px); }
      80%{ transform: translateY(24px) scale(.12) rotate(980deg); opacity:.25; filter: blur(1.6px); }
      100%{ transform: translateY(32px) scale(.05) rotate(1260deg); opacity:0; filter: blur(2.1px); }
    }

    /* 色 */
    .btn.O { background: var(--color-o); color:#0b1020; }
    .btn.X { background: var(--color-x); color:#fff; }
    .btn.A { background: var(--color-a); color:#fff; }
    .btn.B { background: var(--color-b); color:#0b1020; }
    .btn.C { background: var(--color-c); color:#0b1020; }
    .btn.D { background: var(--color-d); color:#fff; }
    .btn.E { background: var(--color-e); color:#fff; }

    /* OX */
    .oxGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:center;
      justify-items:center;
    }
    .oxGrid .btn{ width:110px; height:110px; font-size:42px; }

    /* 5択 */
    .fiveGrid{
      width:min(340px, 80vw);
      aspect-ratio: 1.15 / 1;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
      gap:12px;
      align-items:center;
      justify-items:center;
    }
    .posD{ grid-column:2; grid-row:1; }
    .posB{ grid-column:2; grid-row:3; }
    .posC{ grid-column:1; grid-row:2; }
    .posA{ grid-column:3; grid-row:2; }
    .posE{ grid-column:2; grid-row:2; width:92px; height:92px; font-size:32px; }

    /* テキスト入力（textモード） */
    .textWrap{
      width:min(420px, 88vw);
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:14px 14px;
      border-radius:22px;
      background:rgba(2,6,23,.55);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 18px 44px rgba(0,0,0,.35);
    }
    .textTitle{
      font-weight:1000;
      letter-spacing:.10em;
      color:rgba(203,213,225,.92);
      font-size:13px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .counter{
      font-weight:900;
      color:rgba(203,213,225,.85);
      letter-spacing:.06em;
      font-size:12px;
    }
    textarea{
      width:100%;
      min-height:140px;
      max-height:220px;
      resize:none;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      color:#fff;
      font-size:18px;
      line-height:1.4;
      outline:none;
    }
    textarea:focus{
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 0 0 4px rgba(255,255,255,.08);
    }
    .hint{
      color:rgba(203,213,225,.80);
      font-size:12px;
      line-height:1.45;
    }

    /* 送信ボタン */
    .submit{
      width:min(320px, 84vw);
      height:64px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(circle at 20% 20%, rgba(255,255,255,.15), transparent 50%),
        linear-gradient(180deg, rgba(99,102,241,.90), rgba(168,85,247,.90));
      color:#fff;
      font-weight:1100;
      font-size:18px;
      letter-spacing:.12em;
      box-shadow:0 18px 40px rgba(139,92,246,.35), 0 18px 60px rgba(0,0,0,.55);
      cursor:pointer;
      transition: transform .10s ease, filter .12s ease, opacity .15s ease;
    }
    .submit:active{ transform: translateY(2px); filter: brightness(.98); }
    .submit:disabled{
      opacity:.45;
      cursor:not-allowed;
      filter: grayscale(.2);
    }

    /* ロック */
    .locked{
      opacity:.55;
      pointer-events:none;
      filter: grayscale(.15);
    }

    /* 受付前 overlay */
    .overlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
      text-align:center;
      background:rgba(0,0,0,.42);
      backdrop-filter: blur(10px);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index:3;
    }
    .overlay.show{
      opacity:1;
      pointer-events:auto;
    }
    .overlayCard{
      width:min(520px, 92vw);
      border-radius:26px;
      padding:18px 16px;
      background:rgba(17,24,39,.72);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 24px 80px rgba(0,0,0,.65);
    }
    .overlayCard h3{
      margin:0 0 8px 0;
      letter-spacing:.10em;
      font-weight:1100;
      font-size:18px;
    }
    .overlayCard p{
      margin:0;
      color:rgba(203,213,225,.9);
      line-height:1.5;
      font-size:14px;
    }

    /* 送信完了 */
    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      background:rgba(17,24,39,.92);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 14px;
      border-radius:999px;
      box-shadow:0 18px 50px rgba(0,0,0,.55);
      color:#f9fafb;
      font-weight:1000;
      letter-spacing:.10em;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index:20;
      white-space:nowrap;
    }
    .toast.show{ opacity:1; }

    #buildTag{
      position:fixed; right:10px; bottom:10px;
      opacity:.55; font-size:12px; z-index:30;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.08);
      padding:6px 10px;
      border-radius:999px;
      backdrop-filter: blur(8px);
    }

    @media (max-height: 640px){
      .controller{ height:min(520px, 78vh); }
      .btn{ width:76px; height:76px; }
      .oxGrid .btn{ width:98px; height:98px; font-size:40px; }
      .posE{ width:86px; height:86px; }
      textarea{ min-height:120px; }
    }
  </style>
</head>

<body>
  <div id="buildTag">build: 2025-12-27 / student-pad-ui-textfix</div>

  <div class="topbar">
    <div class="room" id="roomLabel">ROOM: -</div>
    <div class="status">
      <span class="pill"><span id="dot" class="dot"></span><span id="statusText">status: -</span></span>
      <span class="pill" id="modeText">mode: -</span>
    </div>
  </div>

  <div class="stage">
    <div class="controller" id="controller">
      <div class="hud">
        <span>回答モード：</span><strong id="hudMode">待機</strong>
      </div>

      <div class="controls">
        <!-- 左：D-Pad風 -->
        <div class="dpad" aria-hidden="true">
          <div class="dpadCore">
            <div class="dpadPiece"></div><div class="dpadPiece"></div><div class="dpadPiece"></div>
            <div class="dpadPiece"></div><div class="dpadPiece center"></div><div class="dpadPiece"></div>
            <div class="dpadPiece"></div><div class="dpadPiece"></div><div class="dpadPiece"></div>
          </div>
        </div>

        <!-- 右：操作 -->
        <div class="pad" id="pad">
          <div class="fxRing" id="fxRing"></div>
          <div class="fxRing2" id="fxRing2"></div>

          <div id="answer-container"></div>

          <button id="submitBtn" class="submit" disabled>START（決定）</button>
        </div>
      </div>

      <!-- 待機/閉鎖 overlay -->
      <div id="overlay" class="overlay">
        <div class="overlayCard">
          <h3>待機中</h3>
          <p id="overlayText">先生が出題を開始すると、解答ボタンが使えるようになります。</p>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">送信しました ✓</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBke-wTU16skpbK8z80ddK04tE154dHERQ",
      authDomain: "satosan-41eac.firebaseapp.com",
      databaseURL: "https://satosan-41eac-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "satosan-41eac"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const url  = new URL(window.location.href);
    const room = url.searchParams.get("room") || "kyoto-01";

    // UI refs
    const controller = document.getElementById("controller");
    const pad = document.getElementById("pad");
    const roomLabel = document.getElementById("roomLabel");
    const dot = document.getElementById("dot");
    const statusText = document.getElementById("statusText");
    const modeText = document.getElementById("modeText");
    const hudMode = document.getElementById("hudMode");

    const container = document.getElementById("answer-container");
    const submitBtn = document.getElementById("submitBtn");
    const overlay = document.getElementById("overlay");
    const overlayText = document.getElementById("overlayText");
    const toast = document.getElementById("toast");

    roomLabel.textContent = `ROOM: ${room}`;

    // userId 永続
    let userId = localStorage.getItem("student_user_id");
    if (!userId) {
      userId = "user_" + Math.random().toString(36).slice(2, 10);
      localStorage.setItem("student_user_id", userId);
    }

    // state
    let isOpen = false;
    let currentMode = null;
    let selected = null;
    let sending = false;
    let textValue = "";

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=> toast.classList.remove("show"), 1200);
    }

    function setOverlay(show, msg){
      overlay.classList.toggle("show", !!show);
      if (msg) overlayText.textContent = msg;
    }

    function clearTrails(){
      pad.querySelectorAll(".trail").forEach(el => el.remove());
    }

    function unlockUI(){
      sending = false;
      controller.classList.remove("fx");
      container.classList.remove("locked");
      submitBtn.disabled = true;
      selected = null;
      textValue = "";
      clearTrails();
      container.style.pointerEvents = "";
    }

    function lockUI(){
      container.classList.add("locked");
      submitBtn.disabled = true;
    }

    function uiLabel(ch){
      const c = String(ch).trim().toUpperCase();
      if (c === "O") return "○";
      if (c === "X") return "✕";
      return c;
    }

    function haptic(){
      try{ if (navigator.vibrate) navigator.vibrate(18); }catch(_){}
    }

    function createChoiceButton(ch){
      const c = String(ch).trim().toUpperCase();
      const btn = document.createElement("button");
      btn.className = `btn ${c}`;
      btn.type = "button";
      btn.textContent = uiLabel(c);

      btn.onclick = () => {
        if (!isOpen || sending) return;
        selected = c;
        haptic();
        container.querySelectorAll(".btn").forEach(b => b.classList.remove("sel"));
        btn.classList.add("sel");
        submitBtn.disabled = false;
      };
      return btn;
    }

    function renderOX(choices){
      unlockUI();
      container.innerHTML = "";
      hudMode.textContent = "○✕";
      modeText.textContent = "mode: ox";

      const grid = document.createElement("div");
      grid.className = "oxGrid";
      (choices || ["O","X"]).forEach(ch => grid.appendChild(createChoiceButton(ch)));
      container.appendChild(grid);

      submitBtn.textContent = "START（決定）";
      submitBtn.disabled = true;
      submitBtn.style.display = "";
    }

    function renderFive(choices){
      unlockUI();
      container.innerHTML = "";
      hudMode.textContent = "5択";
      modeText.textContent = "mode: five";

      const grid = document.createElement("div");
      grid.className = "fiveGrid";

      const order = (choices && choices.length) ? choices : ["A","B","C","D","E"];
      const posClass = { A:"posA", B:"posB", C:"posC", D:"posD", E:"posE" };

      order.forEach(ch => {
        const c = String(ch).trim().toUpperCase();
        const btn = createChoiceButton(c);
        btn.classList.add(posClass[c] || "");
        grid.appendChild(btn);
      });

      container.appendChild(grid);

      submitBtn.textContent = "START（決定）";
      submitBtn.disabled = true;
      submitBtn.style.display = "";
    }

    function renderText(){
      unlockUI();
      container.innerHTML = "";
      hudMode.textContent = "文字入力";
      modeText.textContent = "mode: text";

      const wrap = document.createElement("div");
      wrap.className = "textWrap";

      const title = document.createElement("div");
      title.className = "textTitle";
      title.innerHTML = `<span>テキストを入力</span><span class="counter" id="counter">0/200</span>`;

      const ta = document.createElement("textarea");
      ta.placeholder = "短くでOK（1〜2文）";
      ta.maxLength = 200;
      ta.disabled = !isOpen;

      const hint = document.createElement("div");
      hint.className = "hint";
      hint.textContent = "※ 送信は1回。先生が「解答終了」を押した後に投影で公開されます。";

      wrap.appendChild(title);
      wrap.appendChild(ta);
      wrap.appendChild(hint);
      container.appendChild(wrap);

      const counterEl = wrap.querySelector("#counter");

      const refresh = () => {
        textValue = ta.value || "";
        counterEl.textContent = `${textValue.length}/200`;
        submitBtn.disabled = (!isOpen) || sending || (textValue.trim().length === 0);
      };

      ta.addEventListener("input", refresh);
      refresh();

      submitBtn.textContent = "SEND（送信）";
      submitBtn.style.display = "";
      submitBtn.disabled = true;

      // openなら即フォーカス（スマホで強制はしない）
      if (isOpen) setTimeout(()=>{ try{ ta.focus(); }catch(_){ } }, 50);
    }

    function makeTrailClone(selBtn, klass){
      const padRect = pad.getBoundingClientRect();
      const r = selBtn.getBoundingClientRect();

      const clone = selBtn.cloneNode(true);
      clone.classList.remove("sel");
      clone.classList.add("trail", klass);

      clone.style.left = (r.left - padRect.left) + "px";
      clone.style.top  = (r.top  - padRect.top)  + "px";
      clone.style.width  = r.width + "px";
      clone.style.height = r.height + "px";
      clone.style.position = "absolute";
      clone.style.boxShadow =
        "0 0 0 2px rgba(255,255,255,.14), 0 0 18px rgba(255,255,255,.18), 0 18px 40px rgba(0,0,0,.35)";

      pad.appendChild(clone);
      clone.addEventListener("animationend", () => clone.remove());
    }

    function playSubmitFX(){
      const selBtn = container.querySelector(".btn.sel");
      if (!selBtn) return;

      clearTrails();
      controller.classList.add("fx");
      makeTrailClone(selBtn, "t2");
      makeTrailClone(selBtn, "t1");
      selBtn.classList.add("sucked");

      container.querySelectorAll(".btn").forEach(b => {
        if (b !== selBtn) b.style.opacity = "0.50";
      });

      setTimeout(() => controller.classList.remove("fx"), 650);
    }

    // 送信
    submitBtn.onclick = async () => {
      if (!isOpen || sending) return;

      // modeごとにpayloadを作る
      let payload = null;

      if (currentMode === "ox" || currentMode === "five"){
        if (!selected) return;
        payload = { value: selected, timestamp: Date.now() };

        sending = true;
        submitBtn.disabled = true;
        container.style.pointerEvents = "none";
        playSubmitFX();
      } else if (currentMode === "text"){
        const text = (textValue || "").trim();
        if (!text) return;
        payload = { value: text, timestamp: Date.now() };

        sending = true;
        submitBtn.disabled = true;
        container.style.pointerEvents = "none";
        // textは吸い込み演出なし（読みやすさ優先）
      } else {
        return;
      }

      try{
        const answerRef = ref(db, `rooms/${room}/answers/${userId}`);
        await set(answerRef, payload);
      }catch(e){
        sending = false;
        container.style.pointerEvents = "";
        showToast("送信失敗…もう一度");
        // openなら再操作可能に戻す
        if (currentMode === "text") renderText();
        else if (currentMode === "ox") renderOX(["O","X"]);
        else if (currentMode === "five") renderFive(["A","B","C","D","E"]);
        return;
      }

      setTimeout(() => {
        container.style.pointerEvents = "";
        showToast("送信しました ✓");
        lockUI();
      }, (currentMode === "ox" || currentMode === "five") ? 560 : 220);
    };

    // activity 監視
    const activityRef = ref(db, `rooms/${room}/activity`);
    onValue(activityRef, snap => {
      const data = snap.val() || {};
      isOpen = (data.status === "open");
      currentMode = data.mode || null;

      statusText.textContent = `status: ${data.status || "-"}`;
      dot.classList.toggle("open", isOpen);
      dot.classList.toggle("closed", !isOpen);

      // status閉鎖なら overlay（textも同様）
      if (!isOpen){
        setOverlay(true, "先生が出題を開始すると、解答ボタンが使えるようになります。");
      } else {
        setOverlay(false);
      }

      const config = data.config || {};
      if (currentMode === "ox") {
        renderOX(config.choices || ["O","X"]);
        return;
      }
      if (currentMode === "five") {
        renderFive(config.choices || ["A","B","C","D","E"]);
        return;
      }
      if (currentMode === "text") {
        renderText();
        return;
      }

      // 未知モードは待機に倒す
      hudMode.textContent = "待機";
      modeText.textContent = `mode: ${currentMode || "-"}`;
      container.innerHTML = "";
      submitBtn.style.display = "";
      submitBtn.disabled = true;
      setOverlay(true, "先生が出題を開始すると、解答ボタンが使えるようになります。");
    });

    // ★ 自分の回答が消されたら（教員リセット等）、open中は再入力可能にする
    const myAnswerRef = ref(db, `rooms/${room}/answers/${userId}`);
    onValue(myAnswerRef, snap => {
      const v = snap.val();
      if (v == null && isOpen){
        // 受付中で自分の回答が無い＝再入力可能
        if (currentMode === "text") renderText();
        if (currentMode === "ox") renderOX(["O","X"]);
        if (currentMode === "five") renderFive(["A","B","C","D","E"]);
      }
    });
  </script>
</body>
</html>
