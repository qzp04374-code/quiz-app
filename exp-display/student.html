<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ClassSync Student</title>

  <style>
    :root{
      /* æ—¢å­˜ã®è‰²ï¼ˆdisplay/indexã¨æƒãˆã‚‹ï¼‰ */
      --color-o:#34c759;
      --color-x:#ff3b30;
      --color-a:#0a84ff;
      --color-b:#30d158;
      --color-c:#ff9f0a;
      --color-d:#bf5af2;
      --color-e:#ff375f;

      --bg:#050608;
      --ink:#f9fafb;
      --muted:rgba(203,213,225,.85);
      --line:rgba(255,255,255,.10);
      --shadow: 0 18px 60px rgba(0,0,0,.65);
    }
    
    /* ===== Seat FX (win/lose) ===== */
    .padShell{ position:relative; } /* å¿µã®ãŸã‚ï¼ˆæ—¢ã«ã‚ã£ã¦ã‚‚OKï¼‰ */
    
    /* ===== Seat FX (win/lose) ===== */
    /* padShellã¯ ::before/::after ã‚’åˆ¥ç”¨é€”ã§ä½¿ã£ã¦ã„ã‚‹ã®ã§ã€FXã¯ padArea ã«å¯„ã›ã‚‹ */
    .padArea{ position:relative; }
    
    .padArea::after{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius:24px;      /* padAreaã®è§’ä¸¸ã«åˆã‚ã›ã‚‹ */
      pointer-events:none;
      opacity:0;
      z-index:25;
    }
    
    /* å‹ã¡ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆå¸­è‰²ï¼‰ */
    .padShell.seatWin .padArea::after{
      background:
        radial-gradient(900px 520px at 50% 70%,
          color-mix(in oklab, var(--seat-flash, rgba(10,132,255,1)) 65%, transparent),
          transparent 62%);
      animation: seatWinFlash 620ms ease-out both;
      filter: saturate(1.35) brightness(1.15);
    }
    
    /* è² ã‘ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ */
    .padShell.seatLose .padArea::after{
      background:
        radial-gradient(900px 520px at 50% 70%,
          rgba(255,59,48,.55),
          transparent 62%);
      animation: seatLoseFlash 520ms ease-out both;
      filter: saturate(1.2) brightness(1.05);
    }
    
    .padShell.seatLose{
      animation: seatShake 420ms ease-in-out both;
    }

    .padShell.seatLose{
      animation: seatShake 420ms ease-in-out both;
    }
    
    @keyframes seatWinFlash{
      0%   { opacity:0; transform:scale(.985); }
      18%  { opacity:1; transform:scale(1.00); }
      100% { opacity:0; transform:scale(1.02); }
    }
    @keyframes seatLoseFlash{
      0%   { opacity:0; transform:scale(.99); }
      22%  { opacity:.95; transform:scale(1.00); }
      100% { opacity:0; transform:scale(1.01); }
    }
    @keyframes seatShake{
      0%{ transform:translateX(0); }
      18%{ transform:translateX(-6px); }
      36%{ transform:translateX(6px); }
      54%{ transform:translateX(-4px); }
      72%{ transform:translateX(4px); }
      100%{ transform:translateX(0); }
}

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 20% 20%, rgba(96,165,250,.10), transparent 55%),
        radial-gradient(1000px 800px at 80% 30%, rgba(34,197,94,.08), transparent 55%),
        radial-gradient(900px 900px at 50% 90%, rgba(191,90,242,.10), transparent 60%),
        var(--bg);
      color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
      overflow:hidden; /* ã¯ã¿å‡ºã—å¯¾ç­– */
      touch-action: manipulation;
    }

    /* top bar */
    .topbar{
      position:fixed;
      top:12px; left:12px; right:12px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:18px;
      background:rgba(17,24,39,.55);
      border:1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
      box-shadow:0 18px 60px rgba(0,0,0,.45);
      z-index:10;
    }
    .room{font-weight:1000; letter-spacing:.10em; font-size:14px; white-space:nowrap;}
    .status{
      display:flex; gap:10px; align-items:center;
      font-weight:900; font-size:13px; color:var(--muted);
      letter-spacing:.06em; white-space:nowrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(2,6,23,.45);
    }
    .dot{width:8px;height:8px;border-radius:50%; background:#9ca3af; box-shadow:0 0 0 3px rgba(156,163,175,.15);}
    .dot.open{background:#22c55e; box-shadow:0 0 0 3px rgba(34,197,94,.18), 0 0 16px rgba(34,197,94,.35);}
    .dot.closed{background:#ef4444; box-shadow:0 0 0 3px rgba(239,68,68,.18), 0 0 16px rgba(239,68,68,.25);}

    /* stage */
    .stage{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      /* âœ… topbar ã®å®Ÿé«˜ã•ï¼ˆJSã§å…¥ã‚Œã‚‹ï¼‰+ ä½™ç™½åˆ†ã ã‘ä¸‹ã’ã‚‹ */
      padding: calc(var(--topbarH, 66px) + 16px) 14px 18px;
    }

    /* âœ…iPhoneç­‰ã§topbarãŒ2æ®µã«ãªã‚‹æ™‚ã®â€œé£Ÿã„è¾¼ã¿â€å¯¾ç­– */
    @media (max-width: 420px){
      .stage{
        padding-top: 136px;  /* â† 88px â†’ å¢—ã‚„ã™ï¼ˆã“ã“ã§å¾…æ©Ÿä¸­ãŒéš ã‚Œãªããªã‚‹ï¼‰ */
      }
    }
    
    .padShell{
      width:min(520px, 94vw);
      height:min(660px, 80vh);
      border-radius:44px;
      background:
        radial-gradient(100% 120% at 50% 15%, rgba(255,255,255,.06), transparent 55%),
        linear-gradient(180deg, rgba(17,24,39,.92), rgba(2,6,23,.88));
      border:1px solid rgba(255,255,255,.10);
      box-shadow:var(--shadow);
      overflow:hidden;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
      position:relative;
    }

    /* ã‚°ãƒªãƒƒãƒ—é¢¨ï¼ˆå·¦å³ä¸‹ã ã‘ã€D-padã¯ç„¡ã—ï¼‰ */
    .padShell::before,.padShell::after{
      content:"";
      position:absolute;
      bottom:-22%;
      width:52%; height:54%;
      border-radius:60px;
      background:
        radial-gradient(90% 80% at 50% 10%, rgba(255,255,255,.05), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.22));
      border:1px solid rgba(255,255,255,.06);
      z-index:0; opacity:.85;
    }
    .padShell::before{left:-22%; transform:rotate(10deg);}
    .padShell::after{right:-22%; transform:rotate(-10deg);}
    .padShell > *{position:relative; z-index:1;}

    .hud{
      display:flex; justify-content:center; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:18px;
      background:rgba(2,6,23,.55);
      border:1px solid rgba(255,255,255,.08);
      letter-spacing:.10em;
      font-weight:1000;
      color:rgba(203,213,225,.92);
      text-align:center;
    }
    .hud strong{color:#fff; letter-spacing:.12em;}

    .padArea{
      flex:1; min-height:0;
      border-radius:24px;
      background:rgba(2,6,23,.45);
      border:1px solid rgba(255,255,255,.08);
      padding:14px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:14px;
      position:relative;
      overflow:hidden;
    }

    /* FX */
    .fxRing,.fxRing2{
      position:absolute; left:50%; top:50%;
      width:18px; height:18px;
      transform:translate(-50%,-50%);
      border-radius:999px;
      pointer-events:none;
      opacity:0;
      z-index:6;
      background: radial-gradient(circle, rgba(255,255,255,.95), rgba(255,255,255,0) 62%);
    }
    .fxRing2{
      width:16px; height:16px;
      background: radial-gradient(circle, rgba(168,85,247,.85), rgba(168,85,247,0) 62%);
      mix-blend-mode: screen;
      z-index:5;
      filter: blur(.4px);
    }
    .fxRing::after,.fxRing2::after{
      content:""; position:absolute; inset:-10px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,.22);
      opacity:0;
    }
    .fxRing2::after{border-color:rgba(168,85,247,.18); inset:-14px; border-width:3px;}

    .padShell.fx .fxRing{opacity:1; animation:ringPop 520ms cubic-bezier(.12,.9,.1,1) forwards;}
    .padShell.fx .fxRing::after{animation:ringOutline 520ms cubic-bezier(.12,.9,.1,1) forwards;}
    .padShell.fx .fxRing2{opacity:1; animation:ringPop2 600ms cubic-bezier(.12,.9,.1,1) forwards;}
    .padShell.fx .fxRing2::after{animation:ringOutline2 600ms cubic-bezier(.12,.9,.1,1) forwards;}

    @keyframes ringPop{
      0%{transform:translate(-50%,-50%) scale(.55); opacity:0;}
      12%{opacity:1;}
      65%{transform:translate(-50%,-50%) scale(12.5); opacity:.55;}
      100%{transform:translate(-50%,-50%) scale(16.0); opacity:0;}
    }
    @keyframes ringOutline{
      0%{opacity:0; transform:scale(.55);}
      18%{opacity:.65;}
      70%{opacity:.35; transform:scale(13.0);}
      100%{opacity:0; transform:scale(16.5);}
    }
    @keyframes ringPop2{
      0%{transform:translate(-50%,-50%) scale(.5); opacity:0;}
      15%{opacity:1;}
      70%{transform:translate(-50%,-50%) scale(10.8); opacity:.45;}
      100%{transform:translate(-50%,-50%) scale(14.8); opacity:0;}
    }
    @keyframes ringOutline2{
      0%{opacity:0; transform:scale(.5);}
      20%{opacity:.55;}
      72%{opacity:.28; transform:scale(11.6);}
      100%{opacity:0; transform:scale(15.4);}
    }

    .trail{
      position:absolute; border-radius:999px;
      pointer-events:none; z-index:7;
      mix-blend-mode: screen;
      filter: blur(.2px);
      will-change: transform, opacity, filter;
    }
    .trail.t1{opacity:.55; animation:trail1 520ms cubic-bezier(.12,.9,.1,1) forwards;}
    .trail.t2{opacity:.35; animation:trail2 560ms cubic-bezier(.12,.9,.1,1) forwards;}
    @keyframes trail1{
      0%{transform:translate(0,0) scale(1) rotate(0deg); opacity:.55;}
      35%{transform:translate(6px,10px) scale(.78) rotate(180deg); opacity:.48;}
      70%{transform:translate(12px,22px) scale(.28) rotate(520deg); opacity:.22;}
      100%{transform:translate(18px,34px) scale(.06) rotate(900deg); opacity:0;}
    }
    @keyframes trail2{
      0%{transform:translate(-2px,2px) scale(1) rotate(0deg); opacity:.35;}
      40%{transform:translate(4px,14px) scale(.72) rotate(210deg); opacity:.28;}
      75%{transform:translate(10px,26px) scale(.22) rotate(620deg); opacity:.14;}
      100%{transform:translate(16px,38px) scale(.05) rotate(980deg); opacity:0;}
    }

    /* buttons */
    .btn{
      -webkit-tap-highlight-color: transparent;
      appearance:none; border:none;
      cursor:pointer; user-select:none; outline:none;
      width:84px; height:84px;
      border-radius:999px;
      font-weight:1100; font-size:30px; letter-spacing:.06em;
      background: rgba(255,255,255,.88);
      box-shadow:
        inset 0 10px 18px rgba(255,255,255,.35),
        inset 0 -14px 18px rgba(0,0,0,.18),
        0 18px 40px rgba(0,0,0,.55);
      transform: translateY(0);
      transition: transform .10s ease, filter .12s ease, box-shadow .12s ease, opacity .15s ease;
      position:relative;
      will-change: transform, opacity;
    }
    .btn::after{
      content:""; position:absolute; inset:10px;
      border-radius:999px;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.55), rgba(255,255,255,0) 55%);
      opacity:.85; pointer-events:none;
    }
    .btn:active{
      transform: translateY(3px) scale(.985);
      filter: brightness(.98);
      box-shadow:
        inset 0 10px 18px rgba(255,255,255,.25),
        inset 0 -14px 18px rgba(0,0,0,.25),
        0 10px 24px rgba(0,0,0,.55);
    }
    .btn.sel{
      box-shadow:
        0 0 0 3px rgba(255,255,255,.24),
        0 0 0 10px rgba(255,255,255,.10),
        0 0 36px rgba(255,255,255,.16),
        0 18px 40px rgba(0,0,0,.55);
      transform: translateY(-2px) scale(1.05);
    }
    .btn.sucked{pointer-events:none; animation:suckIn 520ms cubic-bezier(.12,.9,.1,1) forwards;}
    @keyframes suckIn{
      0%{transform: translateY(-2px) scale(1.05) rotate(0deg); opacity:1; filter: blur(0);}
      18%{transform: translateY(1px) scale(.90) rotate(180deg); opacity:1; filter: blur(.2px);}
      50%{transform: translateY(12px) scale(.42) rotate(540deg); opacity:.70; filter: blur(1px);}
      80%{transform: translateY(24px) scale(.12) rotate(980deg); opacity:.25; filter: blur(1.6px);}
      100%{transform: translateY(32px) scale(.05) rotate(1260deg); opacity:0; filter: blur(2.1px);}
    }

    .btn.O { background: var(--color-o); color:#0b1020; }
    .btn.X { background: var(--color-x); color:#fff; }
    .btn.A { background: var(--color-a); color:#fff; }
    .btn.B { background: var(--color-b); color:#0b1020; }
    .btn.C { background: var(--color-c); color:#0b1020; }
    .btn.D { background: var(--color-d); color:#fff; }
    .btn.E { background: var(--color-e); color:#fff; }

    /* OX */
    .oxGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:center;
      justify-items:center;
    }
    .oxGrid .btn{width:112px; height:112px; font-size:44px;}

    /* 5æŠï¼šå³å´ãƒœã‚¿ãƒ³ã ã‘ï¼ˆãƒ€ã‚¤ãƒ¤é…ç½®ï¼‰ */
    .fiveGrid{
      width:min(360px, 86vw);
      aspect-ratio: 1.15 / 1;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
      gap:12px;
      align-items:center;
      justify-items:center;
    }
    .posD{ grid-column:2; grid-row:1; }
    .posB{ grid-column:2; grid-row:3; }
    .posC{ grid-column:1; grid-row:2; }
    .posA{ grid-column:3; grid-row:2; }
    .posE{ grid-column:2; grid-row:2; width:92px; height:92px; font-size:32px; }

    /* text */
    .textWrap{
      width:min(420px, 88vw);
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:14px;
      border-radius:22px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 18px 44px rgba(0,0,0,.25);
    }
    .textTitle{
      font-weight:1000;
      letter-spacing:.10em;
      color:rgba(203,213,225,.92);
      font-size:13px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .counter{font-weight:900; color:rgba(203,213,225,.85); letter-spacing:.06em; font-size:12px;}
    textarea{
      width:100%;
      min-height:150px;
      max-height:240px;
      resize:none;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      color:#fff;
      font-size:18px;
      line-height:1.4;
      outline:none;
    }
    textarea:focus{
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 0 0 4px rgba(255,255,255,.08);
    }
    .hint{color:rgba(203,213,225,.80); font-size:12px; line-height:1.45;}

    /* START/SEND */
    .submit{
      width:min(340px, 90vw);
      height:64px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(circle at 20% 20%, rgba(255,255,255,.15), transparent 50%),
        linear-gradient(180deg, rgba(99,102,241,.90), rgba(168,85,247,.90));
      color:#fff;
      font-weight:1100;
      font-size:18px;
      letter-spacing:.12em;
      box-shadow:0 18px 40px rgba(139,92,246,.35), 0 18px 60px rgba(0,0,0,.55);
      cursor:pointer;
      transition: transform .10s ease, filter .12s ease, opacity .15s ease;
    }
    .submit:active{ transform: translateY(2px); filter: brightness(.98); }
    .submit:disabled{ opacity:.45; cursor:not-allowed; filter: grayscale(.2); }

    .locked{opacity:.55; pointer-events:none; filter: grayscale(.15);}

    /* overlay: closedä¸­ */
    .overlay{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:22px;
      text-align:center;
      background:rgba(0,0,0,.42);
      backdrop-filter: blur(10px);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index:30;
    }
    .overlay.show{opacity:1; pointer-events:auto;}
    .overlayCard{
      width:min(520px, 92vw);
      border-radius:26px;
      padding:18px 16px;
      background:rgba(17,24,39,.72);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 24px 80px rgba(0,0,0,.65);
    }
    .overlayCard h3{margin:0 0 8px 0; letter-spacing:.10em; font-weight:1100; font-size:18px;}
    .overlayCard p{margin:0; color:rgba(203,213,225,.9); line-height:1.5; font-size:14px;}

    /* toast */
    .toast{
      position:fixed; left:50%; bottom:16px;
      transform:translateX(-50%);
      background:rgba(17,24,39,.92);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 14px;
      border-radius:999px;
      box-shadow:0 18px 50px rgba(0,0,0,.55);
      color:#f9fafb;
      font-weight:1000;
      letter-spacing:.10em;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index:50;
      white-space:nowrap;
    }
    .toast.show{opacity:1;}

    #buildTag{
      position:fixed; right:10px; bottom:10px;
      opacity:.60; font-size:12px; z-index:60;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.08);
      padding:6px 10px;
      border-radius:999px;
      backdrop-filter: blur(8px);
    }

    @media (max-height: 640px){
      .padShell{ height:min(660px, 84vh); }
      .btn{ width:76px; height:76px; }
      .oxGrid .btn{ width:98px; height:98px; font-size:40px; }
      .posE{ width:86px; height:86px; }
      textarea{ min-height:130px; }
    }

  /* âœ…ã‚¹ãƒãƒ›ã§ pill ãŒåˆ‡ã‚Œãªã„ã‚ˆã†ã«æŠ˜ã‚Šè¿”ã™ */
  .topbar{
    flex-wrap: wrap;              /* â˜…è¿½åŠ ï¼šæŠ˜ã‚Šè¿”ã—è¨±å¯ */
    align-items: flex-start;      /* â˜…è¿½åŠ ï¼šä¸Šå¯„ã› */
  }
  
  /* ROOMè¡¨ç¤ºã¯ã‚¹ãƒãƒ›ã ã¨1è¡Œç›®ã«ç¢ºä¿ï¼ˆåˆ‡ã‚Œé˜²æ­¢ï¼‰ */
  .topbar .room{
    flex: 1 1 120px;
    min-width: 120px;
  }
  
  /* pillç¾¤ã¯æŠ˜ã‚Šè¿”ã—ã¦2æ®µä»¥ä¸Šã«ãªã£ã¦OK */
  .status{
    flex: 1 1 260px;
    flex-wrap: wrap;              /* â˜…è¿½åŠ ï¼šæŠ˜ã‚Šè¿”ã— */
    justify-content: flex-end;
    gap: 8px;
  }
  
  /* pillã‚’å°‘ã—ã ã‘å°ã•ãã—ã¦ã‚¹ãƒãƒ›ã«åã‚ã‚„ã™ã */
  .pill{
    font-size: 12.5px;            /* â˜…è¿½åŠ ï¼šãŠå¥½ã¿ã§ 12ã€œ13.5 */
    padding: 7px 10px;            /* â˜…è¿½åŠ ï¼šå°‘ã—è©°ã‚ã‚‹ */
    white-space: nowrap;          /* â˜…è¿½åŠ ï¼špillå†…ã¯æŠ˜ã‚Šè¿”ã•ãªã„ */
  }
  
  /* meè¡¨ç¤ºãŒé•·ã„ã¨ãã®ä¿é™º */
  #meTag{
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  /* âœ…iPhoneã®ãƒãƒƒãƒå¯¾ç­–ï¼ˆä¸ŠãŒåˆ‡ã‚Œã‚‹ã‚±ãƒ¼ã‚¹é˜²æ­¢ï¼‰ */
  body{
    padding-top: calc(env(safe-area-inset-top) + 10px);
  }

  </style>
</head>

<body>
  <div id="buildTag">build: 2025-12-28 / student-one-side-pad-v3</div>

  <div class="topbar">
    <div class="room" id="roomLabel">ROOM: -</div>
    <div class="status">
      <span class="pill"><span id="dot" class="dot"></span><span id="statusText">status: -</span></span>
      <span class="pill" id="modeText">mode: -</span>
      <!-- â˜…è¿½åŠ ï¼šè‡ªåˆ†ã®å° -->
      <span class="pill" id="meTag">me: -</span>
    </div>
  </div>

  <div class="stage">
    <div class="padShell" id="padShell">
      <div class="hud">
        <span>å›ç­”ãƒ¢ãƒ¼ãƒ‰ï¼š</span><strong id="hudMode">å¾…æ©Ÿ</strong>
      </div>

      <div class="padArea" id="padArea">
        <div class="fxRing" id="fxRing"></div>
        <div class="fxRing2" id="fxRing2"></div>

        <div id="answer-container"></div>
        <button id="submitBtn" class="submit" disabled>STARTï¼ˆæ±ºå®šï¼‰</button>
      </div>

      <div id="overlay" class="overlay">
        <div class="overlayCard">
          <h3>å¾…æ©Ÿä¸­</h3>
          <p id="overlayText">å…ˆç”ŸãŒå‡ºé¡Œã‚’é–‹å§‹ã™ã‚‹ã¨ã€è§£ç­”ãƒœã‚¿ãƒ³ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">é€ä¿¡ã—ã¾ã—ãŸ âœ“</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getDatabase, ref, onValue, set, runTransaction
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
  
    const firebaseConfig = {
      apiKey: "AIzaSyBke-wTU16skpbK8z80ddK04tE154dHERQ",
      authDomain: "satosan-41eac.firebaseapp.com",
      databaseURL: "https://satosan-41eac-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "satosan-41eac"
    };
  
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
  
    const url  = new URL(window.location.href);
    const room = url.searchParams.get("room") || "kyoto-01";
  
    const padShell    = document.getElementById("padShell");
    const padArea     = document.getElementById("padArea");
    const roomLabel   = document.getElementById("roomLabel");
    const dot         = document.getElementById("dot");
    const statusText  = document.getElementById("statusText");
    const modeText    = document.getElementById("modeText");
    const hudMode     = document.getElementById("hudMode");
  
    const container   = document.getElementById("answer-container");
    const submitBtn   = document.getElementById("submitBtn");
    const overlay     = document.getElementById("overlay");
    const overlayText = document.getElementById("overlayText");
    const toast       = document.getElementById("toast");
  
    roomLabel.textContent = `ROOM: ${room}`;
  
    // ===== userIdå›ºå®š =====
    let userId = localStorage.getItem("student_user_id");
    if (!userId) {
      userId = "user_" + Math.random().toString(36).slice(2, 10);
      localStorage.setItem("student_user_id", userId);
    }
    
    // ===== è¿½åŠ ï¼šè‡ªåˆ†è¡¨ç¤ºï¼ˆemoji + shortIdï¼‰=====
    const ME_EMOJI_KEY = "cs_me_emoji";
    const ME_TAG_KEY   = "cs_me_tag";
    const ME_COLOR_KEY = "cs_me_color";
    
    function hash32(s){
      let h = 2166136261;
      for (let i=0;i<s.length;i++){
        h ^= s.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h >>> 0);
    }
    
    function getOrCreateMe(userId){
      const savedEmoji = localStorage.getItem(ME_EMOJI_KEY);
      const savedTag   = localStorage.getItem(ME_TAG_KEY);
      const savedColor = localStorage.getItem(ME_COLOR_KEY);
      if (savedEmoji && savedTag && savedColor){
        return { emoji: savedEmoji, tag: savedTag, color: savedColor };
      }
    
      const EMOJIS = ["ğŸ¶","ğŸ±","ğŸ¼","ğŸ¦Š","ğŸ¸","ğŸµ","ğŸ¯","ğŸ°","ğŸ¨","ğŸ¦","ğŸ®","ğŸ·","ğŸ§","ğŸ»","ğŸ¹","ğŸ¦„"];
      const COLORS = ["#60a5fa","#34d399","#f59e0b","#a78bfa","#fb7185","#22c55e","#38bdf8","#f472b6"];
    
      const h = hash32(String(userId||""));
      const emoji = EMOJIS[h % EMOJIS.length];
      const num = (h % 90) + 10; // 10-99
      const tag = `ID-${String(num).padStart(2,"0")}`;
      const color = COLORS[h % COLORS.length];
    
      localStorage.setItem(ME_EMOJI_KEY, emoji);
      localStorage.setItem(ME_TAG_KEY, tag);
      localStorage.setItem(ME_COLOR_KEY, color);
    
      return { emoji, tag, color };
    }
    
    const me = getOrCreateMe(userId);
    
    // meTagè¡¨ç¤º
    const meTagEl = document.getElementById("meTag");
    if (meTagEl){
      meTagEl.textContent = `me: ${me.emoji} ${me.tag}`;
    }
    
    // displayå´ãŒæ‹¾ãˆã‚‹ã‚ˆã†ã« roster å…¬é–‹
    set(ref(db, `rooms/${room}/activity/roster/${userId}`), {
      emoji: me.emoji,
      tag: me.tag,
      color: me.color,
      at: Date.now()
    }).catch(()=>{});
  
    // ===== state =====
    let isOpen = false;
    let currentMode = null;     // ox / five / text
    let currentView = "quiz";   // quiz / poll / standby / qr / game
    let selected = null;        // O/X/A-E
    let sending = false;
    let textValue = "";

    // ===== game state =====
    let isGame = false;
    let gameRound = null;
    let gamePhase = null;
    let gameSeatsRemain = {A:0,B:0,C:0,D:0,E:0};
    let mySeat = null;          // åº§ã‚ŒãŸã‚‰ "A".."E"
    let claimBusy = false;

    // ===== seat FX state =====
    let seatFxRound = -1;     // roundã”ã¨ã«1å›ã ã‘é³´ã‚‰ã™
    let seatFxDone = false;
    
    function seatColorVar(seatKey){
      const k = String(seatKey || "").trim().toUpperCase();
      const map = {
        A:"var(--color-a)", B:"var(--color-b)", C:"var(--color-c)", D:"var(--color-d)", E:"var(--color-e)"
      };
      return map[k] || "var(--color-a)";
    }
    
    function resetSeatFxIfNeeded(){
      const r = (gameRound == null) ? -1 : Number(gameRound);
      if (seatFxRound !== r){
        seatFxRound = r;
        seatFxDone = false;
      }
    }
    
    function fireSeatWinFx(seatKey){
      resetSeatFxIfNeeded();
      if (seatFxDone) return;
      seatFxDone = true;
    
      padShell.style.setProperty("--seat-flash", seatColorVar(seatKey));
    
      padShell.classList.remove("seatLose");
      padShell.classList.add("seatWin");
      setTimeout(()=> padShell.classList.remove("seatWin"), 700);
    
      // åŠ¹æœã ã‘ï¼ˆéŸ³ã¯é³´ã‚‰ã•ãªã„ï¼‰
      if (navigator.vibrate) navigator.vibrate(35);
    }
    
    function fireSeatLoseFx(){
      // å¤±æ•—ã¯é€£æ‰“ã—å¾—ã‚‹ã®ã§ã€roundå†…ã§ã‚‚æ¯å›å‡ºã—ã¦OKï¼ˆå«Œãªã‚‰1å›åˆ¶é™ã«ã—ã¦ã‚‚OKï¼‰
      padShell.classList.remove("seatWin");
      padShell.classList.add("seatLose");
      setTimeout(()=> padShell.classList.remove("seatLose"), 520);
    
      if (navigator.vibrate) navigator.vibrate([60, 40, 60]);
}

    // ===== activityç›£è¦– =====
  
    // ===== UI helpers =====
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=> toast.classList.remove("show"), 1200);
    }
  
    function setOverlay(show, msg){
      overlay.classList.toggle("show", !!show);
      if (msg) overlayText.textContent = msg;
    }
  
    function clearTrails(){
      padArea.querySelectorAll(".trail").forEach(el => el.remove());
    }
  
    function unlockUI(){
      sending = false;
      padShell.classList.remove("fx");
      container.classList.remove("locked");
      submitBtn.disabled = true;
      selected = null;
      textValue = "";
      clearTrails();
      container.style.pointerEvents = "";
      container.querySelectorAll(".btn").forEach(b => b.classList.remove("sel", "sucked"));
      container.querySelectorAll(".btn").forEach(b => b.style.opacity = "");
    }
  
    function lockUI(){
      container.classList.add("locked");
      submitBtn.disabled = true;
    }
  
    function uiLabel(ch){
      const c = String(ch).trim().toUpperCase();
      if (c === "O") return "â—‹";
      if (c === "X") return "âœ•";
      return c;
    }
  
    function haptic(){
      try{ if (navigator.vibrate) navigator.vibrate(18); }catch(_){}
    }
  
    // ===== Game HUD line (å‹•çš„ã«1è¡Œè¿½åŠ ) =====
    let gameLineEl = null;
    function ensureGameLine(){
      if (gameLineEl) return gameLineEl;
      gameLineEl = document.createElement("div");
      gameLineEl.id = "gameLine";
      gameLineEl.style.margin = "0 16px";
      gameLineEl.style.padding = "10px 12px";
      gameLineEl.style.borderRadius = "16px";
      gameLineEl.style.background = "rgba(2,6,23,.40)";
      gameLineEl.style.border = "1px solid rgba(255,255,255,.08)";
      gameLineEl.style.color = "rgba(203,213,225,.92)";
      gameLineEl.style.fontWeight = "1000";
      gameLineEl.style.letterSpacing = ".08em";
      gameLineEl.style.fontSize = "12px";
      // hudã®ç›´å¾Œã«å…¥ã‚Œã‚‹
      const hud = document.querySelector(".hud");
      hud?.insertAdjacentElement("afterend", gameLineEl);
      return gameLineEl;
    }
    function setGameLine(text){
      const el = ensureGameLine();
      el.textContent = text;
      el.style.display = isGame ? "block" : "none";
    }
  
    function normKey(k){
      return String(k||"").trim().toUpperCase();
    }
  
    function getRemainMap(game){
      const g = game || {};
      // å„ªå…ˆï¼šseatsRemain â†’ seats
      const src = (g.seatsRemain && typeof g.seatsRemain === "object") ? g.seatsRemain
                : (g.seats && typeof g.seats === "object") ? g.seats
                : null;
      const out = {A:0,B:0,C:0,D:0,E:0};
      if (!src) return out;
      ["A","B","C","D","E"].forEach(k => out[k] = Math.max(0, Math.floor(Number(src[k] || 0))));
      return out;
    }
  
    function updateGameButtonsAvailability(){
      const buttons = container.querySelectorAll(".btn");
    
      buttons.forEach(btn => {
        const key = (btn.dataset && btn.dataset.choice) ? String(btn.dataset.choice) : "";
        // æ—¢å­˜ã®disable/opacityå‡¦ç†ã¯ãã®ã¾ã¾
    
        // â˜…åº§ã‚ŒãŸã‚‰ã€ãã®å¸­ä»¥å¤–ã¯æ¶ˆã™
        if (mySeat){
          btn.style.display = (key === mySeat) ? "" : "none";
        } else {
          btn.style.display = "";
        }
      });
    }
  
    // ===== Button factory =====
    function createChoiceButton(ch, onPress){
      const c = normKey(ch);
      const btn = document.createElement("button");
      btn.className = `btn ${c}`;
      btn.type = "button";
      btn.textContent = uiLabel(c);
      btn.dataset.choice = c; // â˜…è¿½åŠ ï¼šupdateGameButtonsAvailability ãŒå‚ç…§ã™ã‚‹
  
      btn.onclick = () => {
        onPress?.(c, btn);
      };
      return btn;
    }
  
    // ===== render (quiz modes) =====
    function renderOX(choices){
      isGame = false;
      submitBtn.style.display = "block";
  
      unlockUI();
      container.innerHTML = "";
      hudMode.textContent = "â—‹âœ•";
      modeText.textContent = "mode: ox";
      setGameLine("");
  
      const grid = document.createElement("div");
      grid.className = "oxGrid";
  
      const onPress = (c, btn) => {
        if (!isOpen || sending) return;
        selected = c;
        haptic();
        container.querySelectorAll(".btn").forEach(b => b.classList.remove("sel"));
        btn.classList.add("sel");
        submitBtn.disabled = false;
      };
  
      (choices || ["O","X"]).forEach(ch => grid.appendChild(createChoiceButton(ch, onPress)));
      container.appendChild(grid);
  
      submitBtn.textContent = "STARTï¼ˆæ±ºå®šï¼‰";
      submitBtn.disabled = true;
    }
  
    function renderFive(choices){
      isGame = false;
      submitBtn.style.display = "block";
  
      unlockUI();
      container.innerHTML = "";
      hudMode.textContent = "5æŠ";
      modeText.textContent = "mode: five";
      setGameLine("");
  
      const grid = document.createElement("div");
      grid.className = "fiveGrid";
  
      const order = (choices && choices.length) ? choices : ["A","B","C","D","E"];
      const posClass = { A:"posA", B:"posB", C:"posC", D:"posD", E:"posE" };
  
      const onPress = (c, btn) => {
        if (!isOpen || sending) return;
        selected = c;
        haptic();
        container.querySelectorAll(".btn").forEach(b => b.classList.remove("sel"));
        btn.classList.add("sel");
        submitBtn.disabled = false;
      };
  
      order.forEach(ch => {
        const c = normKey(ch);
        const btn = createChoiceButton(c, onPress);
        btn.classList.add(posClass[c] || "");
        grid.appendChild(btn);
      });
  
      container.appendChild(grid);
  
      submitBtn.textContent = "STARTï¼ˆæ±ºå®šï¼‰";
      submitBtn.disabled = true;
    }
  
    function renderText(){
      isGame = false;
      submitBtn.style.display = "block";
  
      unlockUI();
      container.innerHTML = "";
      hudMode.textContent = "æ–‡å­—å…¥åŠ›";
      modeText.textContent = "mode: text";
      setGameLine("");
  
      const wrap = document.createElement("div");
      wrap.className = "textWrap";
  
      const title = document.createElement("div");
      title.className = "textTitle";
      title.innerHTML = `<span>ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›</span><span class="counter" id="counter">0/200</span>`;
  
      const ta = document.createElement("textarea");
      ta.placeholder = "çŸ­ãã§OKï¼ˆ1ã€œ2æ–‡ï¼‰";
      ta.maxLength = 200;
      ta.disabled = !isOpen;
  
      const hint = document.createElement("div");
      hint.className = "hint";
      hint.textContent = "â€» é€ä¿¡ã¯1å›ã€‚å…ˆç”ŸãŒã€Œè§£ç­”çµ‚äº†ã€ã‚’æŠ¼ã—ãŸå¾Œã«æŠ•å½±ã§å…¬é–‹ã•ã‚Œã¾ã™ã€‚";
  
      wrap.appendChild(title);
      wrap.appendChild(ta);
      wrap.appendChild(hint);
      container.appendChild(wrap);
  
      const counterEl = wrap.querySelector("#counter");
  
      const refresh = () => {
        textValue = ta.value || "";
        counterEl.textContent = `${textValue.length}/200`;
        submitBtn.disabled = (!isOpen) || sending || (textValue.trim().length === 0);
      };
      ta.addEventListener("input", refresh);
      refresh();
  
      submitBtn.textContent = "SENDï¼ˆé€ä¿¡ï¼‰";
      submitBtn.disabled = true;
  
      if (isOpen) setTimeout(()=>{ try{ ta.focus(); }catch(_){ } }, 50);
    }
  
    // ===== FX for submit (quiz) =====
    function makeTrailClone(selBtn, klass){
      const areaRect = padArea.getBoundingClientRect();
      const r = selBtn.getBoundingClientRect();
      const clone = selBtn.cloneNode(true);
      clone.classList.remove("sel");
      clone.classList.add("trail", klass);
      clone.style.left = (r.left - areaRect.left) + "px";
      clone.style.top  = (r.top  - areaRect.top)  + "px";
      clone.style.width  = r.width + "px";
      clone.style.height = r.height + "px";
      clone.style.position = "absolute";
      clone.style.boxShadow = "0 0 0 2px rgba(255,255,255,.14), 0 0 18px rgba(255,255,255,.18), 0 18px 40px rgba(0,0,0,.35)";
      padArea.appendChild(clone);
      clone.addEventListener("animationend", () => clone.remove());
    }
  
    function playSubmitFX(){
      const selBtn = container.querySelector(".btn.sel");
      if (!selBtn) return;
  
      clearTrails();
      padShell.classList.add("fx");
  
      makeTrailClone(selBtn, "t2");
      makeTrailClone(selBtn, "t1");
  
      selBtn.classList.add("sucked");
      container.querySelectorAll(".btn").forEach(b => {
        if (b !== selBtn) b.style.opacity = "0.50";
      });
  
      setTimeout(() => padShell.classList.remove("fx"), 650);
    }
  
    // ===== submit (quiz/text only) =====
    submitBtn.onclick = async () => {
      if (isGame) return; // â˜…ã‚²ãƒ¼ãƒ ã§ã¯ä½¿ã‚ãªã„
      if (!isOpen || sending) return;
  
      let payload = null;
  
      if (currentMode === "ox" || currentMode === "five"){
        if (!selected) return;
        payload = { value: selected, timestamp: Date.now() };
        sending = true;
        submitBtn.disabled = true;
        container.style.pointerEvents = "none";
        playSubmitFX();
      } else if (currentMode === "text"){
        const text = (textValue || "").trim();
        if (!text) return;
        payload = { value: text, timestamp: Date.now() };
        sending = true;
        submitBtn.disabled = true;
        container.style.pointerEvents = "none";
      } else {
        return;
      }
  
      try{
        await set(ref(db, `rooms/${room}/answers/${userId}`), payload);
      }catch(e){
        sending = false;
        container.style.pointerEvents = "";
        showToast("é€ä¿¡å¤±æ•—â€¦ã‚‚ã†ä¸€åº¦");
        if (currentMode === "text") renderText();
        if (currentMode === "ox") renderOX(["O","X"]);
        if (currentMode === "five") renderFive(["A","B","C","D","E"]);
        return;
      }
  
      setTimeout(() => {
        container.style.pointerEvents = "";
        showToast("é€ä¿¡ã—ã¾ã—ãŸ âœ“");
        lockUI();
      }, (currentMode === "ox" || currentMode === "five") ? 560 : 220);
    };
  
    // ===== Game render =====
    function renderGameFive(){
      isGame = true;
      submitBtn.style.display = "none"; // â˜…æ±ºå®šãƒœã‚¿ãƒ³ã¯ä½¿ã‚ãªã„
  
      // ãƒ©ã‚¦ãƒ³ãƒ‰ãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹ãŸã³ã«å‚åŠ ã§ãã‚‹ã‚ˆã†ã«
      unlockUI();
      mySeat = null;
      claimBusy = false;
  
      container.innerHTML = "";
      hudMode.textContent = `GAME${(gameRound!=null ? ` R${gameRound}` : "")}`;
      modeText.textContent = "mode: game(A-E)";
  
      const grid = document.createElement("div");
      grid.className = "fiveGrid";
  
      const order = ["A","B","C","D","E"];
      const posClass = { A:"posA", B:"posB", C:"posC", D:"posD", E:"posE" };
  
      const onPress = async (c, btn) => {
        if (!isGame) return;
        if (!isOpen) return;
        if (mySeat != null) return;
        if (claimBusy) return;
  
        // æ®‹å¸­ãŒè¦‹ãˆã¦ã‚‹å ´åˆï¼š0ã¯æŠ¼ã›ãªã„ï¼ˆã‚¬ã‚¤ãƒ‰ï¼‰
        const rem = Number(gameSeatsRemain[c] || 0);
        if (rem <= 0){
          showToast(`${c} ã¯æº€å¸­ï¼`);
          return;
        }
  
        haptic();
        claimBusy = true;
        updateGameButtonsAvailability();
  
        // ã€Œã©ã“ã«é›†ã¾ã£ã¦ã„ã‚‹ã‹ã€ã®å‚è€ƒç”¨ï¼ˆdisplay_gameã®æ··é›‘è¡¨ç¤ºã«ä½¿ãˆã‚‹ï¼‰
        // â€»ä¸Šæ›¸ããªã®ã§äººæ•°ã‚«ã‚¦ãƒ³ãƒˆã¯å¢—ãˆãªã„
        set(ref(db, `rooms/${room}/answers/${userId}`), { value: c, timestamp: Date.now(), game: true }).catch(()=>{});
  
        const okSeat = await claimSeatTransaction(c);
  
        claimBusy = false;
  
        if (okSeat){
          mySeat = okSeat;
          showToast(`${okSeat} ã«åº§ã‚ŒãŸï¼`);
          fireSeatWinFx(okSeat);   // â˜…è¿½åŠ 
          lockUI(); // ã“ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¯å›ºå®š
        }else{
          showToast("å–ã‚Œãªã‹ã£ãŸï¼åˆ¥ã®æ¤…å­ã¸");
          fireSeatLoseFx();        // â˜…è¿½åŠ 
        }
  
        updateGameButtonsAvailability();
        updateGameLine();
      };
  
      order.forEach(ch => {
        const btn = createChoiceButton(ch, onPress);
        btn.classList.add(posClass[ch] || "");
        grid.appendChild(btn);
      });
  
      container.appendChild(grid);
      updateGameButtonsAvailability();
      updateGameLine();
    }
  
    function updateGameLine(){
      if (!isGame){
        setGameLine("");
        return;
      }
      const r = gameSeatsRemain || {A:0,B:0,C:0,D:0,E:0};
      const remainText = `æ®‹å¸­ A${r.A} B${r.B} C${r.C} D${r.D} E${r.E}`;
      const meText = mySeat ? ` / ã‚ãªãŸ: ${mySeat}` : "";
      const ph = gamePhase ? ` / phase:${gamePhase}` : "";
      setGameLine(remainText + meText + ph);
    }
  
    // ===== Core: å…ˆç€ç¢ºä¿ï¼ˆtransactionï¼‰ =====
    async function claimSeatTransaction(choiceKey){
      const k = normKey(choiceKey);
      if (!["A","B","C","D","E"].includes(k)) return null;
    
      const gameRef = ref(db, `rooms/${room}/activity/game`);
    
      try{
        const res = await runTransaction(gameRef, (game) => {
          if (!game || typeof game !== "object") return; // â†ä¸­æ–­
    
          const phase = String(game.phase || "").trim();
          // â˜…å—ä»˜ã¯ openï¼ˆå¾Œæ–¹äº’æ›ã§ running ã‚‚è¨±å¯ï¼‰
          if (phase && phase !== "open" && phase !== "running") return; // â†ä¸­æ–­

    
          const round = Number(game.round || 0);
    
          game.players ??= {};
    
          // ã™ã§ã«â€œä»Šãƒ©ã‚¦ãƒ³ãƒ‰â€ã§åº§ã£ã¦ãŸã‚‰ã€ãã®ã¾ã¾ï¼ˆDBæ›´æ–°ã¯ã—ãªã„ï¼‰
          const cur = game.players[userId];
          if (cur && Number(cur.round || 0) === round && cur.seat) return; // â†ä¸­æ–­
    
          // seatsRemainå„ªå…ˆã€ç„¡ã‘ã‚Œã°seats
          const hasSeatsRemain = (game.seatsRemain && typeof game.seatsRemain === "object");
          const hasSeats       = (game.seats && typeof game.seats === "object");
          if (!hasSeatsRemain && !hasSeats) return; // â†ä¸­æ–­ï¼ˆå…ˆç”Ÿå´åˆæœŸåŒ–å¾…ã¡ï¼‰
    
          const target = hasSeatsRemain ? "seatsRemain" : "seats";
          game[target] ??= {A:0,B:0,C:0,D:0,E:0};
    
          const remain = Math.max(0, Math.floor(Number(game[target][k] || 0)));
          if (remain <= 0) return; // â†ä¸­æ–­ï¼ˆæº€å¸­ï¼‰
    
          // ç¢ºä¿
          game[target][k] = remain - 1;
          game.players[userId] = { seat: k, round, at: Date.now() };
    
          return game; // â†ã“ã“ã ã‘æ›´æ–°ã‚³ãƒŸãƒƒãƒˆ
        });
        showToast(`TX committed=${res.committed} /æŠ¼:${k}`);
    
        // é‡è¦ï¼šè¿”ã™ seat ã¯ã€Œç¾åœ¨ãƒ©ã‚¦ãƒ³ãƒ‰ã€ã ã‘
        const g = res.snapshot.val();
        const p = g?.players?.[userId];
    
        if (!p) return null;
        if (Number(p.round || 0) !== Number(gameRound || 0)) return null;
    
        const seat = normKey(p.seat);
        if (!["A","B","C","D","E"].includes(seat)) return null;
    
        // æŠ¼ã—ãŸã‚­ãƒ¼ã¨é•ã† seat ãŒè¿”ã£ã¦ããŸã‚‰äº‹æ•…ãªã®ã§ç„¡åŠ¹ï¼ˆå¥½ã¿ã§å¤–ã—ã¦OKï¼‰
        if (seat !== k) return null;
    
        return seat;
      }catch(e){
        console.warn("[game] claim failed:", e);
        return null;
      }
    }
  
    // ===== å†æç”»æ¡ä»¶ï¼ˆã‚¿ã‚¤ãƒãƒ¼æ›´æ–°ã§ã¯å†æç”»ã—ãªã„ï¼‰=====
    let lastStatus = null;
    let lastMode = null;
    let lastView = null;
    let lastConfigKey = "";
  
    function makeConfigKey(mode, config){
      const c = config || {};
      if (mode === "text") return "text";
      const arr = Array.isArray(c.choices) ? c.choices : [];
      return arr.map(x => String(x).trim().toUpperCase()).join(",");
    }
  
    // ===== activityç›£è¦– =====
    const activityRef = ref(db, `rooms/${room}/activity`);
    onValue(activityRef, snap => {
      const data = snap.val() || {};
      const status = data.status || "-";
      const mode = data.mode || null;
      const view = data.view || "quiz";
      const config = data.config || {};
      const game = data.game || null;
  
      // 1) æ¯å›è¿½éšï¼šopen/closed
      currentMode = mode;
      currentView = view;
      
      // game stateï¼ˆæ¯å›è¿½éšï¼šã“ã“ã¯åº§å¸­è¡¨ç¤ºã®æ›´æ–°ã«ä½¿ã†ï¼‰
      isGame = (view === "game");
      gameRound = (game && game.round != null) ? Number(game.round) : null;
      gamePhase = (game && game.phase != null) ? String(game.phase) : null;
      gameSeatsRemain = getRemainMap(game);
      
      // â˜…å…¥åŠ›å¯èƒ½åˆ¤å®šï¼šã‚²ãƒ¼ãƒ ä¸­ã¯ phase ã‚’å„ªå…ˆ
      const quizInputOpen = (status === "open");
      const gameInputOpen = (view === "game") && (gamePhase === "open" || gamePhase === "running");
      isOpen = isGame ? gameInputOpen : quizInputOpen;
  
      statusText.textContent = isGame
        ? `status: ${status} / phase: ${gamePhase || "-"}`
        : `status: ${status}`;

      dot.classList.toggle("open", isOpen);
      dot.classList.toggle("closed", !isOpen);
  
      // game stateï¼ˆæ¯å›è¿½éšï¼šã“ã“ã¯åº§å¸­è¡¨ç¤ºã®æ›´æ–°ã«ä½¿ã†ï¼‰
      isGame = (view === "game");
      gameRound = (game && game.round != null) ? Number(game.round) : null;
      gamePhase = (game && game.phase != null) ? String(game.phase) : null;
      gameSeatsRemain = getRemainMap(game);

      // â˜…è£œè¶³ï¼šDBå´ã§ seat ãŒç¢ºå®šã—ã¦ã„ãŸã‚‰ã€æŠ¼ä¸‹å‡¦ç†ã‚’çµŒç”±ã—ãªãã¦ã‚‚åæ˜ ï¼†FX
      if (isGame && game && game.players && game.players[userId]){
        const p = game.players[userId];
        const pr = Number(p.round || 0);
        const seat = String(p.seat || "").trim().toUpperCase();
      
        if (gameRound != null && pr === Number(gameRound) && ["A","B","C","D","E"].includes(seat)){
          if (mySeat !== seat){
            mySeat = seat;
            fireSeatWinFx(seat);
            lockUI();
            updateGameButtonsAvailability();
            updateGameLine();
          }
        }
      }

      // overlay
      if (!isOpen){
        let msg = "å…ˆç”Ÿã®æ“ä½œã‚’å¾…ã£ã¦ã„ã¾ã™â€¦";
        if (status === "closed"){
          if (isGame){
            if (gamePhase === "music") msg = "â™ª éŸ³æ¥½ä¸­â€¦ã€ã‚¹ãƒˆãƒƒãƒ—ã€ã§æŠ¼ã›ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚";
            else if (gamePhase === "reveal") msg = "ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†ï¼æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’å¾…ã£ã¦ãã ã•ã„ã€‚";
            else msg = "ã“ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¯ç· åˆ‡ï¼æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’å¾…ã£ã¦ãã ã•ã„ã€‚";
          } else {
            msg = "è§£ç­”ã¯ç· åˆ‡ã§ã™ã€‚å…ˆç”Ÿã®æ¬¡ã®æ“ä½œã‚’å¾…ã£ã¦ãã ã•ã„ã€‚";
          }
        }
        setOverlay(true, msg);
      }else{
        setOverlay(false);
      }
  
      // 2) å†æç”»åˆ¤å®šï¼ˆã‚¿ã‚¤ãƒãƒ¼æ›´æ–°ãªã©ã¯ç„¡è¦–ï¼‰
      const cfgKey = makeConfigKey(mode, config);
      const shouldRerender =
        (status !== lastStatus) ||
        (mode !== lastMode) ||
        (view !== lastView) ||
        (cfgKey !== lastConfigKey);
  
      // 3) å†æç”»ã—ãªã„å ´åˆã§ã‚‚ã€ã‚²ãƒ¼ãƒ æƒ…å ±ã ã‘ã¯æ›´æ–°
      if (!shouldRerender){
        if (isGame){
          // roundãŒå¤‰ã‚ã£ãŸã‚‰å‚åŠ ãƒªã‚»ãƒƒãƒˆï¼ˆã“ã“ãŒé‡è¦ï¼‰
          // view/mode/statusã¯åŒã˜ã§ã‚‚ round ã¯å¤‰ã‚ã‚‹ã®ã§ã“ã“ã§è¦‹ã‚‹
          const prevRound = Number(container.dataset.gameRound || "NaN");
          if (!Number.isNaN(gameRound) && gameRound !== prevRound){
            container.dataset.gameRound = String(gameRound);
            renderGameFive();
            updateGameButtonsAvailability();
            updateGameLine();
            return;
          }
  
          updateGameButtonsAvailability();
          updateGameLine();
          return;
        }
  
        // textã®å…¥åŠ›ç¶™ç¶šï¼ˆå¾“æ¥ï¼‰
        const ta = container.querySelector("textarea");
        if (ta){
          ta.disabled = (!isOpen) || container.classList.contains("locked");
          submitBtn.disabled =
            (!isOpen) ||
            sending ||
            container.classList.contains("locked") ||
            ((textValue || "").trim().length === 0);
        } else {
          if (!isOpen) submitBtn.disabled = true;
        }
        return;
      }
  
      // 4) æœ¬è³ªçš„ã«å¤‰åŒ–ã—ãŸã®ã§å†æç”»
      lastStatus = status;
      lastMode = mode;
      lastView = view;
      lastConfigKey = cfgKey;
  
      // ã‚²ãƒ¼ãƒ 
      if (view === "game"){
        container.dataset.gameRound = (gameRound != null ? String(gameRound) : "");
        renderGameFive();
        updateGameButtonsAvailability();
        updateGameLine();
        return;
      }
  
      // é€šå¸¸æŠ•ç¥¨
      if (currentMode === "ox")   return renderOX(config.choices || ["O","X"]);
      if (currentMode === "five") return renderFive(config.choices || ["A","B","C","D","E"]);
      if (currentMode === "text") return renderText();
  
      // modeãŒç„¡ã„ï¼ˆåˆæœŸ/å¾…æ©Ÿï¼‰
      hudMode.textContent = "å¾…æ©Ÿ";
      modeText.textContent = `mode: ${currentMode || "-"}`;
      container.innerHTML = "";
      submitBtn.style.display = "block";
      submitBtn.disabled = true;
      setOverlay(true, "å…ˆç”ŸãŒå‡ºé¡Œã‚’é–‹å§‹ã™ã‚‹ã¨ã€è§£ç­”ãƒœã‚¿ãƒ³ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚");
    });

  // âœ… topbar ãŒ2æ®µã«ãªã£ã¦ã‚‚è¢«ã‚‰ãªã„ã‚ˆã†ã«ã€å®Ÿé«˜ã•ã‚’CSSå¤‰æ•°ã¸åæ˜ 
  function updateTopbarInset(){
    const tb = document.querySelector(".topbar");
    if (!tb) return;
    document.documentElement.style.setProperty("--topbarH", (tb.offsetHeight || 66) + "px");
  }
  
  // âœ… ã“ã“ã‹ã‚‰ä¸‹ï¼ˆå‘¼ã³å‡ºã—ã‚»ãƒƒãƒˆï¼‰ã‚’å¿…ãšä»˜ã‘ã‚‹
  updateTopbarInset();
  requestAnimationFrame(updateTopbarInset);
  setTimeout(updateTopbarInset, 200);
  window.addEventListener("resize", updateTopbarInset);
  
  </script>
</body>
</html>
