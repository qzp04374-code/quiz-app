<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClassSync Student</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      text-align: center;
      padding: 28px 18px;
      background: #0b1220;
      color: #f9fafb;
    }
    .hint{
      color:#cbd5e1;
      margin-top:6px;
      font-size:14px;
    }
    .choice-btn {
      width: 78px;
      height: 78px;
      margin: 10px;
      font-size: 30px;
      border-radius: 50%;
      border: none;
      background-color: #f1f1f4;
      color:#111827;
      box-shadow: 0 6px 16px rgba(0,0,0,0.35);
      transition: 0.15s;
    }
    .choice-btn.selected {
      background-color: #0a84ff;
      color: white;
      transform: scale(1.07);
    }
    .submit-btn {
      margin-top: 18px;
      padding: 14px 34px;
      font-size: 22px;
      border-radius: 16px;
      border: none;
      background-color: #0a84ff;
      color: white;
      box-shadow: 0 6px 16px rgba(0,0,0,0.35);
    }
    .locked {
      opacity: 0.5;
      pointer-events: none;
    }
    .state{
      margin-top:14px;
      color:#cbd5e1;
      font-size:14px;
    }
  </style>
</head>

<body>
  <h2>回答画面</h2>
  <div class="hint">投影画面を見て、A〜E / ○× を選んでください。</div>
  <div id="answer-container" style="margin-top:18px;"></div>
  <div id="state" class="state">出題待ち…</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBke-wTU16skpbK8z80ddK04tE154dHERQ",
    authDomain: "satosan-41eac.firebaseapp.com",
    databaseURL: "https://satosan-41eac-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "satosan-41eac",
    storageBucket: "satosan-41eac.firebasestorage.app",
    messagingSenderId: "992482993229",
    appId: "1:992482993229:web:e2c59b078233b0ed16e804",
    measurementId: "G-VT9FKHN3LT"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const url = new URL(window.location.href);
  const room = url.searchParams.get("room") || "kyoto-01";

  // userId 永続化
  let userId = localStorage.getItem("student_user_id");
  if (!userId) {
    userId = "user_" + Math.random().toString(36).slice(2, 8);
    localStorage.setItem("student_user_id", userId);
  }

  const container = document.getElementById("answer-container");
  const stateEl = document.getElementById("state");

  let isOpen = false;
  let selected = null;

  function lockUI() {
    container.classList.add("locked");
  }
  function unlockUI(){
    container.classList.remove("locked");
  }

  function renderChoices(choices) {
    container.innerHTML = "";
    selected = null;
    unlockUI();

    choices.forEach(ch => {
      const btn = document.createElement("button");
      btn.className = "choice-btn";
      btn.textContent = ch;

      btn.onclick = () => {
        if (!isOpen) return;
        selected = ch;
        document.querySelectorAll(".choice-btn").forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
      };
      container.appendChild(btn);
    });

    const submit = document.createElement("button");
    submit.className = "submit-btn";
    submit.textContent = "決定";

    submit.onclick = async () => {
      if (!isOpen || !selected) return;

      const answerRef = ref(db, `rooms/${room}/answers/${userId}`);
      await set(answerRef, { value: selected, timestamp: Date.now() });

      lockUI();
      stateEl.textContent = "送信しました";
    };

    container.appendChild(document.createElement("div"));
    container.appendChild(submit);
  }

  // activity を監視（mode/config/status が必須）
  const activityRef = ref(db, `rooms/${room}/activity`);
  onValue(activityRef, snap => {
    const data = snap.val();

    if (!data){
      stateEl.textContent = "出題待ち…";
      container.innerHTML = "";
      return;
    }

    isOpen = (data.status === "open");
    const mode = data.mode;
    const config = data.config || {};
    const choices = (config.choices && Array.isArray(config.choices)) ? config.choices : null;

    if (!mode){
      // mode が無いと student はUIを出せない（元の仕様）
      stateEl.textContent = "出題準備中…（mode待ち）";
      container.innerHTML = "";
      return;
    }

    if (!choices){
      stateEl.textContent = "出題準備中…（choices待ち）";
      container.innerHTML = "";
      return;
    }

    // 出題中/終了
    stateEl.textContent = isOpen ? "回答受付中" : "回答終了（次の出題を待ってください）";

    // UI描画
    renderChoices(choices);

    // status closed のときは押せない
    if (!isOpen) lockUI();
  });
</script>
</body>
</html>
