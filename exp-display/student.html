<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClassSync Student</title>

  <style>
    :root{
      --bg:#050608;
      --card: rgba(17,24,39,.72);
      --line: rgba(255,255,255,.10);
      --ink:#f9fafb;
      --muted:#cbd5e1;

      /* 色対応：正本（index/displayと一致） */
      --color-o:#34c759;
      --color-x:#ff3b30;
      --color-a:#0a84ff;
      --color-b:#30d158;
      --color-c:#ff9f0a;
      --color-d:#bf5af2;
      --color-e:#ff375f;

      --ok:#22c55e;
      --ng:#ef4444;

      --shadow: 0 20px 70px rgba(0,0,0,.65);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(99,102,241,.12), transparent 60%),
        radial-gradient(1000px 600px at 80% 10%, rgba(34,197,94,.10), transparent 60%),
        radial-gradient(1200px 700px at 50% 120%, rgba(245,158,11,.10), transparent 60%),
        var(--bg);
      color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:18px 12px 28px;
      overflow-x:hidden;
    }

    #buildTag{
      position:fixed; right:10px; bottom:10px;
      opacity:.55; font-size:12px; z-index:9999;
      background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.08);
      padding:6px 10px; border-radius:999px;
      backdrop-filter: blur(8px);
    }

    .card{
      width:min(720px, 96vw);
      background:var(--card);
      border:1px solid rgba(255,255,255,.08);
      border-radius:24px;
      box-shadow:var(--shadow);
      padding:16px 14px 18px;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.10), transparent 55%);
      transform: rotate(10deg);
      pointer-events:none;
    }

    .top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
      position:relative;
      z-index:1;
    }
    .room{
      font-weight:1000;
      letter-spacing:.08em;
      font-size:14px;
      opacity:.95;
      white-space:nowrap;
    }
    .badges{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(2,6,23,.60);
      border:1px solid rgba(255,255,255,.10);
      font-weight:1000;
      letter-spacing:.06em;
      font-size:12px;
      color:#e5e7eb;
      backdrop-filter: blur(8px);
    }

    .header{
      position:relative;
      z-index:1;
      margin: 6px 0 14px;
    }
    .title{
      margin:0 0 6px;
      font-size:18px;
      font-weight:1000;
      letter-spacing:.06em;
    }
    .hint{
      margin:0;
      color:rgba(203,213,225,.92);
      font-size:14px;
      line-height:1.45;
    }

    /* 画面切替アニメ */
    .stage{
      position:relative;
      z-index:1;
      transition: opacity .22s ease, transform .22s ease;
    }
    .stage.fade{
      opacity:0;
      transform: translateY(6px);
    }

    /* 選択ボタン：かっこよく */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:12px;
    }

    .btn{
      width:100%;
      border:none;
      border-radius:20px;
      padding:14px 14px;
      background:rgba(2,6,23,.55);
      border:1px solid rgba(255,255,255,.10);
      color:#f9fafb;
      cursor:pointer;
      box-shadow:0 12px 34px rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      transition: transform .10s ease, filter .10s ease, box-shadow .10s ease, border-color .10s ease;
      user-select:none;
      overflow:hidden;
      position:relative;
    }
    .btn::after{
      content:"";
      position:absolute; inset:-60%;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.14), transparent 55%);
      transform: rotate(12deg);
      opacity:0;
      transition:opacity .18s ease;
      pointer-events:none;
    }
    .btn:active{ transform: scale(.985); filter:brightness(.98); }
    .btn:hover::after{ opacity:.75; }

    .btn[disabled]{
      opacity:.45;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    .left{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }

    /* 大きいラベル（○/✕/Aなど） */
    .pill{
      width:56px;
      height:44px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1100;
      letter-spacing:.06em;
      color:#0b1220;
      flex:0 0 auto;
      box-shadow:0 10px 26px rgba(0,0,0,.35);
    }

    .pill.O{ background:var(--color-o); }
    .pill.X{ background:var(--color-x); color:#fff; }
    .pill.A{ background:var(--color-a); }
    .pill.B{ background:var(--color-b); }
    .pill.C{ background:var(--color-c); }
    .pill.D{ background:var(--color-d); color:#fff; }
    .pill.E{ background:var(--color-e); color:#fff; }

    .label{
      font-size:16px;
      font-weight:1000;
      letter-spacing:.04em;
      white-space:nowrap;
    }
    .sub{
      font-size:12px;
      color:rgba(203,213,225,.90);
      letter-spacing:.06em;
      white-space:nowrap;
    }

    .rightMark{
      font-weight:1000;
      color:rgba(203,213,225,.92);
      letter-spacing:.06em;
      white-space:nowrap;
    }

    /* 選択時の強調 */
    .btn.selected{
      border-color: rgba(34,197,94,.55);
      box-shadow:0 0 0 4px rgba(34,197,94,.16), 0 18px 60px rgba(0,0,0,.45);
      transform: translateY(-1px);
    }

    /* text入力 */
    .textBox{
      margin-top:12px;
      padding:12px;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(2,6,23,.55);
      box-shadow:0 12px 34px rgba(0,0,0,.30);
    }
    textarea{
      width:100%;
      min-height:110px;
      resize:vertical;
      border:none;
      outline:none;
      background:transparent;
      color:#f9fafb;
      font-size:16px;
      line-height:1.50;
      font-weight:800;
    }
    .row{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .send{
      flex:1;
      border:none;
      border-radius:999px;
      padding:12px 14px;
      font-weight:1100;
      letter-spacing:.06em;
      background: linear-gradient(135deg, var(--color-o), #06b6d4);
      color:#041016;
      cursor:pointer;
      box-shadow:0 16px 40px rgba(0,0,0,.35);
      transition: transform .10s ease, filter .10s ease;
    }
    .send:active{ transform:scale(.985); filter:brightness(.98); }
    .send:disabled{ opacity:.45; cursor:not-allowed; box-shadow:none; }

    .clear{
      width:120px;
      border:none;
      border-radius:999px;
      padding:12px 14px;
      font-weight:1000;
      letter-spacing:.06em;
      background: rgba(75,85,99,.85);
      color:#f9fafb;
      cursor:pointer;
      transition: transform .10s ease, filter .10s ease;
    }
    .clear:active{ transform:scale(.985); filter:brightness(.98); }
    .clear:disabled{ opacity:.45; cursor:not-allowed; }

    .msg{
      margin-top:12px;
      padding:10px 12px;
      border-radius:16px;
      background:rgba(2,6,23,.55);
      border:1px solid rgba(255,255,255,.08);
      color:#e5e7eb;
      font-size:14px;
      line-height:1.45;
      white-space:pre-wrap;
      position:relative;
      z-index:1;
    }
    .msg.ok{ border-color: rgba(34,197,94,.35); }
    .msg.ng{ border-color: rgba(239,68,68,.35); }
  </style>
</head>

<body>
  <div id="buildTag">build: 2025-12-27 / student-colorsync-noproblem</div>

  <div class="card">
    <div class="top">
      <div class="room" id="roomLabel">ROOM</div>
      <div class="badges">
        <span class="badge" id="modeBadge">—</span>
        <span class="badge" id="statusBadge">status: -</span>
      </div>
    </div>

    <div class="header">
      <div class="title" id="title">接続中…</div>
      <p class="hint" id="hint">ボタンで回答してください。</p>
    </div>

    <div class="stage" id="stage">
      <div class="grid" id="choices"></div>

      <div class="textBox" id="textBox" style="display:none;">
        <textarea id="textInput" placeholder="ここに入力して送信"></textarea>
        <div class="row">
          <button id="sendTextBtn" class="send">送信</button>
          <button id="clearTextBtn" class="clear">消去</button>
        </div>
      </div>

      <div class="msg" id="msg" style="display:none;"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set } from
      "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBke-wTU16skpbK8z80ddK04tE154dHERQ",
      authDomain: "satosan-41eac.firebaseapp.com",
      databaseURL: "https://satosan-41eac-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "satosan-41eac"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const url = new URL(location.href);
    const room = url.searchParams.get("room") || "kyoto-01";

    // uid（端末ごと）
    const uidKey = "classsync_uid_v2";
    let uid = localStorage.getItem(uidKey);
    if (!uid) {
      uid = "u_" + Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4);
      localStorage.setItem(uidKey, uid);
    }

    // refs
    const activityRef = ref(db, `rooms/${room}/activity`);
    const answersMyRef= ref(db, `rooms/${room}/answers/${uid}`);

    // DOM
    const roomLabel = document.getElementById("roomLabel");
    const modeBadge = document.getElementById("modeBadge");
    const statusBadge = document.getElementById("statusBadge");
    const titleEl = document.getElementById("title");
    const hintEl  = document.getElementById("hint");

    const stage = document.getElementById("stage");
    const choicesEl = document.getElementById("choices");

    const textBox = document.getElementById("textBox");
    const textInput = document.getElementById("textInput");
    const sendTextBtn = document.getElementById("sendTextBtn");
    const clearTextBtn = document.getElementById("clearTextBtn");

    const msgEl = document.getElementById("msg");

    roomLabel.textContent = `ROOM: ${room}`;

    // state
    let currentStatus = "closed";
    let currentView = "quiz"; // quiz | poll（学生UIは同じ動作にする）
    let currentMode = null;   // ox | five | text
    let configChoices = null;

    function uiLabel(key){
      const k = String(key).trim().toUpperCase();
      if (k === "O") return "○";
      if (k === "X") return "✕";
      return k;
    }

    function defaultChoicesFromMode(mode){
      if (mode === "ox") return ["O","X"];
      if (mode === "five") return ["A","B","C","D","E"];
      return ["A","B","C","D","E"];
    }

    function showMsg(text, kind){
      msgEl.style.display = "block";
      msgEl.classList.remove("ok","ng");
      if (kind) msgEl.classList.add(kind);
      msgEl.textContent = text;
    }
    function hideMsg(){
      msgEl.style.display = "none";
      msgEl.textContent = "";
    }

    function setDisabled(disabled){
      Array.from(choicesEl.querySelectorAll("button")).forEach(b => b.disabled = disabled);
      sendTextBtn.disabled = disabled;
      clearTextBtn.disabled = disabled;
      textInput.disabled = disabled;
    }

    function animateSwitch(){
      stage.classList.add("fade");
      setTimeout(()=> stage.classList.remove("fade"), 160);
    }

    async function submitValue(value){
      if (currentStatus !== "open"){
        showMsg("受付は終了しています。", "ng");
        return;
      }
      await set(answersMyRef, { value, timestamp: Date.now() });
      showMsg("送信しました（必要なら押し直し/再送信で変更できます）", "ok");
    }

    function renderChoiceButtons(keys){
      choicesEl.innerHTML = "";
      textBox.style.display = "none";

      (keys || []).forEach(k => {
        const key = String(k).trim().toUpperCase();
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.type = "button";

        const left = document.createElement("div");
        left.className = "left";

        const pill = document.createElement("div");
        pill.className = `pill ${key}`;
        pill.textContent = uiLabel(key);

        const labelWrap = document.createElement("div");
        const label = document.createElement("div");
        label.className = "label";
        label.textContent = (key === "O" || key === "X") ? "回答" : "選択";
        const sub = document.createElement("div");
        sub.className = "sub";
        sub.textContent = (key === "O" || key === "X") ? "○ / ✕" : "A〜E";
        labelWrap.appendChild(label);
        labelWrap.appendChild(sub);

        left.appendChild(pill);
        left.appendChild(labelWrap);

        const right = document.createElement("div");
        right.className = "rightMark";
        right.textContent = "タップ";

        btn.appendChild(left);
        btn.appendChild(right);

        btn.onclick = async () => {
          // 見た目：選択を強調
          Array.from(choicesEl.querySelectorAll("button")).forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");
          await submitValue(key);
        };

        choicesEl.appendChild(btn);
      });

      setDisabled(currentStatus !== "open");
    }

    function renderTextInput(){
      choicesEl.innerHTML = "";
      textBox.style.display = "block";
      setDisabled(currentStatus !== "open");
    }

    function setHeader(){
      statusBadge.textContent = `status: ${currentStatus}`;
      const viewLabel = (currentView === "poll") ? "口頭投票" : "授業";
      const modeLabel =
        (currentMode === "ox") ? "2択（○✕）" :
        (currentMode === "five") ? "5択（ABCDE）" :
        (currentMode === "text") ? "文字入力" : "—";
      modeBadge.textContent = `${viewLabel} / ${modeLabel}`;
    }

    function applyUI(){
      hideMsg();
      animateSwitch();

      if (currentStatus === "closed"){
        titleEl.textContent = "受付終了";
        hintEl.textContent  = "先生の指示を待ってください。";
      } else {
        titleEl.textContent = "回答してください";
        hintEl.textContent  = "ボタンを押すと送信されます。";
      }

      // 学生は “問題文を一切表示しない”
      if (currentMode === "text"){
        hintEl.textContent = (currentStatus === "open")
          ? "入力して「送信」を押してください。"
          : "受付終了です（先生の指示を待ってください）。";
        renderTextInput();
        return;
      }

      const keys = (Array.isArray(configChoices) && configChoices.length)
        ? configChoices.map(x => String(x).trim().toUpperCase())
        : defaultChoicesFromMode(currentMode);

      renderChoiceButtons(keys);
    }

    // activity監視
    onValue(activityRef, snap => {
      const a = snap.val() || {};
      const prevMode = currentMode;
      const prevStatus = currentStatus;

      currentStatus = a.status || "closed";
      currentView = a.view || "quiz";
      currentMode = a.mode || null;

      configChoices = (a.config && Array.isArray(a.config.choices)) ? a.config.choices : null;

      setHeader();

      // モード/状態が変わったときだけUI再描画
      if (prevMode !== currentMode || prevStatus !== currentStatus){
        applyUI();
      } else {
        // 受付終了だけは即反映
        setDisabled(currentStatus !== "open");
      }
    });

    // text送信
    sendTextBtn.onclick = async () => {
      const v = (textInput.value || "").trim();
      if (!v){
        showMsg("文字を入力してください。", "ng");
        return;
      }
      await submitValue(v);
    };
    clearTextBtn.onclick = () => {
      textInput.value = "";
      hideMsg();
    };

    // 初期表示
    applyUI();
  </script>
</body>
</html>
