<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClassSync Student</title>

  <style>
    :root{
      --bg:#050608;
      --panel:#111827;
      --panel2:#020617;
      --line:rgba(255,255,255,.10);
      --ink:#f9fafb;
      --muted:#cbd5e1;

      --a:#0a84ff;
      --b:#30d158;
      --c:#ff9f0a;
      --d:#bf5af2;
      --e:#ff375f;

      --o:#34c759;
      --x:#ff3b30;

      --ok:#22c55e;
      --danger:#ef4444;
    }

    body{
      margin:0;
      min-height:100vh;
      background:var(--bg);
      color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:18px 12px 28px;
      box-sizing:border-box;
    }

    #buildTag{
      position:fixed; right:10px; bottom:10px;
      opacity:.55; font-size:12px; z-index:9999;
      background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.08);
      padding:6px 10px; border-radius:999px;
      backdrop-filter: blur(8px);
    }

    .card{
      width:min(720px, 96vw);
      background:rgba(17,24,39,.70);
      border:1px solid rgba(255,255,255,.08);
      border-radius:22px;
      box-shadow:0 18px 60px rgba(0,0,0,.65);
      padding:16px 14px 18px;
      box-sizing:border-box;
    }

    .top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }

    .room{
      font-weight:1000;
      letter-spacing:.08em;
      font-size:15px;
      opacity:.95;
      white-space:nowrap;
    }

    .status{
      font-size:13px;
      color:var(--muted);
      white-space:nowrap;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(2,6,23,.60);
      border:1px solid rgba(255,255,255,.10);
      font-weight:900;
      letter-spacing:.06em;
      font-size:12px;
      color:#e5e7eb;
    }

    .title{
      margin:6px 0 10px;
      font-size:18px;
      font-weight:1000;
      letter-spacing:.06em;
    }

    .hint{
      margin:0 0 12px;
      color:var(--muted);
      font-size:14px;
      line-height:1.45;
    }

    .question{
      margin:0 0 12px;
      padding:14px 14px;
      border-radius:18px;
      background:rgba(2,6,23,.62);
      border:1px solid rgba(255,255,255,.08);
      font-size:18px;
      font-weight:900;
      line-height:1.35;
      white-space:pre-wrap;
    }

    .choices{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }

    .btn{
      width:100%;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(2,6,23,.62);
      color:#f9fafb;
      font-weight:1000;
      font-size:16px;
      letter-spacing:.04em;
      text-align:left;
      cursor:pointer;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      transition:transform .10s ease, filter .10s ease, box-shadow .10s ease, opacity .10s ease;
      user-select:none;
    }
    .btn:active{ transform:scale(.98); filter:brightness(.98); }
    .btn[disabled]{
      opacity:.45;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:40px;
      height:28px;
      border-radius:999px;
      font-weight:1000;
      margin-right:10px;
      color:#0b1220;
      background:#94a3b8;
      letter-spacing:.06em;
      flex:0 0 auto;
    }
    .pill.A{ background:var(--a); }
    .pill.B{ background:var(--b); }
    .pill.C{ background:var(--c); }
    .pill.D{ background:var(--d); color:#fff; }
    .pill.E{ background:var(--e); color:#fff; }
    .pill.O{ background:var(--o); }
    .pill.X{ background:var(--x); color:#fff; }

    .selected{
      outline: none;
      border-color: rgba(34,197,94,.55);
      box-shadow:0 0 0 3px rgba(34,197,94,.18), 0 18px 60px rgba(0,0,0,.45);
    }

    .textBox{
      margin-top:10px;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(2,6,23,.62);
    }

    textarea{
      width:100%;
      min-height:96px;
      resize:vertical;
      border:none;
      outline:none;
      background:transparent;
      color:#f9fafb;
      font-size:16px;
      line-height:1.45;
      font-weight:700;
    }

    .row{
      display:flex;
      gap:10px;
      margin-top:10px;
    }

    .send{
      flex:1;
      text-align:center;
      background:linear-gradient(135deg, #22c55e, #06b6d4);
      border:none;
    }

    .clear{
      width:120px;
      text-align:center;
      background:rgba(75,85,99,.9);
      border:none;
    }

    .msg{
      margin-top:12px;
      padding:10px 12px;
      border-radius:16px;
      background:rgba(2,6,23,.62);
      border:1px solid rgba(255,255,255,.08);
      color:#e5e7eb;
      font-size:14px;
      line-height:1.45;
      white-space:pre-wrap;
    }

    .msg.ok{ border-color: rgba(34,197,94,.35); }
    .msg.ng{ border-color: rgba(239,68,68,.35); }

    .small{
      margin-top:10px;
      color:rgba(203,213,225,.85);
      font-size:12px;
      line-height:1.4;
    }
  </style>
</head>

<body>
  <div id="buildTag">build: 2025-12-27 / student-pollfix</div>

  <div class="card">
    <div class="top">
      <div class="room" id="roomLabel">ROOM</div>
      <div class="status">
        <span class="badge" id="modeBadge">—</span>
        <span class="badge" id="statusBadge">status: -</span>
      </div>
    </div>

    <div class="title" id="title">接続中…</div>
    <div class="hint" id="hint">先生の指示に従って回答してください。</div>

    <div class="question" id="questionBox" style="display:none;"></div>

    <div class="choices" id="choices"></div>

    <div class="textBox" id="textBox" style="display:none;">
      <textarea id="textInput" placeholder="ここに入力して送信"></textarea>
      <div class="row">
        <button class="btn send" id="sendTextBtn">送信</button>
        <button class="btn clear" id="clearTextBtn">消去</button>
      </div>
    </div>

    <div class="msg" id="msg" style="display:none;"></div>
    <div class="small" id="smallNote"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getDatabase, ref, onValue, set
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBke-wTU16skpbK8z80ddK04tE154dHERQ",
      authDomain: "satosan-41eac.firebaseapp.com",
      databaseURL: "https://satosan-41eac-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "satosan-41eac"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const url = new URL(location.href);
    const room = url.searchParams.get("room") || "kyoto-01";

    // ---- uid（端末ごと）----
    const uidKey = "classsync_uid_v1";
    let uid = localStorage.getItem(uidKey);
    if (!uid) {
      uid = "u_" + Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4);
      localStorage.setItem(uidKey, uid);
    }

    // ---- refs ----
    const activityRef = ref(db, `rooms/${room}/activity`);
    const qidRef      = ref(db, `rooms/${room}/quiz/current_question_id`);
    const answersMyRef= ref(db, `rooms/${room}/answers/${uid}`);
    const qRef = (qid) => ref(db, `rooms/${room}/questions/${qid}`);

    // ---- DOM ----
    const roomLabel = document.getElementById("roomLabel");
    const modeBadge = document.getElementById("modeBadge");
    const statusBadge = document.getElementById("statusBadge");

    const titleEl = document.getElementById("title");
    const hintEl  = document.getElementById("hint");
    const questionBox = document.getElementById("questionBox");
    const choicesEl = document.getElementById("choices");

    const textBox = document.getElementById("textBox");
    const textInput = document.getElementById("textInput");
    const sendTextBtn = document.getElementById("sendTextBtn");
    const clearTextBtn = document.getElementById("clearTextBtn");

    const msgEl = document.getElementById("msg");
    const smallNote = document.getElementById("smallNote");

    roomLabel.textContent = `ROOM: ${room}`;

    // ---- state ----
    let currentStatus = "closed";
    let currentView = "quiz"; // quiz | poll
    let currentMode = null;   // ox | five | text
    let configChoices = null;
    let currentQid = null;
    let currentQuestion = null;

    let selected = null; // 選んだ値

    function showMsg(text, kind){
      msgEl.style.display = "block";
      msgEl.classList.remove("ok","ng");
      if (kind) msgEl.classList.add(kind);
      msgEl.textContent = text;
    }
    function hideMsg(){
      msgEl.style.display = "none";
      msgEl.textContent = "";
    }

    async function submitValue(value){
      if (currentStatus !== "open"){
        showMsg("受付は終了しています。", "ng");
        return;
      }
      await set(answersMyRef, { value, timestamp: Date.now() });
      showMsg("送信しました。必要なら押し直して変更できます。", "ok");
    }

    function setButtonsDisabled(disabled){
      Array.from(choicesEl.querySelectorAll("button")).forEach(b => b.disabled = disabled);
      sendTextBtn.disabled = disabled;
      clearTextBtn.disabled = disabled;
      textInput.disabled = disabled;
    }

    function renderChoiceButtons(keys){
      choicesEl.innerHTML = "";
      textBox.style.display = "none";

      (keys || []).forEach(k => {
        const key = String(k).trim().toUpperCase();
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.type = "button";

        const pill = document.createElement("span");
        pill.className = `pill ${key}`;
        pill.textContent = key;

        const label = document.createElement("span");
        label.textContent = "選択";

        btn.appendChild(pill);
        btn.appendChild(label);

        btn.onclick = async () => {
          selected = key;
          // 見た目
          Array.from(choicesEl.querySelectorAll("button")).forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");
          await submitValue(key);
        };

        choicesEl.appendChild(btn);
      });

      setButtonsDisabled(currentStatus !== "open");
    }

    function renderTextInput(){
      choicesEl.innerHTML = "";
      questionBox.style.display = "none"; // poll文字は問題なし
      textBox.style.display = "block";
      setButtonsDisabled(currentStatus !== "open");
    }

    function setHeader(){
      statusBadge.textContent = `status: ${currentStatus}`;
      const viewLabel = (currentView === "poll") ? "口頭投票" : "授業問題";
      const modeLabel = (currentMode === "ox") ? "2択(○×)" : (currentMode === "five") ? "5択(A-E)" : (currentMode === "text") ? "文字入力" : "—";
      modeBadge.textContent = `${viewLabel} / ${modeLabel}`;
    }

    function applyUI(){
      hideMsg();

      // poll（口頭Q&A）：qid不要。modeに応じて即UIを出す
      if (currentView === "poll"){
        titleEl.textContent = "口頭Q&A：投票してください";
        hintEl.textContent  = (currentMode === "text")
          ? "入力して「送信」を押してください。"
          : "該当するボタンを押してください。";

        questionBox.style.display = "none";

        if (currentMode === "text"){
          renderTextInput();
        } else if (currentMode === "ox"){
          renderChoiceButtons(configChoices || ["O","X"]);
        } else {
          renderChoiceButtons(configChoices || ["A","B","C","D","E"]);
        }
        return;
      }

      // quiz（通常）：qidが無いなら待機
      if (!currentQid){
        titleEl.textContent = "先生の出題を待っています…";
        hintEl.textContent  = "出題開始後に解答ボタンが表示されます。";
        questionBox.style.display = "none";
        textBox.style.display = "none";
        choicesEl.innerHTML = "";
        setButtonsDisabled(true);
        return;
      }

      // quiz：問題がある
      titleEl.textContent = "問題に答えてください";
      hintEl.textContent  = "該当する選択肢を押してください。";

      if (currentQuestion && currentQuestion.question){
        questionBox.style.display = "block";
        questionBox.textContent = currentQuestion.question;
      } else {
        questionBox.style.display = "block";
        questionBox.textContent = "（問題データ読み込み中…）";
      }

      // quiz：choicesは問題データ優先
      if (currentQuestion && currentQuestion.choices){
        const keys = Object.keys(currentQuestion.choices).map(k => String(k).toUpperCase());
        renderChoiceButtons(keys);
        // ラベルを選択肢文に変える
        Array.from(choicesEl.querySelectorAll("button")).forEach(btn => {
          const key = btn.querySelector(".pill")?.textContent;
          const text = currentQuestion.choices[key];
          btn.querySelector("span:last-child").textContent = text ?? "選択";
        });
      } else {
        // フォールバック（mode/configがあればそれを使う）
        if (currentMode === "ox") renderChoiceButtons(configChoices || ["O","X"]);
        else renderChoiceButtons(configChoices || ["A","B","C","D","E"]);
      }
    }

    // ---- activity監視（view/mode/status/choices）----
    onValue(activityRef, snap => {
      const a = snap.val() || {};
      currentStatus = a.status || "closed";
      currentView = a.view || "quiz";
      currentMode = a.mode || null;

      // choicesの優先：config.choices
      configChoices = (a.config && Array.isArray(a.config.choices)) ? a.config.choices : null;

      setHeader();
      applyUI();
    });

    // ---- qid監視（quizでのみ使う）----
    onValue(qidRef, snap => {
      currentQid = snap.val() || null;
      // pollの時はqidを無視してUI固定
      if (currentView !== "quiz") return;
      applyUI();

      if (!currentQid) {
        currentQuestion = null;
        return;
      }

      // 問題データ購読
      onValue(qRef(currentQid), qsnap => {
        currentQuestion = qsnap.val() || null;
        if (currentView !== "quiz") return;
        applyUI();
      });
    });

    // ---- text送信 ----
    sendTextBtn.onclick = async () => {
      const v = (textInput.value || "").trim();
      if (!v){
        showMsg("文字を入力してください。", "ng");
        return;
      }
      await submitValue(v);
    };
    clearTextBtn.onclick = () => {
      textInput.value = "";
      hideMsg();
    };

    // note
    smallNote.textContent =
      "※送信後も押し直し/再送信で変更できます（受付中のみ）。";
  </script>
</body>
</html>
