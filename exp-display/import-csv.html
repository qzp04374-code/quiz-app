<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClassSync CSV Import</title>

<style>
  body{
    background:#050608;
    color:#f9fafb;
    font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
    margin:0;
    padding:24px;
  }
  h2{ text-align:center; }
  textarea{
    width:100%;
    height:260px;
    background:#020617;
    color:#e5e7eb;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    padding:14px;
    box-sizing:border-box;
    font-family:monospace;
    font-size:14px;
  }
  button{
    margin-top:12px;
    padding:12px 20px;
    border-radius:999px;
    border:none;
    background:#0ea5e9;
    color:white;
    font-size:15px;
    cursor:pointer;
  }
  #log{
    margin-top:14px;
    font-size:14px;
    color:#cbd5e1;
    white-space:pre-wrap;
  }
</style>
</head>

<body>
<h2>CSV → questions 投入</h2>

<textarea id="csvInput" placeholder="ここにCSVを貼り付けてください"></textarea>
<button id="importBtn">Firebase に投入</button>
<div id="log"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBke-wTU16skpbK8z80ddK04tE154dHERQ",
  databaseURL: "https://satosan-41eac-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "satosan-41eac"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

const room = new URLSearchParams(location.search).get("room") || "kyoto-01";

const log = msg => document.getElementById("log").textContent += msg + "\n";

function norm(h){
  return h.trim().toLowerCase().replace(/-/g,"_");
}

document.getElementById("importBtn").onclick = async () => {
  const text = document.getElementById("csvInput").value.trim();
  if (!text){ alert("CSVが空です"); return; }

  const lines = text.split(/\r?\n/).filter(l => l.trim());
  const rawHeaders = lines[0].split(",").map(norm);

  const idx = name => rawHeaders.indexOf(name);

  const qidIdx = idx("question_id");
  const qIdx   = idx("question");
  const ansIdx = idx("answer");
  const expIdx = idx("explanation");
  const modeIdx= idx("mode");

  if (qidIdx < 0 || qIdx < 0){
    alert("question-id / question 列が見つかりません");
    return;
  }

  let count = 0;
  const out = {};

  for (let i=1;i<lines.length;i++){
    const cols = lines[i].split(",");
    const qid = cols[qidIdx]?.trim();
    if (!qid) continue;

    const mode = (cols[modeIdx]||"").trim().toLowerCase();

    const q = {
      question: cols[qIdx] || "",
      answer: cols[ansIdx] || "",
      explanation: cols[expIdx] || "",
      mode: mode || undefined
    };

    // choices（text 以外）
    if (mode !== "text"){
      const choices = {};
      ["a","b","c","d","e"].forEach((k,n)=>{
        const v = cols[idx("choice"+k.toUpperCase())];
        if (v) choices[k.toUpperCase()] = v;
      });
      if (Object.keys(choices).length) q.choices = choices;
    }

    out[qid] = q;
    count++;
  }

  await set(ref(db, `rooms/${room}/questions`), out);
  log(`投入完了：${count}問（question-id / text 両対応）`);
};
</script>
</body>
</html>
