<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClassSync CSV Import</title>

<style>
  body{
    background:#050608;
    color:#f9fafb;
    font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
    margin:0;
    padding:24px;
  }
  h2{ text-align:center; margin-top:0; }
  .box{
    background:#111827;
    border-radius:20px;
    padding:18px;
    margin-bottom:16px;
    border:1px solid rgba(255,255,255,.08);
  }
  textarea{
    width:100%;
    height:240px;
    background:#020617;
    color:#e5e7eb;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    padding:14px;
    box-sizing:border-box;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-size:14px;
  }
  input[type=file]{
    margin-top:8px;
    color:#cbd5e1;
  }
  button{
    margin-top:12px;
    padding:12px 22px;
    border-radius:999px;
    border:none;
    background:#0ea5e9;
    color:white;
    font-size:15px;
    cursor:pointer;
    font-weight:900;
    letter-spacing:.04em;
  }
  button:active{ transform: scale(.99); }
  #log{
    margin-top:14px;
    font-size:14px;
    color:#cbd5e1;
    white-space:pre-wrap;
    line-height:1.6;
  }
  .hint{
    margin-top:10px;
    font-size:13px;
    color:#cbd5e1;
    opacity:.9;
    line-height:1.65;
  }
  code{
    background: rgba(255,255,255,.08);
    padding: 2px 6px;
    border-radius: 8px;
  }
</style>
</head>

<body>

<h2>CSV → questions 投入</h2>

<div class="box">
  <strong>room</strong>：<span id="roomLabel"></span><br>
  <div class="hint">
    URLに <code>?room=kyoto-01</code> のように指定できます。
  </div>
</div>

<div class="box">
  <strong>① CSVファイルから読み込む</strong><br>
  <input type="file" id="fileInput" accept=".csv">
</div>

<div class="box">
  <strong>② CSVを直接貼り付ける</strong>
  <textarea id="csvInput" placeholder="CSVをここに貼り付けてください"></textarea>

  <div class="hint">
    ✅ 分岐を入れたい場合は列を追加：<br>
    ○×用：<code>branch_o</code>, <code>branch_x</code><br>
    5択用：<code>branch_a</code>〜<code>branch_e</code><br>
    例：<code>branch_a</code> に <code>Q10</code> を入れると、Aが多数決のとき次は Q10 になります。
  </div>
</div>

<button id="importBtn">Firebase に投入</button>

<!-- 追加：CSV書き出し -->
<button id="exportRawBtn">貼り付け欄のCSVを保存</button>
<button id="exportNormalizedBtn">正規化してCSV保存（推奨）</button>

<div id="log"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBke-wTU16skpbK8z80ddK04tE154dHERQ",
  databaseURL: "https://satosan-41eac-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "satosan-41eac"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

const room = new URLSearchParams(location.search).get("room") || "kyoto-01";
document.getElementById("roomLabel").textContent = room;

const logEl = document.getElementById("log");

function log(msg){
  logEl.textContent += msg + "\n";
}

function normalizeHeader(h){
  // 大文字小文字・ハイフン差・空白差を吸収
  return String(h ?? "")
    .trim()
    .toLowerCase()
    .replace(/\s+/g, "")
    .replace(/-/g, "_");
}

/**
 * RFC4180 “っぽい” CSV 行パーサ
 * - ダブルクォート内のカンマを許容
 * - "" を " として扱う
 */
function parseCSVLine(line){
  const out = [];
  let cur = "";
  let inQuotes = false;

  for (let i=0; i<line.length; i++){
    const ch = line[i];

    if (inQuotes){
      if (ch === '"'){
        // "" -> "
        if (line[i+1] === '"'){ cur += '"'; i++; }
        else inQuotes = false;
      }else{
        cur += ch;
      }
      continue;
    }

    if (ch === '"'){ inQuotes = true; continue; }
    if (ch === ","){ out.push(cur); cur = ""; continue; }
    cur += ch;
  }
  out.push(cur);
  return out;
}

// 追加：直近の parse 結果を保持
let lastParsedOut = null;

// 追加：CSVエスケープ（カンマ/改行/" 対応）
function csvEscape(v){
  const s = String(v ?? "");
  if (/[",\r\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
  return s;
}

// 追加：out(questions) → ClassSync標準17列CSVに変換
function buildCanonicalCSVFromOut(out){
  const header = [
    "question_id","mode","question",
    "choiceA","choiceB","choiceC","choiceD","choiceE",
    "answer","explanation",
    "branch_o","branch_x","branch_a","branch_b","branch_c","branch_d","branch_e"
  ];

  const qids = Object.keys(out || {}).sort((a,b)=>{
  const na = parseInt(String(a).match(/^Q(\d+)/i)?.[1] || "999999", 10);
  const nb = parseInt(String(b).match(/^Q(\d+)/i)?.[1] || "999999", 10);
  if (na !== nb) return na - nb;
  // 同番号（枝番など）がある場合は文字列で安定化
  return String(a).localeCompare(String(b), "ja");
});
  const lines = [header.join(",")];

  for (const qid of qids){
    const q = out[qid] || {};
    const choices = q.choices || {};
    const branch  = q.branch  || {};

    const row = [
      qid,
      q.mode ?? "",
      q.question ?? "",
      choices.A ?? "",
      choices.B ?? "",
      choices.C ?? "",
      choices.D ?? "",
      choices.E ?? "",
      q.answer ?? "",
      q.explanation ?? "",
      branch.O ?? "",
      branch.X ?? "",
      branch.A ?? "",
      branch.B ?? "",
      branch.C ?? "",
      branch.D ?? "",
      branch.E ?? ""
    ];

    lines.push(row.map(csvEscape).join(","));
  }

  return lines.join("\r\n");
}

// 追加：CSVをダウンロード保存
function downloadText(filename, text){
  const blob = new Blob([text], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function stripBOM(s){
  return s.charCodeAt(0) === 0xFEFF ? s.slice(1) : s;
}

function firstIndex(headers, candidates){
  for (const c of candidates){
    const k = normalizeHeader(c);
    const i = headers.indexOf(k);
    if (i >= 0) return i;
  }
  return -1;
}

function getCell(cols, idx){
  if (idx < 0) return "";
  return String(cols[idx] ?? "").trim();
}

function pickChoiceValue(headers, cols, key){
  // key: "A".."E"
  const k = key.toUpperCase();
  const i = firstIndex(headers, [
    `choice${k}`, `choice_${k}`, `choice-${k}`,
    k, k.toLowerCase()
  ]);
  return getCell(cols, i);
}

function parseCSV(text){
  const rawLines = text.split(/\r?\n/);
  const lines = rawLines.map(l => l.trimEnd()).filter(l => l.trim() !== "");
  if (lines.length < 2) throw new Error("CSVの行数が足りません（ヘッダ+1行以上必要）");

  const headerLine = stripBOM(lines[0]);
  const headers = parseCSVLine(headerLine).map(normalizeHeader);

  const qidIdx = firstIndex(headers, ["question_id","question-id","qid","id"]);
  const qIdx   = firstIndex(headers, ["question","q"]);
  const ansIdx = firstIndex(headers, ["answer","ans"]);
  const expIdx = firstIndex(headers, ["explanation","exp","comment"]);
  const modeIdx= firstIndex(headers, ["mode","type"]);

  if (qidIdx < 0 || qIdx < 0){
    throw new Error("question_id（または qid）/ question（または q）列が見つかりません");
  }

  // branch列（任意）
  const bO = firstIndex(headers, ["branch_o","branch-o"]);
  const bX = firstIndex(headers, ["branch_x","branch-x"]);
  const bA = firstIndex(headers, ["branch_a","branch-a"]);
  const bB = firstIndex(headers, ["branch_b","branch-b"]);
  const bC = firstIndex(headers, ["branch_c","branch-c"]);
  const bD = firstIndex(headers, ["branch_d","branch-d"]);
  const bE = firstIndex(headers, ["branch_e","branch-e"]);

  const out = {};
  let count = 0;
  let branchCount = 0;

  for (let i=1; i<lines.length; i++){
    const cols = parseCSVLine(lines[i]);
    const qid = getCell(cols, qidIdx);
    if (!qid) continue;

    const mode = getCell(cols, modeIdx).toLowerCase(); // "ox" / "five" / "text" など
    const q = {
      question: getCell(cols, qIdx),
      answer: getCell(cols, ansIdx),
      explanation: getCell(cols, expIdx),
    };
    if (mode) q.mode = mode;

    // choices（five のときだけ作る）
if (mode === "five"){
  const choices = {};
  for (const k of ["A","B","C","D","E"]){
    const v = pickChoiceValue(headers, cols, k);
    if (v) choices[k] = v;
  }
  if (Object.keys(choices).length) q.choices = choices;
}

    // branch（入っているものだけ作る）
    const branch = {};
    const put = (key, idx) => {
      const v = getCell(cols, idx);
      if (v) branch[key] = v;
    };
    put("O", bO);
    put("X", bX);
    put("A", bA);
    put("B", bB);
    put("C", bC);
    put("D", bD);
    put("E", bE);

    if (Object.keys(branch).length){
      q.branch = branch;
      branchCount++;
    }

    out[qid] = q;
    count++;
  }

  lastParsedOut = out;
  return { out, count, branchCount };
}

// ファイル読み込み
document.getElementById("fileInput").addEventListener("change", e=>{
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    document.getElementById("csvInput").value = reader.result;
    logEl.textContent = "";
    log("CSVファイルを読み込みました");
  };
  reader.readAsText(file);
});

// 投入（questions を丸ごと置き換え）
document.getElementById("importBtn").onclick = async () => {
  logEl.textContent = "";
  try{
    const text = document.getElementById("csvInput").value.trim();
    if (!text) throw new Error("CSVが空です");

    const { out, count, branchCount } = parseCSV(text);
    if (count <= 0) throw new Error("有効な行がありません（question_id が空など）");

    await set(ref(db, `rooms/${room}/questions`), out);

    log(`✅ 投入完了：${count}問`);
    log(`✅ branch付き：${branchCount}問`);
    log(`room: ${room}`);
    log("対応：text / ox / five / choiceA..E / branch_*");
  }catch(err){
    console.error(err);
    log("❌ エラー");
    log(err?.message || String(err));
  }
};
// A) 貼り付け欄の内容をそのままCSV保存
document.getElementById("exportRawBtn").onclick = () => {
  logEl.textContent = "";
  const text = document.getElementById("csvInput").value.trim();
  if (!text){
    log("❌ 貼り付け欄が空です");
    return;
  }
  downloadText(`raw_${room}.csv`, text.endsWith("\n") ? text : (text + "\r\n"));
  log("✅ 貼り付け欄のCSVを保存しました");
};

// B) 正規化してCSV保存（17列固定・推奨）
document.getElementById("exportNormalizedBtn").onclick = () => {
  logEl.textContent = "";
  try{
    if (!lastParsedOut){
      const text = document.getElementById("csvInput").value.trim();
      if (!text) throw new Error("貼り付け欄が空です");
      const { out } = parseCSV(text);
      lastParsedOut = out;
    }

    const csv = buildCanonicalCSVFromOut(lastParsedOut);
    downloadText(`questions_${room}_canonical.csv`, csv + "\r\n");
    log("✅ 正規化CSV（17列固定）を保存しました");
  }catch(err){
    console.error(err);
    log("❌ エラー");
    log(err?.message || String(err));
  }
};
</script>

</body>
</html>
