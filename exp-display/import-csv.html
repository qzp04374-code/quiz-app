<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClassSync CSV Import</title>

<style>
  body{
    background:#050608;
    color:#f9fafb;
    font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
    margin:0;
    padding:24px;
  }
  h2{ text-align:center; margin-top:0; }
  .box{
    background:#111827;
    border-radius:20px;
    padding:18px;
    margin-bottom:16px;
    border:1px solid rgba(255,255,255,.08);
  }
  textarea{
    width:100%;
    height:220px;
    background:#020617;
    color:#e5e7eb;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    padding:14px;
    box-sizing:border-box;
    font-family:monospace;
    font-size:14px;
  }
  input[type=file]{
    margin-top:8px;
    color:#cbd5e1;
  }
  button{
    margin-top:12px;
    padding:12px 22px;
    border-radius:999px;
    border:none;
    background:#0ea5e9;
    color:white;
    font-size:15px;
    cursor:pointer;
  }
  #log{
    margin-top:14px;
    font-size:14px;
    color:#cbd5e1;
    white-space:pre-wrap;
    line-height:1.5;
  }
</style>
</head>

<body>

<h2>CSV → questions 投入</h2>

<div class="box">
  <strong>① CSVファイルから読み込む</strong><br>
  <input type="file" id="fileInput" accept=".csv">
</div>

<div class="box">
  <strong>② CSVを直接貼り付ける</strong>
  <textarea id="csvInput" placeholder="CSVをここに貼り付けてください"></textarea>
</div>

<button id="importBtn">Firebase に投入</button>

<div id="log"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBke-wTU16skpbK8z80ddK04tE154dHERQ",
  databaseURL: "https://satosan-41eac-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "satosan-41eac"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

const room = new URLSearchParams(location.search).get("room") || "kyoto-01";
const logEl = document.getElementById("log");

function log(msg){
  logEl.textContent += msg + "\n";
}

function normalizeHeader(h){
  return h.trim().toLowerCase().replace(/-/g,"_");
}

function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l => l.trim());
  if (lines.length < 2) throw new Error("CSVの行数が足りません");

  const headers = lines[0].split(",").map(normalizeHeader);
  const idx = name => headers.indexOf(name);

  const qidIdx = idx("question_id");
  const qIdx   = idx("question");
  const ansIdx = idx("answer");
  const expIdx = idx("explanation");
  const modeIdx= idx("mode");

  if (qidIdx < 0 || qIdx < 0){
    throw new Error("question-id / question 列が見つかりません");
  }

  const out = {};
  let count = 0;

  for (let i=1;i<lines.length;i++){
    const cols = lines[i].split(",");
    const qid = cols[qidIdx]?.trim();
    if (!qid) continue;

    const mode = (cols[modeIdx]||"").trim().toLowerCase();

    const q = {
      question: cols[qIdx] || "",
      answer: cols[ansIdx] || "",
      explanation: cols[expIdx] || "",
      mode: mode || undefined
    };

    if (mode !== "text"){
      const choices = {};
      ["A","B","C","D","E"].forEach(k=>{
        const v = cols[idx("choice"+k)];
        if (v) choices[k] = v;
      });
      if (Object.keys(choices).length) q.choices = choices;
    }

    out[qid] = q;
    count++;
  }

  return { out, count };
}

// ファイル読み込み
document.getElementById("fileInput").addEventListener("change", e=>{
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    document.getElementById("csvInput").value = reader.result;
    log("CSVファイルを読み込みました");
  };
  reader.readAsText(file);
});

// 投入
document.getElementById("importBtn").onclick = async () => {
  logEl.textContent = "";
  try{
    const text = document.getElementById("csvInput").value.trim();
    if (!text) throw new Error("CSVが空です");

    const { out, count } = parseCSV(text);
    await set(ref(db, `rooms/${room}/questions`), out);

    log(`投入完了：${count}問`);
    log(`room: ${room}`);
    log("question-id / text / five / ox すべて対応");
  }catch(err){
    log("❌ エラー");
    log(err.message);
  }
};
</script>

</body>
</html>
