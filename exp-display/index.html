<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClassSync Teacher Control</title>

  <style>
    :root{
      --bg:#050608;
      --panel:#111827;
      --panel2:#020617;
      --ink:#f9fafb;
      --muted:#cbd5e1;

      --color-o:#34c759;
      --color-x:#ff3b30;
      --color-c:#ff9f0a;
      --color-d:#bf5af2;

      --danger:#ef4444;
      --danger2:#991b1b;
      --info:#0ea5e9;
      --indigo:#6366f1;
      --gray:#4b5563;
    }

    body{
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
      margin:0;
      min-height:100vh;
      background:var(--bg);
      display:flex;
      justify-content:center;
      padding:32px 0;
      color:var(--ink);
    }

    .card{
      background:var(--panel);
      border-radius:24px;
      padding:26px 22px 30px;
      max-width:1180px;
      width:100%;
      box-shadow:0 18px 60px rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.04);
      box-sizing:border-box;
    }

    h2{
      margin:0 0 14px 0;
      text-align:center;
      letter-spacing:.10em;
      font-weight:900;
    }

    .topRow{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:14px;
    }

    select, button{
      border:none;
      font-size:14px;
      border-radius:999px;
      padding:10px 18px;
      box-sizing:border-box;
    }

    select{
      background:var(--panel2);
      color:#e5e7eb;
      border:1px solid rgba(255,255,255,.12);
      outline:none;
      min-width: 180px;
    }

    button{
      cursor:pointer;
      color:#fff;
      background:#374151;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      transition:transform .12s ease, filter .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    button:active{ transform:scale(.97); filter:brightness(.98); }
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    /* クイック投票 */
    .quickWrap{
      margin: 10px auto 18px;
      padding: 14px 12px 12px;
      border-radius: 22px;
      background: rgba(2,6,23,.55);
      border:1px solid rgba(255,255,255,.08);
    }
    .quickTitle{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding-bottom:10px;
      color: var(--muted);
      font-weight:900;
      letter-spacing:.10em;
      font-size:13px;
    }
    .quickRow{
      display:flex;
      justify-content:center;
      gap:14px;
      flex-wrap:wrap;
    }
    .qbtn{
      width:100px;
      height:100px;
      border-radius:9999px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:6px;
      border:1px solid rgba(255,255,255,.10);
      font-weight:900;
      letter-spacing:.06em;
    }
    .q2{ background: linear-gradient(135deg, var(--color-o), #06b6d4); }
    .q5{ background: linear-gradient(135deg, var(--color-d), #a855f7); }
    .qt{ background: linear-gradient(135deg, var(--color-c), #f59e0b); color:#111827; }

    .button-row{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:10px;
      margin: 12px 0 16px;
    }

    #prevQuestionBtn { background: var(--gray); }
    #nextQuestionBtn { background: linear-gradient(135deg, var(--color-o), #06b6d4); }
    #stopBtn { background: var(--danger); }
    #endClassBtn { background: linear-gradient(135deg,var(--danger),var(--danger2)); }
    #qrBtn { background: var(--info); }
    #projectionBtn { background: linear-gradient(135deg,var(--indigo),#a855f7); }
    #importBtn { background: linear-gradient(135deg,var(--color-c),#f97316); }

    #preview{
      margin-top:18px;
      padding:18px;
      border-radius:20px;
      background: var(--panel2);
      border:1px solid rgba(255,255,255,.08);
    }

    .pvGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
      margin-top:10px;
    }
    @media (max-width: 980px){
      .pvGrid{ grid-template-columns: 1fr; } /* 画面が狭い時は縦 */
    }
    .pvCard{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding: 14px;
    }
    .pvHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .pvBadge{
      font-weight:1000;
      font-size:12px;
      letter-spacing:.12em;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(6,182,212,.22);
      border: 1px solid rgba(6,182,212,.35);
    }
    .pvBadge.next{
      background: rgba(168,85,247,.22);
      border: 1px solid rgba(168,85,247,.35);
    }
    .pvMeta{
      font-size:12px;
      opacity:.75;
      font-weight:900;
    }

    .pv-choice{ margin-left:12px; margin-bottom:4px; }
    .pv-answer{ margin-top:12px; font-weight:900; color:var(--color-o); }
    .pv-explanation{ margin-top:6px; font-size:14px; white-space:pre-wrap; }

    #buildTag{
      position:fixed; right:10px; bottom:10px;
      opacity:.60; font-size:12px; z-index:60;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.08);
      padding:6px 10px;
      border-radius:999px;
      backdrop-filter: blur(8px);
    }

    /* ===== 操作ボタン：3グループ化 ===== */
    .controlGroups{
      display:grid;
      gap:12px;
      margin: 12px 0 16px;
    }
    .btnGroup{
      padding: 12px 10px;
      border-radius: 22px;
      background: rgba(2,6,23,.55);
      border:1px solid rgba(255,255,255,.08);
    }
    .btnGroupTitle{
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .10em;
      font-size: 13px;
      margin: 0 0 10px 2px;
    }
    .btnRow{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:10px;
      margin-bottom:10px;
    }
    .btnRow:last-child{ margin-bottom:0; }

    /* 新ボタン（辞書） */
    #dictBtn { background: linear-gradient(135deg, var(--info), #22c55e); }

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, update, remove, onValue, get } from
      "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBke-wTU16skpbK8z80ddK04tE154dHERQ",
      databaseURL: "https://satosan-41eac-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "satosan-41eac"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // =========================================================
    // ルーム定義（★ここだけ触ればOK）
    // =========================================================
    const roomSelect = document.getElementById("roomSelect");

    const ROOMS = [
      { id: "kyoto-01",  label: "Kyoto-01"  },
      { id: "kyoto-02",  label: "Kyoto-02"  },
      { id: "sendai-01", label: "Sendai-01" },
      { id: "sendai-02", label: "Sendai-02" },
      { id: "nagoya-01", label: "Nagoya-01" },
      { id: "nagoya-02", label: "Nagoya-02" },
    ];

    function buildRoomOptions(){
      roomSelect.innerHTML = "";
      for (const r of ROOMS){
        const opt = document.createElement("option");
        opt.value = r.id;
        opt.textContent = r.label;
        roomSelect.appendChild(opt);
      }
    }

    // 初期ルーム：URL ?room → localStorage → 先頭
    const url = new URL(location.href);
    const urlRoom = url.searchParams.get("room");
    const savedRoom = localStorage.getItem("cs_teacher_room");

    buildRoomOptions();

    let currentRoom =
      (urlRoom && ROOMS.some(r => r.id === urlRoom)) ? urlRoom :
      (savedRoom && ROOMS.some(r => r.id === savedRoom)) ? savedRoom :
      ROOMS[0].id;

    roomSelect.value = currentRoom;

    // =========================================================
    // DOM
    // =========================================================
    const quickState = document.getElementById("quickState");

    const pvQuestion = document.getElementById("pvQuestion");
    const pvChoices  = document.getElementById("pvChoices");
    const pvAnswer   = document.getElementById("pvAnswer");
    const pvExplanation = document.getElementById("pvExplanation");
    const pvQid = document.getElementById("pvQid");
    const pvQuestionNext = document.getElementById("pvQuestionNext");
    const pvChoicesNext  = document.getElementById("pvChoicesNext");
    const pvAnswerNext   = document.getElementById("pvAnswerNext");
    const pvExplanationNext = document.getElementById("pvExplanationNext");
    const pvQidNext = document.getElementById("pvQidNext");

    const btnPrev = document.getElementById("prevQuestionBtn");
    const btnNext = document.getElementById("nextQuestionBtn");
    const btnStop = document.getElementById("stopBtn");
    const btnQR   = document.getElementById("qrBtn");

    const btnT20  = document.getElementById("t20Btn");
    const btnT30  = document.getElementById("t30Btn");
    const btnT60  = document.getElementById("t60Btn");
    const btnTOff = document.getElementById("tOffBtn");

    const btnQ2   = document.getElementById("quick2Btn");
    const btnQ5   = document.getElementById("quick5Btn");
    const btnQT   = document.getElementById("quickTextBtn");

    // =========================================================
    // Firebase refs helper
    // =========================================================
    function activityRef(room=currentRoom){ return ref(db, `rooms/${room}/activity`); }
    function answersRef(room=currentRoom){ return ref(db, `rooms/${room}/answers`); }
    function qidRef(room=currentRoom){ return ref(db, `rooms/${room}/quiz/current_question_id`); }
    function questionsRef(room=currentRoom){ return ref(db, `rooms/${room}/questions`); }
    function questionRef(qid, room=currentRoom){ return ref(db, `rooms/${room}/questions/${qid}`); }

    async function clearAnswers(){
      await set(answersRef(), {});
    }

    async function refreshOrder(){
      const snap = await get(questionsRef());
      return Object.keys(snap.val() || {}).sort();
    }

    async function updateNextSubscription(){
      const base = state.latestQid;
      if (!base){
        subscribeNextQuestion(null);
        return;
      }

      const order = await refreshOrder();
      const i = order.indexOf(base);
      const next = (i >= 0) ? (order[i+1] || null) : (order[0] || null);

      // 取得中にQIDが変わったら捨てる（race対策）
      if (state.latestQid !== base) return;

      subscribeNextQuestion(next);
    }

    function uiLabel(key){
      const k = String(key).trim().toUpperCase();
      if (k === "O") return "○";
      if (k === "X") return "✕";
      return k;
    }

    // =========================================================
    // 出題（quiz）
    // =========================================================
    async function startQuizQuestion(qid){
      if (!qid) return;

      await set(qidRef(), qid);
      await clearAnswers();

      const qs = await get(questionRef(qid));
      const q = qs.val() || {};

      let mode = (q.mode || "").toLowerCase().trim();
      if (!mode){
        const keys = q.choices ? Object.keys(q.choices).map(k => k.toUpperCase()) : [];
        if (keys.length === 2 && keys.includes("O") && keys.includes("X")) mode = "ox";
        else if (["A","B","C","D","E"].every(k => keys.includes(k))) mode = "five";
        else mode = "text";
      }

      let config = null;
      if (mode === "text") config = { type:"text" };
      else if (mode === "ox") config = { choices:["O","X"] };
      else if (mode === "five") config = { choices:["A","B","C","D","E"] };

      await update(activityRef(), {
        status:"open",
        qr:false,
        view:"quiz",
        mode,
        config,
        timer:{ running:false }
      });
    }

    // =========================================================
    // クイック投票（poll）
    // =========================================================
    async function startQuickPoll(mode){
      await clearAnswers();
      let config = null;
      if (mode === "text") config = { type:"text" };
      else if (mode === "ox") config = { choices:["O","X"] };
      else if (mode === "five") config = { choices:["A","B","C","D","E"] };

      await update(activityRef(), {
        status:"open",
        qr:false,
        view:"poll",
        mode,
        config,
        timer:{ running:false }
      });
    }

    // =========================================================
    // タイマー（解答終了カウントダウン）
    // =========================================================
    async function startTimer(sec){
       await update(activityRef(), {
        timer: {
          running: true,
          endsAt: Date.now() + sec * 1000,
          durationSec: sec,
          autoClose: true
        }
      });
    }

    async function stopTimer(){
      await update(activityRef(), { timer: { running: false } });
    }

    // =========================================================
    // QRトグル（★QR解除→standbyへ）
    // =========================================================
    const state = {
      activity: {},
      latestQid: null,
      question: null,
      unsubActivity: null,
      unsubQid: null,
      unsubQuestion: null
    };

    async function toggleQR(){
      const isQR = (state.activity?.qr === true);

      // QRを表示
      if (!isQR){
        await update(activityRef(), { qr:true, view:"qr" });
        return;
      }

      // QRを消す → スタンバイ（問題は出さない／学生も待機）
      await update(activityRef(), {
        qr:false,
        view:"standby",
        status:"ready",
        mode:null,
        config:null
      });
    }

    // =========================================================
    // 教員プレビュー
    // =========================================================
    function renderPreview(){
      const a = state.activity || {};
      const view = a.view || "quiz";
      const status = a.status || "-";
      const mode = a.mode || "-";
      const qr = (a.qr === true);

      quickState.textContent =
        `room:${currentRoom} / view:${view} / status:${status} / mode:${mode}${qr ? " / QR" : ""}`;

      // QR中は操作抑止（事故軽減）
      const lock = (a.qr === true);
      btnPrev.disabled = lock;
      btnNext.disabled = lock;
      btnStop.disabled = lock;
      btnQ2.disabled = lock;
      btnQ5.disabled = lock;
      btnQT.disabled = lock;
      btnT20.disabled  = lock;
      btnT30.disabled  = lock;
      btnT60.disabled  = lock;
      btnTOff.disabled = lock;

      // ★standby
      if (view === "standby"){
        pvQuestion.textContent = "（スタンバイ中… 次の問題を待っています）";
        pvChoices.innerHTML = "";
        pvAnswer.textContent = "";
        pvExplanation.textContent = "";
        return;
      }

      // poll
      if (view === "poll"){
        pvQuestion.textContent = "（クイック投票：問題表示なし / 集計のみ）";
        pvChoices.innerHTML = "";
        pvAnswer.textContent = "";
        pvExplanation.textContent = "";
        return;
      }

      const q = state.question;
      if (!state.latestQid){
        pvQuestion.textContent = "問題を待っています…";
        pvChoices.innerHTML = "";
        pvAnswer.textContent = "";
        pvExplanation.textContent = "";
        return;
      }

      if (!q){
        pvQuestion.textContent = `（${state.latestQid}：問題データ待ち）`;
        pvChoices.innerHTML = "";
        pvAnswer.textContent = "";
        pvExplanation.textContent = "";
        return;
      }

      pvQuestion.textContent = q.question || "";

pvChoices.innerHTML = "";
if (q.choices && typeof q.choices === "object"){
  Object.entries(q.choices).forEach(([k, v]) => {
    const div = document.createElement("div");
    div.className = "pv-choice";
    div.textContent = `${uiLabel(k)}：${v}`;
    pvChoices.appendChild(div);
  });
} // ★ここで q.choices の if を閉じる（超重要）

// ===== 次の1問 =====
const q2id = state.nextQid;
const q2 = state.nextQuestion;

pvQidNext.textContent = `ID: ${q2id || "—"}`;

if (!q2id){
  pvQuestionNext.textContent = "（次の問題なし）";
  pvChoicesNext.innerHTML = "";
  pvAnswerNext.textContent = "";
  pvExplanationNext.textContent = "";
} else if (!q2){
  pvQuestionNext.textContent = `（${q2id}：問題データ待ち）`;
  pvChoicesNext.innerHTML = "";
  pvAnswerNext.textContent = "";
  pvExplanationNext.textContent = "";
} else {
  pvQuestionNext.textContent = q2.question || "";

  pvChoicesNext.innerHTML = "";
  if (q2.choices && typeof q2.choices === "object"){
    Object.entries(q2.choices).forEach(([k, v]) => {
      const div = document.createElement("div");
      div.className = "pv-choice";
      div.textContent = `${uiLabel(k)}：${v}`;
      pvChoicesNext.appendChild(div);
    });
  }

  const ans2 = (q2.answer || "").toString().trim().toUpperCase();
  pvAnswerNext.textContent = ans2 ? `正解：${uiLabel(ans2)}` : "正解：—";
  pvExplanationNext.textContent = q2.explanation ? `解説：${q2.explanation}` : "";
}

// ★常に表示（教員プレビューなので最初から出す）
const ans = (q.answer || "").toString().trim().toUpperCase();
pvAnswer.textContent = ans ? `正解：${uiLabel(ans)}` : "正解：—";
pvExplanation.textContent = q.explanation ? `解説：${q.explanation}` : "";
pvQid.textContent = `ID: ${state.latestQid || "—"}`;
    function subscribeQuestion(qid){
      if (state.unsubQuestion){ state.unsubQuestion(); state.unsubQuestion = null; }
      state.question = null;

      if (!qid){
        renderPreview();
        return;
      }

      state.unsubQuestion = onValue(questionRef(qid), snap => {
        state.question = snap.val() || null;
        renderPreview();
      });
    }

    function subscribeNextQuestion(qid){
      if (state.unsubNextQuestion){ state.unsubNextQuestion(); state.unsubNextQuestion = null; }
      state.nextQuestion = null;
      state.nextQid = qid || null;

      if (!qid){
        renderPreview();
        return;
      }

      state.unsubNextQuestion = onValue(questionRef(qid), snap => {
        state.nextQuestion = snap.val() || null;
        renderPreview();
      });
    }    

    function attachRoom(room){
      currentRoom = room;
      roomSelect.value = room;

      // detach
      if (state.unsubActivity){ state.unsubActivity(); state.unsubActivity = null; }
      if (state.unsubQid){ state.unsubQid(); state.unsubQid = null; }
      if (state.unsubQuestion){ state.unsubQuestion(); state.unsubQuestion = null; }

      state.activity = {};
      state.latestQid = null;
      state.question = null;

      state.unsubActivity = onValue(activityRef(room), snap => {
        state.activity = snap.val() || {};
        renderPreview();

        // ★quiz のときだけ問題を購読（poll/standby/qrは無視）
        if ((state.activity.view || "quiz") === "quiz"){
          subscribeQuestion(state.latestQid);
        }
      });

      state.unsubQid = onValue(qidRef(room), snap => {
        state.latestQid = snap.val() || null;
        if (state.unsubNextQuestion){ state.unsubNextQuestion(); state.unsubNextQuestion = null; }
        updateNextSubscription();

        // ★quiz のときだけ問題を購読（poll/standby/qrは無視）
        if ((state.activity.view || "quiz") === "quiz"){
          subscribeQuestion(state.latestQid);
        }else{
          renderPreview();
        }
      });

      renderPreview();
    }

    // =========================================================
    // イベント配線
    // =========================================================
    roomSelect.onchange = () => {
      currentRoom = roomSelect.value;
      localStorage.setItem("cs_teacher_room", currentRoom);
      attachRoom(currentRoom);
    };

    btnNext.onclick = async () => {
      const order = await refreshOrder();
      const cur = (await get(qidRef())).val();
      const i = order.indexOf(cur);
      const next = i < 0 ? order[0] : order[i + 1];
      if (next) startQuizQuestion(next);
    };

    btnPrev.onclick = async () => {
      const order = await refreshOrder();
      const cur = (await get(qidRef())).val();
      const i = order.indexOf(cur);
      const prev = i > 0 ? order[i - 1] : order[0];
      if (prev) startQuizQuestion(prev);
    };

    btnStop.onclick = async () => {
      await update(activityRef(), { status:"closed" });
    };

    document.getElementById("endClassBtn").onclick = async () => {
      const ok1 = confirm("授業終了します。データを削除しますか？（1/2）");
      if (!ok1) return;
      const ok2 = confirm("本当に削除しますか？（2/2）");
      if (!ok2) return;
      await remove(ref(db, `rooms/${currentRoom}`));
      alert("授業データを削除しました。");
    };

    btnQR.onclick = async () => { await toggleQR(); };

    btnQ2.onclick = async () => { await startQuickPoll("ox"); };
    btnQ5.onclick = async () => { await startQuickPoll("five"); };
    btnQT.onclick = async () => { await startQuickPoll("text"); };

    btnT20.onclick  = () => startTimer(20);
    btnT30.onclick  = () => startTimer(30);
    btnT60.onclick  = () => startTimer(60);
    btnTOff.onclick = () => stopTimer();

    document.getElementById("projectionBtn").onclick = () => {
      window.open(
        `https://qzp04374-code.github.io/quiz-app/exp-display/display.html?room=${encodeURIComponent(currentRoom)}`,
        "_blank"
      );
    };

    document.getElementById("importBtn").onclick = () => {
      window.open(
        `https://qzp04374-code.github.io/quiz-app/exp-display/import-csv.html?room=${encodeURIComponent(currentRoom)}`,
        "_blank"
      );
    };
    document.getElementById("dictBtn").onclick = () => {
      window.open(
        `https://qzp04374-code.github.io/quiz-app/exp-display/dict-editor.html?room=${encodeURIComponent(currentRoom)}`,
        "_blank"
      );
    };

    // 起動時
    attachRoom(currentRoom);
  </script>
</body>
</html>
