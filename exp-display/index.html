<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClassSync Teacher Control</title>

  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
      margin:0;
      min-height:100vh;
      background:#050608;
      display:flex;
      justify-content:center;
      padding:32px 0;
      color:#f9fafb;
    }
    .card{
      background:#111827;
      border-radius:24px;
      padding:26px 22px 30px;
      max-width:1100px;
      width:100%;
      box-sizing:border-box;
      box-shadow:0 18px 50px rgba(0,0,0,0.65);
    }
    h2{margin:0 0 10px 0;text-align:center;letter-spacing:.08em;}

    select,button{
      padding:10px 18px;
      border-radius:999px;
      border:none;
      font-size:14px;
    }
    select{
      background:#020617;
      color:#e5e7eb;
      border:1px solid #4b5563;
      outline:none;
    }
    button{
      cursor:pointer;
      color:#fff;
      background:#374151;
      transition:opacity .15s ease, transform .12s ease, box-shadow .15s ease, filter .15s ease;
      box-shadow:0 8px 22px rgba(0,0,0,0.35);
    }
    button:active{transform:scale(.98);filter:brightness(.98);}
    button:disabled{
      opacity:0.35;
      cursor:not-allowed;
      filter:grayscale(.2);
      box-shadow:none !important;
      transform:none !important;
    }

    .button-row{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:10px;
      margin:18px 0 18px;
    }

    #prevQuestionBtn{background:#4b5563;}
    #nextQuestionBtn{background:linear-gradient(135deg,#22c55e,#06b6d4);}
    #stopBtn{background:#ef4444;}
    #endClassBtn{background:linear-gradient(135deg,#dc2626,#991b1b);}
    #qrBtn{background:#0ea5e9;}
    #qrOffBtn{background:linear-gradient(135deg,#64748b,#475569);}
    #projectionBtn{background:linear-gradient(135deg,#6366f1,#a855f7);}
    #importBtn{background:linear-gradient(135deg,#f59e0b,#f97316);}

    .qr-off-active{
      background:linear-gradient(135deg,#f59e0b,#ef4444) !important;
      box-shadow:0 0 18px rgba(239,68,68,0.55);
      opacity:1 !important;
    }

    #preview{
      margin-top:18px;
      padding:18px;
      border-radius:20px;
      background:#020617;
      border:1px solid rgba(255,255,255,0.06);
    }
    #preview h3{
      margin:0 0 10px 0;
      font-size:16px;
      letter-spacing:.10em;
      color:#e5e7eb;
    }
    #pvQuestion{
      font-size:18px;
      font-weight:700;
      line-height:1.35;
      margin-bottom:10px;
    }
    .pv-choice{margin:4px 0 0 10px;color:#e5e7eb;}
    .pv-answer{margin-top:12px;font-weight:800;color:#34d399;}
    .pv-explanation{margin-top:6px;font-size:14px;color:#cbd5e1;line-height:1.5;}

    #qrModal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.85);
      align-items:center;
      justify-content:center;
      z-index:1000;
    }
    #qrInner{
      background:#111827;
      padding:20px;
      border-radius:20px;
      text-align:center;
      box-shadow:0 14px 40px rgba(0,0,0,0.9);
      border:1px solid rgba(255,255,255,0.06);
    }
    #qrcode canvas{border-radius:12px;background:#fff;padding:10px;box-sizing:border-box;}
    #closeQR{background:#4b5563;}
  </style>
</head>

<body>
  <div class="card">
    <h2>教員画面</h2>

    <div style="text-align:center; margin-bottom:6px;">
      ルーム：
      <select id="roomSelect">
        <option value="kyoto-01">kyoto-01</option>
        <option value="kyoto-02">kyoto-02</option>
        <option value="nagoya-01">nagoya-01</option>
        <option value="nagoya-02">nagoya-02</option>
        <option value="sendai-01">sendai-01</option>
        <option value="sendai-02">sendai-02</option>
      </select>
    </div>

    <div class="button-row">
      <button id="prevQuestionBtn">問題戻る ◀</button>
      <button id="nextQuestionBtn">次の問題 ▶</button>
      <button id="stopBtn">解答終了</button>
      <button id="endClassBtn">授業終了</button>
      <button id="qrBtn">QR表示</button>
      <button id="qrOffBtn">QRを消す（出題開始）</button>
      <button id="projectionBtn">display表示</button>
      <button id="importBtn">CSV投入</button>
    </div>

    <div id="preview">
      <h3>出題プレビュー（教員のみ）</h3>
      <div id="pvQuestion">問題を待っています…</div>
      <div id="pvChoices"></div>
      <div id="pvAnswer" class="pv-answer"></div>
      <div id="pvExplanation" class="pv-explanation"></div>
    </div>
  </div>

  <div id="qrModal">
    <div id="qrInner">
      <h3 style="margin:0 0 12px 0; letter-spacing:.08em;">学生用QRコード</h3>
      <div id="qrcode"></div>
      <div style="margin-top:16px;">
        <button id="closeQR">閉じる</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, update, onValue, get } from
      "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBke-wTU16skpbK8z80ddK04tE154dHERQ",
      authDomain: "satosan-41eac.firebaseapp.com",
      databaseURL: "https://satosan-41eac-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "satosan-41eac",
      storageBucket: "satosan-41eac.firebasestorage.app",
      messagingSenderId: "992482993229",
      appId: "1:992482993229:web:e2c59b078233b0ed16e804",
      measurementId: "G-VT9FKHN3LT"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const roomSelect = document.getElementById("roomSelect");
    const prevBtn = document.getElementById("prevQuestionBtn");
    const nextBtn = document.getElementById("nextQuestionBtn");
    const stopBtn = document.getElementById("stopBtn");
    const endBtn  = document.getElementById("endClassBtn");
    const qrBtn   = document.getElementById("qrBtn");
    const qrOffBtn= document.getElementById("qrOffBtn");
    const projBtn = document.getElementById("projectionBtn");
    const impBtn  = document.getElementById("importBtn");

    const qrModal = document.getElementById("qrModal");
    const qrDiv   = document.getElementById("qrcode");
    const closeQR = document.getElementById("closeQR");

    const pvQ = document.getElementById("pvQuestion");
    const pvC = document.getElementById("pvChoices");
    const pvA = document.getElementById("pvAnswer");
    const pvE = document.getElementById("pvExplanation");

    let currentRoom = roomSelect.value;

    let unsubActivity = null;
    let unsubQid = null;
    let unsubQuestion = null;
    let unsubAnswers = null;

    const actRef = () => ref(db, `rooms/${currentRoom}/activity`);
    const qidRef = () => ref(db, `rooms/${currentRoom}/quiz/current_question_id`);
    const qRef   = (qid) => ref(db, `rooms/${currentRoom}/questions/${qid}`);
    const ansRef = () => ref(db, `rooms/${currentRoom}/answers`);
    const resRef = () => ref(db, `rooms/${currentRoom}/result`);

    function detachAll(){
      if (unsubActivity){unsubActivity();unsubActivity=null;}
      if (unsubQid){unsubQid();unsubQid=null;}
      if (unsubQuestion){unsubQuestion();unsubQuestion=null;}
      if (unsubAnswers){unsubAnswers();unsubAnswers=null;}
    }

    function normMode(x){ return (x === "ox") ? "ox" : "five"; }

    function inferModeFromQuestion(q){
      if (q && q.mode) return normMode(q.mode);
      const ch = q && q.choices ? q.choices : null;
      if (ch && (ch.O || ch.X || ch.o || ch.x)) return "ox";
      return "five";
    }

    function inferChoicesFromMode(mode){
      return (mode === "ox") ? ["O","X"] : ["A","B","C","D","E"];
    }

    async function applyActivityForQuestion(qid){
      const snap = await get(qRef(qid));
      const q = snap.val() || {};
      const mode = inferModeFromQuestion(q);
      const choices = inferChoicesFromMode(mode);

      await update(actRef(), {
        status:"open",
        qr:false,
        mode,
        config:{ choices }
      });

      await set(ansRef(), {});
      const init = {};
      choices.forEach(c => init[c] = 0);
      await set(resRef(), init);
    }

    async function startCurrentOrQ01(){
      let qid = (await get(qidRef())).val();
      if (!qid){
        qid = "Q01";
        await set(qidRef(), qid);
      }
      await applyActivityForQuestion(qid);
    }

    function attachListeners(){
      detachAll();

      unsubActivity = on Вам(1)
