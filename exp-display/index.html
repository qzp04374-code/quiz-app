<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClassSync Teacher Control</title>

  <style>
    :root{
      --bg:#050608;
      --panel:#111827;
      --panel2:#020617;
      --line:rgba(255,255,255,.10);
      --ink:#f9fafb;
      --muted:#cbd5e1;

      /* ここが “番号(文字)と色の対応” の正本 */
      --color-o:#34c759;
      --color-x:#ff3b30;
      --color-a:#0a84ff;
      --color-b:#30d158;
      --color-c:#ff9f0a;
      --color-d:#bf5af2;
      --color-e:#ff375f;

      --danger:#ef4444;
      --danger2:#991b1b;
      --info:#0ea5e9;
      --indigo:#6366f1;
      --gray:#4b5563;
    }

    body{
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
      margin:0;
      min-height:100vh;
      background:var(--bg);
      display:flex;
      justify-content:center;
      padding:32px 0;
      color:var(--ink);
    }

    .card{
      background:var(--panel);
      border-radius:24px;
      padding:26px 22px 30px;
      max-width:1180px;
      width:100%;
      box-shadow:0 18px 60px rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.04);
      box-sizing:border-box;
    }

    h2{
      margin:0 0 14px 0;
      text-align:center;
      letter-spacing:.10em;
      font-weight:900;
    }

    .topRow{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:14px;
    }

    select, button{
      border:none;
      font-size:14px;
      border-radius:999px;
      padding:10px 18px;
      box-sizing:border-box;
    }

    select{
      background:var(--panel2);
      color:#e5e7eb;
      border:1px solid rgba(255,255,255,.12);
      outline:none;
    }

    button{
      cursor:pointer;
      color:#fff;
      background:#374151;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      transition:transform .12s ease, filter .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    button:active{ transform:scale(.97); filter:brightness(.98); }
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    /* ===== クイック投票（正円ボタン） ===== */
    .quickWrap{
      margin: 10px auto 18px;
      padding: 14px 12px 12px;
      border-radius: 22px;
      background: rgba(2,6,23,.55);
      border:1px solid rgba(255,255,255,.08);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }
    .quickTitle{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 0 6px 10px;
      color: var(--muted);
      font-weight:900;
      letter-spacing:.10em;
      font-size:13px;
    }
    .quickRow{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:14px;
      flex-wrap:wrap;
    }

    .qbtn{
      width:100px;
      height:100px;
      border-radius:9999px;
      padding:0;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:6px;
      border:1px solid rgba(255,255,255,.10);
      position:relative;
      overflow:hidden;
      user-select:none;
    }
    .qbtn::before{
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.22), transparent 55%);
      transform: rotate(12deg);
      opacity:.0;
      transition:opacity .18s ease;
    }
    .qbtn:hover::before{ opacity:.75; }
    .qbtn.active{
      box-shadow: 0 0 0 4px rgba(255,255,255,.10), 0 18px 60px rgba(0,0,0,.55);
      border-color: rgba(255,255,255,.22);
      transform: translateY(-1px);
    }
    .qbtn .big{
      font-size:28px;
      font-weight:1000;
      letter-spacing:.02em;
      line-height:1;
    }
    .qbtn .small{
      font-size:13px;
      font-weight:900;
      letter-spacing:.08em;
      opacity:.95;
    }
    .qbtn .hint{
      font-size:11px;
      letter-spacing:.10em;
      opacity:.9;
    }

    .q2{ background: linear-gradient(135deg, var(--color-o), rgba(6,182,212,.95)); }
    .q5{ background: linear-gradient(135deg, var(--color-d), rgba(168,85,247,.95)); }
    .qt{ background: linear-gradient(135deg, var(--color-c), rgba(245,158,11,.95)); color:#111827; }
    .qt .hint,.qt .small{ color: rgba(0,0,0,.72); }

    /* ===== 既存ボタン列 ===== */
    .button-row{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:10px;
      margin: 12px 0 16px;
    }

    #prevQuestionBtn { background: var(--gray); }
    #nextQuestionBtn { background: linear-gradient(135deg, var(--color-o), #06b6d4); }
    #stopBtn { background: var(--danger); }
    #endClassBtn { background: linear-gradient(135deg,var(--danger),var(--danger2)); }
    #qrBtn { background: var(--info); }
    #projectionBtn { background: linear-gradient(135deg,var(--indigo),#a855f7); }
    #importBtn { background: linear-gradient(135deg,var(--color-c),#f97316); }

    /* プレビュー */
    #preview{
      margin-top:18px;
      padding:18px 18px;
      border-radius:20px;
      background: var(--panel2);
      border:1px solid rgba(255,255,255,.08);
    }
    #preview h3{
      margin:0 0 10px 0;
      font-size:16px;
      letter-spacing:.10em;
    }
    .pv-choice{ margin-left:12px; margin-bottom:4px; color:#e5e7eb; }
    .pv-answer{ margin-top:12px; font-weight:1000; color:var(--color-o); }
    .pv-explanation{ margin-top:6px; font-size:14px; color:#d1d5db; white-space:pre-wrap; }

    /* QRモーダル */
    #qrModal{
      display:none;
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.85);
      align-items:center;
      justify-content:center;
      z-index:1000;
    }
    #qrInner{
      background:#111827;
      padding:20px;
      border-radius:20px;
      text-align:center;
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 18px 60px rgba(0,0,0,.75);
      width:min(420px, 92vw);
    }
    #qrcode canvas{ border-radius:16px; background:#fff; padding:8px; }

    #buildTag{
      position:fixed; right:12px; bottom:10px;
      opacity:.55; font-size:12px; z-index:9999;
      background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.08);
      padding:6px 10px; border-radius:999px;
      backdrop-filter: blur(8px);
    }
  </style>
</head>

<body>
  <div id="buildTag">build: 2025-12-27 / teacher-colorsync</div>

  <div class="card">
    <h2>教員画面</h2>

    <div class="topRow">
      <div>
        ルーム：
        <select id="roomSelect">
          <option value="kyoto-01">kyoto-01</option>
          <option value="kyoto-02">kyoto-02</option>
          <option value="nagoya-01">nagoya-01</option>
          <option value="nagoya-02">nagoya-02</option>
          <option value="sendai-01">sendai-01</option>
          <option value="sendai-02">sendai-02</option>
        </select>
      </div>
    </div>

    <!-- クイック投票 -->
    <div class="quickWrap">
      <div class="quickTitle">
        <span>クイック投票（口頭Q&A用：集計だけ表示）</span>
        <span id="quickState" style="opacity:.85;">—</span>
      </div>

      <div class="quickRow">
        <button id="quick2Btn" class="qbtn q2" title="2択（○✕）">
          <div class="big">○✕</div>
          <div class="small">2択</div>
          <div class="hint">投票</div>
        </button>

        <button id="quick5Btn" class="qbtn q5" title="5択（A〜E）">
          <div class="big">ABCDE</div>
          <div class="small">5択</div>
          <div class="hint">投票</div>
        </button>

        <button id="quickTextBtn" class="qbtn qt" title="文字入力">
          <div class="big">TEXT</div>
          <div class="small">文字</div>
          <div class="hint">入力</div>
        </button>
      </div>
    </div>

    <!-- 授業運用ボタン -->
    <div class="button-row">
      <button id="prevQuestionBtn">問題戻る ◀</button>
      <button id="nextQuestionBtn">次の問題 ▶</button>
      <button id="stopBtn">解答終了</button>
      <button id="endClassBtn">授業終了</button>
      <button id="qrBtn">QRコード</button>
      <button id="projectionBtn">display表示</button>
      <button id="importBtn">CSV投入</button>
    </div>

    <!-- プレビュー（教員用：残しておく） -->
    <div id="preview">
      <h3>出題プレビュー（教員のみ）</h3>
      <div id="pvQuestion">問題を待っています…</div>
      <div id="pvChoices"></div>
      <div id="pvAnswer" class="pv-answer"></div>
      <div id="pvExplanation" class="pv-explanation"></div>
    </div>
  </div>

  <!-- QRモーダル -->
  <div id="qrModal">
    <div id="qrInner">
      <h3 style="margin:0 0 10px 0;">学生用QRコード</h3>
      <div id="qrcode"></div>
      <div style="margin-top:10px; color:rgba(203,213,225,.9); font-size:13px;">
        ※QR中は display が参加画面になります
      </div>
      <div style="margin-top:14px;">
        <button id="closeQR" style="background:#4b5563;">閉じる</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, update, remove, onValue, get } from
      "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBke-wTU16skpbK8z80ddK04tE154dHERQ",
      authDomain: "satosan-41eac.firebaseapp.com",
      databaseURL: "https://satosan-41eac-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "satosan-41eac"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const roomSelect = document.getElementById("roomSelect");

    const quick2Btn = document.getElementById("quick2Btn");
    const quick5Btn = document.getElementById("quick5Btn");
    const quickTextBtn = document.getElementById("quickTextBtn");
    const quickState = document.getElementById("quickState");

    const prevQuestionBtn = document.getElementById("prevQuestionBtn");
    const nextQuestionBtn = document.getElementById("nextQuestionBtn");
    const stopBtn = document.getElementById("stopBtn");
    const endClassBtn = document.getElementById("endClassBtn");
    const qrBtn = document.getElementById("qrBtn");
    const projectionBtn = document.getElementById("projectionBtn");
    const importBtn = document.getElementById("importBtn");

    const qEl = document.getElementById("pvQuestion");
    const cEl = document.getElementById("pvChoices");
    const aEl = document.getElementById("pvAnswer");
    const eEl = document.getElementById("pvExplanation");

    const qrModal = document.getElementById("qrModal");
    const qrDiv   = document.getElementById("qrcode");
    const closeQR = document.getElementById("closeQR");

    let currentRoom = roomSelect.value;
    let questionOrder = [];
    let currentQid = null;

    function activityRef(){ return ref(db, `rooms/${currentRoom}/activity`); }
    function answersRef(){  return ref(db, `rooms/${currentRoom}/answers`); }
    function qidRef(){      return ref(db, `rooms/${currentRoom}/quiz/current_question_id`); }
    function questionsRef(){return ref(db, `rooms/${currentRoom}/questions`); }
    function questionRef(qid){ return ref(db, `rooms/${currentRoom}/questions/${qid}`); }

    function setQuickActive(which){
      [quick2Btn, quick5Btn, quickTextBtn].forEach(b => b.classList.remove("active"));
      if (which === "2") quick2Btn.classList.add("active");
      if (which === "5") quick5Btn.classList.add("active");
      if (which === "t") quickTextBtn.classList.add("active");
    }

    roomSelect.addEventListener("change", async () => {
      currentRoom = roomSelect.value;
      setQuickActive(null);
      quickState.textContent = "—";
      await refreshQuestionOrder();
      attachPreview();
    });

    async function clearAnswers(){
      await set(answersRef(), {});
    }

    // クイック投票（集計だけ）
    async function startQuickPoll(mode){
      await set(qidRef(), null);         // 口頭なので問題IDは消す
      await clearAnswers();

      const data = { status:"open", qr:false, view:"poll", mode };

      if (mode === "text"){
        data.config = { type:"text" };
      } else if (mode === "ox"){
        // DB値は O/X を維持、表示は ○/✕ に変換（display/student側）
        data.config = { choices:["O","X"] };
      } else {
        data.config = { choices:["A","B","C","D","E"] };
      }

      await update(activityRef(), data);

      if (mode === "ox"){ setQuickActive("2"); quickState.textContent = "クイック：2択（○✕）"; }
      if (mode === "five"){ setQuickActive("5"); quickState.textContent = "クイック：5択（ABCDE）"; }
      if (mode === "text"){ setQuickActive("t"); quickState.textContent = "クイック：文字入力"; }
    }

    quick2Btn.onclick = () => startQuickPoll("ox");
    quick5Btn.onclick = () => startQuickPoll("five");
    quickTextBtn.onclick = () => startQuickPoll("text");

    // 問題順（questionsキー昇順）
    async function refreshQuestionOrder(){
      const snap = await get(questionsRef());
      const val = snap.val() || {};
      questionOrder = Object.keys(val).sort();
      return questionOrder;
    }

    // 授業モード（view:"quiz"）
    async function startQuizQuestion(qid){
      if (!qid) return;

      await set(qidRef(), qid);
      await clearAnswers();

      const qs = await get(questionRef(qid));
      const q = qs.val() || {};
      const keys = q.choices ? Object.keys(q.choices).map(k => String(k).toUpperCase()) : ["A","B","C","D","E"];

      const inferredMode =
        (keys.length === 2 && keys.includes("O") && keys.includes("X")) ? "ox" :
        (keys.length === 5 && keys.includes("A")) ? "five" : "five";

      await update(activityRef(), {
        status:"open",
        qr:false,
        view:"quiz",
        mode: inferredMode,
        config: { choices: keys }
      });

      setQuickActive(null);
      quickState.textContent = "授業モード：問題表示";
    }

    prevQuestionBtn.onclick = async () => {
      await refreshQuestionOrder();
      if (questionOrder.length === 0) return;
      const i = questionOrder.indexOf(currentQid);
      const prev = (i <= 0) ? questionOrder[0] : questionOrder[i - 1];
      await startQuizQuestion(prev);
    };

    nextQuestionBtn.onclick = async () => {
      await refreshQuestionOrder();
      if (questionOrder.length === 0) return;
      const i = questionOrder.indexOf(currentQid);
      const next = (i < 0) ? questionOrder[0]
                 : (i >= questionOrder.length - 1) ? questionOrder[questionOrder.length - 1]
                 : questionOrder[i + 1];
      await startQuizQuestion(next);
    };

    stopBtn.onclick = async () => {
      await update(activityRef(), { status:"closed" });
    };

    endClassBtn.onclick = async () => {
      const ok1 = confirm("授業終了します。データを消去しますか？（1/2）");
      if (!ok1) return;
      const ok2 = confirm("本当に削除します。よろしいですか？（2/2）");
      if (!ok2) return;

      await update(activityRef(), { ending:true, status:"closed", qr:false });

      setTimeout(async () => {
        await remove(ref(db, `rooms/${currentRoom}/questions`)).catch(()=>{});
        await remove(ref(db, `rooms/${currentRoom}/quiz`)).catch(()=>{});
        await remove(ref(db, `rooms/${currentRoom}/answers`)).catch(()=>{});
        await remove(ref(db, `rooms/${currentRoom}/result`)).catch(()=>{});
        await remove(ref(db, `rooms/${currentRoom}/activity`)).catch(()=>{});
        alert("授業データを削除しました。次回はCSV投入から開始してください。");
      }, 650);
    };

    qrBtn.onclick = async () => {
      await update(activityRef(), { qr:true });

      const studentUrl =
        `https://qzp04374-code.github.io/quiz-app/exp-display/student.html?room=${encodeURIComponent(currentRoom)}`;

      qrDiv.innerHTML = "";
      // eslint-disable-next-line no-undef
      new QRCode(qrDiv, { text: studentUrl, width: 280, height: 280 });

      qrModal.style.display = "flex";
    };

    closeQR.onclick = async () => {
      qrModal.style.display = "none";
      await update(activityRef(), { qr:false });
    };

    qrModal.addEventListener("click", async (e) => {
      if (e.target === qrModal){
        qrModal.style.display = "none";
        await update(activityRef(), { qr:false });
      }
    });

    projectionBtn.onclick = () => {
      const url =
        `https://qzp04374-code.github.io/quiz-app/exp-display/display.html?room=${encodeURIComponent(currentRoom)}&v=teacher-colorsync`;
      window.open(url, "_blank");
    };

    importBtn.onclick = () => {
      const url =
        `https://qzp04374-code.github.io/quiz-app/exp-display/import-csv.html?v=teacher-colorsync`;
      window.open(url, "_blank");
    };

    // プレビュー：current_question_id を監視（教員のみ）
    let unsubQid = null;
    let unsubQ = null;

    function attachPreview(){
      if (unsubQid) unsubQid();
      if (unsubQ) unsubQ();

      unsubQid = onValue(qidRef(), snap => {
        const qid = snap.val();
        currentQid = qid || null;

        if (!qid){
          qEl.textContent = "（クイック投票中 / または問題未選択）";
          cEl.innerHTML = "";
          aEl.textContent = "";
          eEl.textContent = "";
          return;
        }

        if (unsubQ) unsubQ();
        unsubQ = onValue(questionRef(qid), qsnap => {
          const q = qsnap.val();
          if (!q){
            qEl.textContent = "（問題データが見つかりません）";
            cEl.innerHTML = "";
            aEl.textContent = "";
            eEl.textContent = "";
            return;
          }

          qEl.textContent = q.question || "";
          cEl.innerHTML = "";
          aEl.textContent = "";
          eEl.textContent = "";

          if (q.choices){
            Object.entries(q.choices).forEach(([k,v]) => {
              const d = document.createElement("div");
              d.className = "pv-choice";
              d.textContent = `${String(k).toUpperCase()}. ${v}`;
              cEl.appendChild(d);
            });
          }
          if (q.answer) aEl.textContent = `正解：${String(q.answer).toUpperCase()}`;
          if (q.explanation) eEl.textContent = `解説：${q.explanation}`;
        });
      });

      // view/poll 表示
      onValue(activityRef(), snap => {
        const a = snap.val() || {};
        if (a.view === "poll"){
          if (a.mode === "ox"){ setQuickActive("2"); quickState.textContent = "クイック：2択（○✕）"; }
          else if (a.mode === "five"){ setQuickActive("5"); quickState.textContent = "クイック：5択（ABCDE）"; }
          else if (a.mode === "text"){ setQuickActive("t"); quickState.textContent = "クイック：文字入力"; }
        }
      });
    }

    (async () => {
      await refreshQuestionOrder();
      attachPreview();
    })();
  </script>
</body>
</html>
