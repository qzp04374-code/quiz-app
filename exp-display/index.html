<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClassSync Teacher Control</title>

  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
      margin:0;
      min-height:100vh;
      background:#050608;
      display:flex;
      justify-content:center;
      padding:32px 0;
      color:#f9fafb;
    }
    .card{
      background:#111827;
      border-radius:24px;
      padding:26px 22px 30px;
      max-width:1100px;
      width:100%;
      box-sizing:border-box;
      box-shadow:0 18px 50px rgba(0,0,0,0.65);
    }
    h2{margin:0 0 10px 0;text-align:center;letter-spacing:.08em;}

    select,button{
      padding:10px 18px;
      border-radius:999px;
      border:none;
      font-size:14px;
    }
    select{
      background:#020617;
      color:#e5e7eb;
      border:1px solid #4b5563;
      outline:none;
    }
    button{
      cursor:pointer;
      color:#fff;
      background:#374151;
      transition:opacity .15s ease, transform .12s ease, box-shadow .15s ease, filter .15s ease;
      box-shadow:0 8px 22px rgba(0,0,0,0.35);
    }
    button:active{transform:scale(.98);filter:brightness(.98);}
    button:disabled{
      opacity:0.35;
      cursor:not-allowed;
      filter:grayscale(.2);
      box-shadow:none !important;
      transform:none !important;
    }

    .button-row{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:10px;
      margin:18px 0 12px;
    }

    #prevQuestionBtn{background:#4b5563;}
    #nextQuestionBtn{background:linear-gradient(135deg,#22c55e,#06b6d4);}
    #stopBtn{background:#ef4444;}
    #endClassBtn{background:linear-gradient(135deg,#dc2626,#991b1b);}
    #qrBtn{background:#0ea5e9;}
    #qrOffBtn{background:linear-gradient(135deg,#64748b,#475569);}
    #projectionBtn{background:linear-gradient(135deg,#6366f1,#a855f7);}
    #importBtn{background:linear-gradient(135deg,#f59e0b,#f97316);}

    .qr-off-active{
      background:linear-gradient(135deg,#f59e0b,#ef4444) !important;
      box-shadow:0 0 18px rgba(239,68,68,0.55);
      opacity:1 !important;
    }

    /* ステータス */
    #statusBox{
      margin: 8px auto 0;
      max-width: 920px;
      background:#020617;
      border:1px solid rgba(255,255,255,0.08);
      border-radius:18px;
      padding:12px 14px;
      color:#cbd5e1;
      font-size:13px;
      line-height:1.4;
    }
    #statusBox b{ color:#f9fafb; }

    /* プレビュー */
    #preview{
      margin-top:14px;
      padding:18px;
      border-radius:20px;
      background:#020617;
      border:1px solid rgba(255,255,255,0.06);
    }
    #preview h3{
      margin:0 0 10px 0;
      font-size:16px;
      letter-spacing:.10em;
      color:#e5e7eb;
    }
    #pvQuestion{
      font-size:18px;
      font-weight:700;
      line-height:1.35;
      margin-bottom:10px;
    }
    .pv-choice{margin:4px 0 0 10px;color:#e5e7eb;}
    .pv-answer{margin-top:12px;font-weight:800;color:#34d399;}
    .pv-explanation{margin-top:6px;font-size:14px;color:#cbd5e1;line-height:1.5;}

    /* QRモーダル */
    #qrModal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.85);
      align-items:center;
      justify-content:center;
      z-index:1000;
    }
    #qrInner{
      background:#111827;
      padding:20px;
      border-radius:20px;
      text-align:center;
      box-shadow:0 14px 40px rgba(0,0,0,0.9);
      border:1px solid rgba(255,255,255,0.06);
    }
    #qrcode canvas{border-radius:12px;background:#fff;padding:10px;box-sizing:border-box;}
    #closeQR{background:#4b5563;}
  </style>
</head>

<body>
  <div class="card">
    <h2>教員画面</h2>

    <div style="text-align:center; margin-bottom:6px;">
      ルーム：
      <select id="roomSelect">
        <option value="kyoto-01">kyoto-01</option>
        <option value="kyoto-02">kyoto-02</option>
        <option value="nagoya-01">nagoya-01</option>
        <option value="nagoya-02">nagoya-02</option>
        <option value="sendai-01">sendai-01</option>
        <option value="sendai-02">sendai-02</option>
      </select>
    </div>

    <div class="button-row">
      <button id="prevQuestionBtn">問題戻る ◀</button>
      <button id="nextQuestionBtn">次の問題 ▶</button>
      <button id="stopBtn">解答終了</button>
      <button id="endClassBtn">授業終了</button>
      <button id="qrBtn">QR表示</button>
      <button id="qrOffBtn">QRを消す（出題開始）</button>
      <button id="projectionBtn">display表示</button>
      <button id="importBtn">CSV投入</button>
    </div>

    <div id="statusBox">
      <div>状態：<b id="stActivity">-</b>　/　出題：<b id="stQid">-</b></div>
      <div style="margin-top:4px;">ヒント：<b>CSV投入 → QR表示 → display表示 → QRを消す（出題開始）</b></div>
      <div id="stWarn" style="margin-top:6px;color:#fbbf24;"></div>
    </div>

    <div id="preview">
      <h3>出題プレビュー（教員のみ）</h3>
      <div id="pvQuestion">問題を待っています…</div>
      <div id="pvChoices"></div>
      <div id="pvAnswer" class="pv-answer"></div>
      <div id="pvExplanation" class="pv-explanation"></div>
    </div>
  </div>

  <!-- QRモーダル（教員PC用） -->
  <div id="qrModal">
    <div id="qrInner">
      <h3 style="margin:0 0 12px 0; letter-spacing:.08em;">学生用QRコード</h3>
      <div id="qrcode"></div>
      <div style="margin-top:16px;">
        <button id="closeQR">閉じる</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, update, onValue, get } from
      "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBke-wTU16skpbK8z80ddK04tE154dHERQ",
      authDomain: "satosan-41eac.firebaseapp.com",
      databaseURL: "https://satosan-41eac-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "satosan-41eac"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // ===== 固定URL（ここが効きます：displayが確実に開く） =====
    const DISPLAY_BASE = "https://qzp04374-code.github.io/quiz-app/exp-display/";
    const DISPLAY_URL  = DISPLAY_BASE + "display.html";
    const STUDENT_URL  = DISPLAY_BASE + "student.html";
    const IMPORT_URL   = DISPLAY_BASE + "import-csv.html";

    // UI
    const roomSelect = document.getElementById("roomSelect");
    const prevBtn = document.getElementById("prevQuestionBtn");
    const nextBtn = document.getElementById("nextQuestionBtn");
    const stopBtn = document.getElementById("stopBtn");
    const endBtn  = document.getElementById("endClassBtn");
    const qrBtn   = document.getElementById("qrBtn");
    const qrOffBtn= document.getElementById("qrOffBtn");
    const projBtn = document.getElementById("projectionBtn");
    const impBtn  = document.getElementById("importBtn");

    const qrModal = document.getElementById("qrModal");
    const qrDiv   = document.getElementById("qrcode");
    const closeQR = document.getElementById("closeQR");

    const pvQ = document.getElementById("pvQuestion");
    const pvC = document.getElementById("pvChoices");
    const pvA = document.getElementById("pvAnswer");
    const pvE = document.getElementById("pvExplanation");

    const stActivity = document.getElementById("stActivity");
    const stQid = document.getElementById("stQid");
    const stWarn = document.getElementById("stWarn");

    let currentRoom = roomSelect.value;

    // refs
    const actRef = () => ref(db, `rooms/${currentRoom}/activity`);
    const qidRef = () => ref(db, `rooms/${currentRoom}/quiz/current_question_id`);
    const qRef   = (qid) => ref(db, `rooms/${currentRoom}/questions/${qid}`);
    const ansRef = () => ref(db, `rooms/${currentRoom}/answers`);
    const resRef = () => ref(db, `rooms/${currentRoom}/result`);

    // unsub
    let unsubActivity = null;
    let unsubQid = null;
    let unsubQuestion = null;

    function detachAll(){
      if (unsubActivity){unsubActivity();unsubActivity=null;}
      if (unsubQid){unsubQid();unsubQid=null;}
      if (unsubQuestion){unsubQuestion();unsubQuestion=null;}
    }

    function normMode(x){ return (x === "ox") ? "ox" : "five"; }

    function inferModeFromQuestion(q){
      if (q && q.mode) return normMode(q.mode);
      const ch = q && q.choices ? q.choices : null;
      if (ch && (ch.O || ch.X || ch.o || ch.x)) return "ox";
      return "five";
    }
    function choicesFromMode(mode){
      return (mode === "ox") ? ["O","X"] : ["A","B","C","D","E"];
    }

    async function applyActivityForQuestion(qid){
      stWarn.textContent = "";
      const snap = await get(qRef(qid));
      const q = snap.val();

      if (!q){
        stWarn.textContent = `⚠️ questions/${qid} がありません。先にCSV投入してください。`;
        // それでも学生が待機しないように、最低限はopen+choicesだけ入れる
        const mode = "five";
        const choices = choicesFromMode(mode);
        await update(actRef(), { status:"open", qr:false, mode, config:{choices} });
        await set(ansRef(), {});
        const init = {}; choices.forEach(c=>init[c]=0);
        await set(resRef(), init);
        return;
      }

      const mode = inferModeFromQuestion(q);
      const choices = choicesFromMode(mode);

      await update(actRef(), { status:"open", qr:false, mode, config:{choices} });
      await set(ansRef(), {});
      const init = {}; choices.forEach(c=>init[c]=0);
      await set(resRef(), init);
    }

    async function startCurrentOrQ01(){
      let qid = (await get(qidRef())).val();
      if (!qid){
        qid = "Q01";
        await set(qidRef(), qid);
      }
      await applyActivityForQuestion(qid);
    }

    function attachListeners(){
      detachAll();

      // activity監視
      unsubActivity = onValue(actRef(), snap => {
        const act = snap.val() || {};
        const isQR = act.qr === true;

        stActivity.textContent = `${act.status || "-"} / qr=${isQR ? "true":"false"} / mode=${act.mode || "-"}`;

        nextBtn.disabled = isQR;
        if (isQR) qrOffBtn.classList.add("qr-off-active");
        else qrOffBtn.classList.remove("qr-off-active");
      });

      // current_question_id監視 → プレビュー
      unsubQid = onValue(qidRef(), snap => {
        const qid = snap.val();
        stQid.textContent = qid || "-";

        if (!qid){
          pvQ.textContent = "問題を待っています…";
          pvC.innerHTML = "";
          pvA.textContent = "";
          pvE.textContent = "";
          if (unsubQuestion){unsubQuestion();unsubQuestion=null;}
          return;
        }

        if (unsubQuestion){unsubQuestion();unsubQuestion=null;}
        unsubQuestion = onValue(qRef(qid), qsnap => {
          const q = qsnap.val();
          if (!q){
            pvQ.textContent = `（${qid} が未登録です：CSV投入してください）`;
            pvC.innerHTML = "";
            pvA.textContent = "";
            pvE.textContent = "";
            return;
          }

          pvQ.textContent = q.question || "";
          pvC.innerHTML = "";
          pvA.textContent = q.answer ? `正解：${q.answer}` : "";
          pvE.textContent = q.explanation ? `解説：${q.explanation}` : "";

          if (q.choices && typeof q.choices === "object"){
            Object.entries(q.choices).forEach(([k,v]) => {
              const d = document.createElement("div");
              d.className = "pv-choice";
              d.textContent = `${String(k).toUpperCase()}. ${v}`;
              pvC.appendChild(d);
            });
          }
        });
      });
    }

    // ルーム変更
    roomSelect.addEventListener("change", () => {
      currentRoom = roomSelect.value;
      qrModal.style.display = "none";
      stWarn.textContent = "";
      attachListeners();
    });

    // display表示（絶対URL）
    projBtn.onclick = async () => {
      // displayを開いた瞬間はQR表示が欲しいので強制qr=true
      await update(actRef(), { qr:true }).catch(()=>{});
      window.open(`${DISPLAY_URL}?room=${encodeURIComponent(currentRoom)}`, "_blank");
    };

    // CSV投入（絶対URL）
    impBtn.onclick = () => {
      window.open(IMPORT_URL, "_blank");
    };

    // QR表示（学生URLの絶対指定）
    qrBtn.onclick = () => {
      update(actRef(), { qr:true });

      const url = `${STUDENT_URL}?room=${encodeURIComponent(currentRoom)}`;
      qrDiv.innerHTML = "";
      // eslint-disable-next-line no-undef
      new QRCode(qrDiv, { text:url, width:260, height:260 });

      qrModal.style.display = "flex";
    };

    // QRを消す（＝その場で出題開始）
    qrOffBtn.onclick = async () => {
      await update(actRef(), { qr:false });
      qrModal.style.display = "none";
      await startCurrentOrQ01(); // ←最初だけ待機を消す
    };

    closeQR.onclick = () => { qrModal.style.display = "none"; };
    qrModal.addEventListener("click", (e) => { if (e.target === qrModal) qrModal.style.display = "none"; });

    // 次の問題 ▶
    nextBtn.onclick = async () => {
      const qrSnap = await get(ref(db, `rooms/${currentRoom}/activity/qr`));
      if (qrSnap.val() === true) return;

      const cur = (await get(qidRef())).val();
      let next = "Q01";
      if (cur){
        const m = String(cur).match(/^Q(\d+)$/);
        if (m) next = `Q${String(Number(m[1]) + 1).padStart(2,"0")}`;
      }
      await set(qidRef(), next);
      await applyActivityForQuestion(next);
    };

    // 問題戻る ◀
    prevBtn.onclick = async () => {
      const cur = (await get(qidRef())).val();
      if (!cur) return;
      const m = String(cur).match(/^Q(\d+)$/);
      if (!m) return;
      const num = Number(m[1]);
      if (num <= 1) return;

      const prev = `Q${String(num - 1).padStart(2,"0")}`;
      await set(qidRef(), prev);
      await applyActivityForQuestion(prev);
    };

    // 解答終了
    stopBtn.onclick = () => {
      update(actRef(), { status:"closed", qr:false });
    };

    // 授業終了（2段階＋削除）
    endBtn.onclick = async () => {
      const ok1 = confirm("【授業終了】\n\n問題・回答・集計がすべて削除されます。\n本当に終了しますか？");
      if (!ok1) return;
      const input = prompt("最終確認：授業を終了する場合は【終了】と入力してください。");
      if (input !== "終了") { alert("キャンセルしました"); return; }

      const base = `rooms/${currentRoom}`;

      await update(ref(db, `${base}/activity`), { ending:true, qr:false });
      await new Promise(r => setTimeout(r, 1500));

      await set(ref(db, `${base}/questions`), null);
      await set(ref(db, `${base}/quiz`), null);
      await set(ref(db, `${base}/answers`), null);
      await set(ref(db, `${base}/result`), null);
      await set(ref(db, `${base}/activity`), null);

      alert("授業を終了しました（データ削除済み）。");
    };

    // 初期
    attachListeners();
  </script>
</body>
</html>
