// ================================
// 授業モード：問題出題（CSV mode 尊重・text完全対応）
// ================================
async function startQuizQuestion(qid){
  if (!qid) return;

  await set(qidRef(), qid);
  await clearAnswers();

  const qs = await get(questionRef(qid));
  const q = qs.val() || {};

  // =====================================
  // ★最重要：CSVで指定された mode を最優先
  // =====================================
  let mode = (q.mode || "").toLowerCase().trim();

  // mode が無い場合のみ推定（保険）
  if (!mode){
    const keys = q.choices
      ? Object.keys(q.choices).map(k => String(k).toUpperCase())
      : [];

    if (keys.includes("O") && keys.includes("X") && keys.length <= 2){
      mode = "ox";
    } else if (["A","B","C","D","E"].every(k => keys.includes(k))){
      mode = "five";
    } else {
      mode = "text";
    }
  }

  // =====================================
  // mode ごとの config
  // =====================================
  let config = null;

  if (mode === "ox"){
    config = { choices: ["O","X"] };
  } else if (mode === "five"){
    config = { choices: ["A","B","C","D","E"] };
  } else if (mode === "text"){
    config = { type: "text" };
  } else {
    // 想定外は text に退避（安全側）
    mode = "text";
    config = { type: "text" };
  }

  // =====================================
  // activity 更新（出題開始）
  // =====================================
  await update(activityRef(), {
    status: "open",
    qr: false,
    view: "quiz",
    mode: mode,
    config: config
  });

  setQuickActive(null);
  quickState.textContent = "授業モード：問題表示";

  console.log(`[Quiz] ${qid} / mode=${mode}`, config);
}
