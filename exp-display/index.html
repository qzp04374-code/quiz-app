<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClassSync Teacher Control</title>

  <style>
    :root{
      --bg:#050608;
      --panel:#111827;
      --panel2:#020617;
      --ink:#f9fafb;
      --muted:#cbd5e1;

      --color-o:#34c759;
      --color-x:#ff3b30;
      --color-c:#ff9f0a;
      --color-d:#bf5af2;

      --danger:#ef4444;
      --danger2:#991b1b;
      --info:#0ea5e9;
      --indigo:#6366f1;
      --gray:#4b5563;
    }

    body{
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
      margin:0;
      min-height:100vh;
      background:var(--bg);
      display:flex;
      justify-content:center;
      padding:32px 0;
      color:var(--ink);
    }

    .card{
      background:var(--panel);
      border-radius:24px;
      padding:26px 22px 30px;
      max-width:1500px;
      width:100%;
      box-shadow:0 18px 60px rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.04);
      box-sizing:border-box;
    }

    h2{ margin:0 0 14px 0; text-align:center; letter-spacing:.10em; font-weight:900; }

    .topRow{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:14px;
    }

    select, button{
      border:none;
      font-size:14px;
      border-radius:999px;
      padding:10px 18px;
      box-sizing:border-box;
    }

    select{
      background:var(--panel2);
      color:#e5e7eb;
      border:1px solid rgba(255,255,255,.12);
      outline:none;
      min-width: 180px;
    }

    button{
      cursor:pointer;
      color:#fff;
      background:#374151;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      transition:transform .12s ease, filter .12s ease, box-shadow .12s ease, opacity .12s ease;
      font-weight:900;
      letter-spacing:.04em;
    }
    button:active{ transform:scale(.97); filter:brightness(.98); }
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    /* ===== æ“ä½œãƒ‘ãƒãƒ«ï¼ˆ2Ã—2ï¼‰ ===== */
    .controlGroups{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
      margin: 12px 0 16px;
    }
    @media (max-width: 980px){
      .controlGroups{ grid-template-columns: 1fr; }
    }

    .btnGroup{
      padding: 10px 10px 10px !important;
      border-radius: 18px !important;
      background: rgba(255,255,255,.06) !important;
      border: 1px solid rgba(255,255,255,.10) !important;
      backdrop-filter: blur(12px);
    }

    .btnGroupTitle{
      display:flex;
      justify-content:space-between;
      align-items:center;
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .08em !important;
      font-size: 11px !important;
      margin: 0 0 8px 2px !important;
      opacity: .85;
    }

    .miniState{ opacity:.85; font-weight:900; font-size:12px; }

    .btnRow, .pollGrid{
      display: grid !important;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)) !important;
      gap: 8px !important;
      margin-bottom: 8px !important;
    }
    .btnRow:last-child{ margin-bottom:0; }

    .controlGroups button{
      width: 100% !important;
      max-width: 180px;
      justify-self: center;
      min-height: 52px !important;
      padding: 10px 10px !important;

      border-radius: 18px !important;
      border: 1px solid rgba(255,255,255,.12) !important;
      background: rgba(255,255,255,.08) !important;

      font-size: 14px !important;
      font-weight: 900 !important;
      letter-spacing: .02em !important;

      box-shadow:
        0 12px 26px rgba(0,0,0,.28),
        inset 0 1px 0 rgba(255,255,255,.10);
      transition: transform .08s ease, filter .12s ease;
    }

    .controlGroups button:hover{ filter: brightness(1.06); }
    .controlGroups button:active{ transform: scale(.985); filter: brightness(.98); }
    .controlGroups button:disabled{ opacity:.45; box-shadow:none; transform:none; }

    .dangerWide{ grid-column: auto !important; }

    /* æŠ•ç¥¨ãƒ»ç®¡ç†ã‚¿ã‚¤ãƒ« */
    .tile{
      min-height:56px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
    }
    .tile-ox{ background: linear-gradient(135deg, var(--color-o), #06b6d4); }
    .tile-five{ background: linear-gradient(135deg, var(--color-d), #a855f7); }
    .tile-text{ background: linear-gradient(135deg, var(--color-c), #f59e0b); color:#fff !important; }
    .tile-admin{ background: rgba(100,116,139,.18); }
    .tile-admin2{ background: linear-gradient(135deg, #22c55e, #16a34a); }

    /* ä¸»è¦ãƒœã‚¿ãƒ³è‰² */
    #prevQuestionBtn{
      background: rgba(142,142,147,.28) !important;
      border-color: rgba(142,142,147,.35) !important;
    }
    #nextQuestionBtn{
      background: rgba(10,132,255,.92) !important;
      border-color: rgba(10,132,255,.55) !important;
    }
    #stopBtn{
      background: rgba(255,159,10,.92) !important;
      border-color: rgba(255,159,10,.55) !important;
    }
    #endClassBtn{
      background: rgba(255,69,58,.92) !important;
      border-color: rgba(255,69,58,.55) !important;
    }
    #qrBtn, #projectionBtn{
      background: rgba(191,90,242,.90) !important;
      border-color: rgba(191,90,242,.55) !important;
    }
    #t20Btn,#t30Btn,#t60Btn,#tOffBtn{
      background: rgba(48,209,88,.72) !important;
      border-color: rgba(48,209,88,.45) !important;
    }
    #importBtn{
      background: rgba(99,102,241,.35) !important;
      border-color: rgba(99,102,241,.40) !important;
    }
    #dictBtn{
      background: rgba(50,215,75,.80) !important;
      border-color: rgba(50,215,75,.55) !important;
    }

    /* â˜…è¿½åŠ ï¼šåˆ†å²ãƒœã‚¿ãƒ³ï¼ˆiOSã£ã½ã„é’ç·‘ï¼‰ */
    #branchSetBtn{
      background: rgba(0,199,190,.85) !important;
      border-color: rgba(0,199,190,.55) !important;
    }

    /* â˜…è¿½åŠ ï¼šçµæœå…¬é–‹æ–¹å¼ãƒˆã‚°ãƒ« */
    #revealBtn{
      background: rgba(142,142,147,0.28) !important;
      border-color: rgba(142,142,147,0.35) !important;
      position: relative !important;
      padding-left: 54px !important;
      text-align:left !important;
    }
    #revealBtn.on{
      background: rgba(255,159,10,0.92) !important;
      border-color: rgba(255,159,10,0.55) !important;
    }
    #revealBtn::before{
      content:"";
      position:absolute;
      left:14px;
      top:50%;
      transform:translateY(-50%);
      width:34px;
      height:20px;
      border-radius:999px;
      background: rgba(255,255,255,0.22);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.18);
    }
    #revealBtn::after{
      content:"";
      position:absolute;
      left:16px;
      top:50%;
      transform:translateY(-50%);
      width:16px;
      height:16px;
      border-radius:999px;
      background:#fff;
      box-shadow:0 6px 14px rgba(0,0,0,0.22);
      transition:left 120ms ease;
    }
    #revealBtn.on::after{ left:30px; }

    .pill{
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,0.12);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.10);
      font-weight:900;
    }
    .textList{
      max-height: 260px;
      overflow:auto;
      padding:10px;
      border-radius:14px;
      background: rgba(0,0,0,0.18);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
    }
    .textItem{
      padding:10px 12px;
      border-radius:12px;
      background: rgba(255,255,255,0.08);
      margin-bottom:10px;
      line-height:1.35;
      word-break: break-word;
    }
    .textMeta{ font-size:12px; opacity:.75; margin-top:6px; font-weight:900; }

    .roomMeta{
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.10);
      font-size:12px;
      white-space: nowrap;
    }

    .timerRow{
      display:flex !important;
      justify-content:center;
      align-items:center;
      gap:10px;
    }
    #t20Btn,#t30Btn,#t60Btn,#tOffBtn{
      width:56px !important;
      height:56px !important;
      padding:0 !important;
      border-radius:999px !important;
      max-width:none !important;
    }

    /* ===== ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆ2æšã‚«ãƒ¼ãƒ‰ï¼‰ ===== */
    #preview{
      margin-top:18px;
      padding:18px;
      border-radius:20px;
      background: var(--panel2);
      border:1px solid rgba(255,255,255,.08);
    }

    .pvGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
      margin-top:10px;
    }
    @media (max-width: 980px){
      .pvGrid{ grid-template-columns: 1fr; }
    }
    .pvCard{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding: 14px;
    }
    .pvHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .pvBadge{
      font-weight:1000;
      font-size:12px;
      letter-spacing:.12em;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(6,182,212,.22);
      border: 1px solid rgba(6,182,212,.35);
    }
    .pvBadge.next{
      background: rgba(168,85,247,.22);
      border: 1px solid rgba(168,85,247,.35);
    }
    .pvMeta{ font-size:12px; opacity:.75; font-weight:900; }

    .pv-choice{ margin-left:12px; margin-bottom:4px; }
    .pv-answer{ margin-top:12px; font-weight:900; color:var(--color-o); }
    .pv-explanation{ margin-top:6px; font-size:14px; white-space:pre-wrap; }

    #buildTag{
      position:fixed; right:10px; bottom:10px;
      opacity:.60; font-size:12px; z-index:60;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.08);
      padding:6px 10px;
      border-radius:999px;
      backdrop-filter: blur(8px);
    }

    /* ===== åºƒã„ç”»é¢ï¼šâ‘ ã€œâ‘£ ã‚’æ¨ªä¸¦ã³ ===== */
    @media (min-width: 1200px){
      .controlGroups{
        grid-template-columns: repeat(4, minmax(0, 1fr)) !important;
      }
    }

    /* Game buttons */
    #gameDisplayBtn{ background: linear-gradient(135deg, #22c55e, #16a34a) !important; }
    #gameStartBtn{ background: linear-gradient(135deg, #0ea5e9, #2563eb) !important; }
    #gameNextRoundBtn{ background: linear-gradient(135deg, #a855f7, #7c3aed) !important; }
    #gameCloseBtn{ background: rgba(255,159,10,.92) !important; border-color: rgba(255,159,10,.55) !important; }
    #gameEndBtn{ background: rgba(255,69,58,.92) !important; border-color: rgba(255,69,58,.55) !important; }
  </style>
</head>

<body>
  <div id="buildTag">build: 2026-02-08 / teacher-branch-v1</div>

  <div class="card">
    <h2>æ•™å“¡ç”»é¢</h2>

    <div class="topRow">
      ãƒ«ãƒ¼ãƒ ï¼š
      <select id="roomSelect"></select>
      <span id="roomMeta" class="miniState roomMeta">â€”</span>
    </div>

    <div class="controlGroups">
      <!-- â‘  å‡ºé¡Œãƒ»å›å -->
      <section class="btnGroup">
        <div class="btnGroupTitle">â‘  å‡ºé¡Œãƒ»å›å</div>
        <div class="btnRow">
          <button id="prevQuestionBtn">å•é¡Œæˆ»ã‚‹ â—€</button>
          <button id="nextQuestionBtn">æ¬¡ã®å•é¡Œ â–¶</button>
        </div>
        <div class="btnRow">
          <button id="stopBtn">è§£ç­”çµ‚äº†</button>
          <button id="branchSetBtn">åˆ†å²ã‚»ãƒƒãƒˆ</button>
        </div>
      </section>

      <!-- â‘¡ ã‚¿ã‚¤ãƒãƒ¼ -->
      <section class="btnGroup">
        <div class="btnGroupTitle">â‘¡ ã‚¿ã‚¤ãƒãƒ¼</div>
        <div class="btnRow timerRow">
          <button id="t20Btn">â±20</button>
          <button id="t30Btn">â±30</button>
          <button id="t60Btn">â±60</button>
          <button id="tOffBtn">â¹åœæ­¢</button>
        </div>
      </section>

      <!-- â‘¢ è¡¨ç¤ºãƒ»å‚åŠ  -->
      <section class="btnGroup">
        <div class="btnGroupTitle">â‘¢ è¡¨ç¤ºãƒ»å‚åŠ </div>
        <div class="btnRow">
          <button id="qrBtn">QRã‚³ãƒ¼ãƒ‰</button>
          <button id="projectionBtn">displayè¡¨ç¤º</button>
        </div>
        <div class="btnRow">
          <button id="revealBtn">çµæœï¼šå³æ™‚å…¬é–‹</button>
        </div>
        <div class="btnRow">
          <button id="endClassBtn">æˆæ¥­çµ‚äº†</button>
        </div>
      </section>

      <!-- â‘£ æŠ•ç¥¨ãƒ»ç®¡ç† -->
      <section class="btnGroup">
        <div class="btnGroupTitle">â‘£ æŠ•ç¥¨ãƒ»ç®¡ç†</div>
        <div class="pollGrid">
          <button id="quick2Btn" class="tile tile-ox">æŠ•ç¥¨ â—‹âœ•</button>
          <button id="quick5Btn" class="tile tile-five">æŠ•ç¥¨ 5æŠ</button>
          <button id="quickTextBtn" class="tile tile-text">æŠ•ç¥¨ TEXT</button>
          <button id="importBtn" class="tile tile-admin">CSVæŠ•å…¥</button>
          <button id="dictBtn" class="tile tile-admin2">èª­ã¿æ–¹ï¼ˆè¾æ›¸ï¼‰</button>
          <button id="setExpectedFromVotesBtn" class="tile tile-admin">æ¯æ•°=æŠ•ç¥¨äººæ•°</button>
          <button id="gameDisplayBtn" class="tile tile-admin2">ã‚²ãƒ¼ãƒ è¡¨ç¤º</button>
          <button id="gameStartBtn" class="tile tile-admin2">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
          <button id="gameNextRoundBtn" class="tile tile-admin2">æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰</button>
          <button id="gameCloseBtn" class="tile tile-admin">ç· åˆ‡ï¼ˆå…¬é–‹ï¼‰</button>
          <button id="gameEndBtn" class="tile tile-admin">ã‚²ãƒ¼ãƒ çµ‚äº†</button>
        </div>
      </section>
    </div>

    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆ2æšï¼‰ -->
    <div id="preview">
      <h3>å‡ºé¡Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆç¾åœ¨ï¼‹æ¬¡ã®1å•ï¼‰</h3>

      <div class="pvGrid">
        <section class="pvCard">
          <div class="pvHead">
            <div class="pvBadge">ç¾åœ¨</div>
            <div class="pvMeta" id="pvQid">ID: â€”</div>
          </div>
          <div id="pvQuestion">å•é¡Œã‚’å¾…ã£ã¦ã„ã¾ã™â€¦</div>
          <div id="pvChoices"></div>
          <div id="pvAnswer" class="pv-answer"></div>
          <div id="pvExplanation" class="pv-explanation"></div>
        </section>

        <section class="pvCard">
          <div class="pvHead">
            <div class="pvBadge next">æ¬¡</div>
            <div class="pvMeta" id="pvQidNext">ID: â€”</div>
          </div>
          <div id="pvQuestionNext">ï¼ˆæ¬¡ã®å•é¡Œï¼‰</div>
          <div id="pvChoicesNext"></div>
          <div id="pvAnswerNext" class="pv-answer"></div>
          <div id="pvExplanationNext" class="pv-explanation"></div>
        </section>
      </div>
    </div>

    <!-- æ•™å¸«ç”¨ï¼šãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµæœ -->
    <div id="teacherLive" style="margin-top:14px; padding:18px; border-radius:20px; background: var(--panel2); border:1px solid rgba(255,255,255,.08);">
      <h3 style="margin:0 0 10px 0;">æ•™å¸«ç”¨ï¼šãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµæœ</h3>

      <div id="liveCounts" style="display:flex; gap:10px; flex-wrap:wrap; margin:10px 0;">
        <div class="pill" id="liveTotal">Total: 0</div>
        <div class="pill" id="liveO">O: 0</div>
        <div class="pill" id="liveX">X: 0</div>
        <div class="pill" id="liveA">A: 0</div>
        <div class="pill" id="liveB">B: 0</div>
        <div class="pill" id="liveC">C: 0</div>
        <div class="pill" id="liveD">D: 0</div>
        <div class="pill" id="liveE">E: 0</div>
      </div>

      <div id="liveTextWrap" style="display:none;">
        <div style="opacity:.85; margin:8px 0 6px;">TEXTï¼ˆæœ€æ–°20ä»¶ï¼‰</div>
        <div id="liveTextList" class="textList"></div>
      </div>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, update, remove, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBke-wTU16skpbK8z80ddK04tE154dHERQ",
      databaseURL: "https://satosan-41eac-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "satosan-41eac"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // ãƒ«ãƒ¼ãƒ 
    const roomSelect = document.getElementById("roomSelect");
    const ROOMS = [
      { id: "kyoto-01",  label: "Kyoto-01"  },
      { id: "kyoto-02",  label: "Kyoto-02"  },
      { id: "sendai-01", label: "Sendai-01" },
      { id: "sendai-02", label: "Sendai-02" },
      { id: "nagoya-01", label: "Nagoya-01" },
      { id: "nagoya-02", label: "Nagoya-02" },
    ];

    function buildRoomOptions(){
      roomSelect.innerHTML = "";
      for (const r of ROOMS){
        const opt = document.createElement("option");
        opt.value = r.id;
        opt.textContent = r.label;
        roomSelect.appendChild(opt);
      }
    }

    const url = new URL(location.href);
    const urlRoom = url.searchParams.get("room");
    const savedRoom = localStorage.getItem("cs_teacher_room");

    buildRoomOptions();

    let currentRoom =
      (urlRoom && ROOMS.some(r => r.id === urlRoom)) ? urlRoom :
      (savedRoom && ROOMS.some(r => r.id === savedRoom)) ? savedRoom :
      ROOMS[0].id;

    roomSelect.value = currentRoom;

    // refs
    function activityRef(room=currentRoom){ return ref(db, `rooms/${room}/activity`); }
    function answersRef(room=currentRoom){ return ref(db, `rooms/${room}/answers`); }
    function gameRef(room=currentRoom){ return ref(db, `rooms/${room}/activity/game`); }

    function qidRef(room=currentRoom){ return ref(db, `rooms/${room}/quiz/current_question_id`); }
    function questionsRef(room=currentRoom){ return ref(db, `rooms/${room}/questions`); }
    function questionRef(qid, room=currentRoom){ return ref(db, `rooms/${room}/questions/${qid}`); }

    const pvQuestion = document.getElementById("pvQuestion");
    const pvChoices  = document.getElementById("pvChoices");
    const pvAnswer   = document.getElementById("pvAnswer");
    const pvExplanation = document.getElementById("pvExplanation");
    const pvQid = document.getElementById("pvQid");

    const pvQuestionNext = document.getElementById("pvQuestionNext");
    const pvChoicesNext  = document.getElementById("pvChoicesNext");
    const pvAnswerNext   = document.getElementById("pvAnswerNext");
    const pvExplanationNext = document.getElementById("pvExplanationNext");
    const pvQidNext = document.getElementById("pvQidNext");

    const btnPrev = document.getElementById("prevQuestionBtn");
    const btnNext = document.getElementById("nextQuestionBtn");
    const btnStop = document.getElementById("stopBtn");
    const btnBranchSet = document.getElementById("branchSetBtn");
    const btnQR   = document.getElementById("qrBtn");
    const btnT20  = document.getElementById("t20Btn");
    const btnT30  = document.getElementById("t30Btn");
    const btnT60  = document.getElementById("t60Btn");
    const btnTOff = document.getElementById("tOffBtn");
    const btnQ2   = document.getElementById("quick2Btn");
    const btnQ5   = document.getElementById("quick5Btn");
    const btnQT   = document.getElementById("quickTextBtn");
    const btnReveal = document.getElementById("revealBtn");
    const btnSetExpectedFromVotes = document.getElementById("setExpectedFromVotesBtn");
    const btnGameDisplay = document.getElementById("gameDisplayBtn");
    const btnGameStart   = document.getElementById("gameStartBtn");
    const btnGameNext    = document.getElementById("gameNextRoundBtn");
    const btnGameClose   = document.getElementById("gameCloseBtn");
    const btnGameEnd     = document.getElementById("gameEndBtn");

    async function clearAnswers(){ await set(answersRef(), {}); }

    async function refreshOrder(){
      const snap = await get(questionsRef());
      return Object.keys(snap.val() || {}).sort();
    }

    function uiLabel(key){
      const k = String(key).trim().toUpperCase();
      if (k === "O") return "â—‹";
      if (k === "X") return "âœ•";
      return k;
    }

    // state
    const state = {
      activity: {},
      latestQid: null,
      question: null,

      nextQid: null,
      nextQuestion: null,

      unsubActivity: null,
      unsubQid: null,
      unsubQuestion: null,
      unsubNextQuestion: null,
      unsubAnswers: null
    };

    function subscribeQuestion(qid){
      if (state.unsubQuestion){ state.unsubQuestion(); state.unsubQuestion = null; }
      state.question = null;

      if (!qid){ renderPreview(); return; }

      state.unsubQuestion = onValue(questionRef(qid), snap => {
        state.question = snap.val() || null;
        renderPreview();
      });
    }

    function subscribeNextQuestion(qid){
      if (state.unsubNextQuestion){ state.unsubNextQuestion(); state.unsubNextQuestion = null; }
      state.nextQuestion = null;
      state.nextQid = qid || null;

      if (!qid){ renderPreview(); return; }

      state.unsubNextQuestion = onValue(questionRef(qid), snap => {
        state.nextQuestion = snap.val() || null;
        renderPreview();
      });
    }

    async function updateNextSubscription(){
      const base = state.latestQid;
      if (!base){ subscribeNextQuestion(null); return; }

      const order = await refreshOrder();
      const i = order.indexOf(base);
      const next = (i >= 0) ? (order[i+1] || null) : (order[0] || null);

      if (state.latestQid !== base) return;
      subscribeNextQuestion(next);
    }

    // modeæ¨å®šï¼ˆæ—¢å­˜ã®æºã‚Œå¯¾ç­–ï¼‰
    function guessMode(q){
      const m = String(q?.mode ?? "").toLowerCase().trim();
      if (m) return m;
      const keys = q?.choices ? Object.keys(q.choices).map(x => String(x).toUpperCase()) : [];
      if (keys.length === 2 && keys.includes("O") && keys.includes("X")) return "ox";
      if (["A","B","C","D","E"].every(k => keys.includes(k))) return "five";
      return "text";
    }

    // å‡ºé¡Œï¼ˆquizï¼‰
    async function startQuizQuestion(qid){
      if (!qid) return;

      await set(qidRef(), qid);
      await clearAnswers();

      const qs = await get(questionRef(qid));
      const q = qs.val() || {};

      let mode = guessMode(q);

      let config = null;
      if (mode === "text") config = { type:"text" };
      else if (mode === "ox") config = { choices:["O","X"] };
      else if (mode === "five") config = { choices:["A","B","C","D","E"] };

      // â˜…æ—¢å­˜ session ã‚’ç¶­æŒï¼ˆãªã‘ã‚Œã°ä½œã‚‹ï¼‰
      const aSnap = await get(activityRef());
      const aNow = aSnap.val() || {};
      const session = String(aNow.session || "") || Date.now().toString(36);
      
      await update(activityRef(), {
        status:"open",
        qr:false,
        view:"quiz",
        mode,
        config,
        timer:{ running:false },
        session
      });
    }

    // ã‚¯ã‚¤ãƒƒã‚¯æŠ•ç¥¨ï¼ˆpollï¼‰
    async function startQuickPoll(mode){
      await clearAnswers();
      let config = null;
      if (mode === "text") config = { type:"text" };
      else if (mode === "ox") config = { choices:["O","X"] };
      else if (mode === "five") config = { choices:["A","B","C","D","E"] };

      // â˜…æ—¢å­˜ session ã‚’ç¶­æŒï¼ˆãªã‘ã‚Œã°ä½œã‚‹ï¼‰
      const aSnap = await get(activityRef());
      const aNow = aSnap.val() || {};
      const session = String(aNow.session || "") || Date.now().toString(36);
      
      await update(activityRef(), {
        status:"open",
        qr:false,
        view:"poll",
        mode,
        config,
        timer:{ running:false },
        session
      });
      }
      
    async function setExpectedFromVotes(){
      const snap = await get(answersRef());
      const ans = snap.val() || {};
      const n = Object.keys(ans).length;

      if (n <= 0){
        alert("ã¾ã æŠ•ç¥¨ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆanswers=0ï¼‰");
        return;
      }

      const ok = confirm(`ä»Šå›ã®æŠ•ç¥¨äººæ•° ${n} äººã‚’ã€100%äººæ•°ï¼ˆæ¯æ•°ï¼‰ã«è¨­å®šã—ã¾ã™ã‹ï¼Ÿ`);
      if (!ok) return;

      await update(activityRef(), { expectedN: n });
      alert(`100%äººæ•°ï¼ˆæ¯æ•°ï¼‰ã‚’ ${n} äººã«è¨­å®šã—ã¾ã—ãŸã€‚`);
    }

    // ã‚¿ã‚¤ãƒãƒ¼
    async function startTimer(sec){
      await update(activityRef(), {
        timer: {
          running: true,
          endsAt: Date.now() + sec * 1000,
          durationSec: sec,
          autoClose: true
        }
      });
    }

    async function stopTimer(){
      await update(activityRef(), { timer: { running: false } });
    }

    // çµæœå…¬é–‹æ–¹å¼ãƒˆã‚°ãƒ«ï¼ˆlive <-> closedï¼‰
    async function toggleRevealMode(){
      const cur = (state.activity?.revealMode === "closed") ? "closed" : "live";
      const next = (cur === "live") ? "closed" : "live";
      await update(activityRef(), { revealMode: next });
    }

    // QRãƒˆã‚°ãƒ«
    async function toggleQR(){
      const isQR = (state.activity?.qr === true);

      if (!isQR){
        const session = Date.now().toString(36);
        await update(activityRef(), {
          qr:true,
          view:"qr",
          session: session   // â˜…è¿½åŠ 
        });

        return;
      }

      await update(activityRef(), {
        qr:false,
        view:"standby",
        status:"ready",
        mode:null,
        config:null
      });
    }

    // ===== åˆ†å²ï¼ˆã‚¯ãƒ©ã‚¹å…¨ä½“ãƒ»å¤šæ•°æ±ºï¼‰=====
    function extractAnswerValue(v){
      if (v == null) return "";
      if (typeof v === "string") return v;
      if (typeof v === "object" && typeof v.value === "string") return v.value;
      return "";
    }

    function pickWinnerFromAnswers(mode, answersObj){
      const keys = (mode === "five") ? ["A","B","C","D","E"] : ["O","X"];
      const count = Object.fromEntries(keys.map(k => [k, 0]));

      const answers = answersObj || {};
      for (const v of Object.values(answers)){
        const s = String(extractAnswerValue(v)).trim().toUpperCase();
        if (count.hasOwnProperty(s)) count[s]++;
      }

      // åŒç¥¨ã¯ keys ã®å…ˆé ­ãŒå‹ã¤ï¼ˆå®‰å®šãƒ»å†ç¾æ€§å„ªå…ˆï¼‰
      let bestK = keys[0];
      let bestV = -1;
      for (const k of keys){
        const v = count[k] ?? 0;
        if (v > bestV){
          bestV = v;
          bestK = k;
        }
      }
      return { winner: bestK, count };
    }

    async function branchSetNextQuestionId(){
      // 1) ç¾åœ¨qid
      const qidSnap = await get(qidRef());
      const qid = qidSnap.val() || null;
      if (!qid){
        alert("current_question_id ãŒã‚ã‚Šã¾ã›ã‚“");
        return;
      }

      // 2) ç¾åœ¨å•é¡Œãƒ‡ãƒ¼ã‚¿
      const qSnap = await get(questionRef(qid));
      const q = qSnap.val() || null;
      if (!q){
        alert(`questions/${qid} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
        return;
      }

      // 3) modeï¼ˆox / five ã®ã¿å¯¾å¿œã€‚textã¯åˆ†å²ä¸å¯ï¼‰
      const mode = guessMode(q);
      if (mode !== "ox" && mode !== "five"){
        alert(`åˆ†å²ã¯ ox / five ã®ã¿å¯¾å¿œã§ã™ï¼ˆç¾åœ¨ mode=${mode}ï¼‰`);
        return;
      }

      // 4) answersã‹ã‚‰å¤šæ•°æ±º
      const ansSnap = await get(answersRef());
      const answersObj = ansSnap.val() || {};
      const n = Object.keys(answersObj).length;
      if (n <= 0){
        alert("ã¾ã æŠ•ç¥¨ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆanswers=0ï¼‰");
        return;
      }

      const { winner, count } = pickWinnerFromAnswers(mode, answersObj);

      // 5) branch ã‚’èª­ã‚€ï¼ˆå•é¡Œãƒ‡ãƒ¼ã‚¿ã«æŒã¤ã®ãŒæœ¬å‘½ï¼‰
      const branch = (q.branch && typeof q.branch === "object") ? q.branch : null;
      const nextId = branch ? branch[winner] : null;

      if (!nextId){
        const msg =
          `åˆ†å²å…ˆãŒæœªå®šç¾©ã§ã™ã€‚\n\n` +
          `qid=${qid}\nmode=${mode}\nå¤šæ•°æ±º=${winner}\n\n` +
          `questions/${qid}/branch ã« { "${winner}": "æ¬¡ã®å•é¡ŒID" } ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚\n\n` +
          `ç¾åœ¨ã®ç¥¨ï¼š${JSON.stringify(count)}`;
        alert(msg);
        return;
      }

      // 6) æ¬¡ã®å•é¡ŒIDã ã‘ã‚»ãƒƒãƒˆï¼ˆopenã¯ã—ãªã„ï¼‰
      await set(qidRef(), nextId);

      alert(
        `åˆ†å²ã‚»ãƒƒãƒˆå®Œäº†\n` +
        `qid: ${qid} â†’ ${nextId}\n` +
        `mode: ${mode}\n` +
        `å¤šæ•°æ±º: ${winner}\n\n` +
        `â€» open ã¯ã—ã¾ã›ã‚“ã€‚å¿…è¦ãªã‚‰ã€Œæ¬¡ã®å•é¡Œâ–¶ã€ç­‰ã§é–‹å§‹ã—ã¦ãã ã•ã„ã€‚`
      );
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æç”»ï¼ˆæ­£è§£ãƒ»è§£èª¬ã¯å¸¸æ™‚è¡¨ç¤ºï¼‰
    function renderPreview(){
      const a = state.activity || {};
      const view = a.view || "quiz";
      const status = a.status || "-";
      const mode = a.mode || "-";
      const qr = (a.qr === true);
      const reveal = (a.revealMode === "closed") ? "closed" : "live";

      const lock = (a.qr === true);
      btnPrev.disabled = lock;
      btnNext.disabled = lock;
      btnStop.disabled = lock;
      btnBranchSet.disabled = lock;          // â˜…è¿½åŠ ï¼šåˆ†å²ã‚‚QRä¸­ã¯ãƒ­ãƒƒã‚¯
      btnQ2.disabled = lock;
      btnQ5.disabled = lock;
      btnQT.disabled = lock;
      btnT20.disabled  = lock;
      btnT30.disabled  = lock;
      btnT60.disabled  = lock;
      btnTOff.disabled = lock;

      btnReveal.disabled = lock;
      btnReveal.classList.toggle("on", reveal === "closed");
      btnReveal.textContent = (reveal === "closed")
        ? "çµæœï¼šè§£ç­”çµ‚äº†ã§å…¬é–‹"
        : "çµæœï¼šå³æ™‚å…¬é–‹";

      const meta =
        `room:${currentRoom} / view:${view} / status:${status} / mode:${mode} / reveal:${reveal}${qr ? " / QR" : ""}`;

      const roomMeta = document.getElementById("roomMeta");
      if (roomMeta) roomMeta.textContent = meta;

      if (view === "standby"){
        pvQid.textContent = `ID: ${state.latestQid || "â€”"}`;
        pvQuestion.textContent = "ï¼ˆã‚¹ã‚¿ãƒ³ãƒã‚¤ä¸­â€¦ æ¬¡ã®å•é¡Œã‚’å¾…ã£ã¦ã„ã¾ã™ï¼‰";
        pvChoices.innerHTML = "";
        pvAnswer.textContent = "";
        pvExplanation.textContent = "";

        pvQidNext.textContent = "ID: â€”";
        pvQuestionNext.textContent = "â€”";
        pvChoicesNext.innerHTML = "";
        pvAnswerNext.textContent = "";
        pvExplanationNext.textContent = "";
        return;
      }

      if (view === "poll"){
        pvQid.textContent = `ID: ${state.latestQid || "â€”"}`;
        pvQuestion.textContent = "ï¼ˆã‚¯ã‚¤ãƒƒã‚¯æŠ•ç¥¨ï¼šå•é¡Œè¡¨ç¤ºãªã— / é›†è¨ˆã®ã¿ï¼‰";
        pvChoices.innerHTML = "";
        pvAnswer.textContent = "";
        pvExplanation.textContent = "";

        pvQidNext.textContent = "ID: â€”";
        pvQuestionNext.textContent = "â€”";
        pvChoicesNext.innerHTML = "";
        pvAnswerNext.textContent = "";
        pvExplanationNext.textContent = "";
        return;
      }

      if (view === "game"){
        pvQid.textContent = "ID: â€”";
        pvQuestion.textContent = "ï¼ˆã‚²ãƒ¼ãƒ ä¸­ï¼šæ¤…å­å–ã‚Š Aã€œEï¼‰";
        pvChoices.innerHTML = "";
        pvAnswer.textContent = "";
        pvExplanation.textContent = "";

        pvQidNext.textContent = "ID: â€”";
        pvQuestionNext.textContent = "â€”";
        pvChoicesNext.innerHTML = "";
        pvAnswerNext.textContent = "";
        pvExplanationNext.textContent = "";
        return;
      }

      // ç¾åœ¨
      const q = state.question;
      if (!state.latestQid){
        pvQid.textContent = "ID: â€”";
        pvQuestion.textContent = "å•é¡Œã‚’å¾…ã£ã¦ã„ã¾ã™â€¦";
        pvChoices.innerHTML = "";
        pvAnswer.textContent = "";
        pvExplanation.textContent = "";
      } else if (!q){
        pvQid.textContent = `ID: ${state.latestQid}`;
        pvQuestion.textContent = `ï¼ˆ${state.latestQid}ï¼šå•é¡Œãƒ‡ãƒ¼ã‚¿å¾…ã¡ï¼‰`;
        pvChoices.innerHTML = "";
        pvAnswer.textContent = "";
        pvExplanation.textContent = "";
      } else {
        pvQid.textContent = `ID: ${state.latestQid}`;
        pvQuestion.textContent = q.question || "";

        pvChoices.innerHTML = "";
        if (q.choices && typeof q.choices === "object"){
          Object.entries(q.choices).forEach(([k, v]) => {
            const div = document.createElement("div");
            div.className = "pv-choice";
            div.textContent = `${uiLabel(k)}ï¼š${v}`;
            pvChoices.appendChild(div);
          });
        }

        const ans = (q.answer || "").toString().trim().toUpperCase();
        pvAnswer.textContent = ans ? `æ­£è§£ï¼š${uiLabel(ans)}` : "æ­£è§£ï¼šâ€”";
        pvExplanation.textContent = q.explanation ? `è§£èª¬ï¼š${q.explanation}` : "";
      }

      // æ¬¡ï¼ˆç¾çŠ¶ã¯ã€Œä¸¦ã³é †ã®æ¬¡ã€ã‚’è¡¨ç¤ºã€‚åˆ†å²å…ˆã¯ branchSet ã§æ±ºã‚ã‚‹é‹ç”¨ï¼‰
      const q2id = state.nextQid;
      const q2 = state.nextQuestion;

      pvQidNext.textContent = `ID: ${q2id || "â€”"}`;

      if (!q2id){
        pvQuestionNext.textContent = "ï¼ˆæ¬¡ã®å•é¡Œãªã—ï¼‰";
        pvChoicesNext.innerHTML = "";
        pvAnswerNext.textContent = "";
        pvExplanationNext.textContent = "";
        return;
      }
      if (!q2){
        pvQuestionNext.textContent = `ï¼ˆ${q2id}ï¼šå•é¡Œãƒ‡ãƒ¼ã‚¿å¾…ã¡ï¼‰`;
        pvChoicesNext.innerHTML = "";
        pvAnswerNext.textContent = "";
        pvExplanationNext.textContent = "";
        return;
      }

      pvQuestionNext.textContent = q2.question || "";
      pvChoicesNext.innerHTML = "";
      if (q2.choices && typeof q2.choices === "object"){
        Object.entries(q2.choices).forEach(([k, v]) => {
          const div = document.createElement("div");
          div.className = "pv-choice";
          div.textContent = `${uiLabel(k)}ï¼š${v}`;
          pvChoicesNext.appendChild(div);
        });
      }

      const ans2 = (q2.answer || "").toString().trim().toUpperCase();
      pvAnswerNext.textContent = ans2 ? `æ­£è§£ï¼š${uiLabel(ans2)}` : "æ­£è§£ï¼šâ€”";
      pvExplanationNext.textContent = q2.explanation ? `è§£èª¬ï¼š${q2.explanation}` : "";
    }

    function extractTimestamp(v){
      if (v && typeof v === "object" && typeof v.timestamp === "number") return v.timestamp;
      return 0;
    }

    function renderTeacherLive(mode, answersObj){
      const answers = answersObj || {};
      const vals = Object.values(answers).map(extractAnswerValue).filter(Boolean);

      const total = vals.length;
      const count = { O:0, X:0, A:0, B:0, C:0, D:0, E:0 };
      for (const s of vals){
        const up = String(s).trim().toUpperCase();
        if (count.hasOwnProperty(up)) count[up]++;
      }

      const setText = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };
      const show = (id, ok) => { const el = document.getElementById(id); if (el) el.style.display = ok ? "" : "none"; };

      setText("liveTotal", `Total: ${total}`);

      const isOX = (mode === "ox");
      const isFive = (mode === "five");
      const isText = (mode === "text");

      show("liveO", isOX); show("liveX", isOX);
      show("liveA", isFive); show("liveB", isFive); show("liveC", isFive); show("liveD", isFive); show("liveE", isFive);

      if (isOX){
        setText("liveO", `O: ${count.O}`);
        setText("liveX", `X: ${count.X}`);
      }
      if (isFive){
        setText("liveA", `A: ${count.A}`);
        setText("liveB", `B: ${count.B}`);
        setText("liveC", `C: ${count.C}`);
        setText("liveD", `D: ${count.D}`);
        setText("liveE", `E: ${count.E}`);
      }

      const wrap = document.getElementById("liveTextWrap");
      if (wrap) wrap.style.display = isText ? "" : "none";

      if (isText) renderTeacherTextList(answersObj);
    }

    function renderTeacherTextList(answersObj){
      const list = document.getElementById("liveTextList");
      if (!list) return;

      const answers = answersObj || {};
      const items = Object.entries(answers).map(([uid, v]) => ({
        uid,
        text: extractAnswerValue(v),
        ts: extractTimestamp(v),
      })).filter(x => x.text);

      items.sort((a,b) => (b.ts||0) - (a.ts||0));
      const top = items.slice(0, 20);

      const esc = (s) => String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
      list.innerHTML = top.map(x => {
        const when = x.ts ? new Date(x.ts).toLocaleString() : "";
        return `
          <div class="textItem">
            ${esc(x.text)}
            <div class="textMeta">${when ? `ğŸ•’ ${when}` : ""}</div>
          </div>
        `;
      }).join("") || `<div style="opacity:.75;">ã¾ã å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    }

    function attachRoom(room){
      currentRoom = room;
      roomSelect.value = room;

      if (state.unsubActivity){ state.unsubActivity(); state.unsubActivity = null; }
      if (state.unsubQid){ state.unsubQid(); state.unsubQid = null; }
      if (state.unsubQuestion){ state.unsubQuestion(); state.unsubQuestion = null; }
      if (state.unsubNextQuestion){ state.unsubNextQuestion(); state.unsubNextQuestion = null; }
      if (state.unsubAnswers){ state.unsubAnswers(); state.unsubAnswers = null; }

      state.activity = {};
      state.latestQid = null;
      state.question = null;
      state.nextQid = null;
      state.nextQuestion = null;

      state.unsubActivity = onValue(activityRef(room), snap => {
        state.activity = snap.val() || {};
        renderPreview();

        if ((state.activity.view || "quiz") === "quiz"){
          subscribeQuestion(state.latestQid);
        }
      });

      state.unsubQid = onValue(qidRef(room), snap => {
        state.latestQid = snap.val() || null;
        updateNextSubscription();

        if ((state.activity.view || "quiz") === "quiz"){
          subscribeQuestion(state.latestQid);
        } else {
          renderPreview();
        }
      });

      state.unsubAnswers = onValue(answersRef(room), (snap) => {
        const answersObj = snap.val() || {};
        const mode = (state.activity?.mode || "ox").toLowerCase();
        renderTeacherLive(mode, answersObj);
      });

      renderPreview();
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆ
    roomSelect.onchange = () => {
      currentRoom = roomSelect.value;
      localStorage.setItem("cs_teacher_room", currentRoom);
      attachRoom(currentRoom);
    };

    btnNext.onclick = async () => {
      const order = await refreshOrder();
      const cur = (await get(qidRef())).val();
      const i = order.indexOf(cur);
      const next = i < 0 ? order[0] : order[i + 1];
      if (next) startQuizQuestion(next);
    };

    btnPrev.onclick = async () => {
      const order = await refreshOrder();
      const cur = (await get(qidRef())).val();
      const i = order.indexOf(cur);
      const prev = i > 0 ? order[i - 1] : order[0];
      if (prev) startQuizQuestion(prev);
    };

    btnStop.onclick = async () => { await update(activityRef(), { status:"closed" }); };

    // â˜…è¿½åŠ ï¼šåˆ†å²ã‚»ãƒƒãƒˆï¼ˆæ¬¡IDã ã‘æ›´æ–°ã€‚openã—ãªã„ï¼‰
    btnBranchSet.onclick = async () => {
      try{
        await branchSetNextQuestionId();
      }catch(e){
        console.error(e);
        alert("åˆ†å²ã‚»ãƒƒãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸï¼ˆconsole ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰");
      }
    };

    btnQR.onclick = async () => { await toggleQR(); };
    btnReveal.onclick = async () => { await toggleRevealMode(); };
    btnSetExpectedFromVotes.onclick = async () => { await setExpectedFromVotes(); };

    btnGameDisplay.onclick = () => {
      window.open(`https://qzp04374-code.github.io/quiz-app/exp-display/display_game.html?room=${encodeURIComponent(currentRoom)}`, "_blank");
    };

    btnGameEnd.onclick = async () => {
      const ok = confirm("ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¦ standy ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ");
      if (!ok) return;

      await update(activityRef(), {
        qr:false,
        view:"standby",
        status:"ready",
        mode:null,
        config:null,
        timer:{ running:false }
      });
    };

    btnQ2.onclick = async () => { await startQuickPoll("ox"); };
    btnQ5.onclick = async () => { await startQuickPoll("five"); };
    btnQT.onclick = async () => { await startQuickPoll("text"); };

    btnT20.onclick  = () => startTimer(20);
    btnT30.onclick  = () => startTimer(30);
    btnT60.onclick  = () => startTimer(60);
    btnTOff.onclick = () => stopTimer();

    document.getElementById("projectionBtn").onclick = () => {
      window.open(`https://qzp04374-code.github.io/quiz-app/exp-display/display.html?room=${encodeURIComponent(currentRoom)}`, "_blank");
    };
    document.getElementById("importBtn").onclick = () => {
      window.open(`https://qzp04374-code.github.io/quiz-app/exp-display/import-csv.html?room=${encodeURIComponent(currentRoom)}`, "_blank");
    };
    document.getElementById("dictBtn").onclick = () => {
      window.open(`https://qzp04374-code.github.io/quiz-app/exp-display/dict-editor.html?room=${encodeURIComponent(currentRoom)}`, "_blank");
    };

    document.getElementById("endClassBtn").onclick = async () => {
      const ok1 = confirm("æˆæ¥­çµ‚äº†ã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆ1/2ï¼‰");
      if (!ok1) return;
      const ok2 = confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆ2/2ï¼‰");
      if (!ok2) return;
      await remove(ref(db, `rooms/${currentRoom}`));
      alert("æˆæ¥­ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    };

    // èµ·å‹•
    attachRoom(currentRoom);
  </script>
</body>
</html>
