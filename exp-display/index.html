<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClassSync Teacher Control</title>

  <style>
    :root{
      --bg:#050608;
      --panel:#111827;
      --panel2:#020617;
      --line:rgba(255,255,255,.10);
      --ink:#f9fafb;
      --muted:#cbd5e1;

      /* 番号(文字)と色の対応 */
      --color-o:#34c759;
      --color-x:#ff3b30;
      --color-a:#0a84ff;
      --color-b:#30d158;
      --color-c:#ff9f0a;
      --color-d:#bf5af2;
      --color-e:#ff375f;

      --danger:#ef4444;
      --danger2:#991b1b;
      --info:#0ea5e9;
      --indigo:#6366f1;
      --gray:#4b5563;
    }

    body{
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
      margin:0;
      min-height:100vh;
      background:var(--bg);
      display:flex;
      justify-content:center;
      padding:32px 0;
      color:var(--ink);
    }

    .card{
      background:var(--panel);
      border-radius:24px;
      padding:26px 22px 30px;
      max-width:1180px;
      width:100%;
      box-shadow:0 18px 60px rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.04);
      box-sizing:border-box;
    }

    h2{
      margin:0 0 14px 0;
      text-align:center;
      letter-spacing:.10em;
      font-weight:900;
    }

    .topRow{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:14px;
    }

    select, button{
      border:none;
      font-size:14px;
      border-radius:999px;
      padding:10px 18px;
      box-sizing:border-box;
    }

    select{
      background:var(--panel2);
      color:#e5e7eb;
      border:1px solid rgba(255,255,255,.12);
      outline:none;
    }

    button{
      cursor:pointer;
      color:#fff;
      background:#374151;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      transition:transform .12s ease, filter .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    button:active{ transform:scale(.97); filter:brightness(.98); }
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    /* クイック投票 */
    .quickWrap{
      margin: 10px auto 18px;
      padding: 14px 12px 12px;
      border-radius: 22px;
      background: rgba(2,6,23,.55);
      border:1px solid rgba(255,255,255,.08);
    }
    .quickTitle{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding-bottom:10px;
      color: var(--muted);
      font-weight:900;
      letter-spacing:.10em;
      font-size:13px;
    }
    .quickRow{
      display:flex;
      justify-content:center;
      gap:14px;
      flex-wrap:wrap;
    }
    .qbtn{
      width:100px;
      height:100px;
      border-radius:9999px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:6px;
      border:1px solid rgba(255,255,255,.10);
    }
    .q2{ background: linear-gradient(135deg, var(--color-o), #06b6d4); }
    .q5{ background: linear-gradient(135deg, var(--color-d), #a855f7); }
    .qt{ background: linear-gradient(135deg, var(--color-c), #f59e0b); color:#111827; }

    .button-row{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:10px;
      margin: 12px 0 16px;
    }

    #prevQuestionBtn { background: var(--gray); }
    #nextQuestionBtn { background: linear-gradient(135deg, var(--color-o), #06b6d4); }
    #stopBtn { background: var(--danger); }
    #endClassBtn { background: linear-gradient(135deg,var(--danger),var(--danger2)); }
    #qrBtn { background: var(--info); }
    #projectionBtn { background: linear-gradient(135deg,var(--indigo),#a855f7); }
    #importBtn { background: linear-gradient(135deg,var(--color-c),#f97316); }

    #preview{
      margin-top:18px;
      padding:18px;
      border-radius:20px;
      background: var(--panel2);
      border:1px solid rgba(255,255,255,.08);
    }
    .pv-choice{ margin-left:12px; margin-bottom:4px; }
    .pv-answer{ margin-top:12px; font-weight:900; color:var(--color-o); }
    .pv-explanation{ margin-top:6px; font-size:14px; white-space:pre-wrap; }
  </style>
</head>

<body>
  <div class="card">
    <h2>教員画面</h2>

    <div class="topRow">
      ルーム：
      <select id="roomSelect">
        <option value="kyoto-01">kyoto-01</option>
        <option value="kyoto-02">kyoto-02</option>
      </select>
    </div>

    <!-- クイック投票 -->
    <div class="quickWrap">
      <div class="quickTitle">
        <span>クイック投票（集計のみ）</span>
        <span id="quickState">—</span>
      </div>
      <div class="quickRow">
        <button id="quick2Btn" class="qbtn q2">○✕</button>
        <button id="quick5Btn" class="qbtn q5">ABCDE</button>
        <button id="quickTextBtn" class="qbtn qt">TEXT</button>
      </div>
    </div>

    <!-- 授業操作 -->
    <div class="button-row">
      <button id="prevQuestionBtn">問題戻る ◀</button>
      <button id="nextQuestionBtn">次の問題 ▶</button>
      <button id="stopBtn">解答終了</button>
      <button id="endClassBtn">授業終了</button>
      <button id="qrBtn">QRコード</button>
      <button id="projectionBtn">display表示</button>
      <button id="importBtn">CSV投入</button>
    </div>

    <!-- プレビュー -->
    <div id="preview">
      <h3>出題プレビュー（教員のみ）</h3>
      <div id="pvQuestion">問題を待っています…</div>
      <div id="pvChoices"></div>
      <div id="pvAnswer" class="pv-answer"></div>
      <div id="pvExplanation" class="pv-explanation"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, update, remove, onValue, get } from
      "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBke-wTU16skpbK8z80ddK04tE154dHERQ",
      databaseURL: "https://satosan-41eac-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "satosan-41eac"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const roomSelect = document.getElementById("roomSelect");
    let currentRoom = roomSelect.value;

    function activityRef(){ return ref(db, `rooms/${currentRoom}/activity`); }
    function answersRef(){ return ref(db, `rooms/${currentRoom}/answers`); }
    function qidRef(){ return ref(db, `rooms/${currentRoom}/quiz/current_question_id`); }
    function questionsRef(){ return ref(db, `rooms/${currentRoom}/questions`); }
    function questionRef(qid){ return ref(db, `rooms/${currentRoom}/questions/${qid}`); }

    async function clearAnswers(){
      await set(answersRef(), {});
    }

    async function refreshOrder(){
      const snap = await get(questionsRef());
      return Object.keys(snap.val() || {}).sort();
    }

    // ===== ★修正箇所：CSVの mode を尊重 =====
    async function startQuizQuestion(qid){
      if (!qid) return;

      await set(qidRef(), qid);
      await clearAnswers();

      const qs = await get(questionRef(qid));
      const q = qs.val() || {};

      let mode = (q.mode || "").toLowerCase().trim();
      if (!mode){
        const keys = q.choices ? Object.keys(q.choices).map(k => k.toUpperCase()) : [];
        if (keys.length === 2 && keys.includes("O") && keys.includes("X")) mode = "ox";
        else if (["A","B","C","D","E"].every(k => keys.includes(k))) mode = "five";
        else mode = "text";
      }

      let config = null;
      if (mode === "text") config = { type:"text" };
      else if (mode === "ox") config = { choices:["O","X"] };
      else if (mode === "five") config = { choices:["A","B","C","D","E"] };

      await update(activityRef(), {
        status:"open",
        qr:false,
        view:"quiz",
        mode,
        config
      });
    }

    document.getElementById("nextQuestionBtn").onclick = async () => {
      const order = await refreshOrder();
      const cur = (await get(qidRef())).val();
      const i = order.indexOf(cur);
      const next = i < 0 ? order[0] : order[i + 1];
      if (next) startQuizQuestion(next);
    };

    document.getElementById("prevQuestionBtn").onclick = async () => {
      const order = await refreshOrder();
      const cur = (await get(qidRef())).val();
      const i = order.indexOf(cur);
      const prev = i > 0 ? order[i - 1] : order[0];
      if (prev) startQuizQuestion(prev);
    };

    document.getElementById("stopBtn").onclick = async () => {
      await update(activityRef(), { status:"closed" });
    };

    document.getElementById("endClassBtn").onclick = async () => {
      const ok1 = confirm("授業終了します。データを削除しますか？（1/2）");
      if (!ok1) return;
      const ok2 = confirm("本当に削除しますか？（2/2）");
      if (!ok2) return;
      await remove(ref(db, `rooms/${currentRoom}`));
      alert("授業データを削除しました。");
    };

    document.getElementById("projectionBtn").onclick = () => {
      window.open(
        `https://qzp04374-code.github.io/quiz-app/exp-display/display.html?room=${encodeURIComponent(currentRoom)}`,
        "_blank"
      );
    };

    document.getElementById("importBtn").onclick = () => {
      window.open(
        `https://qzp04374-code.github.io/quiz-app/exp-display/import-csv.html`,
        "_blank"
      );
    };
  </script>
</body>
</html>
