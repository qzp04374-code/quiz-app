<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>クイズ回答ページ</title>

<link rel="stylesheet" href="student.css">

<!-- Firebase -->
<script type="module">
import { db, ref, set, onValue } from "./common.js";

document.addEventListener("DOMContentLoaded", () => {

  /* ---------- URLからroom取得 ---------- */
  const params = new URLSearchParams(window.location.search);
  const room = params.get("room");

  const statusText = document.getElementById("statusText");
  const sendBtn = document.getElementById("sendBtn");
  const choiceBtns = document.querySelectorAll(".choice-btn");

  let selected = null;

  if (!room) {
    statusText.textContent = "ルームが指定されていません。";
    return;
  }

  /* ---------- ルームのステータス監視 ---------- */
  const activityRef = ref(db, `rooms/${room}/activity/status`);

  onValue(activityRef, (snapshot) => {
    const status = snapshot.val();

    if (status === "open") {
      statusText.textContent = "回答できます。";
      sendBtn.disabled = false;
    } else {
      statusText.textContent = "待機中...";
      sendBtn.disabled = true;
    }
  });

  /* ---------- ○✕ ボタン選択 ---------- */
  choiceBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      choiceBtns.forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      selected = btn.dataset.value;
    });
  });

  /* ---------- 送信 ---------- */
  sendBtn.addEventListener("click", async () => {
    if (!selected) {
      alert("○ か ✕ を選択してください。");
      return;
    }

    const userId = `stu_${Math.random().toString(36).substring(2, 10)}`;
    await set(ref(db, `rooms/${room}/answers/${userId}`), selected);

    sendBtn.classList.add("sent");
    sendBtn.textContent = "送信しました ✓";

    setTimeout(() => {
      sendBtn.classList.remove("sent");
      sendBtn.textContent = "送信";
    }, 2000);
  });

});
</script>
</head>

<body>
  <div class="container">

    <h1 class="title">クイズ回答</h1>

    <div id="statusText" class="status">読み込み中...</div>

    <div class="buttons">
      <button class="choice-btn o-btn" data-value="O">○</button>
      <button class="choice-btn x-btn" data-value="X">✕</button>
    </div>

    <button id="sendBtn" class="send-btn" disabled>送信</button>

  </div>
</body>
</html>

