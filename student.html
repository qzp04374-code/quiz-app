<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>学生用クイズ回答</title>
<link rel="stylesheet" href="style.css">
<script type="module">
import { db, ref, get, set, onValue } from "./common.js";

const activityRef = ref(db, "activity");
const resultRef = ref(db, "result");

// 学生を識別（ブラウザごとに固定）
let studentId = localStorage.getItem("studentId");
if (!studentId) {
  studentId = "stu_" + Math.random().toString(36).substring(2, 9);
  localStorage.setItem("studentId", studentId);
}
const answersRef = ref(db, "answers/" + studentId);

let selected = null;   // ○ or ✕の一時選択
let submitted = false; // 決定済フラグ

document.addEventListener("DOMContentLoaded", () => {
  const oBtn = document.getElementById("o-btn");
  const xBtn = document.getElementById("x-btn");
  const submitBtn = document.getElementById("submit-btn");
  const status = document.getElementById("status");
  const msg = document.getElementById("message");

  // 教員の制御状態を監視
  onValue(activityRef, (snapshot) => {
    const data = snapshot.val();
    if (data.status === "open") {
      oBtn.disabled = false;
      xBtn.disabled = false;
      submitBtn.disabled = false;
      status.textContent = "回答受付中";
      msg.textContent = "";
      submitted = false;
      selected = null;
      highlightButton(null);
    } else {
      oBtn.disabled = true;
      xBtn.disabled = true;
      submitBtn.disabled = true;
      status.textContent = "ロック中（待機してください）";
    }
  });

  oBtn.onclick = () => { selected = "O"; highlightButton("O"); };
  xBtn.onclick = () => { selected = "X"; highlightButton("X"); };

  submitBtn.onclick = async () => {
    if (submitted) return;
    if (!selected) {
      msg.textContent = "○か✕を選んでから決定してください。";
      return;
    }
    // 回答を登録
    const resSnap = await get(resultRef);
    const res = resSnap.val() || { O: 0, X: 0 };
    res[selected]++;
    await set(resultRef, res);
    await set(answersRef, selected);

    msg.textContent = `あなたの回答（${selected === "O" ? "○" : "✕"}）を受け付けました。`;
    submitted = true;

    // ボタンを無効化
    oBtn.disabled = true;
    xBtn.disabled = true;
    submitBtn.disabled = true;
  };
});

// ボタン選択の強調表示
function highlightButton(choice) {
  const oBtn = document.getElementById("o-btn");
  const xBtn = document.getElementById("x-btn");
  oBtn.classList.remove("selected");
  xBtn.classList.remove("selected");
  if (choice === "O") oBtn.classList.add("selected");
  if (choice === "X") xBtn.classList.add("selected");
}
</script>
</head>
<body>
<h1>○☓クイズ 回答ページ</h1>
<p id="status">ロック中（待機してください）</p>

<div class="buttons">
  <button id="o-btn" disabled>○</button>
  <button id="x-btn" disabled>×</button>
</div>

<p><button id="submit-btn" disabled style="padding:0.6em 1.5em;">決定</button></p>
<p id="message" style="color:#333;font-weight:bold;"></p>
</body>
</html>

