<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>学生用回答ページ</title>
<link rel="stylesheet" href="student.css">

<!-- Firebase -->
<script type="module">
import { db, ref, onValue, set, update } from "./common.js";

document.addEventListener("DOMContentLoaded", () => {
    /* -------------------------
       URL から room を取得
    ------------------------- */
    const params = new URLSearchParams(window.location.search);
    const room = params.get("room");

    const roomLabel = document.getElementById("roomLabel");
    const statusLabel = document.getElementById("statusLabel");
    const btnO = document.getElementById("btnO");
    const btnX = document.getElementById("btnX");

    roomLabel.textContent = room ? `ルーム：${room}` : "ルーム未設定";

    if (!room) {
        statusLabel.textContent = "エラー：roomが設定されていません";
        btnO.disabled = true;
        btnX.disabled = true;
        return;
    }

    /* -------------------------
       Firebase パス設定
    ------------------------- */
    const activityRef = ref(db, `rooms/${room}/activity`);
    const answersRef  = ref(db, `rooms/${room}/answers`);
    const resultRef   = ref(db, `rooms/${room}/result`);

    /* -------------------------
       回答開始 / 終了の監視
    ------------------------- */
    onValue(activityRef, (snapshot) => {
        const data = snapshot.val();
        const status = data?.status || "closed";

        if (status === "open") {
            statusLabel.textContent = "回答できます";
            btnO.disabled = false;
            btnX.disabled = false;
        } else {
            statusLabel.textContent = "回答終了";
            btnO.disabled = true;
            btnX.disabled = true;
        }
    });

    /* -------------------------
       回答送信（1回のみ）
    ------------------------- */
    function sendAnswer(choice) {
        const user = `user_${Math.random().toString(36).substring(2,8)}`;

        // 個人回答（answers）に登録
        update(answersRef, { [user]: choice });

        // 集計用 result をカウントアップ
        set(resultRef, {
            O: choice === "O" ? incrementCount("O") : incrementCount("O", 0),
            X: choice === "X" ? incrementCount("X") : incrementCount("X", 0)
        });

        btnO.disabled = true;
        btnX.disabled = true;
        statusLabel.textContent = "回答しました";
    }

    /* Local カウンタ（Firebase読み込み後に更新する） */
    let currentOK = 0;
    let currentX = 0;

    // Firebase result を監視してローカル値へ反映
    onValue(resultRef, (snap) => {
        const v = snap.val() || { O: 0, X: 0 };
        currentOK = v.O;
        currentX = v.X;
    });

    function incrementCount(type, add = 1) {
        return type === "O" ? currentOK + add : currentX + add;
    }

    btnO.addEventListener("click", () => sendAnswer("O"));
    btnX.addEventListener("click", () => sendAnswer("X"));
});
</script>

</head>
<body>

<div class="container">

    <h2 id="roomLabel">ルーム：---</h2>
    <p id="statusLabel" class="status">読み込み中...</p>

    <div class="button-box">
        <button id="btnO" class="btn-o" disabled>○</button>
        <button id="btnX" class="btn-x" disabled>✕</button>
    </div>

</div>

</body>
</html>

