<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>学生用回答ページ</title>
<link rel="stylesheet" href="student.css">

<!-- キャッシュ防止（スマホ対策） -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<script type="module">
import { db, ref, onValue, set } from "./common.js";

/* -------------------------
   URLからルーム名を取得
------------------------- */
function getRoomName() {
  const url = new URL(window.location.href);
  const r = url.searchParams.get("room");
  if (!r) {
    alert("room が指定されていません");
    return null;
  }
  return r;
}

const room = getRoomName();
if (!room) throw new Error("Room not found");

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("roomName").textContent = room;
});

/* -------------------------
   Firebase 参照
------------------------- */
const activityRef = ref(db, `rooms/${room}/activity`);
const answersRef  = ref(db, `rooms/${room}/answers`);

/* 学生IDを生成 */
let userId = localStorage.getItem("studentUserId");
if (!userId) {
  userId = "u" + Math.random().toString(36).substring(2, 10);
  localStorage.setItem("studentUserId", userId);
}

/* -------------------------
   回答送信
------------------------- */
function sendAnswer(val) {
  set(ref(db, `rooms/${room}/answers/${userId}`), val)
    .then(() => {
      glowButton(val);
      playPoyo();
    });
}

/* ボタン光らせる */
function glowButton(val) {
  document.getElementById("btnO").classList.remove("selected");
  document.getElementById("btnX").classList.remove("selected");

  if (val === "O") document.getElementById("btnO").classList.add("selected");
  if (val === "X") document.getElementById("btnX").classList.add("selected");
}

/* ぽよん音 */
function playPoyo() {
  const audio = new Audio("poyo.mp3");
  audio.play();
}

/* -------------------------
   回答開始・終了を監視
------------------------- */
onValue(activityRef, (snapshot) => {
  const data = snapshot.val() || {};
  const open = data.status === "open";

  const msg = document.getElementById("statusText");

  if (open) {
    msg.textContent = "回答できます";
    msg.classList.remove("closed");
    msg.classList.add("open");

    document.getElementById("btnO").disabled = false;
    document.getElementById("btnX").disabled = false;

  } else {
    msg.textContent = "回答できません（待機中）";
    msg.classList.remove("open");
    msg.classList.add("closed");

    document.getElementById("btnO").disabled = true;
    document.getElementById("btnX").disabled = true;
  }
});

/* HTMLボタンを JS と接続 */
window.sendO = () => sendAnswer("O");
window.sendX = () => sendAnswer("X");

</script>
</head>

<body>
  <h2>学生回答ページ</h2>
  <p>ルーム：<span id="roomName"></span></p>

  <p id="statusText" class="closed">回答できません（待機中）</p>

  <button id="btnO" onclick="sendO()" disabled>○</button>
  <button id="btnX" onclick="sendX()" disabled>×</button>
</body>
</html>

