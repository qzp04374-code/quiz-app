<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>学生回答ページ</title>
<link rel="stylesheet" href="student.css">

<!-- Firebase -->
<script type="module">
import { db, ref, onValue, push } from "./common.js";

document.addEventListener("DOMContentLoaded", () => {

  /* ====================================================
      URLから room を確実に取得する（最新版）
     ==================================================== */
  let classRoom = "kyoto-01"; // フォールバック用

  try {
    const url = new URL(window.location.href);
    const r = url.searchParams.get("room");
    if (r) classRoom = r;
  } catch (e) {
    console.warn("URL解析に失敗。フォールバック kyoto-01 を使用します");
  }

  // ページに表示
  document.getElementById("roomName").textContent = classRoom;


  /* ====================================================
      Firebase参照
     ==================================================== */
  const answersRef   = ref(db, `answers/${classRoom}`);
  const activityRef  = ref(db, "activity");

  let isOpen = false;
  let hasAnswered = false;

  /* 回答音 */
  const popSound = new Audio(
    "https://qzp04374-code.github.io/quiz-app/poyon.mp3"
  );

  /* ボタン取得 */
  const btnO = document.getElementById("btnO");
  const btnX = document.getElementById("btnX");

  /* ====================================================
      回答（1回のみ）
     ==================================================== */
  function answer(value) {
    if (!isOpen) {
      alert("まだ回答できません。");
      return;
    }

    if (hasAnswered) {
      alert("回答は1回です。");
      return;
    }

    push(answersRef, value);

    if (value === "O") {
      btnO.classList.add("answered");
      btnX.classList.remove("answered");
    } else {
      btnX.classList.add("answered");
      btnO.classList.remove("answered");
    }

    hasAnswered = true;

    popSound.currentTime = 0;
    popSound.play();
  }

  btnO.addEventListener("click", () => answer("O"));
  btnX.addEventListener("click", () => answer("X"));

  /* ====================================================
      回答開始／停止の監視
     ==================================================== */
  onValue(activityRef, snap => {
    const v = snap.val() || {};
    isOpen = (v.status === "open" && v.class === classRoom);

    document.getElementById("statusText").textContent =
      isOpen ? "回答できます" : "回答停止中";
  });

});
</script>
</head>

<body>

  <div class="container">
    <h2 id="title">学生回答ページ</h2>

    <div class="room-info">
      <p>あなたのクラス： <span id="roomName"></span></p>
      <p id="statusText">読み込み中…</p>
    </div>

    <div class="button-box">
      <button id="btnO" class="answer-btn o">○</button>
      <button id="btnX" class="answer-btn x">✕</button>
    </div>
  </div>

</body>
</html>

