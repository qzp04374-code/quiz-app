<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>学生用回答ページ</title>
<link rel="stylesheet" href="student.css">

<!-- Firebase -->
<script type="module">
import { db, ref, onValue, update } from "./common.js";

document.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const room = params.get("room");

    const roomLabel = document.getElementById("roomLabel");
    const statusLabel = document.getElementById("statusLabel");
    const btnO = document.getElementById("btnO");
    const btnX = document.getElementById("btnX");
    const btnSend = document.getElementById("btnSend");

    roomLabel.textContent = room ? `ルーム：${room}` : "ルーム未設定";

    if (!room) return;

    const activityRef = ref(db, `rooms/${room}/activity`);
    const answersRef  = ref(db, `rooms/${room}/answers`);

    let choice = null;
    let locked = true;

    // 回答開始／終了
    onValue(activityRef, (snap) => {
        const status = snap.val()?.status || "closed";
        locked = (status !== "open");

        if (locked) {
            statusLabel.textContent = "回答終了";
            disableAll();
        } else {
            statusLabel.textContent = "回答できます";
            enableChoices();
        }
    });

    // 〇 × 選択
    btnO.addEventListener("click", () => {
        if (locked) return;
        choice = "O";
        highlightChoice("O");
    });

    btnX.addEventListener("click", () => {
        if (locked) return;
        choice = "X";
        highlightChoice("X");
    });

    // 決定 → Firebaseへ送信
    btnSend.addEventListener("click", () => {
        if (locked || !choice) return;

        const user = `user_${Math.random().toString(36).substring(2,8)}`;

        update(answersRef, { [user]: choice });

        // 決定後ロック
        disableAll();
        statusLabel.textContent = "回答しました";

        // 音（決定時のみ）
        const audio = new Audio("poyon.mp3");
        audio.play();
    });

    // UI 管理
    function disableAll() {
        btnO.disabled = true;
        btnX.disabled = true;
        btnSend.disabled = true;
    }

    function enableChoices() {
        btnO.disabled = false;
        btnX.disabled = false;
        btnSend.disabled = false;
        choice = null;
        highlightChoice(null);
    }

    function highlightChoice(c) {
        btnO.classList.toggle("selected", c === "O");
        btnX.classList.toggle("selected", c === "X");
    }
});
</script>

</head>
<body>
<div class="container">

    <h2 id="roomLabel">ルーム</h2>
    <p id="statusLabel" class="status">読み込み中...</p>

    <div class="choice-box">
        <button id="btnO" class="btn-o">○</button>
        <button id="btnX" class="btn-x">×</button>
    </div>

    <button id="btnSend" class="btn-send">決定</button>

</div>
</body>
</html>

