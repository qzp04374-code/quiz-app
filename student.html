<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>学生回答ページ</title>
<link rel="stylesheet" href="student.css">

<!-- Firebase -->
<script type="module">
import { db, ref, onValue, set, push } from "./common.js";

document.addEventListener("DOMContentLoaded", () => {

  /* ───────────────────────────────
      URL から classRoom を読み取る
  ─────────────────────────────── */
  const params = new URLSearchParams(window.location.search);
  const classRoom = params.get("room") || "kyoto-01";

  document.getElementById("roomName").textContent = classRoom;


  /* ───────────────────────────────
      Firebase参照
  ─────────────────────────────── */
  const answersRef = ref(db, `answers/${classRoom}`);
  const activityRef = ref(db, "activity");

  let isOpen = false;
  let hasAnswered = false;  // 1回回答制限


  /* ───────────────────────────────
      回答音（ぽよん♪）
  ─────────────────────────────── */
  const popSound = new Audio(
    "https://github.com/qzp04374-code/quiz-app/raw/main/poyon.mp3"
  );


  /* ───────────────────────────────
      回答ボタン（○✕）の取得
  ─────────────────────────────── */
  const btnO = document.getElementById("btnO");
  const btnX = document.getElementById("btnX");


  /* ───────────────────────────────
      回答処理（1回のみ）
  ─────────────────────────────── */
  function answer(value) {
    if (!isOpen) {
      alert("まだ回答できません。");
      return;
    }

    if (hasAnswered) {
      alert("回答は1回のみです。");
      return;
    }

    // 回答を Firebase に push
    push(answersRef, value);

    // ボタンを光らせる
    if (value === "O") {
      btnO.classList.add("answered");
      btnX.classList.remove("answered");
    } else {
      btnX.classList.add("answered");
      btnO.classList.remove("answered");
    }

    hasAnswered = true;

    // ぽよん♪
    popSound.currentTime = 0;
    popSound.play();
  }


  /* ───────────────────────────────
      ボタンにイベント設定
  ─────────────────────────────── */
  btnO.addEventListener("click", () => answer("O"));
  btnX.addEventListener("click", () => answer("X"));


  /* ───────────────────────────────
      回答開始 / 終了の状態を監視
  ─────────────────────────────── */
  onValue(activityRef, snapshot => {
    const val = snapshot.val() || {};
    isOpen = (val.status === "open" && val.class === classRoom);

    if (!isOpen) {
      document.getElementById("statusText").textContent = "回答停止中";
    } else {
      document.getElementById("statusText").textContent = "回答できます";
    }
  });

});
</script>

</head>

<body>

  <div class="container">

    <h2 id="title">学生回答ページ</h2>

    <div class="room-info">
      <p>あなたのクラス： <span id="roomName"></span></p>
      <p id="statusText">読み込み中…</p>
    </div>

    <div class="button-box">
      <button id="btnO" class="answer-btn o">○</button>
      <button id="btnX" class="answer-btn x">✕</button>
    </div>

  </div>

</body>
</html>

