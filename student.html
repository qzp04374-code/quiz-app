<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>学生ページ</title>

<!-- キャッシュ対策（iPhone用） -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<link rel="stylesheet" href="student.css?v=20251117">

<script type="module">
import { db, ref, set, onValue } from "./common.js?v=20251117";

document.addEventListener("DOMContentLoaded", () => {

  /* ---------------------------------------------------
     ① room を確実に URL から取得（Safari対策）
  --------------------------------------------------- */
  const url = new URL(location.href);
  let room = url.searchParams.get("room");

  if (!room) {
    alert("ルーム情報がありません（room=???）");
    room = "default";
  }

  /* ---------------------------------------------------
     ② Firebase パスを rooms/{room}/... に統一
  --------------------------------------------------- */
  const activityRef = ref(db, `rooms/${room}/activity`);
  const answersRef  = ref(db, `rooms/${room}/answers`);

  const btnO = document.getElementById("btnO");
  const btnX = document.getElementById("btnX");
  const statusText = document.getElementById("statusText");

  /* ---------------------------------------------------
     ③ 学生ごとに固定の userId を発行（1 回だけ）
        → 毎回回答IDが変わる問題を完全修正
  --------------------------------------------------- */
  let userId = localStorage.getItem("quiz_userId");
  if (!userId) {
    userId = "u_" + Math.random().toString(36).slice(2, 10);
    localStorage.setItem("quiz_userId", userId);
  }

  /* ---------------------------------------------------
     ④ 回答開始/終了のリアルタイム監視
  --------------------------------------------------- */
  onValue(activityRef, (snap) => {
    const data = snap.val();

    if (!data || data.status !== "open") {
      statusText.textContent = "【回答終了】";
      btnO.disabled = true;
      btnX.disabled = true;
    } else {
      statusText.textContent = "【回答受付中】";
      btnO.disabled = false;
      btnX.disabled = false;
    }
  });

  /* ---------------------------------------------------
     ⑤ 回答送信（1 回だけ上書き可能）
  --------------------------------------------------- */
  const send = (val) => {
    set(ref(db, `rooms/${room}/answers/${userId}`), val);
    document.getElementById("pop").play();
  };

  btnO.onclick = () => send("O");
  btnX.onclick = () => send("X");

});
</script>
</head>

<body>
<h1>回答ページ</h1>

<div id="statusText">状態確認中…</div>

<div class="btn-area">
  <button id="btnO" class="answer-btn o" disabled>○</button>
  <button id="btnX" class="answer-btn x" disabled>✕</button>
</div>

<!-- かわいい音：ぽよん♪ -->
<audio id="pop">
  <source src="pop.mp3">
</audio>

</body>
</html>

