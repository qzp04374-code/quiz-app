<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>学生用クイズページ</title>
<link rel="stylesheet" href="student.css">
<script type="module">
import { db, ref, onValue, update } from "./common.js";

const activityRef = ref(db, "activity");
const resultRef = ref(db, "result");

let currentChoice = null; // 学生の現在の選択

document.addEventListener("DOMContentLoaded", () => {
  const statusText = document.getElementById("status");
  const buttons = document.querySelectorAll(".answer-btn");
  const confirmBtn = document.getElementById("confirm");
  let locked = true;

  // 回答ボタンの選択
  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      if (locked) return;
      buttons.forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      currentChoice = btn.dataset.choice;
    });
  });

  // 回答送信
  confirmBtn.addEventListener("click", () => {
    if (locked) return;
    if (!currentChoice) {
      alert("○か×を選んでください。");
      return;
    }
    update(resultRef, { [currentChoice]: increment(1) });
    locked = true;
    statusText.textContent = "回答を送信しました。";
    confirmBtn.disabled = true;
  });

  // 状態監視
  onValue(activityRef, (snapshot) => {
    const data = snapshot.val();
    if (!data) return;
    if (data.status === "open") {
      locked = false;
      currentChoice = null;
      buttons.forEach(b => b.classList.remove("selected"));
      confirmBtn.disabled = false;
      statusText.textContent = "回答受付中です";
    } else {
      locked = true;
      statusText.textContent = "回答は締め切られました";
      confirmBtn.disabled = true;
    }
  });
});

// Firebaseの数値更新補助
function increment(num) {
  return { ".sv": { "increment": num } };
}
</script>
</head>

<body>
<h1>クイズ回答ページ</h1>

<p id="status">回答は締め切られています</p>

<div class="buttons">
  <button class="answer-btn" data-choice="O">○</button>
  <button class="answer-btn" data-choice="X">×</button>
</div>

<button id="confirm">回答を決定する</button>

</body>
</html>

