<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>学生用回答ページ</title>
<link rel="stylesheet" href="student.css">

<script type="module">
import { db, ref, onValue, update } from "./common.js";

document.addEventListener("DOMContentLoaded", () => {

    /* --- ルーム取得 --- */
    const params = new URLSearchParams(window.location.search);
    const room = params.get("room");

    const roomLabel = document.getElementById("roomLabel");
    const statusLabel = document.getElementById("statusLabel");
    const btnO = document.getElementById("btnO");
    const btnX = document.getElementById("btnX");
    const btnSend = document.getElementById("btnSend");

    roomLabel.textContent = room ? `ルーム：${room}` : "ルーム未設定";
    if (!room) return;

    /* --- 固定ユーザーID --- */
    let userId = localStorage.getItem("quizUserId");
    if (!userId) {
        userId = "user_" + Math.random().toString(36).substring(2, 10);
        localStorage.setItem("quizUserId", userId);
    }

    const activityRef = ref(db, `rooms/${room}/activity`);
    const answersRef  = ref(db, `rooms/${room}/answers`);

    let choice = null;
    let locked = true;

    /* --- 回答開始・終了の監視 --- */
    onValue(activityRef, (snap) => {
        const status = snap.val()?.status || "closed";

        locked = (status !== "open");

        if (locked) {
            statusLabel.textContent = "回答終了";
            disableAll();
        } else {
            statusLabel.textContent = "回答できます";
            enableChoices();
        }
    });

    /* --- 選択処理 --- */
    btnO.addEventListener("click", () => {
        if (locked) return;
        choice = "O";
        highlightChoice("O");
    });

    btnX.addEventListener("click", () => {
        if (locked) return;
        choice = "X";
        highlightChoice("X");
    });

    /* --- 決定ボタン --- */
    btnSend.addEventListener("click", () => {
        if (locked || !choice) return;

        update(answersRef, { [userId]: choice });

        disableAll();
        statusLabel.textContent = "回答しました";

        const audio = new Audio("poyon.mp3");
        audio.play();
    });

    /* --- UI管理 --- */
    function disableAll() {
        btnO.disabled = true;
        btnX.disabled = true;
        btnSend.disabled = true;
    }

    function enableChoices() {
        btnO.disabled = false;
        btnX.disabled = false;
        btnSend.disabled = false;
        choice = null;
        highlightChoice(null);
    }

    function highlightChoice(c) {
        btnO.classList.toggle("selected", c === "O");
        btnX.classList.toggle("selected", c === "X");
    }
});
</script>
</head>

<body>
<div class="container">
    <h2 id="roomLabel">ルーム</h2>
    <p id="statusLabel" class="status">読み込み中...</p>

    <div class="choice-box">
        <button id="btnO" class="btn-o">○</button>
        <button id="btnX" class="btn-x">×</button>
    </div>

    <button id="btnSend" class="btn-send">決定</button>
</div>
</body>
</html>

