<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>学生用回答ページ</title>
<link rel="stylesheet" href="student.css">

<script type="module">
import { db, ref, set, onValue, getRoom } from "./common.js";

document.addEventListener("DOMContentLoaded", () => {

  /* -------------------------
       クラス名（room）取得
  ------------------------- */
  const room = getRoom();
  document.getElementById("roomName").textContent = room;

  /* -------------------------
       Firebase パス
       rooms/{room}/activity
       rooms/{room}/answers
  ------------------------- */
  const activityRef = ref(db, `rooms/${room}/activity`);
  const answersRef  = ref(db, `rooms/${room}/answers`);

  /* -------------------------
       学生側 UI 要素
  ------------------------- */
  const btnO = document.getElementById("btnO");
  const btnX = document.getElementById("btnX");
  const statusText = document.getElementById("status");

  /* -------------------------
       回答できるかどうか
  ------------------------- */
  let answeringAllowed = false;

  onValue(activityRef, snapshot => {
    const v = snapshot.val();
    answeringAllowed = (v && v.status === "open");

    if (answeringAllowed) {
      statusText.textContent = "【回答できます】";
      btnO.classList.remove("locked");
      btnX.classList.remove("locked");
    } else {
      statusText.textContent = "【回答は締め切られています】";
      btnO.classList.add("locked");
      btnX.classList.add("locked");
    }
  });

  /* -------------------------
       学生の識別子
       （ランダムIDで十分）
  ------------------------- */
  const myId = "user_" + Math.floor(Math.random() * 999999999);

  /* -------------------------
       回答送信（最後の1つだけ有効）
  ------------------------- */
  function sendAnswer(ans) {
    if (!answeringAllowed) return;

    // Firebaseに書き込む
    set(ref(db, `rooms/${room}/answers/${myId}`), ans);

    // 見た目の反転
    btnO.classList.remove("selected");
    btnX.classList.remove("selected");

    if (ans === "O") btnO.classList.add("selected");
    if (ans === "X") btnX.classList.add("selected");
  }

  /* -------------------------
       ボタンイベント
  ------------------------- */
  btnO.addEventListener("click", () => sendAnswer("O"));
  btnX.addEventListener("click", () => sendAnswer("X"));

});
</script>

</head>

<body>

<h1>回答ページ</h1>
<h2 id="roomName"></h2>
<div id="status">読み込み中…</div>

<button id="btnO" class="answer-btn o">○</button>
<button id="btnX" class="answer-btn x">×</button>

</body>
</html>