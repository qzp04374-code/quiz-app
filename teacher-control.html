<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>先生画面（teacher-control）</title>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
      background: #f2f2f7;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    .room-select {
      text-align: center;
      margin-bottom: 20px;
    }

    #roomSelector {
      font-size: 20px;
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .mode-buttons {
      text-align: center;
      margin: 20px 0;
    }

    button {
      font-size: 20px;
      padding: 14px 24px;
      margin: 8px;
      border-radius: 12px;
      border: none;
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      cursor: pointer;
    }

    button.active {
      background: #007aff;
      color: white;
      box-shadow: 0 0 12px rgba(0,122,255,0.7);
    }

    #graphArea {
      width: 90%;
      margin: 20px auto;
    }

    .bar {
      height: 48px;
      background: #ddd;
      border-radius: 30px;
      margin: 16px 0;
      position: relative;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      width: 0%;
      transition: width 0.4s;
      border-radius: 30px;
    }

    .bar-label {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      font-weight: bold;
    }

    .bar-count {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      font-weight: bold;
    }

    #textList {
      width: 90%;
      margin: 20px auto;
      font-size: 22px;
      line-height: 1.6em;
    }

    /* QRコードモーダル */
    #qrModal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
    }

    #qrModalContent {
      background: white;
      padding: 20px;
      border-radius: 16px;
      text-align: center;
      width: 320px;
    }

    #qr {
      margin: 20px auto;
    }

  </style>
</head>

<body>

  <h1>先生画面</h1>

  <div class="room-select">
    <label>ルーム選択：</label>
    <select id="roomSelector">
      <option value="kyoto-01">kyoto-01</option>
      <option value="kyoto-02">kyoto-02</option>
      <option value="sendai-01">sendai-01</option>
      <option value="sendai-02">sendai-02</option>
      <option value="nagoya-01">nagoya-01</option>
      <option value="nagoya-02">nagoya-02</option>
    </select>
  </div>

  <div class="mode-buttons">
    <button id="oxBtn">○× モード開始</button>
    <button id="fiveBtn">5択 モード開始</button>
    <button id="textBtn">文字記入 モード開始</button>
    <button id="stopBtn">回答終了</button>
    <button id="resetBtn">集計リセット</button>
    <button id="qrBtn">QRコード</button>
    <button id="projectionBtn">集計画面を開く</button>
  </div>

  <div id="graphArea"></div>
  <div id="textList"></div>
  <!-- QRコード用ライブラリ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      set,
      update
    } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

    /* ▼ Firebase設定（固定） */
    const firebaseConfig = {
      apiKey: "AIzaSyBke-wTU16skpbK8z80ddK04tE154dHERQ",
      authDomain: "satosan-41eac.firebaseapp.com",
      databaseURL: "https://satosan-41eac-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "satosan-41eac",
      storageBucket: "satosan-41eac.firebasestorage.app",
      messagingSenderId: "992482993229",
      appId: "1:992482993229:web:e2c59b078233b0ed16e804",
      measurementId: "G-VT9FKHN3LT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* ▼ UI 要素 */
    const roomSelector = document.getElementById("roomSelector");
    const oxBtn = document.getElementById("oxBtn");
    const fiveBtn = document.getElementById("fiveBtn");
    const textBtn = document.getElementById("textBtn");
    const stopBtn = document.getElementById("stopBtn");
    const resetBtn = document.getElementById("resetBtn");
    const qrBtn = document.getElementById("qrBtn");
    const projectionBtn = document.getElementById("projectionBtn");

    const graphArea = document.getElementById("graphArea");
    const textList = document.getElementById("textList");

    const qrModal = document.getElementById("qrModal");
    const qrDiv = document.getElementById("qr");

    /* ▼ 現在のルームを管理 */
    let currentRoom = roomSelector.value;

    const actRef = () => ref(db, `rooms/${currentRoom}/activity`);
    const ansRef = () => ref(db, `rooms/${currentRoom}/answers`);
    const resRef = () => ref(db, `rooms/${currentRoom}/result`);

    /* ▼ 票が増えたときの音 */
    const sound = new Audio("poyo.mp3");

    /* ▼ 学生回答監視 → result自動加算 */
    onValue(ansRef(), snap => {
      const answers = snap.val() || {};

      let counts = {};
      Object.values(answers).forEach(v => {
        if (!counts[v]) counts[v] = 0;
        counts[v]++;
      });

      set(resRef(), counts);

      sound.currentTime = 0;
      sound.play();
    });

    /* ▼ グラフ描画（OX・5択） */
    function renderGraph(resultData) {
      graphArea.innerHTML = "";

      if (!resultData) return;

      Object.keys(resultData).forEach(label => {
        const count = resultData[label] || 0;

        const bar = document.createElement("div");
        bar.className = "bar";

        const fill = document.createElement("div");
        fill.className = "bar-fill";
        fill.style.background = getColor(label);

        const max = Math.max(...Object.values(resultData));
        fill.style.width = max === 0 ? "0%" : `${(count / max) * 100}%`;

        const labelDiv = document.createElement("div");
        labelDiv.className = "bar-label";
        labelDiv.textContent = label;

        const countDiv = document.createElement("div");
        countDiv.className = "bar-count";
        countDiv.textContent = count;

        bar.appendChild(fill);
        bar.appendChild(labelDiv);
        bar.appendChild(countDiv);
        graphArea.appendChild(bar);
      });
    }

    /* カラー設定 */
    function getColor(label) {
      const colors = {
        "O": "#4CAF50",
        "X": "#F44336",
        "A": "#2196F3",
        "B": "#4CAF50",
        "C": "#FF9800",
        "D": "#9C27B0",
        "E": "#E91E63",
      };
      return colors[label] || "#888";
    }
    /* ▼ ルーム変更時の動作 */
    roomSelector.onchange = () => {
      currentRoom = roomSelector.value;
      graphArea.innerHTML = "";
      textList.innerHTML = "";

      onValue(ansRef(), snap => {
        const answers = snap.val() || {};
        let counts = {};
        Object.values(answers).forEach(v => {
          if (!counts[v]) counts[v] = 0;
          counts[v]++;
        });
        renderGraph(counts);
      });
    };

    /* -----------------------------------------
       ▼ ここから QR同期追加部分（最重要）
       ----------------------------------------- */

    /* QRボタン：qr:true を送る */
    qrBtn.onclick = () => {
      update(actRef(), { qr: true });

      const here = new URL(location.href);
      const dirPath = here.pathname.replace(/[^/]*$/, "");
      const base = here.origin + dirPath;
      const url = `${base}student.html?room=${currentRoom}`;

      qrDiv.innerHTML = "";
      new QRCode(qrDiv, {
        text: url,
        width: 280,
        height: 280
      });

      qrModal.style.display = "flex";
    };

    /* -----------------------------------------
       ▼ モード開始（OX / 5択 / 文字） → qr:false を送る
       ----------------------------------------- */

    function startMode(mode, choices = null) {
      set(ansRef(), {});
      set(resRef(), {});
      update(actRef(), { status: "open", mode, qr: false });

      /* 5択やOXの場合は result の初期値を生成 */
      if (choices) {
        const obj = {};
        choices.forEach(c => (obj[c] = 0));
        set(resRef(), obj);
      }

      graphArea.innerHTML = "";
      textList.innerHTML = "";
    }

    oxBtn.onclick = () => {
      update(actRef(), { qr: false });
      startMode("ox", ["O", "X"]);
      setActiveModeButton(oxBtn);
    };

    fiveBtn.onclick = () => {
      update(actRef(), { qr: false });
      startMode("five", ["A", "B", "C", "D", "E"]);
      setActiveModeButton(fiveBtn);
    };

    textBtn.onclick = () => {
      update(actRef(), { qr: false });
      startMode("text");
      setActiveModeButton(textBtn);
    };

    /* -----------------------------------------
       ▼ 回答終了（文字記入は一覧表示のため読み込みも行う）
       ----------------------------------------- */

    stopBtn.onclick = () => {
      update(actRef(), { status: "closed", qr: false });

      onValue(ansRef(), snap => {
        const answers = snap.val() || {};
        const keys = Object.keys(answers);

        textList.innerHTML = "<h2>回答一覧</h2>";

        let html = "<ul>";
        keys.forEach((k, idx) => {
          html += `<li>${idx + 1}. ${answers[k]}</li>`;
        });
        html += "</ul>";

        textList.innerHTML = html;
      });

      setActiveModeButton(null);
    };

    /* -----------------------------------------
       ▼ 集計リセット（graph・text・Firebase初期化）
       ----------------------------------------- */

    resetBtn.onclick = () => {
      update(actRef(), { qr: false });

      set(ansRef(), {});
      set(resRef(), {});
      graphArea.innerHTML = "";
      textList.innerHTML = "";
    };

    /* -----------------------------------------
       ▼ 集計画面（projection）を新しいタブで開く
       ----------------------------------------- */

    projectionBtn.onclick = () => {
      const here = new URL(location.href);
      const dirPath = here.pathname.replace(/[^/]*$/, "");
      const base = here.origin + dirPath;
      window.open(`${base}teacher-screen.html?room=${currentRoom}`, "_blank");
    };

    /* -----------------------------------------
       ▼ モードボタンの光るアニメーション維持
       ----------------------------------------- */

    function setActiveModeButton(btn) {
      [oxBtn, fiveBtn, textBtn].forEach(b => b.classList.remove("active"));
      if (btn) btn.classList.add("active");
    }

  </script>
</body>
</html>
