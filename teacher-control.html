<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>先生画面（teacher-control）</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
      background: #f2f2f7;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    .mode-buttons {
      text-align: center;
      margin: 20px 0;
    }
    button {
      font-size: 20px;
      padding: 14px 24px;
      margin: 8px;
      border-radius: 12px;
      border: none;
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      cursor: pointer;
    }
    button.active {
      background: #007aff;
      color: white;
    }

    #graphArea {
      width: 90%;
      margin: 20px auto;
    }
    .bar {
      height: 48px;
      background: #ddd;
      border-radius: 30px;
      margin: 16px 0;
      position: relative;
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      width: 0%;
      transition: width 0.4s;
      border-radius: 30px;
    }
    .bar-label {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      font-weight: bold;
    }
    .bar-count {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      font-weight: bold;
    }

    /* QRコードモーダル */
    #qrModal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
    }
    #qrModalContent {
      background: white;
      padding: 20px;
      border-radius: 16px;
      text-align: center;
    }
  </style>
</head>

<body>
  <h1>先生画面</h1>

  <div class="mode-buttons">
    <button id="oxBtn">○× モード開始</button>
    <button id="fiveBtn">5択 モード開始</button>
    <button id="textBtn">文字記入 モード開始</button>
    <button id="stopBtn">回答終了</button>
    <button id="resetBtn">集計リセット</button>
    <button id="qrBtn">QRコード</button>
  </div>

  <div id="graphArea"></div>
  <div id="textList"></div>

  <!-- QRモーダル -->
  <div id="qrModal">
    <div id="qrModalContent">
      <h2>参加用QRコード</h2>
      <div id="qr"></div>
      <button onclick="qrModal.style.display='none'">閉じる</button>
    </div>
  </div>

  <!-- 外部ライブラリ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      set,
      update,
      get
    } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBke-wTU16skpbK8z80ddK04tE154dHERQ",
      authDomain: "satosan-41eac.firebaseapp.com",
      databaseURL: "https://satosan-41eac-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "satosan-41eac",
      storageBucket: "satosan-41eac.firebasestorage.app",
      messagingSenderId: "992482993229",
      appId: "1:992482993229:web:e2c59b078233b0ed16e804",
      measurementId: "G-VT9FKHN3LT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* ▼ URL room=xxx */
    const params = new URLSearchParams(location.search);
    const currentRoom = params.get("room") || "kyoto-01";

    const actRef = () => ref(db, `rooms/${currentRoom}/activity`);
    const ansRef = () => ref(db, `rooms/${currentRoom}/answers`);
    const resRef = () => ref(db, `rooms/${currentRoom}/result`);

    /* ▼ UI */
    const oxBtn = document.getElementById("oxBtn");
    const fiveBtn = document.getElementById("fiveBtn");
    const textBtn = document.getElementById("textBtn");
    const stopBtn = document.getElementById("stopBtn");
    const resetBtn = document.getElementById("resetBtn");
    const qrBtn = document.getElementById("qrBtn");

    const qrModal = document.getElementById("qrModal");
    const qrDiv = document.getElementById("qr");

    /* ------------------------------
       QRボタンクリック → qr:true を設定
       ------------------------------ */
    qrBtn.onclick = () => {
      update(actRef(), { qr: true });

      const here = new URL(location.href);
      const dirPath = here.pathname.replace(/[^/]*$/, "");
      const base = here.origin + dirPath;

      const url = `${base}student.html?room=${currentRoom}`;

      qrDiv.innerHTML = "";
      new QRCode(qrDiv, {
        text: url,
        width: 280,
        height: 280
      });

      qrModal.style.display = "flex";
    };

    /* ------------------------------
       ○× / 5択 / 文字記入 / 終了 / リセット → qr:false を設定
       ------------------------------ */

    oxBtn.onclick = () => {
      update(actRef(), { qr: false });
      startMode("ox", ["O", "X"]);
    };

    fiveBtn.onclick = () => {
      update(actRef(), { qr: false });
      startMode("five", ["A", "B", "C", "D", "E"]);
    };

    textBtn.onclick = () => {
      update(actRef(), { qr: false });
      startMode("text");
    };

    stopBtn.onclick = () => {
      update(actRef(), { status: "closed", qr: false });
    };

    resetBtn.onclick = () => {
      update(actRef(), { qr: false });
      set(ansRef(), {});
      set(resRef(), {});
      document.getElementById("graphArea").innerHTML = "";
      document.getElementById("textList").innerHTML = "";
    };

    /* ▼ モード開始処理 */
    async function startMode(mode, choices = null) {
      await set(ansRef(), {});
      await set(resRef(), {});

      await update(actRef(), {
        status: "open",
        mode,
        qr: false
      });

      if (choices) {
        const obj = {};
        choices.forEach(c => (obj[c] = 0));
        await set(resRef(), obj);
      }
    }

  </script>
</body>
</html>
