<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>投影画面（teacher-screen）</title>

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    margin: 0;
    padding: 20px;
    background: #f2f2f7;
    text-align: center;
  }

  h1 {
    font-size: 32px;
    margin-bottom: 20px;
  }

  .bar {
    width: 80%;
    height: 60px;
    background: #ddd;
    margin: 20px auto;
    border-radius: 30px;
    position: relative;
    overflow: hidden;
  }

  .bar-fill {
    height: 100%;
    width: 0%;
    transition: width 0.3s;
    border-radius: 30px;
  }

  .bar-label, .bar-count {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    font-size: 24px;
    font-weight: bold;
  }

  .bar-label {
    left: 20px;
  }

  .bar-count {
    right: 20px;
  }

  #qr-area {
    display: none;
    margin-top: 30px;
  }

  #qr {
    margin: 0 auto;
  }

  #textList {
    width: 80%;
    margin: 20px auto;
    font-size: 26px;
    text-align: left;
    line-height: 1.6em;
  }
</style>

</head>
<body>

<h1>集計画面</h1>

<div id="graphArea"></div>
<div id="textList"></div>

<!-- QR 表示エリア -->
<div id="qr-area">
  <h2>参加用QRコード</h2>
  <div id="qr"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
  import {
    getDatabase,
    ref,
    onValue
  } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

  /* ▼ URL から room を取得 */
  const params = new URLSearchParams(location.search);
  const room = params.get("room") || "kyoto-01";

  /* ▼ Firebase */
  const firebaseConfig = {
    apiKey: "AIzaSyBke-wTU16skpbK8z80ddK04tE154dHERQ",
    authDomain: "satosan-41eac.firebaseapp.com",
    databaseURL: "https://satosan-41eac-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "satosan-41eac",
    storageBucket: "satosan-41eac.firebasestorage.app",
    messagingSenderId: "992482993229",
    appId: "1:992482993229:web:e2c59b078233b0ed16e804"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const actRef = ref(db, `rooms/${room}/activity`);
  const ansRef = ref(db, `rooms/${room}/answers`);
  const resRef = ref(db, `rooms/${room}/result`);

  const graphArea = document.getElementById("graphArea");
  const textList = document.getElementById("textList");

  let currentMode = null;
  let qrVisible = false;

  /* ▼ 参加URL の生成（teacher-control と同じ方式） */
  const here = new URL(location.href);
  const dirPath = here.pathname.replace(/[^/]*$/, "");
  const base = here.origin + dirPath;
  const joinURL = `${base}student.html?room=${room}`;

  /* ▼ QR 表示更新 */
  function renderQR() {
    const area = document.getElementById("qr-area");
    if (qrVisible) {
      area.style.display = "block";
      const qrDiv = document.getElementById("qr");
      qrDiv.innerHTML = "";
      new QRCode(qrDiv, { text: joinURL, width: 300, height: 300 });
    } else {
      area.style.display = "none";
    }
  }

  /* ▼ グラフ描画 */
  function renderGraph(resultData) {
    graphArea.innerHTML = "";
    if (!resultData) return;

    const max = Math.max(...Object.values(resultData), 1);

    Object.keys(resultData).forEach(label => {
      const count = resultData[label];

      const bar = document.createElement("div");
      bar.className = "bar";

      const fill = document.createElement("div");
      fill.className = "bar-fill";
      fill.style.background = getColor(label);
      fill.style.width = `${(count / max) * 100}%`;

      const labelDiv = document.createElement("div");
      labelDiv.className = "bar-label";
      labelDiv.textContent = label;

      const countDiv = document.createElement("div");
      countDiv.className = "bar-count";
      countDiv.textContent = count;

      bar.appendChild(fill);
      bar.appendChild(labelDiv);
      bar.appendChild(countDiv);
      graphArea.appendChild(bar);
    });
  }

  function getColor(label) {
    const colors = {
      "O": "#4CAF50",
      "X": "#F44336",
      "A": "#2196F3",
      "B": "#4CAF50",
      "C": "#FF9800",
      "D": "#9C27B0",
      "E": "#E91E63"
    };
    return colors[label] || "#888";
  }

  /* ▼ 文字記入一覧表示（回答終了時） */
  function renderTextList(answers) {
    textList.innerHTML = "<h2>回答一覧</h2>";
    let html = "<ul>";
    Object.keys(answers).forEach((key, idx) => {
      html += `<li>${idx + 1}. ${answers[key]}</li>`;
    });
    html += "</ul>";
    textList.innerHTML = html;
  }

  /* ▼ activity 監視（mode・status・qr 表示） */
  onValue(actRef, snap => {
    const data = snap.val() || {};

    currentMode = data.mode || null;
    const status = data.status || "open";

    /* QR表示反映 */
    qrVisible = data.qr === true;
    renderQR();

    /* 回答終了 → 文字一覧表示 */
    if (currentMode === "text" && status === "closed") {
      onValue(ansRef, snap2 => {
        renderTextList(snap2.val() || {});
      });
    }
  });

  /* ▼ result 監視してグラフ更新（OX・5択） */
  onValue(resRef, snap => {
    if (currentMode === "ox" || currentMode === "five") {
      renderGraph(snap.val() || {});
    }
  });

</script>

</body>
</html>
