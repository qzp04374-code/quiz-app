<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投影用 集計画面</title>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f7f7f7;
            margin: 0;
            padding: 20px;
            text-align: center;
        }

        .graph-container {
            width: 90%;
            margin: 0 auto;
            margin-top: 20px;
        }

        .bar {
            height: 60px;
            background: #ddd;
            margin: 20px 0;
            border-radius: 40px;
            position: relative;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            width: 0%;
            border-radius: 40px;
            transition: width 0.4s;
        }

        .bar-label {
            position: absolute;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            font-size: 28px;
            font-weight: bold;
        }

        .bar-count {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            font-size: 28px;
            font-weight: bold;
        }

        /* QRコード中央配置 */
        #qr-wrapper {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-top: 30px;
        }
    </style>
</head>

<body>

<h1 style="font-size: 40px; margin-bottom: 10px;">集計結果</h1>

<div id="graphArea" class="graph-container"></div>

<h2 style="font-size: 34px; margin-top: 40px;">参加用QRコード</h2>

<div id="qr-wrapper">
    <div id="qr"></div>
</div>

<!-- QRコード生成 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- Firebase -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

    /* ▼ Firebase設定（全画面共通） */
    const firebaseConfig = {
        apiKey: "AIzaSyBke-wTU16skpbK8z80ddK04tE154dHERQ",
        authDomain: "satosan-41eac.firebaseapp.com",
        databaseURL: "https://satosan-41eac-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "satosan-41eac",
        storageBucket: "satosan-41eac.firebasestorage.app",
        messagingSenderId: "992482993229",
        appId: "1:992482993229:web:e2c59b078233b0ed16e804",
        measurementId: "G-VT9FKHN3LT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* ▼ room=xxx を取得 */
    const params = new URLSearchParams(window.location.search);
    const room = params.get("room") || "kyoto-01";

    /* ▼ student.html の正しいパス生成 */
    const here = new URL(location.href);
    const basePath = here.pathname.replace(/[^/]*$/, "");
    const joinURL = `${here.origin}${basePath}student.html?room=${room}`;

    /* ▼ QR表示 */
    new QRCode(document.getElementById("qr"), {
        text: joinURL,
        width: 300,
        height: 300
    });

    /* ▼ Firebase参照 */
    const activityRef = ref(db, `rooms/${room}/activity`);
    const resultRef   = ref(db, `rooms/${room}/result`);

    /* ▼ 最新データ保持用 */
    let currentMode = "ox";
    let latestResult = {};

    /* ▼ 先に activity（mode）を監視 */
    onValue(activityRef, snap => {
        const data = snap.val() || {};
        currentMode = data.mode || "ox";

        // モード変更された瞬間に現在の result を使って再描画
        renderGraph(latestResult);
    });

    /* ▼ 次に result を監視 */
    onValue(resultRef, snap => {
        latestResult = snap.val() || {};
        renderGraph(latestResult);
    });


    /* ▼ グラフ描画（モード別） */
    function renderGraph(resultData) {
        const graph = document.getElementById("graphArea");
        graph.innerHTML = "";

        let labels = [];

        if (currentMode === "ox") {
            labels = ["O", "X"];
        } else if (currentMode === "five") {
            labels = ["A", "B", "C", "D", "E"];
        } else if (currentMode === "text") {
            labels = ["回答数"];
        } else {
            graph.innerHTML = "<p>集計データはありません。</p>";
            return;
        }

        labels.forEach(label => {
            const count = resultData[label] || 0;

            const bar = document.createElement("div");
            bar.className = "bar";

            const fill = document.createElement("div");
            fill.className = "bar-fill";
            fill.style.background = getColor(label);

            const max = getMax(resultData, labels);
            fill.style.width = max === 0 ? "0%" : `${(count / max) * 100}%`;

            const textL = document.createElement("div");
            textL.className = "bar-label";
            textL.textContent = label;

            const textC = document.createElement("div");
            textC.className = "bar-count";
            textC.textContent = count;

            bar.appendChild(fill);
            bar.appendChild(textL);
            bar.appendChild(textC);
            graph.appendChild(bar);
        });
    }

    /* ▼ 色設定 */
    function getColor(label) {
        const colors = {
            "O": "#4CAF50",
            "X": "#F44336",
            "A": "#2196F3",
            "B": "#4CAF50",
            "C": "#FF9800",
            "D": "#9C27B0",
            "E": "#E91E63",
            "回答数": "#607D8B"
        };
        return colors[label] || "#888";
    }

    /* ▼ 棒の最大値（相対幅用） */
    function getMax(data, labels) {
        let max = 0;
        labels.forEach(lb => {
            max = Math.max(max, data[lb] || 0);
        });
        return max;
    }

</script>

</body>
</html>
